<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SkyFarm — Users & Roles (Admin)</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>

<style>
  :root { --brand:#0B7A6E; }
  * { box-sizing:border-box; }
  body { font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#f6fbf8; margin:16px; color:#0f172a; }
  h1 { margin:0 0 12px; font-size:1.6rem; }
  .wrap { max-width:1100px; margin:0 auto; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:12px 0; }
  .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; align-items:flex-end; }
  label { display:block; font-size:.9rem; color:#475569; margin-bottom:4px; }
  input, select, button, textarea { padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
  button { cursor:pointer; }
  .primary { background:var(--brand); color:#fff; border-color:var(--brand); }
  .danger { background:#ef4444; color:#fff; border-color:#ef4444; }
  .muted { color:#64748b; font-size:.9rem; }
  .spacer { flex:1; }
  table { width:100%; border-collapse:collapse; }
  th, td { border-bottom:1px solid #e5e7eb; padding:8px; text-align:left; }
  th { background:#f1f5f9; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#e2e8f0; font-size:.8rem; margin-right:6px; }
  .pill { padding:2px 8px; border-radius:999px; background:#dcfce7; color:#065f46; font-size:.8rem; }
  .warn { color:#9a3412; }
  .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:8px; }

  /* Header styling */
  #skyfarm-header { position:sticky; top:0; z-index:10; }
  #skyfarm-header .bar { display:flex; align-items:center; gap:12px; padding:10px 14px; background:#fff; border-bottom:1px solid #e5e7eb; }
  #skyfarm-header .brand { display:flex; align-items:center; gap:10px; color:#0B7A6E; font-weight:700; text-decoration:none; }
  #skyfarm-header nav a { color:#0B7A6E; text-decoration:none; font-weight:600; margin-right:10px; }
  #skyfarm-header nav a[aria-current="page"] { text-decoration:underline; }
</style>

<link rel="stylesheet" href="skyfarm-shared.css">
</head>
<body>
<div id="sf-header-root"></div>
<script src="skyfarm-header.js"></script>
<script>SkyFarmHeader.mount();</script>



<script>SkyFarmAuth.requireAuth();</script>
<!-- SkyFarm header with logo and navigation -->


<div class="wrap">
  <h1>SkyFarm — Users & Roles</h1>

  <!-- Invite block -->
  <div class="card">
    <div class="row">
      <strong>Invite a user (email link)</strong>
      <span class="spacer"></span>
      <span id="status" class="muted">Connecting…</span>
    </div>
    <div class="grid">
      <div>
        <label>Email</label>
        <input id="invEmail" type="email" placeholder="user@example.com" style="width:100%" />
      </div>
      <div>
        <label>Name (optional)</label>
        <input id="invName" placeholder="e.g. Jane Brown" style="width:100%" />
      </div>
      <div>
        <label>Role</label>
        <select id="invRole" style="width:100%">
          <option value="worker">Worker</option>
          <option value="manager">Manager</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div>
        <label>Allowed properties</label>
        <div id="invProps" class="grid" style="grid-template-columns: repeat(1, minmax(200px,1fr));">
          <!-- checkboxes inserted here -->
        </div>
      </div>
      <div>
        <label>Redirect after sign-in</label>
        <input id="redirectUrl" style="width:100%" />
        <div class="muted">Default: live domain — users land on Diary after confirming the link.</div>
      </div>
    </div>
    <div class="row">
      <button id="inviteBtn" class="primary">Send invite link</button>
      <span id="inviteMsg" class="muted" aria-live="polite"></span>
    </div>
  </div>

  <!-- Manage users -->
  <div class="card">
    <div class="row">
      <strong>Manage users</strong>
      <span class="spacer"></span>
      <input id="search" placeholder="Search email / name" />
      <button id="refreshBtn">Refresh</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Email</th><th>Name</th><th>Role</th><th>Properties</th><th>Last updated</th><th></th>
        </tr>
      </thead>
      <tbody id="usersTbody"><tr><td colspan="6">Loading…</td></tr></tbody>
    </table>
  </div>
</div>

<script>
/*** Firebase ***/
const firebaseConfig = {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/*** Constants ***/
const PROPERTY_IDS = {
  "Consentes":"s7PlDM9wrEpxuJ6DGIab",
  "Mt Myrtle":"TRuxtRBx2zJlwZnRGYKJ",
  "Gerawin":"P0dQ0H2FWHeqqxejflZs"
};
const PROPERTY_NAME_BY_ID = Object.fromEntries(Object.entries(PROPERTY_IDS).map(([n,i])=>[i,n]));

/*** DOM helpers ***/
const $ = s=>document.querySelector(s);
const statusEl = $('#status');
const setStatus = t => { statusEl.textContent=t||''; statusEl.className = t?.toLowerCase().includes('connected')?'pill':'warn'; };
const setMsg = (el,t,ms=4000)=>{ el.textContent=t||''; if(t&&ms) setTimeout(()=>el.textContent='',ms); };

/*** Elements ***/
const invEmail=$('#invEmail'), invName=$('#invName'), invRole=$('#invRole'),
      invPropsBox=$('#invProps'), redirectUrl=$('#redirectUrl'),
      inviteBtn=$('#inviteBtn'), inviteMsg=$('#inviteMsg'),
      usersTbody=$('#usersTbody'), searchInp=$('#search'), refreshBtn=$('#refreshBtn'), sfAuth=$('#sf-auth');

let users=[];

/*** Init ***/
(async function init(){
  invPropsBox.innerHTML = Object.entries(PROPERTY_IDS).map(([name,id])=>`
    <label style="display:flex;align-items:center;gap:8px;">
      <input type="checkbox" value="${id}"> ${name}
    </label>`).join('');

  const defaultRedirect = location.hostname.endsWith('consentes.com.au')
    ? `${location.origin}/skyfarm-diary.html`
    : 'https://www.consentes.com.au/skyfarm-diary.html';
  redirectUrl.value = defaultRedirect;

  try {
    await auth.signInAnonymously();
    setStatus('Connected');
  } catch(e){
    console.error(e);
    setStatus('Auth issue — check Anonymous sign-in & domains');
  }

  auth.onAuthStateChanged(u=>{
    sfAuth.textContent = u ? (u.isAnonymous?'Connected (guest)':'Signed in') : 'Connecting…';
  });

  inviteBtn.onclick=sendInvite;
  refreshBtn.onclick=loadUsers;
  searchInp.oninput=renderUsers;
  await loadUsers();
})();

/*** Invite ***/
async function sendInvite(){
  const email=(invEmail.value||'').trim().toLowerCase();
  if(!email||!email.includes('@')) return setMsg(inviteMsg,'Enter valid email');
  const name=(invName.value||'').trim();
  const role=invRole.value||'worker';
  const allowed=Array.from(invPropsBox.querySelectorAll('input:checked')).map(c=>c.value);
  const docId=email.replace(/[^\w.-]/g,'_');
  try {
    await db.collection('users').doc(docId).set({
      email,name,role,allowedProperties:allowed,
      updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
  }catch(e){console.error(e);}
  try{
    await auth.sendSignInLinkToEmail(email,{url:redirectUrl.value,handleCodeInApp:true});
    localStorage.setItem('emailForSignIn',email);
    setMsg(inviteMsg,`Invite sent to ${email}.`);
    invEmail.value=invName.value='';
  }catch(e){
    console.error(e);
    setMsg(inviteMsg,`Failed: ${e.code||''} ${e.message||''}`,'red');
  }
}

/*** Load users ***/
async function loadUsers(){
  usersTbody.innerHTML='<tr><td colspan="6">Loading…</td></tr>';
  users=[];
  const snap=await db.collection('users').orderBy('updatedAt','desc').get();
  snap.forEach(d=>{const r=d.data();users.push({...r,id:d.id,updatedAt:r.updatedAt?.toDate?.()?.toLocaleString?.()||''});});
  renderUsers();
}
function renderUsers(){
  const q=(searchInp.value||'').toLowerCase();
  const list=users.filter(u=>!q||u.email?.toLowerCase().includes(q)||u.name?.toLowerCase().includes(q));
  usersTbody.innerHTML='';
  if(!list.length)return usersTbody.innerHTML='<tr><td colspan="6">No users</td></tr>';
  for(const u of list){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${u.email}</td>
      <td><input data-name value="${u.name||''}"></td>
      <td>
        <select data-role>
          <option value="worker"${u.role==='worker'?' selected':''}>Worker</option>
          <option value="manager"${u.role==='manager'?' selected':''}>Manager</option>
          <option value="admin"${u.role==='admin'?' selected':''}>Admin</option>
        </select>
      </td>
      <td>${Object.entries(PROPERTY_IDS).map(([n,id])=>
        `<label><input type="checkbox" value="${id}"${(u.allowedProperties||[]).includes(id)?' checked':''}> ${n}</label>`).join('<br>')}</td>
      <td>${u.updatedAt}</td>
      <td><button data-save class="primary">Save</button> <button data-del class="danger">Del</button></td>`;
    tr.querySelector('[data-save]').onclick=()=>saveRow(u.id,tr);
    tr.querySelector('[data-del]').onclick=()=>delRow(u.id,u.email);
    usersTbody.appendChild(tr);
  }
}
async function saveRow(id,tr){
  const name=tr.querySelector('[data-name]').value;
  const role=tr.querySelector('[data-role]').value;
  const allowed=Array.from(tr.querySelectorAll('input[type=checkbox]:checked')).map(c=>c.value);
  await db.collection('users').doc(id).set({name,role,allowedProperties:allowed,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
  loadUsers();
}
async function delRow(id,email){
  if(!confirm(`Remove ${email}?`))return;
  await db.collection('users').doc(id).delete();
  loadUsers();
}

/*** Sign-in via email link ***/
window.addEventListener('load',async()=>{
  if(auth.isSignInWithEmailLink(location.href)){
    let email=localStorage.getItem('emailForSignIn')||prompt('Enter your email');
    try{
      await auth.signInWithEmailLink(email,location.href);
      localStorage.removeItem('emailForSignIn');
      setMsg(inviteMsg,`Signed in as ${email}`);
    }catch(e){console.error(e);}
  }
});
</script>
</body>
</html>
