<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SkyFarm — Livestock (Diagnostic v2)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
<style>
  :root{--bg:#f6faf8;--card:#fff;--muted:#6b7280;--text:#111827;--brand:#0B7A6E;}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  h1{font-size:2rem;margin:24px 24px 8px}
  .wrap{max-width:1200px;margin:0 auto;padding:0 16px}
  .card{background:var(--card);border-radius:16px;padding:20px;margin:16px 0;box-shadow:0 1px 3px rgba(0,0,0,.06)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row > *{flex:1 1 240px}
  label{display:block;font-size:.85rem;color:var(--muted);margin-bottom:4px}
  input,select,textarea,button{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff}
  button{background:var(--brand);border-color:var(--brand);color:#fff;font-weight:600;cursor:pointer}
  button.ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
  .small{font-size:.85rem;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid #e5e7eb;padding:8px;text-align:left}
  th{font-size:.85rem;color:var(--muted)}
  .log{background:#000;color:#0f0;font-family:ui-monospace,Consolas,Menlo,monospace;height:220px;overflow:auto;border-radius:10px;padding:10px}
</style>
</head>
<body>
  <!-- SkyFarm mini header/nav -->
<header id="skyfarm-header" style="position:sticky;top:0;z-index:10">
  <div style="display:flex;align-items:center;gap:12px;padding:10px 14px;background:#fff;border-bottom:1px solid #e5e7eb">
    <div style="display:flex;align-items:center;gap:8px;color:#0B7A6E;font-weight:700">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none"><path d="M5 13c8-9 14-8 14-8s1 6-7 14c-4 4-9 3-9 3s-1-5 3-9Z" stroke="currentColor" stroke-width="1.8"/></svg>
      SkyFarm
    </div>
    <nav style="display:flex;gap:10px;margin-left:10px">
      <a href="#" data-nav="diary" style="color:#0B7A6E;text-decoration:none;font-weight:600">Diary</a>
      <a href="#" data-nav="map"   style="color:#0B7A6E;text-decoration:none;font-weight:600">Map</a>
      <a href="#" data-nav="chem"  style="color:#0B7A6E;text-decoration:none;font-weight:600">Chemicals</a>
      <a href="#" data-nav="admin" style="color:#0B7A6E;text-decoration:none;font-weight:600">Users</a>
    </nav>
    <div style="flex:1"></div>
    <span id="sf-auth" style="color:#64748b;font-size:.9rem">Connecting…</span>
  </div>
</header>
<script>
  (function(){
    // Link handler
    function pageUrl(slug){
      const base = location.origin;
      if (slug === 'diary') return `${base}/skyfarm-diary.html`;
      if (slug === 'map')   return `${base}/skyfarm-map.html`;
      if (slug === 'chem')  return `${base}/skyfarm-chemical-inventory.html`;
      if (slug === 'admin') return `${base}/skyfarm-admin-users.html`;
      return base + '/';
    }
    document.querySelectorAll('#skyfarm-header [data-nav]').forEach(a=>{
      a.onclick = (e)=>{ e.preventDefault(); location.href = pageUrl(a.getAttribute('data-nav')); };
    });

    // Optional: show simple auth state if Firebase is present on the page
    try {
      if (window.firebase?.auth) {
        const el = document.getElementById('sf-auth');
        firebase.auth().onAuthStateChanged(u=>{
          el.textContent = u ? (u.isAnonymous ? 'Connected (guest)' : `Signed in`) : 'Connecting…';
        });
      }
    } catch(e){}
  })();
</script>
<div class="wrap">
<h1>SkyFarm — Livestock (Diagnostic)</h1>

<!-- CONNECT -->
<div class="card">
  <div class="row">
    <div><label>apiKey</label><input id="cfg_apiKey" /></div>
    <div><label>authDomain</label><input id="cfg_authDomain" /></div>
    <div><label>projectId</label><input id="cfg_projectId" /></div>
    <div><label>appId</label><input id="cfg_appId" /></div>
  </div>
  <div class="row">
    <div style="flex:1 1 100%">
      <label>Or paste full firebaseConfig JSON</label>
      <textarea id="cfg_json" rows="5"></textarea>
      <div class="small">Paste the entire firebaseConfig object if you prefer.</div>
    </div>
  </div>
  <div class="row" style="align-items:flex-end">
    <div><label>Property</label><select id="propertySelect"></select></div>
    <div><label class="small">&nbsp;</label><button id="btnConnect">Connect</button></div>
    <div style="flex:2 1 auto;display:flex;align-items:center">
      <span id="status" class="small" style="color:#0B7A6E"></span>
      <span id="statusErr" class="small" style="color:#b42318;margin-left:12px"></span>
    </div>
  </div>
</div>

<!-- LIVESTOCK ENTRY -->
<div class="card">
  <div class="row">
    <div><label>Species</label>
      <select id="species">
        <option value="Cattle">Cattle</option>
        <option value="Sheep">Sheep</option>
      </select>
    </div>
    <div><label>Class</label><select id="classSel"></select></div>
    <div id="classCustomWrap" style="display:none"><label>Custom class</label><input id="classCustom"/></div>
    <div><label>Breed</label><input id="breed"/></div>
    <div><label>Count</label><input id="count" type="number" value="0"/></div>
    <div><label>Avg Weight (kg)</label><input id="avgWeight" type="number" value="400"/></div>
    <div><label>AE/head</label><input id="ae" type="number" step="0.01"/></div>
    <div><label>DSE/head</label><input id="dse" type="number" step="0.1"/></div>
  </div>
  <div class="row">
    <div><label>Location</label><select id="location"></select></div>
    <div><label>Moved In</label><input id="movedIn" type="date"/></div>
    <div><label class="small">&nbsp;</label><button id="btnSave">Add / Update</button></div>
  </div>
</div>

<!-- CURRENT HERDS -->
<div class="card">
  <table id="herdTable">
    <thead><tr><th>Species</th><th>Class</th><th>Breed</th><th>Count</th><th>Avg Wt</th><th>AE</th><th>DSE</th><th>Location</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- STATION TOTALS -->
<div class="card">
  <div class="row" style="align-items:center">
    <div><strong>Station Totals</strong></div>
    <div style="flex:1 1 auto"></div>
    <div style="display:flex;align-items:center;gap:8px">
      <label class="small"><input type="checkbox" id="totalsAllProps"/> All properties</label>
      <button class="ghost" id="btnRecalcTotals">Recalculate</button>
    </div>
  </div>
  <table id="totalsTable"><thead><tr><th>Species</th><th>Class</th><th>Head</th><th>AE</th></tr></thead><tbody></tbody></table>
  <div class="small" id="totalsSummary"></div>
</div>

<!-- PADDOCK TOTALS -->
<div class="card">
  <div><strong>Paddock Totals (selected property)</strong></div>
  <table id="paddockTotalsTable"><thead><tr><th>Paddock</th><th>Head</th><th>AE</th><th>AE-days</th><th>Area(ha)</th><th>AE/ha/yr</th></tr></thead><tbody></tbody></table>
  <div class="small" id="paddockTotalsSummary"></div>
</div>

<!-- LOG -->
<div class="card"><strong>Log</strong><div id="log" class="log"></div></div>
</div>

<script>
const $=id=>document.getElementById(id);
let app,db,paddockAreas=new Map(),editingId=null;
const YARDS="Yards",AE_KG=400,DSE_PER_AE=8.5;
function log(m){$('log').textContent+=m+"\\n";$('log').scrollTop=$('log').scrollHeight;}
const CATTLE_CLASSES=["PTIC Cow","PTE Cow","Joined Cow","PTIC Heifer","Joined Heifer","Weaner Heifer","Weaner Steer","Store Steer","Bullock","Bull","PTE Heifer","Steer Calf","Heifer Calf"];
const SHEEP_CLASSES=["Ewes","Weaner Lambs","Lambs","Rams","Wether Lambs","Ewe Lambs"];

function populateClassOptions(){
 const sp=$('species').value,sel=$('classSel');
 sel.innerHTML='';(sp==='Sheep'?SHEEP_CLASSES:CATTLE_CLASSES).forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;sel.appendChild(o);});
 const other=document.createElement('option');other.value='Other';other.textContent='Other…';sel.appendChild(other);
 $('classCustomWrap').style.display=sel.value==='Other'?'':'none';
}
$('species').addEventListener('change',populateClassOptions);
$('classSel').addEventListener('change',()=>{$('classCustomWrap').style.display=$('classSel').value==='Other'?'':'none';});
$('avgWeight').addEventListener('input',()=>{const w=parseFloat($('avgWeight').value||'400'),ae=w/AE_KG;$('ae').value=ae.toFixed(2);$('dse').value=(ae*DSE_PER_AE).toFixed(1);});

$('btnConnect').addEventListener('click',async()=>{
 $('status').textContent='';$('statusErr').textContent='';
 try{
   let cfgText=$('cfg_json').value.trim(),cfg;
   if(cfgText){const m=cfgText.match(/\{[\s\S]*\}/);if(m)cfgText=m[0];cfg=Function('return '+cfgText)();}
   else cfg={apiKey:$('cfg_apiKey').value.trim(),authDomain:$('cfg_authDomain').value.trim(),projectId:$('cfg_projectId').value.trim(),appId:$('cfg_appId').value.trim()};
   if(!cfg.apiKey||!cfg.projectId)throw new Error('Provide apiKey and projectId or paste JSON');
   try{firebase.app();firebase.app().delete?.();}catch{}
   const appInst=firebase.initializeApp(cfg);db=firebase.firestore(appInst);
   await firebase.auth().signInAnonymously();
   $('status').textContent=`Connected to ${cfg.projectId}`;log(`Connected ${cfg.projectId}`);
   await loadProperties();
 }catch(e){$('statusErr').textContent=e.message;log('Connect error:'+e.message);}
});

async function loadProperties(){
 const sel=$('propertySelect');sel.innerHTML='';
 const snap=await db.collection('properties').get();
 snap.forEach(d=>{const o=document.createElement('option');o.value=d.id;o.textContent=d.data().name||d.id;sel.appendChild(o);});
 sel.onchange=()=>{loadLocations();loadHerds();};
 await loadLocations();await loadHerds();
}

async function loadLocations(){
 const pid=$('propertySelect').value;const loc=$('location');loc.innerHTML='';paddockAreas.clear();
 const q=await db.collection('paddocks').where('propertyId','==',pid).get();
 q.forEach(d=>{const x=d.data(),n=x.name||d.id,a=parseFloat(x.areaHa||x.hectares||0)||0;paddockAreas.set(n,a);
   const o=document.createElement('option');o.value=n;o.textContent=`${n}${a?` (${a}ha)`:''}`;loc.appendChild(o);});
 const oy=document.createElement('option');oy.value=YARDS;oy.textContent=YARDS;loc.appendChild(oy);
 await computePaddockTotals();
}

$('btnSave').onclick=saveHerd;
async function saveHerd(){
 const pid=$('propertySelect').value;if(!pid)return alert('Select property');
 const sp=$('species').value;let cls=$('classSel').value;if(cls==='Other')cls=$('classCustom').value.trim();
 const br=$('breed').value,c=parseInt($('count').value||0,10),avg=parseFloat($('avgWeight').value||400);
 const ae=parseFloat($('ae').value||avg/AE_KG),dse=parseFloat($('dse').value||ae*DSE_PER_AE),loc=$('location').value,moved=$('movedIn').value||new Date().toISOString().slice(0,10);
 const id=`${pid}__${cls}__${loc}`,data={propertyId:pid,species:sp,class:cls,breed:br,count:c,avgWeightKg:avg,aePerHead:ae,dsePerHead:dse,location:loc,movedIn:moved,lastUpdated:firebase.firestore.FieldValue.serverTimestamp()};
 if(editingId&&editingId!==id){await db.collection('livestock').doc(id).set(data,{merge:true});await db.collection('livestock').doc(editingId).delete();editingId=null;}
 else await db.collection('livestock').doc(id).set(data,{merge:true});
 await loadHerds();
}

function matchArea(loc){for(const [n,a] of paddockAreas.entries()){if(n.toLowerCase().trim()===String(loc).toLowerCase().trim())return a;}return 0;}
function calcAEDays(m,ae,c){if(!m||!ae||!c)return 0;const s=new Date(m);return ae*c*((Date.now()-s.getTime())/86400000);}
function classPriority(cls){const c=cls.toLowerCase();if(c.includes('cow'))return 1;if(c.includes('heifer'))return 2;if(c.includes('weaner'))return 3;if(c.includes('calf'))return 4;if(c.includes('steer'))return 5;if(c.includes('bull'))return 6;return 99;}

async function loadHerds(){
 const pid=$('propertySelect').value;const tb=$('herdTable').querySelector('tbody');tb.innerHTML='';if(!pid)return;
 const q=await db.collection('livestock').where('propertyId','==',pid).get();
 q.forEach(d=>{const x=d.data(),tr=document.createElement('tr');tr.innerHTML=`<td>${x.species}</td><td>${x.class}</td><td>${x.breed||''}</td><td>${x.count}</td><td>${x.avgWeightKg}</td><td>${x.aePerHead.toFixed(2)}</td><td>${x.dsePerHead.toFixed(1)}</td><td>${x.location}</td>`;tb.appendChild(tr);});
 await computeTotals();await computePaddockTotals();
}

$('btnRecalcTotals').onclick=computeTotals;
$('totalsAllProps').onchange=computeTotals;
async function computeTotals(){
 const all=$('totalsAllProps').checked;const tb=$('totalsTable').querySelector('tbody');tb.innerHTML='';
 let q=db.collection('livestock');if(!all){const p=$('propertySelect').value;if(!p)return;q=q.where('propertyId','==',p);}
 const snap=await q.get();const map=new Map();let head=0,aeSum=0;
 snap.forEach(d=>{const x=d.data(),sp=x.species||'Cattle',cl=x.class||'Unspec',h=parseInt(x.count||0,10),ae=(x.aePerHead||0)*h,k=sp+'||'+cl,v=map.get(k)||{species:sp,cls:cl,head:0,ae:0};v.head+=h;v.ae+=ae;map.set(k,v);head+=h;aeSum+=ae;});
 [...map.values()].sort((a,b)=>a.species.localeCompare(b.species)||classPriority(a.cls)-classPriority(b.cls)||a.cls.localeCompare(b.cls))
 .forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.species}</td><td>${r.cls}</td><td>${r.head}</td><td>${r.ae.toFixed(1)}</td>`;tb.appendChild(tr);});
 $('totalsSummary').textContent=`Totals — Head:${head} AE:${aeSum.toFixed(1)} ${all?'(all properties)':'(selected property)'}`;
}

async function computePaddockTotals(){
 const pid=$('propertySelect').value;if(!pid)return;const tb=$('paddockTotalsTable').querySelector('tbody');tb.innerHTML='';
 const snap=await db.collection('livestock').where('propertyId','==',pid).get();
 const map=new Map();let head=0,aeTot=0,aeDTot=0;
 snap.forEach(d=>{const x=d.data(),loc=x.location||'Unknown',h=parseInt(x.count||0,10),aeH=x.aePerHead||0,ae=aeH*h,aeD=calcAEDays(x.movedIn,aeH,h),v=map.get(loc)||{head:0,ae:0,aeDays:0};v.head+=h;v.ae+=ae;v.aeDays+=aeD;map.set(loc,v);head+=h;aeTot+=ae;aeDTot+=aeD;});
 [...map.entries()].forEach(([loc,v])=>{const area=matchArea(loc);const aeHa=area?(v.aeDays/(365*area)).toFixed(2):'';const tr=document.createElement('tr');tr.innerHTML=`<td>${loc}</td><td>${v.head}</td><td>${v.ae.toFixed(1)}</td><td>${v.aeDays.toFixed(1)}</td><td>${area||''}</td><td>${aeHa}</td>`;tb.appendChild(tr);});
 $('paddockTotalsSummary').textContent=`Totals — Head:${head} AE:${aeTot.toFixed(1)} AE-days:${aeDTot.toFixed(1)} (property)`;
}
populateClassOptions();
$('movedIn').value=new Date().toISOString().slice(0,10);
</script>
</body>
</html>