<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>SkyFarm ‚Äî Seed Inventory (Oats & Sorghum)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

<style>
  :root{
    --bg:#f8faf9; --card:#fff; --muted:#6b7280; --text:#111827;
    --brand:#0B7A6E; --border:#e5e7eb; --warn:#9a3412;
  }
  html,body{
    height:100%;margin:0;background:var(--bg);color:var(--text);
    font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial
  }
  /* Top global header */
  #sf-header{position:sticky;top:0;z-index:10;}
  #sf-header .bar{
    display:flex;gap:12px;align-items:center;flex-wrap:wrap;
    padding:10px 14px;border-bottom:1px solid var(--border);background:#fff;
  }
  #sf-header .brand{
    display:flex;align-items:center;gap:8px;
    color:var(--brand);font-weight:700;text-decoration:none;
  }
  #sf-header nav a{
    color:var(--brand);text-decoration:none;font-weight:600;margin-right:10px;
  }
  #sf-header nav a[aria-current="page"]{text-decoration:underline;}
  .spacer{flex:1;}
  .muted{color:var(--muted);font-size:.9rem;}
  .hidden{display:none;}

  .nav-db{position:relative;}
  .nav-db button{font-size:.9rem;}
  .db-menu{
    position:absolute;top:100%;left:0;background:#fff;
    border:1px solid var(--border);border-radius:10px;min-width:160px;
    padding:4px 0;box-shadow:0 10px 25px rgba(15,23,42,.12);z-index:20;
  }
  .db-menu a{
    display:block;padding:6px 12px;color:var(--text);
    text-decoration:none;font-size:.9rem;
  }
  .db-menu a:hover{background:#f1f5f9;}

  .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 14px;border-bottom:1px solid var(--border);background:#fff}
  .topbar h1{font-size:1.1rem;margin:0 10px 0 0}
  .status{margin-left:auto;font-size:.9rem}
  .layout{display:grid;grid-template-columns: 1fr 1.2fr; gap:16px; padding:16px}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .col{display:flex;flex-direction:column;gap:6px}
  label{font-size:.85rem;color:var(--muted)}
  input,select,button,textarea{
    border:1px solid var(--border);border-radius:10px;background:#fff;padding:6px 10px;font:inherit;color:inherit
  }
  textarea{min-height:72px}
  button{cursor:pointer}
  .primary{background:var(--brand);color:#fff;border-color:#0B7A6E}
  .danger{background:#b91c1c;color:#fff;border-color:#7f1d1d}
  .mutedSmall{color:var(--muted);font-size:.85rem;}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px 6px;font-size:.92rem;text-align:left}
  th{background:#fafafa;color:#374151}
  .actions button{margin-right:6px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:.75rem}
  #log{white-space:pre-wrap;font:12px/1.45 ui-monospace,Consolas,Menlo,monospace}

  /* Auth overlay */
  #authOverlay{
    position:fixed;inset:0;background:rgba(15,23,42,.06);
    display:none;align-items:center;justify-content:center;z-index:50;
  }
  #authCard{
    width:min(520px,92vw);background:#fff;border:1px solid var(--border);
    border-radius:16px;padding:20px;
  }
  #authCard h2{margin:0 0 10px;}
</style>
</head>
<body>

<!-- Global SkyFarm header -->
<div id="sf-header">
  <div class="bar">
    <a class="brand" href="skyfarm-diary.html">üå± SkyFarm</a>
    <nav>
  <a href="skyfarm-diary.html">Diary</a>
  <a href="skyfarm-map.html">Map</a>
  <a href="skyfarm-rain.html">Rain</a>
</nav>
    <div class="nav-db">
      <button id="dbMenuBtn" type="button">Database ‚ñæ</button>
      <div id="dbMenu" class="db-menu hidden">
        <a href="skyfarm-livestock.html">Livestock</a>
        <a href="skyfarm-chemical.html">Chemicals</a>
        <a href="skyfarm-seeds.html">Seeds</a>
        <a href="skyfarm-barcode.html">Barcode Scanner</a>
        <a href="skyfarm-users.html">Users &amp; Roles</a>
      </div>
    </div>
    <span class="spacer"></span>
    <span id="authWho" class="muted">Connecting‚Ä¶</span>
    <button id="signOutBtn" class="danger hidden">Sign out</button>
  </div>
</div>

<div class="topbar">
  <h1>SkyFarm ‚Äî Seed Inventory</h1>
  <div class="status">Firebase: <span id="fbStatus" class="muted">Connecting‚Ä¶</span></div>
</div>

<div class="layout">
  <!-- LEFT: Add/Edit form + Quick Use -->
  <div class="card">
    <h3 style="margin:0 0 8px 0;">Add / Edit Seed</h3>

    <div class="row">
      <div class="col">
        <label>Crop</label>
        <select id="cropSel" style="min-width:140px">
          <option value="Oats">Oats</option>
          <option value="Sorghum">Sorghum</option>
        </select>
      </div>
      <div class="col">
        <label>Variety</label>
        <input id="varietyInp" placeholder="e.g. Leichhardt, MR-Buster" />
      </div>
      <div class="col">
        <label>Season</label>
        <select id="seasonSel">
          <option value="Summer">Summer</option>
          <option value="Winter" selected>Winter</option>
          <option value="Dry">Dry</option>
          <option value="Wet">Wet</option>
        </select>
      </div>
      <div class="col">
        <label>Year</label>
        <input id="yearInp" type="number" min="2000" max="2100" style="width:110px" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Unit</label>
        <input id="unitInp" value="KG" disabled style="width:90px" />
      </div>
      <div class="col">
        <label>Quantity (kg)</label>
        <input id="qtyKgInp" type="number" min="0" step="0.01" style="width:140px" />
      </div>
      <div class="col">
        <label>Bag size (kg)</label>
        <input id="bagSizeInp" type="number" min="0" step="0.1" placeholder="optional" style="width:130px" />
      </div>
      <div class="col">
        <label>Bags</label>
        <input id="bagsInp" type="number" min="0" step="1" placeholder="optional" style="width:110px" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Treatment</label>
        <input id="treatInp" placeholder="e.g. Fungicide treated" />
      </div>
      <div class="col">
        <label>Germination %</label>
        <input id="germInp" type="number" min="0" max="100" step="1" placeholder="optional" style="width:130px" />
      </div>
      <div class="col">
        <label>Storage location</label>
        <input id="storeInp" placeholder="e.g. Silo 2, Machinery Shed" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Property</label>
        <select id="propSel" style="min-width:180px"></select>
      </div>
      <div class="col" style="flex:1">
        <label>SDS URL (optional)</label>
        <input id="sdsInp" placeholder="https://‚Ä¶ or gs://‚Ä¶" />
      </div>
    </div>

    <div class="col" style="margin-top:8px">
      <label>Notes</label>
      <textarea id="notesInp" placeholder="Optional notes‚Ä¶"></textarea>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="saveBtn" class="primary">Save</button>
      <button id="cancelBtn" class="hidden">Cancel edit</button>
      <span id="formMsg" class="muted"></span>
    </div>

    <hr style="margin:16px 0;border:none;border-top:1px solid #eee" />

    <h3 style="margin:0 0 8px 0;">Use Seed</h3>
    <div class="mutedSmall" style="margin-bottom:8px">Pick a seed row on the right, then record usage here.</div>

    <div class="row">
      <div class="col">
        <label>Date</label>
        <input id="useDate" type="date" />
      </div>
      <div class="col">
        <label>Use (kg) ‚Äî direct</label>
        <input id="useKg" type="number" min="0" step="0.01" placeholder="e.g. 1500" style="width:140px" />
      </div>
      <div class="col">
        <label>OR Area (ha)</label>
        <input id="useHa" type="number" min="0" step="0.01" placeholder="e.g. 120" style="width:120px" />
      </div>
      <div class="col">
        <label>Rate (kg/ha)</label>
        <input id="useRate" type="number" min="0" step="0.01" placeholder="e.g. 12" style="width:120px" />
      </div>
    </div>

    <!-- Property + Paddock for usage -->
    <div class="row" style="margin-top:8px">
      <div class="col">
        <label>Property (usage)</label>
        <select id="usePropSel" style="min-width:180px"></select>
      </div>
      <div class="col">
        <label>Paddock (usage)</label>
        <select id="usePaddSel" style="min-width:220px">
          <option value="">‚Äî select property first ‚Äî</option>
        </select>
      </div>
      <div class="col" style="flex:1">
        <label>Notes</label>
        <input id="useNotes" placeholder="Paddock/block, drill setting, operator‚Ä¶" />
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="useBtn" class="primary">Record Usage &amp; Deduct</button>
      <span id="useMsg" class="muted"></span>
    </div>
  </div>

  <!-- RIGHT: List & filters -->
  <div class="card">
    <div class="row" style="align-items:flex-end;margin-bottom:8px">
      <div class="col">
        <label>Filter: Property</label>
        <select id="fltProp"><option value="">All</option></select>
      </div>
      <div class="col">
        <label>Search</label>
        <input id="fltText" placeholder="variety / storage / notes‚Ä¶" />
      </div>
      <button id="refreshBtn" style="height:36px">Refresh</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Crop</th>
          <th>Variety</th>
          <th>Season/Year</th>
          <th>Qty (kg)</th>
          <th>Bags</th>
          <th>Property</th>
          <th>Storage</th>
          <th>Treatment</th>
          <th>Germ%</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="seedBody">
        <tr><td colspan="10" class="muted">No records.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div class="card" style="margin:0 16px 16px 16px">
  <strong>Log</strong>
  <div id="log" class="muted"></div>
</div>

<!-- Auth overlay -->
<div id="authOverlay">
  <div id="authCard">
    <h2>Sign in to SkyFarm</h2>
    <p class="mutedSmall">Email &amp; password only. Anonymous sign-in is disabled.</p>
    <div class="row">
      <div class="col" style="flex:1; min-width:260px">
        <label>Email</label>
        <input id="siEmail" type="email" placeholder="you@example.com" autocomplete="username" />
      </div>
      <div class="col" style="flex:1; min-width:220px">
        <label>Password</label>
        <input id="siPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="signInBtn" class="primary">Sign in</button>
      <span id="authMsg" class="muted"></span>
      <span class="spacer"></span>
      <button id="closeOverlayBtn" class="btn" type="button">Close</button>
    </div>
  </div>
</div>

<script>
/* ---------- Firebase init + auth ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  appId: "1:494858780013:web:d87497b370c82eeab06e64",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* Header DB menu */
const dbMenuBtn = document.getElementById('dbMenuBtn');
const dbMenu = document.getElementById('dbMenu');
if (dbMenuBtn && dbMenu){
  dbMenuBtn.onclick = (e)=>{ e.stopPropagation(); dbMenu.classList.toggle('hidden'); };
  document.addEventListener('click', (e)=>{
    if (!dbMenu.contains(e.target) && e.target !== dbMenuBtn) dbMenu.classList.add('hidden');
  });
}

/* Auth overlay helpers */
const authOverlay = document.getElementById('authOverlay');
const authWho = document.getElementById('authWho');
const signOutBtn = document.getElementById('signOutBtn');
const signInBtn = document.getElementById('signInBtn');
const closeOverlayBtn = document.getElementById('closeOverlayBtn');
const fbStatusEl = document.getElementById('fbStatus');

function showOverlay(show){ authOverlay.style.display = show ? 'flex' : 'none'; }

/* Sign-in button */
signInBtn.onclick = async ()=>{
  const email = document.getElementById('siEmail').value.trim();
  const pass  = document.getElementById('siPass').value;
  document.getElementById('authMsg').textContent = 'Signing in‚Ä¶';
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithEmailAndPassword(email, pass);
    document.getElementById('authMsg').textContent = 'Signed in.';
    showOverlay(false);
  }catch(e){
    document.getElementById('authMsg').textContent = 'Sign-in failed: ' + (e?.message || e?.code || 'Unknown');
  }
};
closeOverlayBtn.onclick = ()=> showOverlay(false);
signOutBtn.onclick = async ()=>{ try{ await auth.signOut(); location.reload(); }catch(e){} };

let bootstrapped = false;
function startBootstrap(){
  if (!bootstrapped){ bootstrapped = true; bootstrapSeeds(); }
}

/* Auth state */
auth.onAuthStateChanged(async (u)=>{
  if (u){
    authWho.textContent = u.email ? `Signed in as ${u.email}` : 'Signed in';
    signOutBtn.classList.remove('hidden');
    fbStatusEl.textContent = 'Connected';
    showOverlay(false);
    try{ await db.enablePersistence({synchronizeTabs:true}); }catch(e){}
    startBootstrap();
  } else {
    authWho.textContent = 'Not signed in';
    signOutBtn.classList.add('hidden');
    fbStatusEl.textContent = 'Not signed in';
    showOverlay(true);
    const seedBody = document.getElementById('seedBody');
    if (seedBody) seedBody.innerHTML = '<tr><td colspan="10" class="muted">Sign in to see seeds.</td></tr>';
  }
});

/* ---------- Main seed logic (adapted from old file) ---------- */
function bootstrapSeeds(){
  (function(){
    const byId = id => document.getElementById(id);
    const log = (m)=>{ const el=byId('log'); el.textContent += (m+'\\n'); el.scrollTop = el.scrollHeight; };
    const todayISO = ()=> new Date().toISOString().slice(0,10);
    const esc = s => String(s??'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));

    // form
    const cropSel = byId('cropSel');
    const varietyInp = byId('varietyInp');
    const seasonSel = byId('seasonSel');
    const yearInp = byId('yearInp');
    const qtyKgInp = byId('qtyKgInp');
    const bagSizeInp = byId('bagSizeInp');
    const bagsInp = byId('bagsInp');
    const treatInp = byId('treatInp');
    const germInp = byId('germInp');
    const storeInp = byId('storeInp');
    const propSel = byId('propSel');
    const sdsInp = byId('sdsInp');
    const notesInp = byId('notesInp');
    const saveBtn = byId('saveBtn');
    const cancelBtn = byId('cancelBtn');
    const formMsg = byId('formMsg');

    // usage
    const useDate = byId('useDate');
    const useKg = byId('useKg');
    const useHa = byId('useHa');
    const useRate = byId('useRate');
    const useNotes = byId('useNotes');
    const useBtn = byId('useBtn');
    const useMsg = byId('useMsg');

    const usePropSel = byId('usePropSel');
    const usePaddSel = byId('usePaddSel');

    const seedBody = byId('seedBody');
    const fltProp = byId('fltProp');
    const fltText = byId('fltText');
    const refreshBtn = byId('refreshBtn');

    let props = [];
    let propNameById = new Map();
    let paddocksByProp = new Map();
    let editingId = null;
    let currentRow = null;

    async function bootstrap(){
      yearInp.value = new Date().getFullYear();
      useDate.value = todayISO();

      await loadProperties();
      await loadPaddocksAll();
      await refreshList();

      saveBtn.addEventListener('click', onSave);
      cancelBtn.addEventListener('click', resetForm);
      refreshBtn.addEventListener('click', refreshList);
      useBtn.addEventListener('click', onUseSeed);

      usePropSel.addEventListener('change', async ()=>{
        await populateUsePaddocks(usePropSel.value);
      });
    }

    async function loadProperties(){
      const snap = await db.collection('properties').get();
      props = []; propNameById.clear();
      snap.forEach(doc=>{
        const d = doc.data()||{};
        props.push({id:doc.id, name:d.name||'(unnamed)'});
        propNameById.set(doc.id, d.name||'(unnamed)');
      });
      propSel.innerHTML = props.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
      fltProp.innerHTML = '<option value="">All</option>' + props.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
      usePropSel.innerHTML = props.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
      if (props[0]) await populateUsePaddocks(props[0].id);
      log('Loaded properties: '+props.length);
    }

    async function loadPaddocksAll(){
      paddocksByProp.clear();
      const snap = await db.collection('paddocks').get();
      snap.forEach(doc=>{
        const d=doc.data()||{};
        const pid = d.propertyId || '';
        if(!paddocksByProp.has(pid)) paddocksByProp.set(pid, []);
        if(d.name) paddocksByProp.get(pid).push(d.name);
      });
      paddocksByProp.forEach((list, k)=> paddocksByProp.set(k, list.sort((a,b)=>a.localeCompare(b))));
      log('Paddocks indexed for all properties');
    }

    async function populateUsePaddocks(propId){
      const list = paddocksByProp.get(propId)||[];
      usePaddSel.innerHTML = list.length
        ? list.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('')
        : `<option value="">(no paddocks in DB)</option>`;
    }

    async function onSave(){
      try{
        const payload = {
          crop: cropSel.value,
          variety: (varietyInp.value||'').trim(),
          season: seasonSel.value,
          year: parseInt(yearInp.value||0,10) || null,
          unit: 'KG',
          quantityKg: parseFloat(qtyKgInp.value||0) || 0,
          bagSizeKg: parseFloat(bagSizeInp.value||0) || null,
          bags: parseInt(bagsInp.value||0,10) || null,
          treatment: (treatInp.value||'').trim() || null,
          germination: (germInp.value? parseInt(germInp.value,10) : null),
          storageLocation: (storeInp.value||'').trim() || null,
          propertyId: propSel.value || null,
          propertyName: propNameById.get(propSel.value)||null,
          sdsUrl: (sdsInp.value||'').trim() || null,
          notes: (notesInp.value||'').trim() || null,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (!payload.variety) return alert('Variety is required.');
        if (!(payload.quantityKg >= 0)) return alert('Quantity (kg) must be >= 0');

        if (!editingId){
          payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('seeds').add(payload);
          formMsg.textContent = 'Saved.';
        } else {
          await db.collection('seeds').doc(editingId).update(payload);
          formMsg.textContent = 'Updated.';
        }
        await refreshList();
        resetForm(true);
      }catch(e){
        alert('Save failed: '+e.message);
      }
    }

    function resetForm(clearMsg){
      editingId = null;
      currentRow = null;
      saveBtn.textContent = 'Save';
      cancelBtn.classList.add('hidden');
      if (clearMsg) formMsg.textContent = '';
      varietyInp.value=''; qtyKgInp.value=''; bagSizeInp.value=''; bagsInp.value='';
      treatInp.value=''; germInp.value=''; storeInp.value=''; sdsInp.value=''; notesInp.value='';
      seedBody.querySelectorAll('tr').forEach(r=> r.style.outline='none');
    }

    function renderRow(id, d){
      const bagsTxt = (d.bagSizeKg && d.bags) ? `${d.bags} √ó ${d.bagSizeKg}kg` : '';
      return `
        <tr data-id="${id}">
          <td>${esc(d.crop||'')}</td>
          <td>${esc(d.variety||'')}</td>
          <td>${esc(d.season||'')}/${esc(d.year||'')}</td>
          <td>${(d.quantityKg??0).toLocaleString(undefined,{maximumFractionDigits:2})}</td>
          <td>${esc(bagsTxt)}</td>
          <td>${esc(d.propertyName||'')}</td>
          <td>${esc(d.storageLocation||'')}</td>
          <td>${esc(d.treatment||'')}</td>
          <td>${d.germination??''}</td>
          <td class="actions">
            <button data-act="pick">‚úÖ Use</button>
            <button data-act="edit">‚úèÔ∏è Edit</button>
            <button data-act="del" class="danger">üóë Delete</button>
          </td>
        </tr>`;
    }

    async function refreshList(){
      const pid = fltProp.value || '';
      const qtxt = (fltText.value||'').toLowerCase();

      const snap = await db.collection('seeds').orderBy('updatedAt','desc').limit(500).get();
      const rows=[];
      snap.forEach(doc=>{
        const d=doc.data()||{};
        if (pid && d.propertyId!==pid) return;
        const hay = [d.variety,d.storageLocation,d.notes].map(x=>(x||'').toLowerCase()).join(' ');
        if (qtxt && !hay.includes(qtxt)) return;
        rows.push(renderRow(doc.id, d));
      });
      seedBody.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="10" class="muted">No records.</td></tr>`;

      if (rows.length){
        seedBody.querySelectorAll('button[data-act]').forEach(btn=>{
          const tr = btn.closest('tr'); const id = tr?.dataset?.id;
          btn.addEventListener('click', ()=>{
            const act = btn.getAttribute('data-act');
            if (act==='edit') loadForEdit(id);
            if (act==='del')  delRow(id);
            if (act==='pick') pickForUse(id, tr);
          });
        });
      }
    }

    async function loadForEdit(id){
      const doc = await db.collection('seeds').doc(id).get();
      if (!doc.exists) return;
      const d = doc.data()||{};
      editingId = id;
      cropSel.value = d.crop || 'Oats';
      varietyInp.value = d.variety || '';
      seasonSel.value = d.season || 'Winter';
      yearInp.value = d.year || new Date().getFullYear();
      qtyKgInp.value = d.quantityKg ?? '';
      bagSizeInp.value = d.bagSizeKg ?? '';
      bagsInp.value = d.bags ?? '';
      treatInp.value = d.treatment || '';
      germInp.value = d.germination ?? '';
      storeInp.value = d.storageLocation || '';
      sdsInp.value = d.sdsUrl || '';
      notesInp.value = d.notes || '';
      propSel.value = d.propertyId || (props[0]?.id||'');
      saveBtn.textContent = 'Update';
      cancelBtn.classList.remove('hidden');
    }

    async function delRow(id){
      if (!confirm('Delete this seed record?')) return;
      await db.collection('seeds').doc(id).delete();
      await refreshList();
      if (editingId===id) resetForm(true);
    }

    function pickForUse(id, tr){
      currentRow = id;
      seedBody.querySelectorAll('tr').forEach(r=> r.style.outline='none');
      if (tr) tr.style.outline = '2px solid #0B7A6E';
      db.collection('seeds').doc(id).get().then(doc=>{
        const d=doc.data()||{};
        const pid = d.propertyId || props[0]?.id || '';
        usePropSel.value = pid;
        populateUsePaddocks(pid);
      });
    }

    async function onUseSeed(){
      try{
        useMsg.textContent = '';
        if (!currentRow) return alert('Click ‚úÖ Use on a seed row first.');
        const dateISO = byId('useDate').value || todayISO();

        let usedKg = parseFloat(useKg.value||0) || 0;
        const area = parseFloat(useHa.value||0) || 0;
        const rate = parseFloat(useRate.value||0) || 0;
        if (area>0 && rate>0) usedKg = area * rate;
        if (!(usedKg>0)) return alert('Enter a usage amount: either direct KG, or Area √ó Rate.');

        const propId = usePropSel.value || '';
        const paddock = usePaddSel.value || '';
        const notes = (useNotes.value||'').trim();
        const propName = propNameById.get(propId)||null;

        await db.runTransaction(async (tx)=>{
          const ref = db.collection('seeds').doc(currentRow);
          const snap = await tx.get(ref);
          if (!snap.exists) throw new Error('Seed record not found.');
          const d = snap.data()||{};
          const cur = parseFloat(d.quantityKg||0);
          const next = cur - usedKg;
          if (next < -0.0001) throw new Error(`Not enough stock (${cur} kg available).`);
          tx.update(ref,{ quantityKg: next, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        });

        await db.collection('seedUsage').add({
          seedId: currentRow,
          dateISO,
          usedKg,
          areaHa: (area>0? area : null),
          rateKgPerHa: (rate>0? rate : null),
          notes,
          propertyId: propId || null,
          propertyName: propName || null,
          paddock: paddock || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        useMsg.textContent = `Recorded ${usedKg.toFixed(2)} kg${paddock?` in ${paddock}`:''}.`;
        log(`Usage recorded: ${usedKg.toFixed(2)} kg ${propName?`@ ${propName}`:''} ${paddock?`/ ${paddock}`:''}`);
        byId('useKg').value = ''; byId('useHa').value = ''; byId('useRate').value = ''; byId('useNotes').value='';
        await refreshList();
      }catch(e){
        alert('Usage failed: ' + e.message);
        useMsg.textContent = 'Error';
      }
    }

    // hook filters
    fltText.addEventListener('input', refreshList);
    fltProp.addEventListener('change', refreshList);

    bootstrap().catch(e=>{ log('Bootstrap failed: '+e.message); });
  })();
}
</script>
</body>
</html>
