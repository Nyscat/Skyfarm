<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>SkyFarm — Seed Inventory (Oats & Sorghum)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

<style>
  :root{ --bg:#f8faf9; --card:#fff; --muted:#6b7280; --text:#111827; --brand:#0B7A6E; --border:#e5e7eb; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 14px;border-bottom:1px solid var(--border);background:#fff}
  .topbar h1{font-size:1.1rem;margin:0 10px 0 0}
  .status{margin-left:auto;font-size:.9rem}
  .layout{display:grid;grid-template-columns: 1fr 1.2fr; gap:16px; padding:16px}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .col{display:flex;flex-direction:column;gap:6px}
  label{font-size:.85rem;color:var(--muted)}
  input,select,button,textarea{
    border:1px solid var(--border);border-radius:10px;background:#fff;padding:6px 10px;font:inherit;color:inherit
  }
  textarea{min-height:72px}
  button{cursor:pointer}
  .primary{background:var(--brand);color:#fff;border-color:#0B7A6E}
  .danger{background:#b91c1c;color:#fff;border-color:#7f1d1d}
  .muted{color:var(--muted)}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px 6px;font-size:.92rem;text-align:left}
  th{background:#fafafa;color:#374151}
  .actions button{margin-right:6px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:.75rem}
  #log{white-space:pre-wrap;font:12px/1.45 ui-monospace,Consolas,Menlo,monospace}
</style>

<link rel="stylesheet" href="skyfarm-shared.css">
</head>
<body>
<div id="sf-header-root"></div>
<script src="skyfarm-header.js"></script>
<script>SkyFarmHeader.mount();</script>

<!-- SkyFarm mini header/nav -->

<script>
  (function(){
    // Link handler
    function pageUrl(slug){
      const base = location.origin;
      if (slug === 'diary') return `${base}/skyfarm-diary.html`;
      if (slug === 'map')   return `${base}/skyfarm-map.html`;
      if (slug === 'chem')  return `${base}/skyfarm-chemical.html`;
      if (slug === 'admin') return `${base}/skyfarm-admin-users.html`;
      return base + '/';
    }
    document.querySelectorAll('#skyfarm-header [data-nav]').forEach(a=>{
      a.onclick = (e)=>{ e.preventDefault(); location.href = pageUrl(a.getAttribute('data-nav')); };
    });

    // Optional: show simple auth state if Firebase is present on the page
    try {
      if (window.firebase?.auth) {
        const el = document.getElementById('sf-auth');
        firebase.auth().onAuthStateChanged(u=>{
          el.textContent = u ? (u.isAnonymous ? 'Connected (guest)' : `Signed in`) : 'Connecting…';
        });
      }
    } catch(e){}
  })();
</script>
<div class="topbar">
  <h1>SkyFarm — Seed Inventory</h1>
  <div class="status">Firebase: <span id="fbStatus" class="muted">Connecting…</span></div>
</div>

<div class="layout">
  <!-- LEFT: Add/Edit form + Quick Use -->
  <div class="card">
    <h3 style="margin:0 0 8px 0;">Add / Edit Seed</h3>

    <div class="row">
      <div class="col">
        <label>Crop</label>
        <select id="cropSel" style="min-width:140px">
          <option value="Oats">Oats</option>
          <option value="Sorghum">Sorghum</option>
        </select>
      </div>
      <div class="col">
        <label>Variety</label>
        <input id="varietyInp" placeholder="e.g. Leichhardt, MR-Buster" />
      </div>
      <div class="col">
        <label>Season</label>
        <select id="seasonSel">
          <option value="Summer">Summer</option>
          <option value="Winter" selected>Winter</option>
          <option value="Dry">Dry</option>
          <option value="Wet">Wet</option>
        </select>
      </div>
      <div class="col">
        <label>Year</label>
        <input id="yearInp" type="number" min="2000" max="2100" style="width:110px" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Unit</label>
        <input id="unitInp" value="KG" disabled style="width:90px" />
      </div>
      <div class="col">
        <label>Quantity (kg)</label>
        <input id="qtyKgInp" type="number" min="0" step="0.01" style="width:140px" />
      </div>
      <div class="col">
        <label>Bag size (kg)</label>
        <input id="bagSizeInp" type="number" min="0" step="0.1" placeholder="optional" style="width:130px" />
      </div>
      <div class="col">
        <label>Bags</label>
        <input id="bagsInp" type="number" min="0" step="1" placeholder="optional" style="width:110px" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Treatment</label>
        <input id="treatInp" placeholder="e.g. Fungicide treated" />
      </div>
      <div class="col">
        <label>Germination %</label>
        <input id="germInp" type="number" min="0" max="100" step="1" placeholder="optional" style="width:130px" />
      </div>
      <div class="col">
        <label>Storage location</label>
        <input id="storeInp" placeholder="e.g. Silo 2, Machinery Shed" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Property</label>
        <select id="propSel" style="min-width:180px"></select>
      </div>
      <div class="col" style="flex:1">
        <label>SDS URL (optional)</label>
        <input id="sdsInp" placeholder="https://… or gs://…" />
      </div>
    </div>

    <div class="col" style="margin-top:8px">
      <label>Notes</label>
      <textarea id="notesInp" placeholder="Optional notes…"></textarea>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="saveBtn" class="primary">Save</button>
      <button id="cancelBtn" class="hidden">Cancel edit</button>
      <span id="formMsg" class="muted"></span>
    </div>

    <hr style="margin:16px 0;border:none;border-top:1px solid #eee" />

    <h3 style="margin:0 0 8px 0;">Use Seed</h3>
    <div class="muted" style="margin-bottom:8px">Pick a seed row on the right, then record usage here.</div>

    <div class="row">
      <div class="col">
        <label>Date</label>
        <input id="useDate" type="date" />
      </div>
      <div class="col">
        <label>Use (kg) — direct</label>
        <input id="useKg" type="number" min="0" step="0.01" placeholder="e.g. 1500" style="width:140px" />
      </div>
      <div class="col">
        <label>OR Area (ha)</label>
        <input id="useHa" type="number" min="0" step="0.01" placeholder="e.g. 120" style="width:120px" />
      </div>
      <div class="col">
        <label>Rate (kg/ha)</label>
        <input id="useRate" type="number" min="0" step="0.01" placeholder="e.g. 12" style="width:120px" />
      </div>
    </div>

    <!-- NEW: Property + Paddock for usage -->
    <div class="row" style="margin-top:8px">
      <div class="col">
        <label>Property (usage)</label>
        <select id="usePropSel" style="min-width:180px"></select>
      </div>
      <div class="col">
        <label>Paddock (usage)</label>
        <select id="usePaddSel" style="min-width:220px">
          <option value="">— select property first —</option>
        </select>
      </div>
      <div class="col" style="flex:1">
        <label>Notes</label>
        <input id="useNotes" placeholder="Paddock/block, drill setting, operator…" />
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="useBtn" class="primary">Record Usage & Deduct</button>
      <span id="useMsg" class="muted"></span>
    </div>
  </div>

  <!-- RIGHT: List & filters -->
  <div class="card">
    <div class="row" style="align-items:flex-end;margin-bottom:8px">
      <div class="col">
        <label>Filter: Property</label>
        <select id="fltProp"><option value="">All</option></select>
      </div>
      <div class="col">
        <label>Search</label>
        <input id="fltText" placeholder="variety / storage / notes…" />
      </div>
      <button id="refreshBtn" style="height:36px">Refresh</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Crop</th>
          <th>Variety</th>
          <th>Season/Year</th>
          <th>Qty (kg)</th>
          <th>Bags</th>
          <th>Property</th>
          <th>Storage</th>
          <th>Treatment</th>
          <th>Germ%</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="seedBody">
        <tr><td colspan="10" class="muted">No records.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div class="card" style="margin:0 16px 16px 16px">
  <strong>Log</strong>
  <div id="log" class="muted"></div>
</div>

<script>
(function(){
  /* ========== Firebase init ========== */
  const cfg = {
    apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
    authDomain: "consentes-pastoral.firebaseapp.com",
    projectId: "consentes-pastoral",
    appId: "1:494858780013:web:d87497b370c82eeab06e64",
  };
  let db;
  firebase.initializeApp(cfg);
  firebase.auth().signInAnonymously()
    .then(()=>{ db = firebase.firestore(); byId('fbStatus').textContent = 'Connected'; bootstrap(); })
    .catch(e=>{ byId('fbStatus').textContent='Connect failed'; log('Firebase error: '+e.message); });

  /* ========== Helpers ========== */
  const byId = id => document.getElementById(id);
  const log = (m)=>{ const el=byId('log'); el.textContent += (m+'\\n'); el.scrollTop = el.scrollHeight; };
  const todayISO = ()=> new Date().toISOString().slice(0,10);
  const esc = s => String(s??'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
  function show(el, yes){ el.classList[yes?'remove':'add']('hidden'); }

  /* ========== DOM refs ========== */
  // form
  const cropSel = byId('cropSel');
  const varietyInp = byId('varietyInp');
  const seasonSel = byId('seasonSel');
  const yearInp = byId('yearInp');
  const qtyKgInp = byId('qtyKgInp');
  const bagSizeInp = byId('bagSizeInp');
  const bagsInp = byId('bagsInp');
  const treatInp = byId('treatInp');
  const germInp = byId('germInp');
  const storeInp = byId('storeInp');
  const propSel = byId('propSel');
  const sdsInp = byId('sdsInp');
  const notesInp = byId('notesInp');
  const saveBtn = byId('saveBtn');
  const cancelBtn = byId('cancelBtn');
  const formMsg = byId('formMsg');

  // usage
  const useDate = byId('useDate');
  const useKg = byId('useKg');
  const useHa = byId('useHa');
  const useRate = byId('useRate');
  const useNotes = byId('useNotes');
  const useBtn = byId('useBtn');
  const useMsg = byId('useMsg');

  // NEW usage property/paddock
  const usePropSel = byId('usePropSel');
  const usePaddSel = byId('usePaddSel');

  // list
  const seedBody = byId('seedBody');
  const fltProp = byId('fltProp');
  const fltText = byId('fltText');
  const refreshBtn = byId('refreshBtn');

  let props = [];         // [{id,name}]
  let propNameById = new Map();
  let paddocksByProp = new Map(); // propId -> [paddock names]
  let editingId = null;   // seed doc id under edit
  let currentRow = null;  // currently selected seed row for "Use Seed"

  /* ========== Bootstrap ========== */
  async function bootstrap(){
    yearInp.value = new Date().getFullYear();
    useDate.value = todayISO();

    await loadProperties();
    await loadPaddocksAll();
    await refreshList();

    saveBtn.addEventListener('click', onSave);
    cancelBtn.addEventListener('click', resetForm);
    refreshBtn.addEventListener('click', refreshList);
    useBtn.addEventListener('click', onUseSeed);

    // usage property change -> refresh paddocks
    usePropSel.addEventListener('change', async ()=>{
      await populateUsePaddocks(usePropSel.value);
    });
  }

  async function loadProperties(){
    const snap = await db.collection('properties').get();
    props = []; propNameById.clear();
    snap.forEach(doc=>{
      const d = doc.data()||{};
      props.push({id:doc.id, name:d.name||'(unnamed)'});
      propNameById.set(doc.id, d.name||'(unnamed)');
    });
    // For create/edit
    propSel.innerHTML = props.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
    // For filter
    fltProp.innerHTML = '<option value="">All</option>' + props.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
    // For usage
    usePropSel.innerHTML = props.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
    // default usage paddocks
    if (props[0]) await populateUsePaddocks(props[0].id);
    log('Loaded properties: '+props.length);
  }

  async function loadPaddocksAll(){
    paddocksByProp.clear();
    const snap = await db.collection('paddocks').get();
    snap.forEach(doc=>{
      const d=doc.data()||{};
      const pid = d.propertyId || '';
      if(!paddocksByProp.has(pid)) paddocksByProp.set(pid, []);
      if(d.name) paddocksByProp.get(pid).push(d.name);
    });
    // sort names
    paddocksByProp.forEach((list, k)=> paddocksByProp.set(k, list.sort((a,b)=>a.localeCompare(b))));
    log('Paddocks indexed for all properties');
  }

  async function populateUsePaddocks(propId){
    const list = paddocksByProp.get(propId)||[];
    usePaddSel.innerHTML = list.length
      ? list.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('')
      : `<option value="">(no paddocks in DB)</option>`;
  }

  /* ========== CRUD ========== */
  async function onSave(){
    try{
      const payload = {
        crop: cropSel.value,
        variety: (varietyInp.value||'').trim(),
        season: seasonSel.value,
        year: parseInt(yearInp.value||0,10) || null,
        unit: 'KG',
        quantityKg: parseFloat(qtyKgInp.value||0) || 0,
        bagSizeKg: parseFloat(bagSizeInp.value||0) || null,
        bags: parseInt(bagsInp.value||0,10) || null,
        treatment: (treatInp.value||'').trim() || null,
        germination: (germInp.value? parseInt(germInp.value,10) : null),
        storageLocation: (storeInp.value||'').trim() || null,
        propertyId: propSel.value || null,
        propertyName: propNameById.get(propSel.value)||null,
        sdsUrl: (sdsInp.value||'').trim() || null,
        notes: (notesInp.value||'').trim() || null,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      if (!payload.variety) return alert('Variety is required.');
      if (!(payload.quantityKg >= 0)) return alert('Quantity (kg) must be >= 0');

      if (!editingId){
        payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        await db.collection('seeds').add(payload);
        formMsg.textContent = 'Saved.';
      } else {
        await db.collection('seeds').doc(editingId).update(payload);
        formMsg.textContent = 'Updated.';
      }
      await refreshList();
      resetForm(true);
    }catch(e){
      alert('Save failed: '+e.message);
    }
  }

  function resetForm(clearMsg){
    editingId = null;
    currentRow = null;
    saveBtn.textContent = 'Save';
    cancelBtn.classList.add('hidden');
    if (clearMsg) formMsg.textContent = '';
    varietyInp.value=''; qtyKgInp.value=''; bagSizeInp.value=''; bagsInp.value='';
    treatInp.value=''; germInp.value=''; storeInp.value=''; sdsInp.value=''; notesInp.value='';
  }

  function renderRow(id, d){
    const bagsTxt = (d.bagSizeKg && d.bags) ? `${d.bags} × ${d.bagSizeKg}kg` : '';
    return `
      <tr data-id="${id}">
        <td>${esc(d.crop||'')}</td>
        <td>${esc(d.variety||'')}</td>
        <td>${esc(d.season||'')}/${esc(d.year||'')}</td>
        <td>${(d.quantityKg??0).toLocaleString(undefined,{maximumFractionDigits:2})}</td>
        <td>${esc(bagsTxt)}</td>
        <td>${esc(d.propertyName||'')}</td>
        <td>${esc(d.storageLocation||'')}</td>
        <td>${esc(d.treatment||'')}</td>
        <td>${d.germination??''}</td>
        <td class="actions">
          <button data-act="pick">✅ Use</button>
          <button data-act="edit">✏️ Edit</button>
          <button data-act="del" class="danger">🗑 Delete</button>
        </td>
      </tr>`;
  }

  async function refreshList(){
    const pid = fltProp.value || '';
    const qtxt = (fltText.value||'').toLowerCase();

    let q = db.collection('seeds').orderBy('updatedAt','desc').limit(500);
    const snap = await q.get();
    const rows=[];
    snap.forEach(doc=>{
      const d=doc.data()||{};
      if (pid && d.propertyId!==pid) return;
      const hay = [d.variety,d.storageLocation,d.notes].map(x=>(x||'').toLowerCase()).join(' ');
      if (qtxt && !hay.includes(qtxt)) return;
      rows.push(renderRow(doc.id, d));
    });
    seedBody.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="10" class="muted">No records.</td></tr>`;

    if (rows.length){
      seedBody.querySelectorAll('button[data-act]').forEach(btn=>{
        const tr = btn.closest('tr'); const id = tr?.dataset?.id;
        btn.addEventListener('click', ()=>{
          const act = btn.getAttribute('data-act');
          if (act==='edit') loadForEdit(id);
          if (act==='del')  delRow(id);
          if (act==='pick') pickForUse(id, tr);
        });
      });
    }
  }

  async function loadForEdit(id){
    const doc = await db.collection('seeds').doc(id).get();
    if (!doc.exists) return;
    const d = doc.data()||{};
    editingId = id;
    cropSel.value = d.crop || 'Oats';
    varietyInp.value = d.variety || '';
    seasonSel.value = d.season || 'Winter';
    yearInp.value = d.year || new Date().getFullYear();
    qtyKgInp.value = d.quantityKg ?? '';
    bagSizeInp.value = d.bagSizeKg ?? '';
    bagsInp.value = d.bags ?? '';
    treatInp.value = d.treatment || '';
    germInp.value = d.germination ?? '';
    storeInp.value = d.storageLocation || '';
    sdsInp.value = d.sdsUrl || '';
    notesInp.value = d.notes || '';
    propSel.value = d.propertyId || (props[0]?.id||'');
    saveBtn.textContent = 'Update';
    cancelBtn.classList.remove('hidden');
  }

  async function delRow(id){
    if (!confirm('Delete this seed record?')) return;
    await db.collection('seeds').doc(id).delete();
    await refreshList();
    if (editingId===id) resetForm(true);
  }

  function pickForUse(id, tr){
    currentRow = id;
    // Visual feedback
    seedBody.querySelectorAll('tr').forEach(r=> r.style.outline='none');
    if (tr) tr.style.outline = '2px solid #0B7A6E';
    // Best-effort: set usage property to the seed's property (if any)
    db.collection('seeds').doc(id).get().then(doc=>{
      const d=doc.data()||{};
      const pid = d.propertyId || props[0]?.id || '';
      usePropSel.value = pid;
      populateUsePaddocks(pid);
    });
  }

  /* ========== Usage & deduction (with property + paddock) ========== */
  async function onUseSeed(){
    try{
      useMsg.textContent = '';
      if (!currentRow) return alert('Click ✅ Use on a seed row first.');
      const dateISO = byId('useDate').value || todayISO();

      // compute usedKg
      let usedKg = parseFloat(useKg.value||0) || 0;
      const area = parseFloat(useHa.value||0) || 0;
      const rate = parseFloat(useRate.value||0) || 0;
      if (area>0 && rate>0) usedKg = area * rate;
      if (!(usedKg>0)) return alert('Enter a usage amount: either direct KG, or Area × Rate.');

      // property + paddock
      const propId = usePropSel.value || '';
      const paddock = usePaddSel.value || '';
      const notes = (useNotes.value||'').trim();
      const propName = propNameById.get(propId)||null;

      await db.runTransaction(async (tx)=>{
        const ref = db.collection('seeds').doc(currentRow);
        const snap = await tx.get(ref);
        if (!snap.exists) throw new Error('Seed record not found.');
        const d = snap.data()||{};
        const cur = parseFloat(d.quantityKg||0);
        const next = cur - usedKg;
        if (next < -0.0001) throw new Error(`Not enough stock (${cur} kg available).`);
        tx.update(ref,{ quantityKg: next, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      });

      // log usage
      await db.collection('seedUsage').add({
        seedId: currentRow,
        dateISO,
        usedKg,
        areaHa: (area>0? area : null),
        rateKgPerHa: (rate>0? rate : null),
        notes,
        propertyId: propId || null,
        propertyName: propName || null,
        paddock: paddock || null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      useMsg.textContent = `Recorded ${usedKg.toFixed(2)} kg${paddock?` in ${paddock}`:''}.`;
      log(`Usage recorded: ${usedKg.toFixed(2)} kg ${propName?`@ ${propName}`:''} ${paddock?`/ ${paddock}`:''}`);
      byId('useKg').value = ''; byId('useHa').value = ''; byId('useRate').value = ''; byId('useNotes').value='';
      await refreshList();
    }catch(e){
      alert('Usage failed: ' + e.message);
      useMsg.textContent = 'Error';
    }
  }

})();
</script>

</body>
</html>