<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SkyFarm â€” Livestock</title>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>

<style>
  :root { --brand:#0B7A6E; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#f6fbf8; --warn:#9a3412; }
  * { box-sizing:border-box; }
  body { font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); margin:0; color:var(--ink); }
  .wrap { max-width:1200px; margin:0 auto; padding:16px; }
  h1 { margin:12px 0; font-size:1.6rem; }

  /* Header */
  #sf-header { position:sticky; top:0; z-index:10; }
  #sf-header .bar { display:flex; align-items:center; gap:12px; padding:10px 14px; background:#fff; border-bottom:1px solid var(--line); }
  #sf-header .brand { display:flex; align-items:center; gap:8px; color:var(--brand); font-weight:700; text-decoration:none; }
  #sf-header nav a { color:var(--brand); text-decoration:none; font-weight:600; margin-right:10px; }
  #sf-header nav a[aria-current="page"] { text-decoration:underline; }
  .spacer { flex:1; }
  .muted { color:var(--muted); font-size:.9rem; }
  .hidden { display:none; }

  .nav-db { position:relative; }
  .nav-db button { font-size:.9rem; }
  .db-menu {
    position:absolute;
    top:100%;
    left:0;
    background:#fff;
    border:1px solid var(--line);
    border-radius:10px;
    min-width:160px;
    padding:4px 0;
    box-shadow:0 10px 25px rgba(15,23,42,.12);
    z-index:20;
  }
  .db-menu a {
    display:block;
    padding:6px 12px;
    color:var(--ink);
    text-decoration:none;
    font-size:.9rem;
  }
  .db-menu a:hover { background:#f1f5f9; }

  /* Cards etc */
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:12px 0; }
  .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  label { font-size:.9rem; color:#475569; }
  input, select, button { padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
  input[disabled], select[disabled] { background:#f8fafc; color:#64748b; }
  button { cursor:pointer; }
  .btn { border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
  .primary { background:var(--brand); color:#fff; border-color:var(--brand); }
  .danger { background:#ef4444; color:#fff; border-color:#ef4444; }
  .pill { display:inline-block; padding:2px 10px; border-radius:999px; background:#eef2f7; font-size:.85rem; margin:4px 6px 0 0; border:1px solid #e5e7eb; }
  .right { text-align:right; }
  .small { font-size:.9rem; color:#475569; }
  .w110 { width:110px; } .w140 { width:160px; } .w180 { width:180px; } .w220 { width:220px; }
  .nowrap { white-space:nowrap; }

  table { width:100%; border-collapse:collapse; }
  th, td { border-bottom:1px solid #e5e7eb; padding:8px; text-align:left; }
  th { background:#f1f5f9; }

  .sum-head { font-weight:600; margin:8px 0 4px; }

  .status-warn{ color:var(--warn); }

  /* Auth overlay */
  #authOverlay{position:fixed; inset:0; background:rgba(15,23,42,.06); display:none; align-items:center; justify-content:center; z-index:50;}
  #authCard{width:min(520px,92vw); background:#fff; border:1px solid var(--line); border-radius:16px; padding:20px}
  #authCard h2{margin:0 0 10px}
</style>
</head>
<body>

<div id="sf-header">
  <div class="bar">
    <a class="brand" href="skyfarm-diary.html">ðŸŒ± SkyFarm</a>
    <nav>
      <a href="skyfarm-diary.html">Diary</a>
      <a href="skyfarm-map.html">Map</a>
    </nav>
    <div class="nav-db">
      <button id="dbMenuBtn" class="btn small" type="button">Database â–¾</button>
      <div id="dbMenu" class="db-menu hidden">
        <a href="skyfarm-livestock.html">Livestock</a>
        <a href="skyfarm-chemical.html">Chemicals</a>
        <a href="skyfarm-seeds.html">Seeds</a>
        <a href="skyfarm-barcode.html">Barcode Scanner</a>
        <a href="skyfarm-users.html">Users &amp; Roles</a>
      </div>
    </div>
    <span class="spacer"></span>
    <span id="authWho" class="muted">Connectingâ€¦</span>
    <button id="signOutBtn" class="danger hidden">Sign out</button>
  </div>
</div>

<div class="wrap">
  <h1>Livestock</h1>

  <!-- ADD NEW -->
  <div class="card" id="addCard">
    <div class="row">
      <div>
        <label>Property</label><br/>
        <select id="newPropSel" class="w180">
          <option value="s7PlDM9wrEpxuJ6DGIab">Consentes</option>
          <option value="TRuxtRBx2zJlwZnRGYKJ">Mt Myrtle</option>
          <option value="P0dQ0H2FWHeqqxejflZs">Gerawin</option>
        </select>
      </div>

      <div>
        <label>Paddock</label><br/>
        <input id="newLocation" class="w180" placeholder="e.g. Gravel Paddock" />
      </div>

      <div>
        <label>Species</label><br/>
        <select id="newSpecies" class="w140">
          <option value="Cattle">Cattle</option>
          <option value="Sheep">Sheep</option>
          <option value="Goats">Goats</option>
        </select>
      </div>

      <div style="min-width:320px;flex:1;">
        <label>Class of stock</label>
        <div id="classPills" style="display:flex;flex-wrap:wrap;margin-top:4px;"></div>
        <input type="hidden" id="newClass" />
      </div>

      <div>
        <label>Count</label><br/>
        <input id="newCount" class="w110" type="number" min="0" />
      </div>

      <div style="align-self:flex-end;">
        <button id="addRowBtn" class="btn primary">Add Livestock</button>
      </div>
      <span id="addMsg" class="muted"></span>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="card">
    <div class="row" style="gap:12px">
      <div>
        <label class="small">View</label><br/>
        <select id="propSel" class="w220">
          <option value="all">All Properties (Summary)</option>
          <option value="s7PlDM9wrEpxuJ6DGIab">Consentes</option>
          <option value="TRuxtRBx2zJlwZnRGYKJ">Mt Myrtle</option>
          <option value="P0dQ0H2FWHeqqxejflZs">Gerawin</option>
        </select>
      </div>
      <div id="searchWrap">
        <label class="small">Search</label><br/>
        <input id="search" class="w220" placeholder="paddock / species / class" />
      </div>
      <button id="refreshBtn" class="btn">Refresh</button>
      <button id="exportBtn" class="btn">Export CSV</button>
      <span class="pill" id="countPill">0 rows</span>
      <span class="pill" id="totalPill">Total: 0</span>
      <span class="muted" id="status" style="margin-left:auto">Loadingâ€¦</span>
    </div>
  </div>

  <!-- TABLE + SUMMARY -->
  <div class="card" id="tableCard">

    <!-- summary is used for ALL properties and single property -->
    <div id="summaryWrap" style="margin-bottom:12px; display:none;">
      <div class="sum-head" id="summaryHeading">Totals</div>
      <table>
        <thead>
          <tr>
            <th>Species</th>
            <th>Class</th>
            <th class="right">Total head</th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </div>

    <table id="rowsTable">
      <thead>
        <tr>
          <th>Paddock</th>
          <th>Species</th>
          <th>Class</th>
          <th class="right">Count</th>
          <th>Updated</th>
          <th class="nowrap">Actions</th>
        </tr>
      </thead>
      <tbody id="rowsTbody"><tr><td colspan="6">Loadingâ€¦</td></tr></tbody>
    </table>
  </div>
</div>

<!-- Auth overlay -->
<div id="authOverlay">
  <div id="authCard">
    <h2>Sign in to SkyFarm</h2>
    <p class="small muted">Email &amp; password only. Anonymous sign-in is disabled.</p>
    <div class="row">
      <div style="flex:1; min-width:260px">
        <label>Email</label>
        <input id="siEmail" type="email" placeholder="you@example.com" autocomplete="username"/>
      </div>
      <div style="flex:1; min-width:220px">
        <label>Password</label>
        <input id="siPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
      </div>
    </div>
    <div class="row">
      <button id="signInBtn" class="primary">Sign in</button>
      <span id="authMsg" class="muted"></span>
      <span class="spacer"></span>
      <button id="closeOverlayBtn" class="btn" type="button">Close</button>
    </div>
  </div>
</div>

<script>
/*** Firebase ***/
const firebaseConfig = {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/*** Helpers ***/
const $ = s => document.querySelector(s);
const escapeHtml = s=>String(s??'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
const statusEl=$('#status'), countPill=$('#countPill'), totalPill=$('#totalPill');
const setStatus = (t, warn=false)=>{ statusEl.textContent=t; statusEl.classList.toggle('status-warn', !!warn); };
function showOverlay(show){ $('#authOverlay').style.display = show ? 'flex' : 'none'; }

/*** Header DB menu ***/
const dbMenuBtn = $('#dbMenuBtn'), dbMenu = $('#dbMenu');
if (dbMenuBtn && dbMenu) {
  dbMenuBtn.onclick = (e)=>{ e.stopPropagation(); dbMenu.classList.toggle('hidden'); };
  document.addEventListener('click', (e)=>{
    if (!dbMenu.contains(e.target) && e.target !== dbMenuBtn) dbMenu.classList.add('hidden');
  });
}

/*** Class sets & order ***/
const CLASSES_BY_SPECIES = {
  "Cattle": [
    "PTE Cow","PTIC Cow","Joined Cow",
    "PTE Heifer","PTIC Heifer","Joined Heifer",
    "Weaner Heifer","Female Calf","Male Calf",
    "Weaner Steer","Store Steer","Bullock","Bull",
    "Missing"
  ],
  "Sheep": [
    "Cull Ewes","Ewes","Weaner Ewes","Weaner Weathers","Mixed Sex Lambs","Rams","Missing"
  ],
};
function classIndex(species){
  const arr = CLASSES_BY_SPECIES[species] || [];
  return Object.fromEntries(arr.map((c,i)=>[c,i]));
}
function compareByClass(a,b){
  const ia = classIndex(a.species)[a.class] ?? 9999;
  const ib = classIndex(b.species)[b.class] ?? 9999;
  if (a.species !== b.species) return a.species.localeCompare(b.species);
  if (ia !== ib) return ia - ib;
  return String(a.location||'').localeCompare(String(b.location||''));
}

/*** DOM refs ***/
const propSel=$('#propSel'), searchInp=$('#search'), searchWrap=$('#searchWrap');
const refreshBtn=$('#refreshBtn'), exportBtn=$('#exportBtn');
const rowsTbody=$('#rowsTbody'), summaryWrap=$('#summaryWrap'), summaryBody=$('#summaryBody'), summaryHeading=$('#summaryHeading');
const rowsTable=$('#rowsTable');
const newPropSel=$('#newPropSel'), newLocation=$('#newLocation'), newSpecies=$('#newSpecies'),
      newClassHidden=$('#newClass'), newCount=$('#newCount'), addRowBtn=$('#addRowBtn'), addMsg=$('#addMsg'), classPillsWrap=$('#classPills');

const authWho = $('#authWho'), signOutBtn = $('#signOutBtn');
const signInBtn = $('#signInBtn'), closeOverlayBtn = $('#closeOverlayBtn');

let allRows=[];

/*** Add-form pills ***/
function renderClassPills(species){
  classPillsWrap.innerHTML = '';
  const set = CLASSES_BY_SPECIES[species];
  if (!set) {
    newClassHidden.value='';
    classPillsWrap.innerHTML='<span class="muted">Free text for Goats (set after adding).</span>';
    return;
  }
  set.forEach(cls=>{
    const b=document.createElement('button');
    b.type='button'; b.className='btn pill'; b.textContent=cls;
    b.onclick=()=>{
      newClassHidden.value=cls;
      classPillsWrap.querySelectorAll('.pill').forEach(x=>{x.style.background='';x.style.color='';x.style.borderColor='#e5e7eb';});
      b.style.background='#0B7A6E'; b.style.color='#fff'; b.style.borderColor='#0B7A6E';
    };
    classPillsWrap.appendChild(b);
  });
  classPillsWrap.querySelector('.pill')?.click();
}
newSpecies.onchange = ()=> renderClassPills(newSpecies.value);
renderClassPills(newSpecies.value);

/*** Auth overlay actions ***/
signInBtn.onclick = async ()=>{
  const email = $('#siEmail').value.trim();
  const pass  = $('#siPass').value;
  $('#authMsg').textContent = 'Signing inâ€¦';
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithEmailAndPassword(email, pass);
    $('#authMsg').textContent = 'Signed in.';
    showOverlay(false);
  }catch(e){
    $('#authMsg').textContent = 'Sign-in failed: ' + (e?.message || e?.code || 'Unknown');
  }
};
signOutBtn.onclick = async ()=>{ try{ await auth.signOut(); location.reload(); }catch(e){} };
closeOverlayBtn.onclick = ()=> showOverlay(false);

/*** Events not depending on auth ***/
propSel.onchange = loadRows;
searchInp.oninput = renderTable;
refreshBtn.onclick = loadRows;
exportBtn.onclick = exportCsv;
addRowBtn.onclick = addLivestock;

/*** Auth state ***/
setStatus('Connectingâ€¦');
auth.onAuthStateChanged(async (u)=>{
  if (u) {
    authWho.textContent = u.email ? `Signed in as ${u.email}` : 'Signed in';
    signOutBtn.classList.remove('hidden');
    showOverlay(false);
    setStatus('Loadingâ€¦');
    try{ await db.enablePersistence({synchronizeTabs:true}); }catch(e){}
    await loadRows();
    setStatus('Loaded');
  } else {
    authWho.textContent = 'Not signed in';
    signOutBtn.classList.add('hidden');
    showOverlay(true);
    setStatus('Please sign in', true);
    rowsTbody.innerHTML = '<tr><td colspan="6">Sign in to see livestock.</td></tr>';
  }
});

/*** Add livestock ***/
async function addLivestock(){
  const pid=newPropSel.value, location=newLocation.value.trim(), species=newSpecies.value,
        klass=newClassHidden.value.trim(), count=Number(newCount.value||0);
  if(!location) return alert('Please enter paddock.');
  if(CLASSES_BY_SPECIES[species] && !klass) return alert('Please choose a class.');
  if(count<0||!Number.isFinite(count)) return alert('Enter a valid count.');
  addRowBtn.disabled=true; addMsg.textContent='Savingâ€¦';
  try{
    await db.collection('livestock').add({
      propertyId:pid, location, species, class:klass || '(Unspecified)', count,
      updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    addMsg.textContent='Added!'; newLocation.value=''; newCount.value='';
    await loadRows();
  }catch(e){ console.error(e); addMsg.textContent='Failed to add'; }
  finally{ addRowBtn.disabled=false; setTimeout(()=>addMsg.textContent='',2500); }
}

/*** Load rows or summary ***/
async function loadRows(){
  if (!auth.currentUser) return;
  setStatus('Loadingâ€¦');
  rowsTbody.innerHTML='<tr><td colspan="6">Loadingâ€¦</td></tr>';
  summaryBody.innerHTML='';
  allRows=[];
  const mode = propSel.value;
  const summaryMode = (mode === 'all');

  document.getElementById('addCard').style.display = summaryMode ? 'none' : '';
  rowsTable.style.display = summaryMode ? 'none' : '';
  summaryWrap.style.display = '';                      // always show some totals when we have data
  searchWrap.style.display = summaryMode ? 'none' : '';

  try{
    let snap;
    if (summaryMode) {
      snap = await db.collection('livestock').get();
      summaryHeading.textContent = 'Totals across all properties';
    } else {
      snap = await db.collection('livestock').where('propertyId','==',mode).get();
      const name = propSel.selectedOptions[0]?.textContent || 'Property';
      summaryHeading.textContent = `Totals for ${name}`;
    }
    snap.forEach(d=>{
      const r=d.data();
      allRows.push({id:d.id,...r,updatedAt:r.updatedAt?.toDate?.()});
    });

    renderSummary(allRows);

    if (!summaryMode) {
      allRows.sort(compareByClass);
      renderTable();
    } else {
      rowsTbody.innerHTML = '<tr><td colspan="6">Select a specific property for paddock detail.</td></tr>';
    }

    setStatus('Loaded');
  }catch(e){ console.error(e); setStatus('Error loading', true); }
}

/*** SUMMARY RENDERER ***/
function renderSummary(rows){
  if (!rows.length) {
    summaryBody.innerHTML = '<tr><td colspan="3">No data.</td></tr>';
    countPill.textContent = '0 rows';
    totalPill.textContent = 'Total: 0';
    return;
  }

  const totals = {};
  for (const r of rows) {
    const species = r.species || '(Unknown)';
    const cls = r.class || '(Unspecified)';
    totals[species] = totals[species] || {};
    totals[species][cls] = (totals[species][cls] || 0) + Number(r.count || 0);
  }

  summaryBody.innerHTML = '';
  const speciesList = Object.keys(totals).sort();
  let grand = 0;

  for (const sp of speciesList) {
    const order = CLASSES_BY_SPECIES[sp] || Object.keys(totals[sp]).sort();
    for (const cls of order) {
      if (!(cls in totals[sp])) continue;
      const sum = totals[sp][cls];
      grand += sum;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(sp)}</td>
        <td>${escapeHtml(cls)}</td>
        <td class="right">${sum}</td>`;
      summaryBody.appendChild(tr);
    }
    for (const cls of Object.keys(totals[sp])) {
      if ((CLASSES_BY_SPECIES[sp]||[]).includes(cls)) continue;
      const sum = totals[sp][cls];
      grand += sum;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(sp)}</td>
        <td>${escapeHtml(cls)} (custom)</td>
        <td class="right">${sum}</td>`;
      summaryBody.appendChild(tr);
    }
  }

  countPill.textContent = `${rows.length} lines`;
  totalPill.textContent = `Total head: ${grand}`;
}

/*** TABLE (per property) ***/
function filtered(){
  const q=(searchInp.value||'').toLowerCase();
  if(!q) return allRows;
  return allRows.filter(r=>`${r.location} ${r.species} ${r.class}`.toLowerCase().includes(q));
}
function renderTable(){
  const rows = filtered();
  countPill.textContent = `${rows.length} lines`;
  const totalHead = rows.reduce((a,b)=>a+Number(b.count||0),0);
  totalPill.textContent = `Total head: ${totalHead}`;

  if (!rows.length) { rowsTbody.innerHTML = '<tr><td colspan="6">No rows</td></tr>'; return; }
  rowsTbody.innerHTML='';

  for (const r of rows) {
    const tr=document.createElement('tr');
    const updatedStr = r.updatedAt ? r.updatedAt.toLocaleString() : '';
    tr.innerHTML = `
      <td><input class="loc" value="${escapeHtml(r.location||'')}" disabled /></td>
      <td>
        <select class="spec w140" disabled>
          <option ${r.species==='Cattle'?'selected':''}>Cattle</option>
          <option ${r.species==='Sheep'?'selected':''}>Sheep</option>
          <option ${r.species==='Goats'?'selected':''}>Goats</option>
        </select>
      </td>
      <td class="clsCell"></td>
      <td class="right"><input type="number" class="cnt w110" value="${Number(r.count||0)}" disabled /></td>
      <td class="small">${updatedStr}</td>
      <td>
        <button class="btn" data-edit>Edit</button>
        <button class="btn primary" data-save style="display:none">Save</button>
        <button class="btn" data-cancel style="display:none">Cancel</button>
        <button class="btn danger" data-del>Delete</button>
      </td>`;

    const clsCell = tr.querySelector('.clsCell');
    const buildClassEditor = (species, val, disabled) => {
      clsCell.innerHTML='';
      const set = CLASSES_BY_SPECIES[species];
      if (set) {
        const sel = document.createElement('select');
        sel.className = 'w180 cls';
        sel.disabled = !!disabled;
        set.forEach(c=>{
          const opt=document.createElement('option');
          opt.textContent=c; opt.value=c; if (c===val) opt.selected=true;
          sel.appendChild(opt);
        });
        if (val && !set.includes(val)) {
          const opt=document.createElement('option');
          opt.textContent=val + ' (custom)'; opt.value=val; opt.selected=true;
          sel.appendChild(opt);
        }
        clsCell.appendChild(sel);
      } else {
        const inp = document.createElement('input');
        inp.className='w180 cls'; inp.value = val || ''; inp.disabled = !!disabled;
        clsCell.appendChild(inp);
      }
    };
    buildClassEditor(r.species, r.class, true);

    const locEl=tr.querySelector('.loc'), specEl=tr.querySelector('.spec'), clsEl=()=>tr.querySelector('.cls'), cntEl=tr.querySelector('.cnt');
    const btnEdit=tr.querySelector('[data-edit]'), btnSave=tr.querySelector('[data-save]'), btnCancel=tr.querySelector('[data-cancel]'), btnDel=tr.querySelector('[data-del]');

    function setEditable(on){
      locEl.disabled = !on; specEl.disabled = !on; cntEl.disabled = !on;
      buildClassEditor(specEl.value, clsEl().value, !on);
      btnEdit.style.display = on ? 'none' : '';
      btnSave.style.display = on ? '' : 'none';
      btnCancel.style.display = on ? '' : 'none';
    }
    specEl.addEventListener('change', ()=> { if (!specEl.disabled) buildClassEditor(specEl.value, clsEl().value, specEl.disabled); });

    btnEdit.onclick = ()=> setEditable(true);
    btnCancel.onclick = ()=> loadRows();
    btnSave.onclick = async ()=>{
      const spec=specEl.value;
      const cls = (clsEl().tagName==='SELECT') ? clsEl().value : clsEl().value.trim();
      const cnt=Number(cntEl.value||0);
      await db.collection('livestock').doc(r.id).set({
        location:locEl.value.trim(), species:spec, class:cls, count:cnt,
        updatedAt:firebase.firestore.FieldValue.serverTimestamp()
      },{merge:true});
      await loadRows();
    };
    btnDel.onclick = async()=>{ if(confirm('Delete this row?')){ await db.collection('livestock').doc(r.id).delete(); await loadRows(); } };

    rowsTbody.appendChild(tr);
  }
}

/*** Export CSV (keeps DocID only in file, not visible) ***/
function exportCsv(){
  const mode = propSel.value;
  if (mode === 'all') {
    alert('Export is for per-property view. Select a property to export paddock rows.');
    return;
  }
  const rows = filtered();
  const propName=propSel.selectedOptions[0]?.textContent||'';
  const head='Property,Paddock,Species,Class,Count,DocID';
  const lines=rows.map(r=>[propName,r.location,r.species,r.class,r.count,r.id].map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(','));
  const blob=new Blob([head+'\n'+lines.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`livestock_${propName}.csv`;a.click();
}
</script>
</body>
</html>
