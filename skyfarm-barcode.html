<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>SkyFarm — Barcode Scanner (Chemicals & Seeds)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<link rel="stylesheet" href="skyfarm-shared.css">

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

<!-- ZXing fallback (only used if BarcodeDetector not present) -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

<style>
  :root{
    --bg:#f8faf9; --card:#fff; --muted:#6b7280; --text:#111827;
    --brand:#0B7A6E; --border:#e5e7eb; --danger:#b91c1c;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 14px;border-bottom:1px solid var(--border);background:#fff}
  .topbar h1{font-size:1.1rem;margin:0 10px 0 0}
  .status{margin-left:auto;font-size:.9rem}
  .layout{display:grid;grid-template-columns: 1.1fr 1fr; gap:16px; padding:16px; max-width:1200px; margin:0 auto;}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .col{display:flex;flex-direction:column;gap:6px}
  label{font-size:.85rem;color:var(--muted)}
  input,select,button,textarea{
    border:1px solid var(--border);border-radius:10px;background:#fff;padding:6px 10px;font:inherit;color:inherit
  }
  button{cursor:pointer}
  .primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .danger{background:var(--danger);color:#fff;border-color:#7f1d1d}
  .muted{color:var(--muted)}
  .hidden{display:none}
  video{width:100%;border-radius:12px;border:1px solid var(--border);background:#000}
  .result{font:14px/1.4 ui-monospace,Consolas,Menlo,monospace;background:#f3f4f6;border:1px dashed #cbd5e1;border-radius:10px;padding:8px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px 6px;font-size:.92rem;text-align:left}
  th{background:#fafafa;color:#374151}

  @media (max-width: 900px){
    .layout{grid-template-columns: 1fr; padding:12px;}
  }

  /* Auth overlay */
  #authOverlay{
    position:fixed; inset:0;
    background:rgba(15,23,42,.10);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2000;
  }
  #authCard{
    width:min(520px,92vw);
    background:#fff;
    border:1px solid var(--border);
    border-radius:16px;
    padding:18px;
    box-shadow:0 18px 45px rgba(15,23,42,.22);
  }
  #authCard h2{margin:0 0 8px;}
</style>
</head>

<body>
  <!-- Shared header mount -->
  <div id="sf-header-root"></div>

  <div class="topbar">
    <h1>SkyFarm — Barcode Scanner</h1>
    <div class="status">
      <span id="who" class="muted">Connecting…</span>
      <button id="signOutBtn" class="danger hidden" type="button" style="margin-left:10px;">Sign out</button>
    </div>
  </div>

  <div class="layout" id="app" style="display:none;">
    <!-- LEFT: Scanner -->
    <div class="card">
      <h3 style="margin:0 0 8px 0;">Scan</h3>
      <div class="row">
        <div class="col">
          <label>Mode</label>
          <select id="modeSel">
            <option value="chemicals">Chemicals</option>
            <option value="seeds">Seeds</option>
          </select>
        </div>
        <div class="col">
          <label>Camera</label>
          <select id="camSel"></select>
        </div>
        <button id="startBtn" class="primary" type="button">Start</button>
        <button id="stopBtn" type="button">Stop</button>
      </div>

      <video id="video" playsinline muted></video>

      <div class="row" style="margin-top:8px">
        <div class="col" style="flex:1">
          <label>Manual barcode (fallback/testing)</label>
          <input id="manualCode" placeholder="Type or paste barcode then Search" />
        </div>
        <button id="manualBtn" type="button">Search</button>
      </div>

      <div style="margin-top:10px">
        <div class="result" id="scanOut">Awaiting scan…</div>
      </div>
    </div>

    <!-- RIGHT: Result + actions -->
    <div class="card">
      <h3 style="margin:0 0 8px 0;">Item</h3>
      <div id="itemBox" class="muted">No item yet.</div>

      <div id="openBox" class="hidden" style="margin-top:10px">
        <button id="openBtn" class="primary" type="button">Open full record</button>
      </div>

      <div id="linkBox" class="hidden" style="margin-top:10px">
        <h4 style="margin:0 0 6px 0;">No item found — link barcode</h4>
        <div class="row">
          <div class="col" style="flex:1">
            <label>Link to existing</label>
            <select id="existingSel"><option value="">Loading…</option></select>
          </div>
          <button id="linkBtn" class="primary" type="button">Link</button>
        </div>

        <div class="muted" style="margin:6px 0">Or create a new minimal record:</div>

        <div id="createChem" class="row hidden">
          <input id="chemName" placeholder="Chemical name" />
          <input id="chemUnit" placeholder="KG or L" style="width:100px" />
          <select id="chemUseOn">
            <option value="paddock">paddock</option>
            <option value="stock">stock</option>
          </select>
          <input id="chemQty" type="number" step="0.01" placeholder="Start qty" style="width:130px" />
          <select id="chemProp"></select>
          <button id="createChemBtn" type="button">Create chemical</button>
        </div>

        <div id="createSeed" class="row hidden">
          <select id="seedCrop">
            <option>Oats</option>
            <option>Sorghum</option>
          </select>
          <input id="seedVariety" placeholder="Variety" />
          <input id="seedQty" type="number" step="0.01" placeholder="Start kg" style="width:130px" />
          <select id="seedProp"></select>
          <button id="createSeedBtn" type="button">Create seed</button>
        </div>
      </div>

      <div id="adjBox" class="hidden" style="margin-top:10px">
        <h4 style="margin:0 0 6px 0;">Adjust quantity</h4>
        <div id="chemAdj" class="row hidden">
          <input id="chemDelta" type="number" step="0.01" placeholder="e.g. -5 or 10" />
          <button id="chemApply" class="primary" type="button">Apply to chemical</button>
        </div>
        <div id="seedAdj" class="row hidden">
          <input id="seedDelta" type="number" step="0.01" placeholder="e.g. -250 or 100" />
          <button id="seedApply" class="primary" type="button">Apply to seed (kg)</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Log</strong>
        <div id="log" class="muted" style="white-space:pre-wrap"></div>
      </div>
    </div>
  </div>

  <!-- Auth overlay -->
  <div id="authOverlay">
    <div id="authCard">
      <h2>Sign in to SkyFarm</h2>
      <p class="muted" style="font-size:.9rem;margin:0 0 10px;">Email &amp; password only.</p>

      <div class="row" style="margin-bottom:8px;">
        <div style="flex:1;min-width:240px">
          <label>Email</label>
          <input id="siEmail" type="email" autocomplete="username" placeholder="you@example.com">
        </div>
        <div style="flex:1;min-width:200px">
          <label>Password</label>
          <input id="siPass" type="password" autocomplete="current-password" placeholder="••••••••">
        </div>
      </div>

      <div class="row">
        <button id="signInBtn" class="primary" type="button">Sign in</button>
        <span id="authMsg" class="muted" style="font-size:.9rem;"></span>
        <span style="flex:1;"></span>
        <button id="closeOverlayBtn" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- Shared header script -->
  <script src="skyfarm-header.js"></script>

<script>
(function(){
  /* ===== Firebase ===== */
  const cfg = {
    apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
    authDomain: "consentes-pastoral.firebaseapp.com",
    projectId: "consentes-pastoral",
    appId: "1:494858780013:web:d87497b370c82eeab06e64",
  };

  firebase.initializeApp(cfg);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // Mount shared header AFTER firebase exists
  try { if (window.SkyFarmHeader?.mount) SkyFarmHeader.mount(); } catch(e){}

  /* ===== Helpers ===== */
  const byId = id => document.getElementById(id);
  const esc = s => String(s??'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
  const log = (m)=>{ const el=byId('log'); el.textContent += (m+'\n'); el.scrollTop = el.scrollHeight; };
  const show = (el, yes)=> el.classList[yes ? 'remove' : 'add']('hidden');
  const showOverlay = (yes)=>{ byId('authOverlay').style.display = yes ? 'flex' : 'none'; };

  /* ===== DOM ===== */
  const app = byId('app');
  const who = byId('who');
  const signOutBtn = byId('signOutBtn');

  const modeSel = byId('modeSel');
  const camSel = byId('camSel');
  const startBtn = byId('startBtn');
  const stopBtn = byId('stopBtn');
  const video = byId('video');
  const manualCode = byId('manualCode');
  const manualBtn = byId('manualBtn');
  const scanOut = byId('scanOut');

  const itemBox = byId('itemBox');

  const openBox = byId('openBox');
  const openBtn = byId('openBtn');

  const linkBox = byId('linkBox');
  const existingSel = byId('existingSel');
  const linkBtn = byId('linkBtn');

  const createChem = byId('createChem');
  const chemName = byId('chemName');
  const chemUnit = byId('chemUnit');
  const chemUseOn = byId('chemUseOn');
  const chemQty = byId('chemQty');
  const chemProp = byId('chemProp');
  const createChemBtn = byId('createChemBtn');

  const createSeed = byId('createSeed');
  const seedCrop = byId('seedCrop');
  const seedVariety = byId('seedVariety');
  const seedQty = byId('seedQty');
  const seedProp = byId('seedProp');
  const createSeedBtn = byId('createSeedBtn');

  const adjBox = byId('adjBox');
  const chemAdj = byId('chemAdj'); const chemDelta = byId('chemDelta'); const chemApply = byId('chemApply');
  const seedAdj = byId('seedAdj'); const seedDelta = byId('seedDelta'); const seedApply = byId('seedApply');

  // Auth overlay controls
  const siEmail = byId('siEmail');
  const siPass = byId('siPass');
  const signInBtn = byId('signInBtn');
  const authMsg = byId('authMsg');
  const closeOverlayBtn = byId('closeOverlayBtn');

  /* ===== State ===== */
  let props = []; let propNameById = new Map();
  let currentBarcode = null;
  let currentDoc = null; // {collection, id, data}
  let stream = null;
  let zxingReader = null;
  let useBarcodeDetector = ('BarcodeDetector' in window);

  /* ===== Auth events ===== */
  signInBtn.onclick = async ()=>{
    const email = (siEmail.value || '').trim();
    const pass  = (siPass.value || '');
    if (!email || !pass){
      authMsg.textContent = 'Enter email + password.';
      return;
    }
    authMsg.textContent = 'Signing in…';
    try{
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      await auth.signInWithEmailAndPassword(email, pass);
      authMsg.textContent = 'Signed in.';
      showOverlay(false);
    }catch(e){
      authMsg.textContent = 'Sign-in failed: ' + (e?.message || e?.code || 'Unknown');
    }
  };
  closeOverlayBtn.onclick = ()=> showOverlay(false);
  signOutBtn.onclick = async ()=>{
    try{
      await stopScan();
      await auth.signOut();
      location.reload();
    }catch(e){}
  };

  auth.onAuthStateChanged(async (u)=>{
    if (u){
      who.textContent = u.email ? `Signed in as ${u.email}` : 'Signed in';
      show(signOutBtn, true);
      showOverlay(false);
      app.style.display = '';
      try{ await db.enablePersistence({synchronizeTabs:true}); }catch(e){}
      await init();
    }else{
      who.textContent = 'Not signed in';
      show(signOutBtn, false);
      app.style.display = 'none';
      showOverlay(true);
    }
  });

  /* ===== Init ===== */
  async function init(){
    await loadProperties();
    await listCameras();
    wire();
    log('Ready.');
  }

  async function loadProperties(){
    const snap = await db.collection('properties').get();
    props = []; propNameById.clear();
    snap.forEach(doc=>{
      const d=doc.data()||{};
      props.push({id:doc.id, name:d.name||'(unnamed)'});
      propNameById.set(doc.id, d.name||'(unnamed)');
    });
    props.sort((a,b)=>String(a.name).localeCompare(String(b.name)));
    chemProp.innerHTML = props.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
    seedProp.innerHTML = chemProp.innerHTML;
    log('Loaded properties.');
  }

  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const vids = devices.filter(d=> d.kind==='videoinput');
      camSel.innerHTML = vids.map((d,i)=>`<option value="${d.deviceId}">${esc(d.label || ('Camera '+(i+1)))}</option>`).join('');
    }catch(e){
      camSel.innerHTML = '<option value="">Default camera</option>';
    }
  }

  function wire(){
    startBtn.addEventListener('click', startScan);
    stopBtn.addEventListener('click', stopScan);
    manualBtn.addEventListener('click', ()=> handleCode(manualCode.value.trim()));
    linkBtn.addEventListener('click', linkExisting);
    createChemBtn.addEventListener('click', createChemical);
    createSeedBtn.addEventListener('click', createSeedRow);
    chemApply.addEventListener('click', adjustChemical);
    seedApply.addEventListener('click', adjustSeed);
    modeSel.addEventListener('change', ()=>{
      // clear UI for new mode
      currentDoc = null;
      currentBarcode = null;
      itemBox.textContent = 'No item yet.';
      show(openBox, false);
      show(linkBox, false);
      show(adjBox, false);
    });

    openBtn.addEventListener('click', ()=>{
      if (!currentDoc) return;
      const base = location.origin;
      if (currentDoc.collection === 'chemicals'){
        location.href = `${base}/skyfarm-chemical.html?id=${currentDoc.id}`;
      } else {
        location.href = `${base}/skyfarm-seeds.html?id=${currentDoc.id}`;
      }
    });
  }

  /* ===== Camera + scanning ===== */
  async function startScan(){
    try{
      await stopScan();
      const constraints = {
        video: {
          deviceId: camSel.value ? {exact: camSel.value} : undefined,
          facingMode: 'environment'
        },
        audio:false
      };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
      scanOut.textContent = 'Scanning…';
      if (useBarcodeDetector){
        loopScanNative();
      } else {
        zxingReader = new ZXing.BrowserMultiFormatReader();
        loopScanZXing();
      }
    }catch(e){
      alert('Camera error: ' + (e?.message || e));
      log('Camera error: ' + (e?.message || e));
    }
  }

  async function stopScan(){
    if (stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    if (zxingReader){
      try{ await zxingReader.reset(); }catch(_){}
      zxingReader = null;
    }
    scanOut.textContent = 'Stopped.';
  }

  async function loopScanNative(){
    if (!stream) return;
    try{
      const det = new BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e','code_128','code_39','itf','qr_code'] });
      const frame = async ()=>{
        if (!stream) return;
        try{
          const codes = await det.detect(video);
          if (codes && codes.length){
            const val = codes[0]?.rawValue;
            if (val) await handleCode(String(val));
          }
        }catch(_){}
        requestAnimationFrame(frame);
      };
      frame();
    }catch(e){
      log('Native detector failed, falling back to ZXing. ' + (e?.message || e));
      useBarcodeDetector = false;
      zxingReader = new ZXing.BrowserMultiFormatReader();
      await loopScanZXing();
    }
  }

  async function loopScanZXing(){
    if (!stream) return;
    const reader = zxingReader;
    const tick = async ()=>{
      if (!stream || !reader) return;
      try{
        const result = await reader.decodeFromVideoElement(video);
        if (result && result.text){
          await handleCode(String(result.text));
        }
      }catch(_){}
      setTimeout(tick, 600);
    };
    tick();
  }

  async function handleCode(code){
    if (!code) return;
    // avoid spamming same barcode
    if (code === currentBarcode) return;
    currentBarcode = code;
    scanOut.textContent = 'Scanned: ' + code;
    await lookupBarcode();
  }

  /* ===== Lookup + render ===== */
  async function lookupBarcode(){
    currentDoc = null;
    show(openBox, false);
    show(linkBox, false);
    show(adjBox, false);

    const mode = modeSel.value; // 'chemicals' or 'seeds'
    try{
      const q = await db.collection(mode).where('barcode','==', currentBarcode).limit(1).get();
      if (!q.empty){
        const doc = q.docs[0];
        currentDoc = { collection: mode, id: doc.id, data: doc.data()||{} };
        renderFound();
      }else{
        renderNotFound();
      }
    }catch(e){
      console.error(e);
      itemBox.innerHTML = '<span class="muted">Lookup failed. See console.</span>';
      log('Lookup failed: ' + (e?.message || e));
    }
  }

  function renderFound(){
    const d = currentDoc.data;
    const prop = d.propertyName || '';

    show(openBox, true);

    if (currentDoc.collection==='chemicals'){
      itemBox.innerHTML = `
        <div><strong>Chemical:</strong> ${esc(d.name||'')}</div>
        <div class="muted">Unit: ${esc(d.unit||'')} &nbsp; UseOn: ${esc(d.useOn||'')}</div>
        <div>Quantity: <strong>${(parseFloat(d.quantity||0)).toLocaleString(undefined,{maximumFractionDigits:2})}</strong></div>
        <div class="muted">Property: ${esc(prop)}</div>
      `;
      show(linkBox, false);
      show(adjBox, true);
      show(chemAdj, true);
      show(seedAdj, false);
    }else{
      itemBox.innerHTML = `
        <div><strong>Seed:</strong> ${esc(d.crop||'')} — ${esc(d.variety||'')}</div>
        <div>Quantity: <strong>${(parseFloat(d.quantityKg||0)).toLocaleString(undefined,{maximumFractionDigits:2})} kg</strong></div>
        <div class="muted">Property: ${esc(prop)}</div>
      `;
      show(linkBox, false);
      show(adjBox, true);
      show(chemAdj, false);
      show(seedAdj, true);
    }
  }

  async function populateExistingDropdown(){
    existingSel.innerHTML = '<option value="">Loading…</option>';
    const col = modeSel.value;
    try{
      const snap = await db.collection(col).orderBy('updatedAt','desc').limit(400).get();
      const opts = [];
      snap.forEach(doc=>{
        const d=doc.data()||{};
        if (col==='chemicals'){
          const label = `${d.name||'(unnamed)'} — ${d.unit||''} — ${d.propertyName||''}`;
          opts.push(`<option value="${doc.id}">${esc(label)}</option>`);
        }else{
          const label = `${d.crop||''} — ${d.variety||''} — ${d.propertyName||''}`;
          opts.push(`<option value="${doc.id}">${esc(label)}</option>`);
        }
      });
      existingSel.innerHTML = '<option value="">(choose)</option>' + opts.join('');
    }catch(e){
      existingSel.innerHTML = '<option value="">(failed to load)</option>';
    }
  }

  function renderNotFound(){
    itemBox.textContent = 'No item with this barcode.';
    show(openBox, false);
    populateExistingDropdown();
    show(linkBox, true);
    const isChem = (modeSel.value==='chemicals');
    show(createChem, isChem);
    show(createSeed, !isChem);
    show(adjBox, false);
  }

  async function linkExisting(){
    const id = existingSel.value;
    if (!id) return alert('Pick an item to link.');
    const col = modeSel.value;
    try{
      await db.collection(col).doc(id).update({
        barcode: currentBarcode,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('Linked.');
      const doc = await db.collection(col).doc(id).get();
      currentDoc = {collection: col, id: id, data: doc.data()||{}};
      renderFound();
    }catch(e){
      alert('Link failed: ' + (e?.message || e));
    }
  }

  /* ===== Create minimal records ===== */
  async function createChemical(){
    try{
      const payload = {
        name: (chemName.value||'').trim() || 'Unnamed chemical',
        unit: (chemUnit.value||'').trim() || 'KG',
        useOn: (chemUseOn.value||'paddock').toLowerCase(),
        quantity: parseFloat(chemQty.value||0) || 0,
        propertyId: chemProp.value || null,
        propertyName: propNameById.get(chemProp.value)||null,
        barcode: currentBarcode,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const ref = await db.collection('chemicals').add(payload);
      const doc = await ref.get();
      currentDoc = {collection:'chemicals', id: ref.id, data: doc.data()||{}};
      alert('Chemical created & linked.');
      renderFound();
    }catch(e){
      alert('Create chemical failed: ' + (e?.message || e));
    }
  }

  async function createSeedRow(){
    try{
      const payload = {
        crop: seedCrop.value,
        variety: (seedVariety.value||'').trim() || 'Unknown',
        quantityKg: parseFloat(seedQty.value||0) || 0,
        propertyId: seedProp.value || null,
        propertyName: propNameById.get(seedProp.value)||null,
        unit: 'KG',
        barcode: currentBarcode,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const ref = await db.collection('seeds').add(payload);
      const doc = await ref.get();
      currentDoc = {collection:'seeds', id: ref.id, data: doc.data()||{}};
      alert('Seed created & linked.');
      renderFound();
    }catch(e){
      alert('Create seed failed: ' + (e?.message || e));
    }
  }

  /* ===== Adjust quantity ===== */
  async function adjustChemical(){
    if (!currentDoc || currentDoc.collection!=='chemicals') return;
    const delta = parseFloat(chemDelta.value||0);
    if (!delta) return alert('Enter a +/- amount.');

    try{
      await db.runTransaction(async (tx)=>{
        const ref = db.collection('chemicals').doc(currentDoc.id);
        const snap = await tx.get(ref);
        if (!snap.exists) throw new Error('Chemical gone.');
        const d = snap.data()||{};
        const cur = parseFloat(d.quantity||0);
        const next = cur + delta;
        if (next < -0.0001) throw new Error('Not enough stock.');
        tx.update(ref,{quantity: next, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
      });
      const doc = await db.collection('chemicals').doc(currentDoc.id).get();
      currentDoc = {collection:'chemicals', id: currentDoc.id, data: doc.data()||{}};
      chemDelta.value='';
      renderFound();
    }catch(e){
      alert('Adjust failed: ' + (e?.message || e));
    }
  }

  async function adjustSeed(){
    if (!currentDoc || currentDoc.collection!=='seeds') return;
    const delta = parseFloat(seedDelta.value||0);
    if (!delta) return alert('Enter a +/- kg.');

    try{
      await db.runTransaction(async (tx)=>{
        const ref = db.collection('seeds').doc(currentDoc.id);
        const snap = await tx.get(ref);
        if (!snap.exists) throw new Error('Seed row gone.');
        const d = snap.data()||{};
        const cur = parseFloat(d.quantityKg||0);
        const next = cur + delta;
        if (next < -0.0001) throw new Error('Not enough stock.');
        tx.update(ref,{quantityKg: next, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
      });
      const doc = await db.collection('seeds').doc(currentDoc.id).get();
      currentDoc = {collection:'seeds', id: currentDoc.id, data: doc.data()||{}};
      seedDelta.value='';
      renderFound();
    }catch(e){
      alert('Adjust failed: ' + (e?.message || e));
    }
  }

})();
</script>
</body>
</html>
