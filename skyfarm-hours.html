<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SkyFarm — Hours</title>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#f6fbf8;
      --card:#ffffff;
      --line:#e2e8f0;
      --ink:#0f172a;
      --muted:#64748b;
      --accent:#047857;
      --danger:#b91c1c;
      --warn:#b45309;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
    }
    a{color:#0f766e;text-decoration:none;}
    a:hover{text-decoration:underline;}

    /* Header */
    #sf-header{
      position:sticky;
      top:0;
      z-index:40;
      background:rgba(255,255,255,.96);
      backdrop-filter:blur(18px);
      border-bottom:1px solid rgba(148,163,184,.4);
    }
    #sf-header .bar{
      max-width:1200px;
      margin:0 auto;
      padding:8px 14px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    #sf-header .brand{
      font-weight:600;
      font-size:1rem;
      padding:4px 10px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 10%,#e0f2fe,#0f766e);
      color:#ecfdf3;
      box-shadow:0 10px 20px rgba(15,23,42,.25);
    }
    #sf-header nav a{
      padding:4px 10px;
      border-radius:999px;
      font-size:.85rem;
      color:#0f172a;
      text-decoration:none;
    }
    #sf-header nav a[aria-current="page"]{
      background:#e0f2fe;
      font-weight:500;
    }
    .nav-db{position:relative;}
    .spacer{flex:1;}
    .muted{color:var(--muted);}
    .small{font-size:.8rem;}
    .status-warn{color:var(--danger);}
    .status-warn2{color:var(--warn);}

    .btn{
      border-radius:999px;
      border:1px solid #cbd5e1;
      padding:6px 12px;
      font-size:.82rem;
      background:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#ecfdf3;
    }
    .btn.danger{
      border-color:#ef4444;
      color:#ef4444;
      background:#fff;
    }
    .btn.small{
      padding:4px 10px;
      font-size:.78rem;
    }
    .btn[disabled]{opacity:.5;cursor:default;}

    .db-menu{
      position:absolute;
      top:100%;
      right:0;
      background:#fff;
      border:1px solid var(--line);
      border-radius:10px;
      min-width:180px;
      padding:4px 0;
      box-shadow:0 10px 25px rgba(15,23,42,.12);
      z-index:20;
    }
    .db-menu a{
      display:block;
      padding:6px 12px;
      font-size:.9rem;
      color:#0f172a;
      text-decoration:none;
    }
    .db-menu a:hover{background:#f1f5f9;}
    .hidden{display:none;}

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:12px;
    }
    h1{margin:10px 0;font-size:1.5rem;}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      margin:10px 0;
      box-shadow:0 10px 25px rgba(15,23,42,.04);
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin:6px 0;
    }
    label{
      display:block;
      font-size:.8rem;
      color:#475569;
      margin-bottom:3px;
    }
    input,select,textarea{
      border-radius:10px;
      border:1px solid #cbd5e1;
      padding:6px 8px;
      font-size:.85rem;
      font-family:inherit;
      background:#fff;
    }
    textarea{resize:vertical;min-height:40px;}
    input:focus,select:focus,textarea:focus{
      outline:none;
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,.2);
    }

    .w90{width:90px;}
    .w120{width:120px;}
    .w160{width:160px;}
    .w220{width:220px;}
    .pill{
      display:inline-block;
      padding:2px 7px;
      border-radius:999px;
      font-size:.75rem;
      background:#e5f3ff;
      border:1px solid #bfdbfe;
      margin-right:4px;
      white-space:nowrap;
    }
    .pill.warn{
      background:#fff7ed;
      border-color:#fed7aa;
      color:#9a3412;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.8rem;
    }
    th,td{
      border-bottom:1px solid #e5e7eb;
      padding:6px 6px;
      text-align:left;
      vertical-align:top;
    }
    th{background:#f9fafb;color:#374151;}
    tr:nth-child(even) td{background:#f9fafb;}
    .nowrap{white-space:nowrap;}

    .table-scroll{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }

    /* Card list for mobile */
    .entries-cards{
      margin-top:8px;
      display:none;
      flex-direction:column;
      gap:8px;
    }
    .entry-card{
      border-radius:12px;
      border:1px solid var(--line);
      background:#f9fafb;
      padding:8px 10px;
    }
    .ec-header{
      display:flex;
      justify-content:space-between;
      font-size:.78rem;
      font-weight:500;
      margin-bottom:4px;
    }
    .ec-line{
      font-size:.78rem;
      margin-bottom:2px;
    }
    .ec-label{
      font-weight:600;
      color:#475569;
      margin-right:4px;
    }
    .ec-notes{color:var(--muted);}

    @media (max-width:800px){
      .table-desktop{display:none;}
      .entries-cards{display:flex;}
      .row{flex-direction:column;align-items:flex-start;}
      .w220,.w160,.w120,.w90{width:100%;}
      #sf-header .bar{flex-wrap:wrap;}
      #sf-header nav a{padding:4px 8px;}
    }
    @media (min-width:801px){
      .table-desktop{display:block;}
      .entries-cards{display:none;}
    }

    /* Auth overlay */
    #authOverlay{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top,#020617 0,rgba(15,23,42,.94) 40%,rgba(15,23,42,.97) 100%);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    #authCard{
      width:min(520px,92vw);
      background:#fff;
      border-radius:16px;
      border:1px solid var(--line);
      padding:20px;
    }
    #authCard h2{margin:0 0 8px;}

    @media print{
      #sf-header,.no-print{display:none!important;}
      body{background:#fff;}
      .wrap{padding:8px;}
      .card{box-shadow:none;border:none;margin:6px 0;}
      .table-desktop{display:block!important;}
      .entries-cards{display:none!important;}
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div id="sf-header">
    <div class="bar">
      <a class="brand" href="skyfarm-diary.html" style="display:flex;align-items:center;gap:8px;">
        <img src="https://raw.githubusercontent.com/Nyscat/Skyfarm/main/FF9D2A05-6AC0-45E5-95EB-659A0A11E8D0_1_105_c.jpeg"
             alt="SkyFarm logo"
             style="height:28px;width:auto;border-radius:6px;">
        <span>SkyFarm</span>
      </a>
      <nav>
        <a href="skyfarm-diary.html">Diary</a>
        <a href="skyfarm-map.html">Map</a>
        <a href="skyfarm-rain.html">Rain</a>
        <a href="skyfarm-hours.html" aria-current="page">Hours</a>
      </nav>
      <div class="nav-db">
        <button id="dbMenuBtn" class="btn small" type="button">Database ▾</button>
        <div id="dbMenu" class="db-menu hidden">
          <a href="skyfarm-livestock.html">Livestock</a>
          <a href="skyfarm-chemical.html">Chemicals</a>
          <a href="skyfarm-seeds.html">Seeds</a>
          <a href="skyfarm-fodder.html">Fodder</a>
          <a href="skyfarm-barcode.html">Barcode scanner</a>
          <a href="skyfarm-users.html">Users &amp; roles</a>
        </div>
      </div>
      <span class="spacer"></span>
      <span id="authWho" class="muted small">Checking sign-in…</span>
      <button id="signOutBtn" class="btn small danger hidden">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <h1>Hours</h1>

    <div class="card no-print">
      <div class="row">
        <div style="flex:1;min-width:260px">
          <div class="small muted">
            Hours are averaged over a <strong>4-week period</strong> under the Pastoral Award (where averaging applies).
            Daily hours over 8 are shown as <strong>Potential OT</strong> only. Overtime is confirmed when the 4-week average is finalised.
          </div>
        </div>
        <span class="spacer"></span>
        <div id="status" class="muted small">Ready</div>
      </div>

      <div class="row">
        <div>
          <label>Property</label>
          <select id="propSel" class="w220"></select>
        </div>
        <div>
          <label>Date</label>
          <input id="dateInp" type="date" class="w160"/>
        </div>
        <div>
          <label>Start</label>
          <input id="startInp" type="time" class="w120"/>
        </div>
        <div>
          <label>Finish</label>
          <input id="endInp" type="time" class="w120"/>
        </div>
        <div>
          <label>Break (mins)</label>
          <input id="breakInp" type="number" min="0" step="5" class="w120" placeholder="0"/>
        </div>
      </div>

      <div class="row">
        <div style="flex:1;min-width:260px">
          <label>Notes (optional)</label>
          <textarea id="notesInp" placeholder="Job, location, anything relevant..."></textarea>
        </div>
        <div style="min-width:260px">
          <label>Calculated</label>
          <div id="calcBox" class="small">
            <span class="pill" id="pillTotal">Total: 0.00h</span>
            <span class="pill warn" id="pillPot">Potential OT: 0.00h</span>
          </div>
          <div class="small muted" style="margin-top:4px;">
            Potential OT is a daily flag (over 8). Confirmed overtime is based on the 4-week average.
          </div>
        </div>
      </div>

      <div class="row">
        <button id="saveBtn" class="btn primary" type="button">Save hours</button>
        <button id="resetBtn" class="btn" type="button">Reset</button>
        <span id="saveMsg" class="muted small"></span>
      </div>
    </div>

    <!-- 4-week window summary (informational) -->
    <div class="card">
      <div class="row">
        <strong>4-week window (informational)</strong>
        <span class="spacer"></span>
        <span class="muted small" id="windowLabel"></span>
      </div>
      <div class="row">
        <span class="pill" id="winTotal">Total: 0.00h</span>
        <span class="pill warn" id="winPot">Potential OT flags: 0.00h</span>
        <span class="pill" id="winDays">Days worked: 0</span>
      </div>
      <div class="small muted">
        This is a running view only. Confirmed overtime requires checking the award rules, rostering, and finalising the period.
      </div>
    </div>

    <!-- Recent entries -->
    <div class="card">
      <div class="row no-print">
        <strong>Recent entries</strong>
        <div>
          <label class="small">Property</label>
          <select id="filterPropSel" class="w160"></select>
        </div>
        <div id="userFilterWrap">
          <label class="small">User</label>
          <select id="filterUserSel" class="w160"></select>
        </div>
        <div>
          <label class="small">Year</label>
          <input id="filterYear" type="number" class="w90" min="2000" max="2100"/>
        </div>
        <div>
          <label class="small">Sort</label>
          <select id="sortSel" class="w160">
            <option value="dateDesc">Newest first</option>
            <option value="dateAsc">Oldest first</option>
            <option value="userAsc">User A–Z</option>
            <option value="userDesc">User Z–A</option>
          </select>
        </div>
        <div>
          <label class="small">&nbsp;</label>
          <button id="refreshBtn" class="btn small" type="button">Refresh</button>
        </div>
        <span class="spacer"></span>
        <button id="printBtn" class="btn small" type="button">Print / PDF</button>
      </div>

      <!-- Desktop/tablet view -->
      <div class="table-desktop">
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Property</th>
                <th class="nowrap">Start</th>
                <th class="nowrap">Finish</th>
                <th class="nowrap">Break</th>
                <th class="nowrap">Total</th>
                <th class="nowrap">Potential OT</th>
                <th>Notes</th>
                <th>User</th>
                <th class="no-print"></th>
              </tr>
            </thead>
            <tbody id="entriesBody">
              <tr><td colspan="10" class="muted small">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Mobile card view -->
      <div id="entriesCards" class="entries-cards"></div>
    </div>
  </div>

  <!-- Auth overlay -->
  <div id="authOverlay">
    <div id="authCard">
      <h2>Sign in to SkyFarm</h2>
      <p class="small muted">Email &amp; password only.</p>
      <div class="row">
        <div style="flex:1;min-width:240px">
          <label>Email</label>
          <input id="siEmail" type="email" autocomplete="username" placeholder="you@example.com"/>
        </div>
        <div style="flex:1;min-width:200px">
          <label>Password</label>
          <input id="siPass" type="password" autocomplete="current-password" placeholder="••••••••"/>
        </div>
      </div>
      <div class="row">
        <button id="signInBtn" class="btn primary" type="button">Sign in</button>
        <span id="
