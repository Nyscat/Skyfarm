<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SkyFarm — Hours</title>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#f6fbf8;
      --card:#ffffff;
      --line:#e2e8f0;
      --ink:#0f172a;
      --muted:#64748b;
      --accent:#047857;
      --danger:#b91c1c;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
    }
    a{color:#0f766e;text-decoration:none;}
    a:hover{text-decoration:underline;}

    /* Header */
    #sf-header{
      position:sticky;
      top:0;
      z-index:40;
      background:rgba(255,255,255,.96);
      backdrop-filter:blur(18px);
      border-bottom:1px solid rgba(148,163,184,.4);
    }
    #sf-header .bar{
      max-width:1200px;
      margin:0 auto;
      padding:8px 14px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    #sf-header .brand{
      font-weight:600;
      font-size:1rem;
      padding:4px 10px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 10%,#e0f2fe,#0f766e);
      color:#ecfdf3;
      box-shadow:0 10px 20px rgba(15,23,42,.25);
    }
    #sf-header nav a{
      padding:4px 10px;
      border-radius:999px;
      font-size:.85rem;
      color:#0f172a;
      text-decoration:none;
    }
    #sf-header nav a[aria-current="page"]{
      background:#e0f2fe;
      font-weight:500;
    }
    .nav-db{position:relative;}
    .spacer{flex:1;}
    .muted{color:var(--muted);}
    .small{font-size:.8rem;}
    .status-warn{color:var(--danger);}

    .btn{
      border-radius:999px;
      border:1px solid #cbd5e1;
      padding:6px 12px;
      font-size:.82rem;
      background:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#ecfdf3;
    }
    .btn.danger{
      border-color:#ef4444;
      color:#ef4444;
      background:#fff;
    }
    .btn.small{
      padding:4px 10px;
      font-size:.78rem;
    }
    .btn[disabled]{opacity:.5;cursor:default;}

    .db-menu{
      position:absolute;
      top:100%;
      right:0;
      background:#fff;
      border:1px solid var(--line);
      border-radius:10px;
      min-width:180px;
      padding:4px 0;
      box-shadow:0 10px 25px rgba(15,23,42,.12);
      z-index:20;
    }
    .db-menu a{
      display:block;
      padding:6px 12px;
      font-size:.9rem;
      color:#0f172a;
      text-decoration:none;
    }
    .db-menu a:hover{background:#f1f5f9;}
    .hidden{display:none;}

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:12px;
    }
    h1{margin:10px 0;font-size:1.5rem;}
    h2{margin:0 0 8px;font-size:1.05rem;}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      margin:10px 0;
      box-shadow:0 10px 25px rgba(15,23,42,.04);
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin:6px 0;
    }
    label{
      display:block;
      font-size:.8rem;
      color:#475569;
      margin-bottom:3px;
    }
    input,select,textarea{
      border-radius:10px;
      border:1px solid #cbd5e1;
      padding:6px 8px;
      font-size:.85rem;
      font-family:inherit;
      background:#fff;
    }
    input:focus,select:focus,textarea:focus{
      outline:none;
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,.2);
    }

    .w90{width:90px;}
    .w120{width:120px;}
    .w160{width:160px;}
    .w220{width:220px;}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.8rem;
    }
    th,td{
      border-bottom:1px solid #e5e7eb;
      padding:6px 6px;
      text-align:left;
      vertical-align:top;
    }
    th{background:#f9fafb;color:#374151;}
    tr:nth-child(even) td{background:#f9fafb;}
    .nowrap{white-space:nowrap;}

    .table-scroll{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }

    /* Auth overlay */
    #authOverlay{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top,#020617 0,rgba(15,23,42,.94) 40%,rgba(15,23,42,.97) 100%);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    #authCard{
      width:min(520px,92vw);
      background:#fff;
      border-radius:16px;
      border:1px solid var(--line);
      padding:20px;
    }
    #authCard h2{margin:0 0 8px;}

    @media print{
      #sf-header,.no-print{display:none!important;}
      body{background:#fff;}
      .wrap{padding:8px;}
      .card{box-shadow:none;border:none;margin:6px 0;}
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div id="sf-header">
    <div class="bar">
      <a class="brand" href="skyfarm-diary.html" style="display:flex;align-items:center;gap:8px;">
        <img src="https://raw.githubusercontent.com/Nyscat/Skyfarm/main/FF9D2A05-6AC0-45E5-95EB-659A0A11E8D0_1_105_c.jpeg"
             alt="SkyFarm logo"
             style="height:28px;width:auto;border-radius:6px;">
        <span>SkyFarm</span>
      </a>
      <nav>
        <a href="skyfarm-diary.html">Diary</a>
        <a href="skyfarm-map.html">Map</a>
        <a href="skyfarm-rain.html">Rain</a>
        <a href="skyfarm-hours.html" aria-current="page">Hours</a>
      </nav>
      <div class="nav-db">
        <button id="dbMenuBtn" class="btn small" type="button">Database ▾</button>
        <div id="dbMenu" class="db-menu hidden">
          <a href="skyfarm-livestock.html">Livestock</a>
          <a href="skyfarm-chemical.html">Chemicals</a>
          <a href="skyfarm-seeds.html">Seeds</a>
          <a href="skyfarm-fodder.html">Fodder</a>
          <a href="skyfarm-barcode.html">Barcode scanner</a>
          <a href="skyfarm-users.html">Users &amp; roles</a>
        </div>
      </div>
      <span class="spacer"></span>
      <span id="authWho" class="muted small">Checking sign-in…</span>
      <button id="signOutBtn" class="btn small danger hidden">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <h1>Hours</h1>

    <!-- Hours entry form -->
    <div class="card no-print">
      <div class="row">
        <div>
          <label>Property</label>
          <select id="hoursProp" class="w220"></select>
        </div>
        <div>
          <label>Date</label>
          <input id="hoursDate" type="date" class="w160"/>
        </div>
        <span class="spacer"></span>
        <div id="hoursStatus" class="muted small">Ready</div>
      </div>

      <div class="row">
        <div>
          <label>Start</label>
          <input id="startTime" type="time" class="w160"/>
        </div>
        <div>
          <label>Finish</label>
          <input id="endTime" type="time" class="w160"/>
        </div>
        <div>
          <label>Break (mins)</label>
          <input id="breakMins" type="number" min="0" step="5" value="30" class="w160"/>
        </div>
      </div>

      <div class="row">
        <div style="flex:1;min-width:260px">
          <label>Duties</label>
          <input id="dutiesInp" style="width:100%" placeholder="Mustering, fencing, feeding..."/>
        </div>
        <div style="flex:1;min-width:260px">
          <label>Notes (optional)</label>
          <input id="hoursNotesInp" style="width:100%" placeholder="Anything to record"/>
        </div>
      </div>

      <div class="row">
        <button id="saveHoursBtn" class="btn primary" type="button">Save hours</button>
        <button id="resetHoursBtn" class="btn" type="button">Reset</button>
        <span id="hoursSummary" class="muted small"></span>
      </div>

      <div class="small muted">
        Totals are calculated automatically. Anything over 8 hours/day is shown as overtime.
      </div>
    </div>

    <!-- Recent hours -->
    <div class="card">
      <div class="row no-print">
        <strong>Recent hours</strong>
        <span class="spacer"></span>
        <button id="refreshHoursBtn" class="btn small" type="button">Refresh</button>
        <button id="printBtn" class="btn small" type="button">Print / PDF</button>
      </div>

      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Property</th>
              <th>Start</th>
              <th>Finish</th>
              <th>Break</th>
              <th>Total</th>
              <th>OT</th>
              <th>Duties</th>
              <th>User</th>
              <th class="no-print"></th>
            </tr>
          </thead>
          <tbody id="hoursBody">
            <tr><td colspan="10" class="muted small">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Auth overlay -->
  <div id="authOverlay">
    <div id="authCard">
      <h2>Sign in to SkyFarm</h2>
      <p class="small muted">Email &amp; password only.</p>
      <div class="row">
        <div style="flex:1;min-width:240px">
          <label>Email</label>
          <input id="siEmail" type="email" autocomplete="username" placeholder="you@example.com"/>
        </div>
        <div style="flex:1;min-width:200px">
          <label>Password</label>
          <input id="siPass" type="password" autocomplete="current-password" placeholder="••••••••"/>
        </div>
      </div>
      <div class="row">
        <button id="signInBtn" class="btn primary" type="button">Sign in</button>
        <span id="authMsg" class="muted small"></span>
        <span class="spacer"></span>
        <button id="closeOverlayBtn" class="btn" type="button">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Firebase init ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
      authDomain: "consentes-pastoral.firebaseapp.com",
      projectId: "consentes-pastoral",
      appId: "1:494858780013:web:d87497b370c82eeab06e64"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ---------- Helpers ----------
    const $  = s => document.querySelector(s);
    const escapeHtml = s => String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const todayISO = () => new Date().toISOString().slice(0,10);

    function setHoursStatus(msg, warn){
      const el = $('#hoursStatus');
      el.textContent = msg || '';
      el.classList.toggle('status-warn', !!warn);
    }

    function calculateHours(start, end, breakMin = 0){
      // Simple daily calc: total hours minus unpaid break.
      // Anything over 8 hours/day is overtime (can adjust later).
      const [sh, sm] = start.split(':').map(Number);
      const [eh, em] = end.split(':').map(Number);

      let mins = (eh*60 + em) - (sh*60 + sm) - Number(breakMin || 0);
      if (!Number.isFinite(mins)) mins = 0;
      if (mins < 0) mins = 0;

      const hours = mins / 60;
      const overtime = Math.max(0, hours - 8);
      return { hours, overtime };
    }

    // Current user/role
    let CURRENT_USER = null;
    let CURRENT_UID = null;
    let CURRENT_EMAIL = null;
    let CURRENT_ROLE = 'worker';       // admin | manager | worker
    let ALLOWED_PROPERTY_IDS = null;   // Set of propertyIds, or null = all

    // Properties
    let ALL_PROPERTIES = [];

    // DOM refs
    const hoursProp = $('#hoursProp');
    const hoursDate = $('#hoursDate');
    const startTime = $('#startTime');
    const endTime = $('#endTime');
    const breakMins = $('#breakMins');
    const dutiesInp = $('#dutiesInp');
    const hoursNotesInp = $('#hoursNotesInp');

    const saveHoursBtn = $('#saveHoursBtn');
    const resetHoursBtn = $('#resetHoursBtn');
    const refreshHoursBtn = $('#refreshHoursBtn');
    const printBtn = $('#printBtn');

    const hoursSummary = $('#hoursSummary');
    const hoursBody = $('#hoursBody');

    // Header DB menu
    const dbMenuBtn = $('#dbMenuBtn');
    const dbMenu = $('#dbMenu');
    if (dbMenuBtn && dbMenu){
      dbMenuBtn.onclick = e => {
        e.stopPropagation();
        dbMenu.classList.toggle('hidden');
      };
      document.addEventListener('click', e=>{
        if (!dbMenu.contains(e.target) && e.target !== dbMenuBtn){
          dbMenu.classList.add('hidden');
        }
      });
    }

    // Auth overlay
    const authOverlay = $('#authOverlay');
    const authWho = $('#authWho');
    const signOutBtn = $('#signOutBtn');

    const siEmail = $('#siEmail');
    const siPass = $('#siPass');
    const signInBtn = $('#signInBtn');
    const authMsg = $('#authMsg');
    const closeOverlayBtn = $('#closeOverlayBtn');

    function showOverlay(show){ authOverlay.style.display = show ? 'flex' : 'none'; }

    signInBtn.onclick = async ()=>{
      const email = (siEmail.value || '').trim();
      const pass  = siPass.value || '';
      if (!email || !pass){
        authMsg.textContent = 'Enter email and password.';
        return;
      }
      authMsg.textContent = 'Signing in…';
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        await auth.signInWithEmailAndPassword(email, pass);
        authMsg.textContent = 'Signed in.';
        showOverlay(false);
      }catch(e){
        console.error(e);
        authMsg.textContent = e.message || 'Sign-in failed.';
      }
    };
    closeOverlayBtn.onclick = ()=> showOverlay(false);
    signOutBtn.onclick = async ()=>{ try{ await auth.signOut(); location.reload(); }catch(e){} };

    async function loadCurrentUserRole(user){
      CURRENT_USER = user;
      CURRENT_UID = user?.uid || null;
      CURRENT_EMAIL = (user?.email || '').toLowerCase() || null;
      CURRENT_ROLE = 'worker';
      ALLOWED_PROPERTY_IDS = null;

      if (!CURRENT_EMAIL) return;
      const docId = CURRENT_EMAIL.replace(/[^\w.-]/g,'_');
      try{
        const snap = await db.collection('users').doc(docId).get();
        if (snap.exists){
          const data = snap.data() || {};
          CURRENT_ROLE = data.role || 'worker';
          const allowed = data.allowedProperties || [];
          if (Array.isArray(allowed) && allowed.length){
            ALLOWED_PROPERTY_IDS = new Set(allowed);
          }
        }
      }catch(e){
        console.error('loadCurrentUserRole failed', e);
      }
    }

    // Load properties (same behaviour as your diary page)
    async function loadProperties(){
      const snap = await db.collection('properties').get();
      let props = [];
      snap.forEach(doc=>{
        const d = doc.data() || {};
        props.push({id:doc.id, name:d.name || '(Property)'});
      });
      props.sort((a,b)=>a.name.localeCompare(b.name));

      if (ALLOWED_PROPERTY_IDS instanceof Set){
        props = props.filter(p=>ALLOWED_PROPERTY_IDS.has(p.id));
      }

      ALL_PROPERTIES = props;

      if (!props.length){
        hoursProp.innerHTML = '<option value="">(no properties available)</option>';
        return;
      }

      hoursProp.innerHTML = props.map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
    }

    async function saveHours(){
      if (!hoursProp.value){
        alert("Choose a property.");
        return;
      }
      if (!hoursDate.value){
        alert("Choose a date.");
        return;
      }
      if (!startTime.value || !endTime.value){
        alert("Start and finish are required.");
        return;
      }

      const b = Number(breakMins.value || 0);
      if (!Number.isFinite(b) || b < 0){
        alert("Break minutes must be 0 or more.");
        return;
      }

      // Quick sanity check: finish must be after start for now (same-day shift).
      // If you need overnight shifts later, we can add a "spans midnight" toggle.
      const calcTry = calculateHours(startTime.value, endTime.value, b);
      if (calcTry.hours <= 0){
        alert("Finish time must be after start time (same day).");
        return;
      }

      const calc = calculateHours(startTime.value, endTime.value, b);
      hoursSummary.textContent = `Total ${calc.hours.toFixed(2)} hrs (OT ${calc.overtime.toFixed(2)})`;

      try{
        setHoursStatus("Saving…");

        await db.collection('timesheets').add({
          date: hoursDate.value,

          propertyId: hoursProp.value,
          propertyName: hoursProp.selectedOptions[0]?.textContent || "",

          workerUid: CURRENT_UID,
          workerEmail: CURRENT_EMAIL,

          startTime: startTime.value,
          endTime: endTime.value,
          breakMinutes: b,

          totalHours: calc.hours,
          overtimeHours: calc.overtime,

          duties: dutiesInp.value || null,
          notes: hoursNotesInp.value || null,

          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          locked: false
        });

        setHoursStatus("Saved");
        await refreshHours();
      }catch(e){
        console.error(e);
        setHoursStatus("Save failed", true);
        alert("Save failed. Check console.");
      }
    }

    async function refreshHours(){
      hoursBody.innerHTML = `<tr><td colspan="10" class="muted small">Loading…</td></tr>`;

      try{
        let q = db.collection('timesheets')
          .orderBy('date','desc')
          .limit(200);

        // Workers only see their own
        if (CURRENT_ROLE === 'worker' && CURRENT_EMAIL){
          q = q.where('workerEmail','==',CURRENT_EMAIL.toLowerCase());
        }

        const snap = await q.get();
        const rows = [];
        snap.forEach(doc => rows.push({ id: doc.id, ...(doc.data() || {}) }));

        if (!rows.length){
          hoursBody.innerHTML = `<tr><td colspan="10" class="muted small">No hours yet.</td></tr>`;
          return;
        }

        hoursBody.innerHTML = rows.map(r=>{
          const canDelete =
            (CURRENT_ROLE !== 'worker') ||
            (String(r.workerEmail||'').toLowerCase() === (CURRENT_EMAIL||'').toLowerCase());

          const delBtn = (canDelete && r.locked !== true)
            ? `<button class="btn small danger" data-del="${r.id}" type="button">Delete</button>`
            : '';

          const total = Number(r.totalHours || 0);
          const ot = Number(r.overtimeHours || 0);

          return `<tr>
            <td class="nowrap">${escapeHtml(r.date||'')}</td>
            <td>${escapeHtml(r.propertyName||'')}</td>
            <td>${escapeHtml(r.startTime||'')}</td>
            <td>${escapeHtml(r.endTime||'')}</td>
            <td>${escapeHtml(String(r.breakMinutes ?? ''))}</td>
            <td>${escapeHtml(total.toFixed(2))}</td>
            <td>${escapeHtml(ot.toFixed(2))}</td>
            <td>${escapeHtml(r.duties||'')}</td>
            <td>${escapeHtml((r.workerEmail||'').split('@')[0])}</td>
            <td class="no-print">${delBtn}</td>
          </tr>`;
        }).join('');

        document.querySelectorAll('button[data-del]').forEach(btn=>{
          btn.onclick = async ()=>{
            const id = btn.dataset.del;
            if (!id) return;
            const ok = confirm("Delete this hours entry?");
            if (!ok) return;
            try{
              await db.collection('timesheets').doc(id).delete();
              await refreshHours();
            }catch(e){
              console.error(e);
              alert("Delete failed. Check console.");
            }
          };
        });

      }catch(e){
        console.error(e);
        hoursBody.innerHTML = `<tr><td colspan="10" class="muted small">Error loading hours.</td></tr>`;
      }
    }

    async function initAfterAuth(){
      hoursDate.value = todayISO();
      const now = new Date();
      startTime.value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      endTime.value = '';

      await loadProperties();

      saveHoursBtn.onclick = saveHours;
      resetHoursBtn.onclick = ()=>{
        startTime.value = '';
        endTime.value = '';
        breakMins.value = 30;
        dutiesInp.value = '';
        hoursNotesInp.value = '';
        hoursSummary.textContent = '';
        setHoursStatus("Ready");
      };
      refreshHoursBtn.onclick = refreshHours;
      printBtn.onclick = ()=>window.print();

      await refreshHours();
    }

    auth.onAuthStateChanged(async user=>{
      if (user){
        authWho.textContent = user.email || 'Signed in';
        signOutBtn.classList.remove('hidden');
        showOverlay(false);
        try{ await db.enablePersistence({synchronizeTabs:true}); }catch(e){}
        await loadCurrentUserRole(user);
        await initAfterAuth();
      }else{
        authWho.textContent = 'Not signed in';
        signOutBtn.classList.add('hidden');
        showOverlay(true);
      }
    });

    window.addEventListener('load', ()=>{
      setHoursStatus('Ready');
    });
  </script>
</body>
</html>
