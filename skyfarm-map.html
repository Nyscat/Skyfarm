<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SkyFarm â€” Property Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#f6fbf8;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --brand:#0B7A6E;
      --line:#e5e7eb;
      --warn:#9a3412;
    }
    *{box-sizing:border-box;}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);
      margin:0;
      color:var(--ink);
    }

    /* Header (same pattern as other pages) */
    #sf-header{position:sticky;top:0;z-index:10;}
    #sf-header .bar{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 14px;
      background:#fff;
      border-bottom:1px solid var(--line);
      flex-wrap:wrap;
    }
    #sf-header .brand{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--brand);
      font-weight:700;
      text-decoration:none;
    }
    #sf-header nav a{
      color:var(--brand);
      text-decoration:none;
      font-weight:600;
      margin-right:10px;
    }
    #sf-header nav a[aria-current="page"]{text-decoration:underline;}
    .spacer{flex:1;}
    .muted{color:var(--muted);font-size:.9rem;}
    .hidden{display:none;}

    .nav-db{position:relative;}
    .nav-db button{font-size:.9rem;}
    .db-menu{
      position:absolute;
      top:100%;
      left:0;
      background:#fff;
      border:1px solid var(--line);
      border-radius:10px;
      min-width:160px;
      padding:4px 0;
      box-shadow:0 10px 25px rgba(15,23,42,.12);
      z-index:20;
    }
    .db-menu a{
      display:block;
      padding:6px 12px;
      color:var(--ink);
      text-decoration:none;
      font-size:.9rem;
    }
    .db-menu a:hover{background:#f1f5f9;}

    .wrap{max-width:1200px;margin:0 auto;padding:16px;}
    h1{margin:12px 0;font-size:1.6rem;}
    .panel{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;}
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#ecfeff;
      font-size:.8rem;
      margin-right:4px;
    }

    /* Auth overlay */
    #authOverlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.06);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    #authCard{
      width:min(520px,92vw);
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:20px;
    }
    #authCard h2{margin:0 0 10px;}
    label{font-size:.85rem;color:#475569;display:block;margin-bottom:4px;}
    input,button{
      padding:6px 10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      font:inherit;
    }
    button{cursor:pointer;}
    .btn{border-radius:10px;}
    .primary{background:var(--brand);color:#fff;border-color:var(--brand);}
    .danger{background:#ef4444;color:#fff;border-color:#ef4444;}
  </style>
</head>
<body>

<!-- Header -->
<div id="sf-header">
  <div class="bar">
    <a class="brand" href="skyfarm-diary.html">ðŸŒ± SkyFarm</a>
    <nav>
      <a href="skyfarm-diary.html">Diary</a>
      <a href="skyfarm-map.html" aria-current="page">Map</a>
      <a href="skyfarm-rain.html">Rain</a>
    </nav>
    <div class="nav-db">
      <button id="dbMenuBtn" class="btn" type="button">Database â–¾</button>
      <div id="dbMenu" class="db-menu hidden">
        <a href="skyfarm-livestock.html">Livestock</a>
        <a href="skyfarm-chemical.html">Chemicals</a>
        <a href="skyfarm-seeds.html">Seeds</a>
        <a href="skyfarm-barcode.html">Barcode Scanner</a>
        <a href="skyfarm-users.html">Users &amp; Roles</a>
      </div>
    </div>
    <span class="spacer"></span>
    <span id="authWho" class="muted">Connectingâ€¦</span>
    <button id="signOutBtn" class="danger hidden">Sign out</button>
  </div>
</div>

<div class="wrap">
  <h1>Property Map</h1>
  <p id="status" class="muted">Loading paddock dataâ€¦</p>

  <div style="display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start;">
    <div class="panel" style="padding:0;">
      <div id="map" style="height:560px;border-radius:12px;"></div>
    </div>

    <aside class="panel">
      <h3 style="margin-top:0;">Paddock details</h3>
      <div id="paddockInfo" class="muted">
        Click a paddock to see livestock totals and recent diary entries (last 30 days).
      </div>
    </aside>
  </div>
</div>

<!-- Auth overlay -->
<div id="authOverlay">
  <div id="authCard">
    <h2>Sign in to SkyFarm</h2>
    <p class="muted" style="font-size:.85rem;">Email &amp; password only. Anonymous sign-in is disabled.</p>
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:8px;">
      <div style="flex:1;min-width:260px;">
        <label>Email</label>
        <input id="siEmail" type="email" placeholder="you@example.com" autocomplete="username">
      </div>
      <div style="flex:1;min-width:220px;">
        <label>Password</label>
        <input id="siPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
      <button id="signInBtn" class="primary btn">Sign in</button>
      <span id="authMsg" class="muted" style="font-size:.85rem;"></span>
      <span class="spacer"></span>
      <button id="closeOverlayBtn" class="btn" type="button">Close</button>
    </div>
  </div>
</div>

<script>
/* ---------- Firebase init ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const db   = firebase.firestore();
const auth = firebase.auth();

/* ---------- Header DB menu ---------- */
const dbMenuBtn = document.getElementById('dbMenuBtn');
const dbMenu    = document.getElementById('dbMenu');
if (dbMenuBtn && dbMenu){
  dbMenuBtn.onclick = (e)=>{ e.stopPropagation(); dbMenu.classList.toggle('hidden'); };
  document.addEventListener('click', e=>{
    if (!dbMenu.contains(e.target) && e.target !== dbMenuBtn) dbMenu.classList.add('hidden');
  });
}

/* ---------- Auth overlay ---------- */
const authOverlay  = document.getElementById('authOverlay');
const authWho      = document.getElementById('authWho');
const signOutBtn   = document.getElementById('signOutBtn');
const signInBtn    = document.getElementById('signInBtn');
const closeOverlay = document.getElementById('closeOverlayBtn');

function showOverlay(on){ authOverlay.style.display = on ? 'flex' : 'none'; }

signInBtn.onclick = async ()=>{
  const email = document.getElementById('siEmail').value.trim();
  const pass  = document.getElementById('siPass').value;
  const msgEl = document.getElementById('authMsg');
  msgEl.textContent = 'Signing inâ€¦';
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithEmailAndPassword(email, pass);
    msgEl.textContent = 'Signed in.';
    showOverlay(false);
  }catch(e){
    msgEl.textContent = 'Sign-in failed: ' + (e?.message || e?.code || 'Unknown');
  }
};
closeOverlay.onclick = ()=> showOverlay(false);
signOutBtn.onclick   = async ()=>{ try{ await auth.signOut(); location.reload(); }catch(e){} };

/* ---------- UI helpers ---------- */
const statusEl      = document.getElementById('status');
const paddockInfoEl = document.getElementById('paddockInfo');
function setStatus(t){ if (statusEl) statusEl.textContent = t; }
function esc(s){
  return String(s ?? '').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
}

/* ---------- Map ---------- */
const map = L.map('map').setView([-20.0, 142.5], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom:19,
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

function featureStyle(feature){
  const t = feature?.geometry?.type;
  if (t === 'Polygon' || t === 'MultiPolygon'){
    return { color:'#00897B', weight:2, fillOpacity:0.25 };
  }
  return { color:'#64748b', weight:1, fillOpacity:0 };
}

/* ---------- IDs & data sources ---------- */
// IMPORTANT: these IDs must match Firestore propertyId values exactly
const PROPERTY_IDS   = ["s7PlDM9wrEpxuJ6DGIab", "TRuxtRBx2zJlwZnRGYKJ"]; // Consentes, Mt Myrtle
const PROPERTY_NAMES = ["Consentes", "Mt Myrtle"];

const CLOUD_URLS = [
  "https://storage.googleapis.com/consentes-maps/consentes_station.json",
  "https://storage.googleapis.com/consentes-maps/mt_myrtle.json"
];
const LOCAL_FALLBACKS = [
  "maps/consentes_station.json",
  "maps/mt_myrtle.json"
];

/* ---------- Firestore-backed indexes ---------- */
// key: `${propertyId}|${paddockName}`
const livestockIndex = new Map();
const diaryCache     = new Map();
let firestoreReady   = false;

async function loadLivestockIndex(){
  livestockIndex.clear();
  const snap = await db.collection('livestock').get();
  snap.forEach(doc=>{
    const d = doc.data() || {};
    const propId  = d.propertyId;
    const paddock = (d.location || '').trim();
    const count   = Number(d.count || 0);
    if (!propId || !paddock || !count) return;

    const key = propId + '|' + paddock;
    let rec = livestockIndex.get(key);
    if (!rec){
      rec = { total:0, byClass:{} };
      livestockIndex.set(key, rec);
    }
    rec.total += count;
    const cls = (d.class || d.species || 'Stock').trim() || 'Stock';
    rec.byClass[cls] = (rec.byClass[cls] || 0) + count;
  });
}

async function getRecentDiary(propertyId, paddockName){
  const cacheKey = propertyId + '|' + paddockName;
  if (diaryCache.has(cacheKey)) return diaryCache.get(cacheKey);

  const today = new Date();
  const from  = new Date(today.getTime() - 30*24*60*60*1000);
  const fromISO = from.toISOString().slice(0,10);

  const out = [];
  const snap = await db.collection('diaryEntries')
    .where('propertyId', '==', propertyId)
    .orderBy('date', 'desc')
    .limit(100)
    .get();

  snap.forEach(doc=>{
    const d = doc.data() || {};
    if ((d.paddock || '').trim() !== paddockName) return;
    const dateStr = d.date || '';
    if (dateStr && dateStr < fromISO) return;
    out.push({
      date: dateStr,
      activity: d.activity || '',
      notes: d.notes || ''
    });
  });

  diaryCache.set(cacheKey, out);
  return out;
}

function renderPaddockInfo(propertyName, paddockName, stockRec, diaryList){
  let html = '';
  html += `<div><strong>Paddock:</strong> ${esc(paddockName)}</div>`;
  html += `<div><strong>Property:</strong> ${esc(propertyName)}</div>`;

  if (stockRec){
    html += `<div style="margin-top:6px;"><strong>Livestock in paddock:</strong> ${stockRec.total}</div>`;
    const classes = Object.keys(stockRec.byClass);
    if (classes.length){
      html += '<div style="margin-top:4px;font-size:.9rem;">';
      classes.sort().forEach(c=>{
        html += `<span class="pill">${esc(c)}: ${stockRec.byClass[c]}</span>`;
      });
      html += '</div>';
    }
  } else {
    html += `<div style="margin-top:6px;">No livestock records for this paddock.</div>`;
  }

  if (diaryList && diaryList.length){
    html += `<div style="margin-top:10px;"><strong>Recent diary entries (last 30 days)</strong></div>`;
    html += '<ul style="margin:4px 0 0 18px;padding:0;font-size:.9rem;">';
    diaryList.forEach(e=>{
      const label = [e.date, e.activity].filter(Boolean).join(' â€” ');
      const notes = e.notes ? `: ${esc(e.notes)}` : '';
      html += `<li>${esc(label)}${notes}</li>`;
    });
    html += '</ul>';
  } else {
    html += `<div style="margin-top:10px;">No diary entries for this paddock in the last 30 days.</div>`;
  }

  paddockInfoEl.innerHTML = html;
}

async function handlePaddockClick(propertyIndex, feature){
  const propertyId   = PROPERTY_IDS[propertyIndex];
  const propertyName = PROPERTY_NAMES[propertyIndex] || 'Property';
  const paddockName  = (feature.properties && feature.properties.title)
    ? String(feature.properties.title).trim()
    : 'Paddock';

  if (!firestoreReady){
    paddockInfoEl.innerHTML = '<span class="muted">Still connecting to Firebaseâ€¦ try again in a moment.</span>';
    return;
  }

  const key      = propertyId + '|' + paddockName;
  const stockRec = livestockIndex.get(key);

  paddockInfoEl.innerHTML = '<span class="muted">Loading diary entriesâ€¦</span>';

  let diaryList = [];
  try {
    diaryList = await getRecentDiary(propertyId, paddockName);
  } catch(e) { diaryList = []; }

  renderPaddockInfo(propertyName, paddockName, stockRec, diaryList);
}

/* ---------- GeoJSON fetch with local fallback ---------- */
async function fetchWithFallback(primaryUrl, fallbackUrl){
  try{
    const r = await fetch(primaryUrl, {cache:'no-store'});
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return await r.json();
  }catch(e){
    const r2 = await fetch(fallbackUrl, {cache:'no-store'});
    if (!r2.ok) throw new Error('Fallback HTTP ' + r2.status);
    return await r2.json();
  }
}

/* ---------- Auth + Firestore bootstrap ---------- */
auth.onAuthStateChanged(async user=>{
  if (user){
    authWho.textContent = user.email ? `Signed in as ${user.email}` : 'Signed in';
    signOutBtn.classList.remove('hidden');
    showOverlay(false);
    try{ await db.enablePersistence({synchronizeTabs:true}); }catch(e){}
    try{
      setStatus('Loading livestock dataâ€¦');
      await loadLivestockIndex();
      firestoreReady = true;
      setStatus('Map ready. Click a paddock to see livestock and diary.');
    }catch(e){
      firestoreReady = false;
      setStatus('Error loading livestock data.');
    }
  } else {
    authWho.textContent = 'Not signed in';
    signOutBtn.classList.add('hidden');
    firestoreReady = false;
    showOverlay(true);
    setStatus('Please sign in to see livestock & diary on paddocks.');
  }
});

/* ---------- Main map load ---------- */
(async ()=>{
  try{
    const bounds = [];
    let loaded = 0;
    for (let i=0;i<CLOUD_URLS.length;i++){
      try{
        const data = await fetchWithFallback(CLOUD_URLS[i], LOCAL_FALLBACKS[i]);
        if (!data || !(data.type === 'FeatureCollection' || data.type === 'Feature')) continue;

        const layer = L.geoJSON(data, {
          style: featureStyle,
          onEachFeature: (feature, lyr)=>{
            const t = feature?.geometry?.type;
            const isPaddock = t === 'Polygon' || t === 'MultiPolygon';
            if (isPaddock){
              lyr.on('click', ()=> handlePaddockClick(i, feature));
            } else if (feature.properties && feature.properties.title){
              lyr.bindTooltip(String(feature.properties.title), {direction:'top'});
            }
          }
        }).addTo(map);

        try{ bounds.push(layer.getBounds()); }catch(_){}
        loaded++;
        setStatus(`Loaded ${loaded} of ${CLOUD_URLS.length} map files`);
      }catch(e){
        // ignore individual source failure
      }
    }

    if (bounds.length){
      let b = bounds[0];
      for (let i=1;i<bounds.length;i++) b = b.extend(bounds[i]);
      map.fitBounds(b, {padding:[20,20]});
    }else{
      setStatus('No features drawn');
    }
  }catch(e){
    setStatus('Error loading map');
  }
})();
</script>
</body>
</html>
