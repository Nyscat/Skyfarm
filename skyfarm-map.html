<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SkyFarm — Property Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Shared styles (header + basics) -->
  <link rel="stylesheet" href="skyfarm-shared.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#f6fbf8; --card:#fff; --ink:#0f172a; --muted:#64748b; --brand:#0B7A6E; --line:#e5e7eb;
    }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{max-width:1200px;margin:0 auto;padding:16px;}
    h1{margin:12px 0;font-size:1.6rem;}
    .panel{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;}
    .muted{color:var(--muted);font-size:.95rem;}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#ecfeff;font-size:.8rem;margin-right:4px;}

    /* Layout */
    .map-layout{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:16px;
      align-items:start;
      width:100%;
    }

    /* Map panel */
    .map-panel{padding:0;}

    /* IMPORTANT FIX:
       On iPhone, we force a real width that can't collapse to 0 */
    #map{
      display:block;
      width:100%;
      max-width:100%;
      height:560px;
      min-height:520px;
      background:#e5e7eb;
      border-radius:12px;
      overflow:hidden;
    }

    /* Leaflet iOS image scaling protection */
    .leaflet-container img{max-width:none !important; max-height:none !important;}
    .leaflet-container .leaflet-tile{max-width:none !important; max-height:none !important;}

    /* Mobile */
    @media (max-width:800px){
      .map-layout{display:block;}
      #map{
        /* Force full usable width on mobile */
        width:calc(100vw - 32px);
        max-width:calc(100vw - 32px);
        height:62vh;
        min-height:520px;
      }
    }

    /* Auth overlay */
    #authOverlay{
      position:fixed; inset:0;
      background:rgba(15,23,42,.06);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
    }
    #authCard{
      width:min(520px,92vw);
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:20px;
    }
    #authCard h2{margin:0 0 10px;}
    button{padding:6px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;}
    .primary{background:var(--brand);color:#fff;border-color:var(--brand);}
    .danger{background:#ef4444;color:#fff;border-color:#ef4444;}
    select,input{padding:6px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;}
    label{font-size:.85rem;color:#475569;display:block;margin-bottom:4px;}
  </style>
</head>

<body>
  <!-- Shared header mount point -->
  <div id="sf-header-root"></div>

  <div class="wrap">
    <div style="display:flex;justify-content:flex-end;gap:10px;align-items:center;margin:6px 0 10px;">
      <button id="signOutBtn" class="danger" type="button" style="display:none;">Sign out</button>
    </div>

    <h1>Property Map</h1>
    <p id="status" class="muted">Loading…</p>

    <div class="panel" style="margin-bottom:12px;">
      <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
        <div>
          <label>Property</label>
          <select id="propertySel" style="min-width:200px;">
            <option value="ALL">(All properties)</option>
          </select>
        </div>
        <span class="muted" id="propertyHint">Zooms map to the selected property’s paddocks.</span>
      </div>
    </div>

    <div class="map-layout">
      <div class="panel map-panel">
        <div id="map"></div>
      </div>

      <aside class="panel" style="margin-top:16px;">
        <h3 style="margin-top:0;">Paddock details</h3>
        <div id="paddockInfo" class="muted">
          Click a paddock to see livestock totals and recent diary entries (last 30 days).
        </div>
      </aside>
    </div>
  </div>

  <!-- Auth overlay -->
  <div id="authOverlay">
    <div id="authCard">
      <h2>Sign in to SkyFarm</h2>
      <p class="muted" style="font-size:.85rem;">Email &amp; password only.</p>
      <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:8px;">
        <div style="flex:1;min-width:260px;">
          <label>Email</label>
          <input id="siEmail" type="email" placeholder="you@example.com" autocomplete="username">
        </div>
        <div style="flex:1;min-width:220px;">
          <label>Password</label>
          <input id="siPass" type="password" placeholder="••••••••" autocomplete="current-password">
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <button id="signInBtn" class="primary" type="button">Sign in</button>
        <span id="authMsg" class="muted" style="font-size:.85rem;"></span>
        <span style="flex:1;"></span>
        <button id="closeOverlayBtn" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- Shared header script -->
  <script src="skyfarm-header.js"></script>

  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
      authDomain: "consentes-pastoral.firebaseapp.com",
      projectId: "consentes-pastoral",
      appId: "1:494858780013:web:d87497b370c82eeab06e64"
    };
    firebase.initializeApp(firebaseConfig);
    const db   = firebase.firestore();
    const auth = firebase.auth();

    // Mount shared header AFTER firebase exists
    SkyFarmHeader.mount();

    // UI refs
    const statusEl = document.getElementById('status');
    const mapEl = document.getElementById('map');
    const signOutBtn = document.getElementById('signOutBtn');
    const authOverlay  = document.getElementById('authOverlay');
    const signInBtn    = document.getElementById('signInBtn');
    const closeOverlay = document.getElementById('closeOverlayBtn');
    const authMsg      = document.getElementById('authMsg');

    function setStatus(t){ statusEl.textContent = t; }
    function showOverlay(on){ authOverlay.style.display = on ? 'flex' : 'none'; }

    // Sign-in handlers
    signInBtn.onclick = async ()=>{
      const email = document.getElementById('siEmail').value.trim();
      const pass  = document.getElementById('siPass').value;
      authMsg.textContent = 'Signing in…';
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        await auth.signInWithEmailAndPassword(email, pass);
        authMsg.textContent = 'Signed in.';
        showOverlay(false);
      }catch(e){
        authMsg.textContent = 'Sign-in failed: ' + (e && e.message ? e.message : 'Unknown error');
      }
    };
    closeOverlay.onclick = ()=> showOverlay(false);
    signOutBtn.onclick = async ()=>{ try{ await auth.signOut(); location.reload(); }catch(e){} };

    // Leaflet init
    const map = L.map('map', {
      zoomControl: true,
      tap: false
    }).setView([-20.0, 142.5], 7);

    function ensureMapSize(){
      try{ map.invalidateSize(true); }catch(e){}
    }

    // IMPORTANT: if iPhone reports width=0 initially, this forces it to recalc
    function fixZeroWidth(){
      const r = mapEl.getBoundingClientRect();
      if (r.width === 0){
        // force a width temporarily
        mapEl.style.width = 'calc(100vw - 32px)';
      }
      setTimeout(ensureMapSize, 50);
      setTimeout(ensureMapSize, 250);
    }
    window.addEventListener('load', ()=>{ fixZeroWidth(); });
    window.addEventListener('resize', ()=>{ fixZeroWidth(); });
    window.addEventListener('orientationchange', ()=> setTimeout(fixZeroWidth, 250));
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(fixZeroWidth, 250); });

    // Tiles
    const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      subdomains: 'abc',
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    tiles.on('load', ()=> setStatus('Map tiles loaded.'));
    tiles.on('tileerror', ()=> setStatus('Map tiles failed to load (tileerror).'));

    // Test marker (if you see this, Leaflet is drawing)
    L.circle([-20.0, 142.5], { radius: 25000 }).addTo(map).bindTooltip('Leaflet OK');

    // Auth state
    auth.onAuthStateChanged(async user=>{
      if (user){
        signOutBtn.style.display = '';
        showOverlay(false);
        setStatus('Signed in. Loading map data…');

        try{ await db.enablePersistence({synchronizeTabs:true}); }catch(e){}

        // ---- PUT YOUR EXISTING FIRESTORE + GEOJSON LOGIC HERE ----
        // loadProperties(), loadPaddocksIndex(), loadLivestockIndex(), loadMapLayers(), etc.
        // ---------------------------------------------------------

        setStatus('Map ready.');
        fixZeroWidth();
      }else{
        signOutBtn.style.display = 'none';
        showOverlay(true);
        setStatus('Please sign in.');
      }
    });
  </script>
</body>
</html>
