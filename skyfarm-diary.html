<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SkyFarm ‚Äî Diary</title>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    :root { --brand:#0B7A6E; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#f6fbf8; --warn:#9a3412; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); margin:0; color:var(--ink); }
    a { color:#0f766e; text-decoration:none; }
    a:hover { text-decoration:underline; }

    #sf-header{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.9);backdrop-filter:blur(14px);border-bottom:1px solid rgba(148,163,184,.5);}
    #sf-header .bar{max-width:1200px;margin:0 auto;padding:6px 12px;display:flex;align-items:center;gap:10px;}
    #sf-header .brand{font-weight:600;font-size:1rem;padding:4px 10px;border-radius:999px;background:radial-gradient(circle at 30% 10%,#e0f2fe,#0f766e);color:#ecfdf3;box-shadow:0 10px 20px rgba(15,23,42,.25);}
    #sf-header nav a{padding:4px 10px;border-radius:999px;font-size:.84rem;color:#0f172a;}
    #sf-header nav a[aria-current="page"]{background:#e0f2fe;font-weight:500;}
    .nav-db{position:relative;margin-left:8px;}
    .spacer{flex:1;}

    .btn{border:1px solid #cbd5e1;border-radius:999px;padding:5px 12px;font-size:.82rem;background:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:4px;}
    .btn.small{padding:3px 10px;font-size:.78rem;}
    .btn.primary{background:#047857;border-color:#047857;color:#ecfdf3;}
    .btn.primary:hover{background:#065f46;border-color:#065f46;}
    .btn.danger{border-color:#ef4444;color:#ef4444;background:#fff;}
    .btn[disabled]{opacity:.5;cursor:default;}

    .db-menu{position:absolute;top:100%;right:0;background:#fff;border:1px solid var(--line);border-radius:10px;min-width:180px;padding:4px 0;box-shadow:0 10px 25px rgba(15,23,42,.12);z-index:20;}
    .db-menu a{display:block;padding:6px 12px;font-size:.85rem;color:var(--ink);}
    .db-menu a:hover{background:#f1f5f9;}
    .hidden{display:none;}

    .wrap{max-width:1200px;margin:0 auto;padding:12px;}
    h1{font-size:1.5rem;margin:10px 0;}

    .card{background:#fff;border-radius:14px;border:1px solid #dbe4ee;padding:12px;margin-top:10px;box-shadow:0 10px 30px rgba(15,23,42,.03);}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    label{display:block;font-size:.8rem;color:#475569;margin-bottom:2px;}
    select,input,textarea{font-size:.85rem;border-radius:10px;border:1px solid #cbd5e1;padding:6px 8px;font-family:inherit;}
    select:focus,input:focus,textarea:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 1px rgba(37,99,235,.25);}
    textarea{min-height:40px;resize:vertical;}

    .muted{color:var(--muted);}
    .small{font-size:.78rem;}
    .pill{display:inline-block;padding:2px 7px;border-radius:999px;background:#e0f2fe;font-size:.7rem;margin-right:4px;}
    .w240{min-width:240px;}
    .w200{min-width:200px;}
    .w140{min-width:140px;}
    .w110{max-width:110px;}

    table{width:100%;border-collapse:collapse;font-size:.8rem;margin-top:6px;}
    th,td{border:1px solid #e5e7eb;padding:4px 6px;text-align:left;}
    th{background:#f9fafb;color:#334155;}
    tr:nth-child(even) td{background:#f9fafb;}

    #filtersRow{align-items:flex-end;}
    #entriesTable td.notes{max-width:350px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    #authOverlay{position:fixed;inset:0;background:radial-gradient(circle at top,#0f172a 0,rgba(15,23,42,.96) 45%,rgba(15,23,42,.98) 100%);display:none;align-items:center;justify-content:center;z-index:50;}
    #authCard{width:min(520px,92vw); background:#fff; border:1px solid var(--line); border-radius:16px; padding:20px}
    #authCard h2{margin:0 0 10px}

    .badge-warn{background:#f97316;color:#7c2d12;padding:2px 6px;border-radius:999px;font-size:.7rem;}

    @media (max-width:800px){
      .row{flex-direction:column;align-items:flex-start;}
      .w240,.w200,.w140,.w110{min-width:100%;max-width:100%;}
      #sf-header .bar{flex-wrap:wrap;}
    }
    @media print{
      body{background:#fff;}
      #sf-header,.no-print{display:none!important;}
      .wrap{padding:8px;}
      .card{box-shadow:none;border:none;margin:0;padding:4px 0;}
      table{font-size:.75rem;}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div id="sf-header">
    <div class="bar">
      <a class="brand" href="skyfarm-diary.html">üå± SkyFarm</a>
      <nav>
  <a href="skyfarm-diary.html" aria-current="page">Diary</a>
  <a href="skyfarm-map.html">Map</a>
  <a href="skyfarm-rain.html">Rain</a>
</nav>
      <div class="nav-db">
        <button id="dbMenuBtn" class="btn small" type="button">Database ‚ñæ</button>
        <div id="dbMenu" class="db-menu hidden">
          <a href="skyfarm-livestock.html">Livestock</a>
          <a href="skyfarm-chemical.html">Chemicals</a>
          <a href="skyfarm-seeds.html">Seeds</a>
          <a href="skyfarm-barcode.html">Barcode Scanner</a>
          <a href="skyfarm-users.html">Users &amp; Roles</a>
        </div>
      </div>
      <span class="spacer"></span>
      <span id="authWho" class="muted">Checking sign-in‚Ä¶</span>
      <button id="signOutBtn" class="btn small danger hidden">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <h1>Diary</h1>

    <!-- Entry form -->
    <div class="card no-print">
      <div class="row">
        <div>
          <label>Property</label>
          <select id="propSel" class="w240"></select>
        </div>
        <div>
          <label>Date</label>
          <input id="dateInp" type="date"/>
        </div>
        <div>
          <label>Time</label>
          <input id="timeInp" type="time"/>
        </div>
        <div>
          <label>Activity</label>
          <select id="activitySel" class="w240">
            <option value="Ploughing">Ploughing</option>
            <option value="Planting">Planting</option>
            <option value="Spraying paddocks">Spraying paddocks</option>
            <option value="Chemical (stock)">Chemical (stock)</option>
            <option value="Trucking (sale)">Trucking (sale)</option>
            <option value="Move stock">Move stock (Paddock ‚Üí Paddock/Yards)</option>
            <option value="Transfer stock (In)">Transfer stock (In)</option>
            <option value="Transfer stock (Out)">Transfer stock (Out)</option>
            <option value="Cattle Received (Purchase)">Cattle Received (Purchase)</option>
            <option value="Mustering">Mustering</option>
            <option value="Rainfall">Rainfall (gauge only)</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <span class="spacer"></span>
        <div class="muted" id="status">‚Äî</div>
      </div>

      <div class="row">
        <div style="min-width:260px">
          <label>Paddock</label>
          <select id="paddockSel" class="w240"><option value="">(choose)</option></select>
          <div class="small muted">Yards appear at the top.</div>
        </div>

        <div id="toPaddockRow" class="hidden" style="min-width:260px">
          <label>To paddock</label>
          <select id="toPaddockSel" class="w240"><option value="">(choose)</option></select>
        </div>

        <div id="transferPropRow" class="hidden" style="min-width:260px">
          <label>To/From Property</label>
          <select id="transferPropSel" class="w240"><option value="">(choose)</option></select>
        </div>

        <div>
          <label>Rainfall (mm to 9am)</label>
          <input id="rainMmInp" type="number" min="0" step="0.1" class="w110"/>
        </div>
        <div>
          <label>Gauge</label>
          <select id="gaugeSel" class="w200">
            <option value="">(none)</option>
          </select>
        </div>

        <div style="flex:1; min-width:260px">
          <label>Notes</label>
          <textarea id="notesInp" placeholder="Short description‚Ä¶"></textarea>
        </div>
      </div>

      <!-- Stock fields -->
      <div id="stockRow" class="row hidden">
        <div>
          <label>Species</label>
          <select id="speciesSel" class="w140">
            <option value="Cattle">Cattle</option>
            <option value="Sheep">Sheep</option>
            <option value="Goats">Goats</option>
          </select>
        </div>
        <div>
          <label>Class</label>
          <input id="classInp" list="classOptions" class="w200" placeholder="e.g. Weaners"/>
          <datalist id="classOptions"></datalist>
        </div>
        <div>
          <label>Head</label>
          <input id="headInp" type="number" min="0" step="1" class="w110"/>
        </div>
        <div id="truckBuyerWrap" class="hidden">
          <label>Buyer / Vendor</label>
          <input id="truckBuyer" class="w200" placeholder="Buyer or vendor name"/>
        </div>
        <div id="truckRefWrap" class="hidden">
          <label>Docket / NVD</label>
          <input id="truckRef" class="w200" placeholder="Docket / NVD reference"/>
        </div>
      </div>

      <!-- Chemical row -->
      <div id="chemRow" class="row hidden">
        <div style="min-width:260px">
          <label>Chemical</label>
          <select id="chemSel" class="w240"></select>
          <div id="chemHint" class="small muted">paddock spray</div>
        </div>
        <div>
          <label>Qty</label>
          <input id="chemQty" type="number" min="0" step="0.01" class="w110"/>
        </div>
        <div>
          <label>Unit</label>
          <input id="chemUnit" class="w110" placeholder="L, kg, mL‚Ä¶"/>
        </div>
      </div>

      <div class="row">
        <div>
          <button id="saveBtn" class="btn primary" type="button">Save entry</button>
        </div>
        <div class="small muted">
          <span id="saveMsg"></span>
        </div>
        <span class="spacer"></span>
        <div class="small muted">
          <span class="badge-warn">TIP</span> Use ‚ÄúAdd action‚Äù below to queue multiple actions (e.g. rainfall + stock movement) then save in one go.
        </div>
      </div>
    </div>

    <!-- Multi-action batch -->
    <div class="card no-print">
      <h3 style="margin-top:0;">Queued actions</h3>
      <div class="row">
        <button id="addActionBtn" class="btn" type="button">Add action from form</button>
        <button id="saveBatchBtn" class="btn primary" type="button">Save all queued</button>
        <span class="small muted" id="batchMsg"></span>
      </div>
      <ol id="actionsOl" class="small" style="margin-top:8px;"></ol>
    </div>

    <!-- Filters + diary table -->
    <div class="card">
      <div id="filtersRow" class="row no-print">
        <div>
          <label>Property</label>
          <select id="filterPropSel" class="w200"></select>
        </div>
        <div>
          <label>From</label>
          <input id="filterFrom" type="date"/>
        </div>
        <div>
          <label>To</label>
          <input id="filterTo" type="date"/>
        </div>
        <div>
          <label>Activity</label>
          <select id="filterAct" class="w200">
            <option value="">(all)</option>
            <option>Rainfall</option>
            <option>Move stock</option>
            <option>Transfer stock (In)</option>
            <option>Transfer stock (Out)</option>
            <option>Trucking (sale)</option>
            <option>Cattle Received (Purchase)</option>
            <option>Spraying paddocks</option>
            <option>Chemical (stock)</option>
            <option>Mustering</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="refreshBtn" class="btn" type="button">Refresh</button>
        </div>
        <span class="spacer"></span>
        <div>
          <label>&nbsp;</label>
          <button id="printDiaryBtn" class="btn" type="button">Print / PDF</button>
        </div>
      </div>

      <table id="entriesTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Property</th>
            <th>Paddock</th>
            <th>Activity</th>
            <th>Stock</th>
            <th>Chemical</th>
            <th>Rain (mm)</th>
            <th class="notes">Notes</th>
          </tr>
        </thead>
        <tbody id="entriesBody">
          <tr><td colspan="9" class="muted small">Loading‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Auth overlay -->
  <div id="authOverlay">
    <div id="authCard">
      <h2>Sign in to SkyFarm</h2>
      <p class="small muted">Email &amp; password only. Anonymous sign-in is disabled.</p>
      <div class="row">
        <div style="flex:1; min-width:220px;">
          <label>Email</label>
          <input id="siEmail" type="email" autocomplete="username" placeholder="you@example.com"/>
        </div>
        <div style="flex:1; min-width:160px;">
          <label>Password</label>
          <input id="siPass" type="password" autocomplete="current-password"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="signInBtn" class="btn primary" type="button">Sign in</button>
        <span id="authMsg" class="small muted"></span>
        <span class="spacer"></span>
        <button id="closeOverlayBtn" class="btn" type="button">Close</button>
      </div>
    </div>
  </div>

<script>
/* -------------------------------------------------------
   Firebase init (compat)
------------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const db   = firebase.firestore();
const auth = firebase.auth();

/* -------------------------------------------------------
   Helpers & constants
------------------------------------------------------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

const PROPERTY_IDS = {};
const PROPERTY_NAME_BY_ID = {};
const SUGGESTED_CLASSES = [
  'Cows & Calves','Pregnant Cows','Weaners','Yearlings','Steers','Heifers','Bulls',
  'Ewes & Lambs','Dry Ewes','Wethers','Rams'
];

function todayISO(){
  const d = new Date();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${d.getFullYear()}-${m}-${day}`;
}
function escapeHtml(str){
  return String(str||'').replace(/[&<>"']/g, s=>(
    s==='&'?'&amp;':s==='<'?'&lt;':s==='>'?'&gt;':s==='"'?'&quot;':'&#039;'
  ));
}

/* -------------------------------------------------------
   DOM refs
------------------------------------------------------- */
const propSel = $('#propSel'), dateInp = $('#dateInp'), timeInp = $('#timeInp'), activitySel = $('#activitySel');
const paddockSel = $('#paddockSel'), toPaddockSel = $('#toPaddockSel'), notesInp = $('#notesInp');
const rainMmInp = $('#rainMmInp'), gaugeSel = $('#gaugeSel');
const transferPropRow = $('#transferPropRow'), transferPropSel = $('#transferPropSel');
const speciesSel = $('#speciesSel'), classInp = $('#classInp'), headInp = $('#headInp'), truckBuyer=$('#truckBuyer'), truckRef=$('#truckRef');
const chemRow = $('#chemRow'), chemSel = $('#chemSel'), chemQty = $('#chemQty'), chemUnit = $('#chemUnit'), chemHint = $('#chemHint');
const stockRow = $('#stockRow'), toPaddockRow = $('#toPaddockRow');
const saveBtn = $('#saveBtn'), saveMsg = $('#saveMsg');
const filterPropSel = $('#filterPropSel'), filterFrom = $('#filterFrom'), filterTo = $('#filterTo'), filterAct = $('#filterAct');
const entriesBody = $('#entriesBody'), statusEl = $('#status');
const addActionBtn = $('#addActionBtn'), saveBatchBtn = $('#saveBatchBtn'), actionsOl = $('#actionsOl'), batchMsg = $('#batchMsg');
const printDiaryBtn = $('#printDiaryBtn');
const dbMenuBtn = $('#dbMenuBtn'), dbMenu = $('#dbMenu');
const authOverlay = $('#authOverlay'), authWho = $('#authWho'), signOutBtn = $('#signOutBtn');
const siEmail = $('#siEmail'), siPass = $('#siPass'), signInBtn = $('#signInBtn'), authMsg = $('#authMsg'), closeOverlayBtn = $('#closeOverlayBtn');

function setMsg(msg, timeoutMs){
  saveMsg.textContent = msg||'';
  if (timeoutMs) setTimeout(()=>{ if (saveMsg.textContent===msg) saveMsg.textContent=''; }, timeoutMs);
}
function setStatus(msg){
  statusEl.textContent = msg || '‚Äî';
}

/* -------------------------------------------------------
   Header DB menu
------------------------------------------------------- */
dbMenuBtn.onclick = e=>{
  e.stopPropagation();
  dbMenu.classList.toggle('hidden');
};
document.addEventListener('click', ()=>dbMenu.classList.add('hidden'));

/* -------------------------------------------------------
   Auth
------------------------------------------------------- */
function showOverlay(show){ authOverlay.style.display = show ? 'flex' : 'none'; }
function setAuthMsg(msg, isError){
  authMsg.textContent = msg || '';
  authMsg.style.color = isError ? '#b91c1c' : '#64748b';
}

signInBtn.onclick = async ()=>{
  const email = siEmail.value.trim();
  const pass  = siPass.value;
  if (!email || !pass){
    setAuthMsg('Enter email and password.', true);
    return;
  }
  setAuthMsg('Signing in‚Ä¶');
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithEmailAndPassword(email, pass);
    setAuthMsg('Signed in.');
    showOverlay(false);
    await onPropertyChange();
    await refreshEntries();
  }catch(e){
    console.error(e);
    setAuthMsg('Sign-in failed: ' + (e?.message || e?.code || 'Unknown'), true);
  }
};
signOutBtn.onclick = async ()=>{
  try{ await auth.signOut(); location.reload(); }catch(e){}
};
closeOverlayBtn.onclick = ()=> showOverlay(false);

auth.onAuthStateChanged(async user=>{
  if (user){
    authWho.textContent = user.email ? `Signed in as ${user.email}` : 'Signed in';
    signOutBtn.classList.remove('hidden');
    showOverlay(false);
    try{ await db.enablePersistence({synchronizeTabs:true}); }catch(e){}
    await loadProperties();
    await onPropertyChange();
    await refreshEntries();
  }else{
    authWho.textContent = 'Not signed in';
    signOutBtn.classList.add('hidden');
    showOverlay(true);
    setStatus('Sign in to edit');
  }
});

/* -------------------------------------------------------
   Load properties / paddocks / chemicals / gauges
------------------------------------------------------- */
async function loadProperties(){
  const snap = await db.collection('properties').get();
  const options = [];
  snap.forEach(doc=>{
    const d = doc.data()||{};
    const name = d.name || '(Property)';
    PROPERTY_IDS[name] = doc.id;
    PROPERTY_NAME_BY_ID[doc.id] = name;
    options.push({id:doc.id,name});
  });
  options.sort((a,b)=>a.name.localeCompare(b.name));
  propSel.innerHTML = options.map(o=>`<option value="${o.id}">${escapeHtml(o.name)}</option>`).join('');
  filterPropSel.innerHTML = '<option value="ALL">(All properties)</option>' +
    options.map(o=>`<option value="${o.id}">${escapeHtml(o.name)}</option>`).join('');
}

async function loadPaddocksForProperty(propertyId){
  paddockSel.innerHTML = '<option value="">(choose)</option>';
  toPaddockSel.innerHTML = '<option value="">(choose)</option>';

  if (!propertyId) return;
  const snap = await db.collection('paddocks')
    .where('propertyId','==',propertyId)
    .orderBy('isYard','desc')
    .orderBy('name').get();

  const opts = [];
  snap.forEach(doc=>{
    const d = doc.data()||{};
    opts.push({id:doc.id,name:d.name||'(paddock)',isYard:!!d.isYard});
  });
  const html = opts.map(p=>`<option value="${p.id}" data-name="${escapeHtml(p.name)}">${p.isYard?'[Yard] ':''}${escapeHtml(p.name)}</option>`).join('');
  paddockSel.innerHTML = '<option value="">(choose)</option>' + html;
  toPaddockSel.innerHTML = '<option value="">(choose)</option>' + html;
}

async function loadChemicalsForProperty(propertyId){
  chemSel.innerHTML = '<option value="">(none)</option>';
  if (!propertyId) return;
  const snap = await db.collection('chemicals').where('propertyId','==',propertyId).orderBy('name').get();
  const html = snap.docs.map(doc=>{
    const d = doc.data()||{};
    return `<option value="${doc.id}">${escapeHtml(d.name||'(chemical)')} (${escapeHtml(d.unit||'unit')})</option>`;
  }).join('');
  chemSel.innerHTML = '<option value="">(none)</option>' + html;
}

async function loadGaugesForProperty(propertyId){
  gaugeSel.innerHTML = '<option value="">(none)</option>';
  if (!propertyId) return;
  const snap = await db.collection('gauges').where('propertyId','==',propertyId).get();
  const html = snap.docs.map(doc=>{
    const d = doc.data()||{};
    return `<option value="${doc.id}">${escapeHtml(d.name||'(gauge)')}</option>`;
  }).join('');
  gaugeSel.innerHTML = '<option value="">(none)</option>' + html;
}

/* -------------------------------------------------------
   Activity-specific UI logic
------------------------------------------------------- */
function onActivityChange(){
  const act = activitySel.value;

  const needsChem = (act==='Spraying paddocks' || act==='Chemical (stock)' || act==='Trucking (sale)');
  chemRow.classList.toggle('hidden', !needsChem);
  chemHint.textContent = (act==='Spraying paddocks') ? 'paddock spray'
                     : (act==='Trucking (sale)' ? 'backline before transport' : 'stock treatment');

  const needsStock = (
    act==='Trucking (sale)' ||
    act==='Move stock' ||
    act==='Chemical (stock)' ||
    act==='Mustering' ||
    act==='Cattle Received (Purchase)' ||
    act.startsWith('Transfer stock')
  );
  stockRow.classList.toggle('hidden', !needsStock);

  const needsTransferProp = (act==='Transfer stock (In)' || act==='Transfer stock (Out)');
  transferPropRow.classList.toggle('hidden', !needsTransferProp);

  const needsToPaddock = (act === 'Move stock');
  toPaddockRow.classList.toggle('hidden', !needsToPaddock);

  const isTruck = (act==='Trucking (sale)' || act==='Cattle Received (Purchase)');
  truckBuyerWrap.classList.toggle('hidden', !isTruck);
  truckRefWrap.classList.toggle('hidden', !isTruck);

  onPaddockOrSpeciesChange();
}

async function onPaddockOrSpeciesChange(){
  const pid = propSel.value;
  const act = activitySel.value;
  const paddockName = paddockSel.selectedOptions[0]?.dataset?.name || '';
  const speciesUI = speciesSel.value || 'Cattle';

  const isStockMove = (
    act==='Trucking (sale)' ||
    act==='Move stock' ||
    act==='Chemical (stock)' ||
    act==='Mustering' ||
    act==='Transfer stock (Out)'
  );
  const isStockIn = (
    act==='Cattle Received (Purchase)' ||
    act==='Transfer stock (In)'
  );

  if ((!paddockName && !isStockIn) || pid==='ALL'){
    $('#classOptions').innerHTML = SUGGESTED_CLASSES.map(r=>`<option value="${escapeHtml(r)}"></option>`).join('');
    return;
  }

  try{
    const q = db.collection('livestock')
      .where('propertyId','==', pid);
    let base = q;
    if (paddockName && isStockMove){
      base = base.where('location','==', paddockName);
    }
    const snap = await base.get();
    const classes = new Set();
    snap.forEach(doc=>{
      const d = doc.data()||{};
      if (!d.class) return;
      if (d.species && String(d.species).toLowerCase() === String(speciesUI).toLowerCase()){
        classes.add(String(d.class));
      }
    });
    const list = (classes.size ? Array.from(classes).sort() : SUGGESTED_CLASSES);
    $('#classOptions').innerHTML = list.map(r=>`<option value="${escapeHtml(r)}"></option>`).join('');
  }catch(e){
    console.error(e);
  }
}

activitySel.onchange = onActivityChange;
paddockSel.onchange = onPaddockOrSpeciesChange;
speciesSel.onchange = onPaddockOrSpeciesChange;

/* -------------------------------------------------------
   Payload builder
------------------------------------------------------- */
function buildPayloadFromUI(){
  const propertyId   = propSel.value;
  const propertyName = PROPERTY_NAME_BY_ID[propertyId] || '';
  const date = dateInp.value || todayISO();
  const time = timeInp.value || '';
  const activity = activitySel.value;
  const paddockId = paddockSel.value || '';
  const paddockName = paddockSel.selectedOptions[0]?.dataset?.name || '';
  const toPaddockId = toPaddockSel.value || '';
  const toPaddockName = toPaddockSel.selectedOptions[0]?.dataset?.name || '';
  const notes = notesInp.value || '';
  const species = speciesSel.value || '';
  const klass = classInp.value || '';
  const head = parseInt(headInp.value||0,10);
  const chemId = chemSel.value || null;
  const chemQ = parseFloat(chemQty.value||0);
  const chemU = chemUnit.value || '';
  const chemName = chemId ? (chemSel.selectedOptions[0]?.textContent.split('(')[0].trim() || null) : null;

  const rainMm = parseFloat(rainMmInp.value||0);
  const gaugeId = gaugeSel.value || null;
  const gaugeName = gaugeId ? (gaugeSel.selectedOptions[0]?.textContent || null) : null;

  const transferPropertyId = transferPropSel.value || null;
  const transferPropertyName = transferPropSel.selectedOptions[0]?.textContent || '';

  const payload = {
    propertyId,
    propertyName,
    date,
    time,
    activity,
    paddockId: paddockId || null,
    paddock: paddockName || null,
    toPaddockId: (activity === 'Move stock' && toPaddockId) ? toPaddockId : null,
    toPaddock: (activity === 'Move stock' && toPaddockName) ? toPaddockName : null,
    notes,
    species: (
      activity==='Mustering' ||
      activity==='Move stock' ||
      activity==='Chemical (stock)' ||
      activity==='Trucking (sale)' ||
      activity==='Cattle Received (Purchase)' ||
      activity.startsWith('Transfer stock')
    ) ? species : null,
    livestockClass: klass || null,
    headCount: (isFinite(head) && head>0) ? head : null,
    chemicalId: chemId || null,
    chemicalName: chemName,
    chemQty: chemId ? chemQ : null,
    chemUnit: chemId ? chemU : null,
    truckBuyer: (activity==='Trucking (sale)' || activity==='Cattle Received (Purchase)') ? (truckBuyer.value || '') : null,
    truckRef:   (activity==='Trucking (sale)' || activity==='Cattle Received (Purchase)') ? (truckRef.value || '')   : null,
    rainfallMm: (isFinite(rainMm) && rainMm>0) ? rainMm : null,
    gaugeId: gaugeId || null,
    gaugeName: gaugeName || null,
    transferPropertyId: transferPropertyId,
    transferPropertyName: transferPropertyName,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  return { payload, propertyId, activity, paddockName, paddockNameTo: toPaddockName, species, klass, head, chemId, chemQ, transferPropertyId, transferPropertyName, gaugeId, rainfallMm: payload.rainfallMm };
}

/* -------------------------------------------------------
   Livestock / chemicals side effects
------------------------------------------------------- */
async function applyLivestockChange({
  activity,
  propertyId,
  paddockName,
  species,
  livestockClass,
  head
}) {
  if (!propertyId || !species || !livestockClass || !head || head <= 0) return;

  let delta = 0;
  if (activity === 'Trucking (sale)' || activity === 'Transfer stock (Out)') {
    delta = -Math.abs(head);
  } else if (activity === 'Cattle Received (Purchase)' || activity === 'Transfer stock (In)') {
    delta = Math.abs(head);
  } else {
    return;
  }

  try {
    const q = await db.collection('livestock')
      .where('propertyId','==',propertyId)
      .where('location','==',paddockName)
      .where('class','==',livestockClass)
      .where('species','==',species)
      .limit(1).get();

    if (!q.empty) {
      const doc = q.docs[0];
      await db.runTransaction(async tx=>{
        const snap = await tx.get(doc.ref);
        if (!snap.exists) return;
        const data = snap.data()||{};
        const current = Number(data.count||0);
        const next = Math.max(0, current + delta);
        tx.set(doc.ref, {
          ...data,
          count: next,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      });
    } else if (delta > 0) {
      // Create line if transferring in / receiving but none exists
      await db.collection('livestock').add({
        propertyId,
        location: paddockName,
        species,
        class: livestockClass,
        count: Math.abs(delta),
        movedIn: todayISO(),
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      console.warn('No livestock line found to subtract from', {
        propertyId,
        paddockName,
        species,
        livestockClass
      });
    }
  } catch (e) {
    console.error('Livestock update failed', e);
  }
}

async function moveLivestockWithinProperty({
  propertyId,
  fromPaddock,
  toPaddock,
  species,
  livestockClass,
  head
}) {
  if (!propertyId || !fromPaddock || !toPaddock) return;
  if (fromPaddock === toPaddock) return;
  if (!species || !livestockClass || !head || head <= 0) return;

  const headInt = Math.floor(Number(head));
  const speciesVariants = [
    species,
    String(species).toLowerCase(),
    String(species).toUpperCase(),
    String(species).charAt(0).toUpperCase()+String(species).slice(1).toLowerCase()
  ];

  try{
    // Find from doc
    let fromDoc = null;
    for (const sp of speciesVariants){
      const snap = await db.collection('livestock')
        .where('propertyId','==',propertyId)
        .where('location','==',fromPaddock)
        .where('species','==',sp)
        .where('class','==',livestockClass)
        .limit(1)
        .get();
      if (!snap.empty) { fromDoc = snap.docs[0]; break; }
    }

    if (fromDoc) {
      await db.runTransaction(async tx => {
        const snap = await tx.get(fromDoc.ref);
        if (!snap.exists) return;
        const data = snap.data() || {};
        const current = Number(data.count || 0);
        const next = Math.max(0, current - headInt);
        tx.set(fromDoc.ref, {
          ...data,
          count: next,
          movedOut: todayISO(),
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      });
    } else {
      console.warn('No livestock row found to move FROM', { propertyId, fromPaddock, species, livestockClass });
    }

    // To paddock
    let toDoc = null;
    for (const sp of speciesVariants){
      const snap = await db.collection('livestock')
        .where('propertyId','==',propertyId)
        .where('location','==',toPaddock)
        .where('species','==',sp)
        .where('class','==',livestockClass)
        .limit(1)
        .get();
      if (!snap.empty) { toDoc = snap.docs[0]; break; }
    }

    if (toDoc) {
      await db.runTransaction(async tx => {
        const snap = await tx.get(toDoc.ref);
        if (!snap.exists) return;
        const data = snap.data() || {};
        const current = Number(data.count || 0);
        const next = current + headInt;
        tx.set(toDoc.ref, {
          ...data,
          count: next,
          movedIn: todayISO(),
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      });
    } else {
      await db.collection('livestock').add({
        propertyId,
        location: toPaddock,
        species,
        class: livestockClass,
        count: headInt,
        movedIn: todayISO(),
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  } catch (e) {
    console.error('Move livestock within property failed', e);
  }
}

/* Rainfall mirror: diary ‚Üí gauges/{gaugeId}/daily/{date} */
async function applyRainfallEntry({ gaugeId, rainfallMm, dateISO }) {
  const mm = Number(rainfallMm);
  if (!gaugeId || !Number.isFinite(mm) || mm <= 0) return;

  const dateStr = (dateISO || todayISO()).slice(0, 10);
  const ref = db
    .collection('gauges')
    .doc(gaugeId)
    .collection('daily')
    .doc(dateStr);

  try {
    await db.runTransaction(async tx => {
      const snap = await tx.get(ref);
      const existing = snap.exists ? Number((snap.data() || {}).mm || 0) : 0;
      const next = (existing || 0) + mm;
      tx.set(ref, {
        mm: next,
        source: 'diary',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    });
  } catch (e) {
    console.error('Rainfall mirror failed', e);
  }
}

/* -------------------------------------------------------
   Save single entry
------------------------------------------------------- */
async function saveEntry(){
  if (propSel.value==='ALL') return alert('Select a specific property to save.');

  const {
    payload,
    propertyId,
    activity,
    paddockName,
    paddockNameTo,
    species,
    klass,
    head,
    chemId,
    chemQ,
    transferPropertyId,
    transferPropertyName,
    gaugeId,
    rainfallMm
  } = buildPayloadFromUI();

  if (!activity){
    alert('Choose an activity.');
    return;
  }

  if (activity === 'Move stock') {
    if (!paddockName) {
      alert('Choose the paddock you are moving FROM.');
      return;
    }
    if (!paddockNameTo) {
      alert('Choose the paddock you are moving TO.');
      return;
    }
    if (!klass || !head || head <= 0) {
      alert('For Move stock you must set Class and Head.');
      return;
    }
  }

  if (activity.startsWith('Transfer stock')) {
    if (!transferPropertyId) {
      alert('Choose the other property in ‚ÄúTo/From Property‚Äù.');
      return;
    }
    if (!klass || !head || head <= 0) {
      alert('For Transfer stock you must set Class and Head.');
      return;
    }
  }

  if (activity === 'Rainfall') {
    if (!gaugeId || !rainfallMm) {
      alert('For Rainfall you must pick a gauge and enter rainfall mm.');
      return;
    }
  }

  try {
    await db.collection('diaryEntries').add(payload);

    const sideEffects = [
      applyChemicalUsage({
        activity,
        propertyId,
        chemId,
        chemQty: chemQ
      }),
      applyLivestockChange({
        activity,
        propertyId,
        paddockName,
        species,
        livestockClass: klass,
        head
      }),
      applyRainfallEntry({
        gaugeId,
        rainfallMm,
        dateISO: payload.date
      })
    ];

    if (activity === 'Move stock') {
      sideEffects.push(
        moveLivestockWithinProperty({
          propertyId,
          fromPaddock: paddockName,
          toPaddock: paddockNameTo,
          species,
          livestockClass: klass,
          head
        })
      );
    }

    await Promise.all(sideEffects);

    setMsg('Saved');
    await refreshEntries();
  } catch(e){
    console.error(e);
    setMsg('Save failed', 3000);
  }
}

/* -------------------------------------------------------
   Multi-action batch
------------------------------------------------------- */
const actions = [];
function renderQueued(){
  actionsOl.style.display = actions.length ? 'block' : 'none';
  actionsOl.innerHTML = actions.map((a,i)=>(
    `<li><span class="pill">${escapeHtml(a.activity)}</span> ${escapeHtml(a.propertyName||'')} ‚Äî ${escapeHtml(a.paddock||'')} ${a.rainfallMm?`¬∑ ${a.rainfallMm}mm`:''} ${a.headCount?`¬∑ ${a.headCount} head`:''} <button data-i="${i}" class="btn small">Remove</button></li>`
  )).join('');
  actionsOl.querySelectorAll('button[data-i]').forEach(b=>{
    b.onclick = () => { actions.splice(Number(b.dataset.i),1); renderQueued(); };
  });
}
function currentActionFromUI(){
  const { payload, propertyId, activity, paddockName, species, klass, head, chemId, chemQ, transferPropertyId, transferPropertyName, gaugeId, rainfallMm } = buildPayloadFromUI();
  return {
    ...payload,
    propertyId,
    activity,
    paddock: payload.paddock,
    toPaddockId: payload.toPaddockId,
    toPaddock: payload.toPaddock,
    species,
    livestockClass: klass,
    headCount: payload.headCount,
    chemicalId: chemId,
    chemicalName: payload.chemicalName,
    chemQty: chemQ,
    chemUnit: payload.chemUnit,
    gaugeId,
    rainfallMm,
    date: payload.date,
    transferPropertyId,
    transferPropertyName
  };
}
addActionBtn.onclick = ()=>{
  if (propSel.value==='ALL') { alert('Choose a specific property'); return; }
  const a = currentActionFromUI();
  actions.push(a);
  renderQueued();
};

saveBatchBtn.onclick = async ()=>{
  if (!actions.length) { alert('No actions queued. Click ‚ÄúAdd action‚Äù first.'); return; }
  const batchId = 'b_'+Date.now();
  batchMsg.textContent = 'Saving‚Ä¶';
  try{
    const batch = db.batch();
    actions.forEach((a, idx)=>{
      const ref = db.collection('diaryEntries').doc();
      batch.set(ref, { ...a, batchId, batchIndex: idx, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    });
    await batch.commit();

    await Promise.all(actions.map(a => {
      const sideEffects = [
        applyChemicalUsage({
          activity: a.activity,
          propertyId: a.propertyId,
          chemId: a.chemicalId,
          chemQty: a.chemQty
        }),
        applyLivestockChange({
          activity: a.activity,
          propertyId: a.propertyId,
          paddockName: a.paddock,
          species: a.species,
          livestockClass: a.livestockClass,
          head: a.headCount
        }),
        applyRainfallEntry({
          gaugeId: a.gaugeId,
          rainfallMm: a.rainfallMm,
          dateISO: a.date
        })
      ];
      if (a.activity === 'Move stock') {
        sideEffects.push(
          moveLivestockWithinProperty({
            propertyId: a.propertyId,
            fromPaddock: a.paddock,
            toPaddock: a.toPaddock,
            species: a.species,
            livestockClass: a.livestockClass,
            head: a.headCount
          })
        );
      }
      return Promise.all(sideEffects);
    }));

    actions.length = 0; renderQueued();
    batchMsg.textContent = 'Saved.'; setTimeout(()=>batchMsg.textContent='', 1500);
    await refreshEntries();
  }catch(e){
    console.error(e);
    batchMsg.textContent = 'Save failed.'; setTimeout(()=>batchMsg.textContent='', 3000);
  }
};

/* -------------------------------------------------------
   Diary table & filters
------------------------------------------------------- */
async function refreshEntries(){
  entriesBody.innerHTML = '<tr><td colspan="9" class="muted small">Loading‚Ä¶</td></tr>';
  try{
    let q = db.collection('diaryEntries').orderBy('date','desc').orderBy('time','desc').limit(500);
    const fp = filterPropSel.value;
    if (fp && fp!=='ALL') q = q.where('propertyId','==',fp);
    const fa = filterAct.value;
    if (fa) q = q.where('activity','==',fa);

    const from = filterFrom.value;
    const to = filterTo.value;
    if (from) q = q.where('date','>=',from);
    if (to) q = q.where('date','<=',to);

    const snap = await q.get();
    if (snap.empty){
      entriesBody.innerHTML = '<tr><td colspan="9" class="muted small">No entries in this range.</td></tr>';
      return;
    }
    const rows = [];
    snap.forEach(doc=>{
      const d = doc.data()||{};
      const stock = d.headCount ? `${d.headCount} ${d.species||''} ${d.livestockClass||''}`.trim() : '';
      const chem = d.chemicalName ? `${d.chemicalName} ${d.chemQty||''} ${d.chemUnit||''}`.trim() : '';
      rows.push(`<tr>
        <td>${escapeHtml(d.date||'')}</td>
        <td>${escapeHtml(d.time||'')}</td>
        <td>${escapeHtml(d.propertyName||'')}</td>
        <td>${escapeHtml(d.paddock||'')}</td>
        <td>${escapeHtml(d.activity||'')}</td>
        <td>${escapeHtml(stock)}</td>
        <td>${escapeHtml(chem)}</td>
        <td>${d.rainfallMm!=null ? escapeHtml(String(d.rainfallMm)) : ''}</td>
        <td class="notes">${escapeHtml(d.notes||'')}</td>
      </tr>`);
    });
    entriesBody.innerHTML = rows.join('');
  }catch(e){
    console.error(e);
    entriesBody.innerHTML = '<tr><td colspan="9" class="muted small">Error loading entries.</td></tr>';
  }
}

/* -------------------------------------------------------
   Property change
------------------------------------------------------- */
async function onPropertyChange(){
  transferPropSel.innerHTML = '<option value="">(choose)</option>' +
    Object.entries(PROPERTY_IDS).filter(([n,id])=> id!==propSel.value)
      .map(([n,id])=>`<option value="${id}">${n}</option>`).join('');

  await loadPaddocksForProperty(propSel.value);
  await loadChemicalsForProperty(propSel.value);
  await loadGaugesForProperty(propSel.value);
  await onPaddockOrSpeciesChange();
}

propSel.onchange = async ()=>{
  await onPropertyChange();
  await refreshEntries();
};
filterPropSel.onchange = refreshEntries;
filterFrom.onchange = refreshEntries;
filterTo.onchange = refreshEntries;
filterAct.onchange = refreshEntries;
$('#refreshBtn').onclick = refreshEntries;
printDiaryBtn.onclick = ()=>window.print();

/* -------------------------------------------------------
   Init
------------------------------------------------------- */
window.addEventListener('load', ()=>{
  dateInp.value = todayISO();
  filterFrom.value = todayISO();
  filterTo.value = todayISO();
  onActivityChange();
});
</script>
</body>
</html>
