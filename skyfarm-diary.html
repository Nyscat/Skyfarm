<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8"/>
Â  <meta name="viewport" content="width=device-width, initial-scale=1"/>
Â  <title>SkyFarm â€” Diary</title>

Â  Â  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

Â  <style>
Â  Â  /* FULL STYLES ADOPTED AND CORRECTED FOR DIARY PAGE */
Â  Â  :root { --brand:#0B7A6E; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#f6fbf8; }
Â  Â  * { box-sizing: border-box; }
Â  Â  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); margin:0; color:var(--ink); }
Â  Â  .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
Â  Â  h1 { margin: 12px 0; font-size: 1.6rem; }

Â  Â  /* Header */
Â  Â  #skyfarm-header { position:sticky; top:0; z-index:10; }
Â  Â  #skyfarm-header .bar { display:flex; align-items:center; gap:12px; padding:10px 14px; background:#fff; border-bottom:1px solid #e5e7eb; }
Â  Â  #skyfarm-header .brand { display:flex; align-items:center; gap:10px; color:var(--brand); font-weight:700; text-decoration:none; }
Â  Â  #skyfarm-header nav a { color:var(--brand); text-decoration:none; font-weight:600; margin-right:10px; }
Â  Â  #skyfarm-header nav a[aria-current="page"] { text-decoration:underline; }
Â  Â  .spacer { flex:1; }
Â  Â  .muted { color:var(--muted); font-size:.9rem; }
Â  Â  .hidden { display:none; }
Â  Â  
Â  Â  /* Cards / Controls */
Â  Â  .card { background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0; }
Â  Â  .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; align-items:center; }
Â  Â  label { font-size:.9rem; color:#475569; margin-bottom:4px; display:block; }
Â  Â  
Â  Â  /* *** FINAL CRITICAL FIX: Ensure form fields expand to 100% of their parent DIV *** */
Â  Â  input, select, textarea { 
Â  Â  Â  width: 100%; 
Â  Â  } 
Â  Â  
Â  Â  input, select, button { padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
Â  Â  button { cursor:pointer; width: auto; } /* Buttons should not take full width */
Â  Â  
Â  Â  .btn { border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
Â  Â  .primary { background:var(--brand); color:#fff; border-color:var(--brand); }
Â  Â  .danger { background:#ef4444; color:#fff; border-color:#ef4444; }
Â  Â  .disabled { opacity:.55; pointer-events:none; }
Â  Â  .small { font-size:.9rem; }
Â  Â  .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#e2e8f0; font-size:.8rem; margin-right:6px; }

Â  Â  /* Table */
Â  Â  table { width: 100%; border-collapse: collapse; }
Â  Â  th, td { border-bottom: 1px solid var(--line); padding: 8px; text-align: left; font-size: .95rem; }
Â  Â  th { background:#f1f5f9; }
Â  Â  .nowrap { white-space: nowrap; }

Â  Â  /* Sign-in overlay (Hidden by default, shown by JS if not signed in) */
Â  Â  #authOverlay{position:fixed; inset:0; background:rgba(15,23,42,.06); display:none; align-items:center; justify-content:center; z-index:50}
Â  Â  #authCard{width:min(520px,92vw); background:#fff; border:1px solid var(--line); border-radius:16px; padding:20px}
Â  Â  #authCard h2{margin:0 0 8px}
Â  Â  .status-bad{color:#b45309}
Â  </style>
</head>
<body>

<div id="skyfarm-header">
Â  <div class="bar">
Â  Â  <a class="brand" href="#">ðŸŒ± SkyFarm</a>
Â  Â  <nav>
Â  Â  Â  <a id="navDiary" href="skyfarm-diary.html" aria-current="page">Diary</a>
Â  Â  Â  <a id="navMap" href="skyfarm-map.html">Map</a>
Â  Â  Â  <a id="navChem" href="skyfarm-chemical.html">Chemicals</a>
Â  Â  </nav>
Â  Â  <span class="spacer"></span>
Â  Â  <span id="authWho" class="muted">Checking sign-inâ€¦</span>
Â  Â  <button id="signOutBtn" class="danger hidden" style="width: auto;">Sign out</button>
Â  </div>
</div>
<div class="wrap">
Â  <h1>SkyFarm â€” Diary</h1>

Â  Â  <div class="card">
Â  Â  Â  Â  <div class="row">
Â  Â  Â  <div style="flex-basis: 220px;">
Â  Â  Â  Â  <label>Property</label>
Â  Â  Â  Â  <select id="propSel"></select>
Â  Â  Â  </div>
Â  Â  Â  <div style="flex-basis: 150px;">
Â  Â  Â  Â  <label>Date</label>
Â  Â  Â  Â  <input id="dateInp" type="date"/>
Â  Â  Â  </div>
Â  Â  Â  <div style="flex-basis: 100px;">
Â  Â  Â  Â  <label>Time</label>
Â  Â  Â  Â  <input id="timeInp" type="time"/>
Â  Â  Â  </div>
Â  Â  Â  <div style="flex-basis: 220px;">
Â  Â  Â  Â  <label>Activity</label>
Â  Â  Â  Â  <select id="activitySel">
Â  Â  Â  Â  Â  <option>Mustering / Moving stock</option>
Â  Â  Â  Â  Â  <option>Trucking (sales/transfer)</option>
Â  Â  Â  Â  Â  <option>Ploughing</option>
Â  Â  Â  Â  Â  <option>Planting</option>
Â  Â  Â  Â  Â  <option>Spraying</option>
Â  Â  Â  Â  Â  <option>General note</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>
Â  Â  Â  <span class="spacer"></span>
Â  Â  Â  <div>
Â  Â  Â  Â  <label>&nbsp;</label>
Â  Â  Â  Â  <span id="status" class="muted">â€”</span>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  <div style="flex-basis: 260px;">
Â  Â  Â  Â  <label>Paddock</label>
Â  Â  Â  Â  <select id="paddockSel"><option value="">(choose)</option></select>
Â  Â  Â  Â  <div class="small"><a href="javascript:void(0)">Canâ€™t see it? Type paddock name instead.</a></div>
Â  Â  Â  </div>
Â  Â  Â  <div style="flex:1;">
Â  Â  Â  Â  <label>Notes</label>
Â  Â  Â  Â  <input id="notesInp" placeholder="optional"/>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  <button id="saveBtn" class="primary" style="width: auto;">Save entry</button>
Â  Â  Â  <button id="resetBtn" class="btn" type="button" style="width: auto;">Reset</button>
Â  Â  Â  <span id="msg" class="muted" aria-live="polite"></span>
Â  Â  </div>
Â  </div>

Â  Â  <div class="card">
Â  Â  <div class="row">
Â  Â  Â  <strong>Recent entries</strong>
Â  Â  Â  <span class="spacer"></span>
Â  Â  Â  <div>
Â  Â  Â  Â  <label>Year</label>
Â  Â  Â  Â  <input id="yearInp" type="number" min="2000" max="2100" style="width:110px"/>
Â  Â  Â  </div>
Â  Â  Â  <button id="refreshBtn" class="btn" type="button" style="width: auto;">Refresh</button>
Â  Â  </div>
Â  Â  <table>
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th>Date</th><th>Property</th><th>Activity</th><th>Paddock</th><th>Notes</th><th></th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody id="entriesTbody"><tr><td colspan="6">Loading entriesâ€¦</td></tr></tbody>
Â  Â  </table>
Â  </div>
</div>

<div id="authOverlay">
Â  <div id="authCard">
Â  Â  <h2>Sign in to SkyFarm</h2>
Â  Â  <p class="small muted">Email &amp; password only. Anonymous sign-in is disabled.</p>
Â  Â  <div class="row">
Â  Â  Â  <div style="flex:1; min-width:260px">
Â  Â  Â  Â  <label>Email</label>
Â  Â  Â  Â  <input id="siEmail" type="email" placeholder="you@example.com" autocomplete="username"/>
Â  Â  Â  </div>
Â  Â  Â  <div style="flex:1; min-width:220px">
Â  Â  Â  Â  <label>Password</label>
Â  Â  Â  Â  <input id="siPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="row">
Â  Â  Â  <button id="signInBtn" class="primary" style="width: auto;">Sign in</button>
Â  Â  Â  <span id="authMsg" class="muted"></span>
Â  Â  Â  <span class="spacer"></span>
Â  Â  Â  <button id="closeOverlayBtn" class="btn" type="button" style="width: auto;">Close</button>
Â  Â  </div>
Â  </div>
</div>

<script>
/* -------------------------------------------------------
Â  Â Firebase init (compat)
------------------------------------------------------- */
const firebaseConfig = {
Â  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70", // <-- VERIFIED KEY
Â  authDomain: "consentes-pastoral.firebaseapp.com",
Â  projectId: "consentes-pastoral",
Â  storageBucket: "consentes-pastoral.appspot.com",
Â  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const dbÂ  Â = firebase.firestore();

/* -------------------------------------------------------
Â  Â Helpers & Properties
------------------------------------------------------- */
const $ = s => document.querySelector(s);
const setMsg = (t, ms=3000)=>{ $('#msg').textContent=t||''; if(t && ms){ setTimeout(()=>$('#msg').textContent='', ms); } };
const errText = e => e?.message || e?.code || 'Unknown error';

const PROPS = [
Â  { id:"s7PlDM9wrEpxuJ6DGIab", name:"Consentes", lat:-20.263323, lon:141.609607 },
Â  { id:"P0dQ0H2FWHeqqxejflZs", name:"Gerawin",Â  Â lat:-20.114428, lon:141.751857 },
Â  { id:"TRuxtRBX2zJlwZnRGYKJ", name:"Mt Myrtle", lat:-26.566565, lon:149.997202 }
];
const DEFAULT_PROP_ID = "TRuxtRBX2zJlwZnRGYKJ";


/* -------------------------------------------------------
Â  Â Auth (Handles persistence check on load)
------------------------------------------------------- */
const overlay = $('#authOverlay');
const signOutBtn = $('#signOutBtn');
const authWho = $('#authWho');

function showOverlay(show){ overlay.style.display = show ? 'flex' : 'none'; }

$('#signInBtn').onclick = async ()=>{
Â  const email = $('#siEmail').value.trim();
Â  const passÂ  = $('#siPass').value;
Â  $('#authMsg').textContent = 'Signing inâ€¦';
Â  try{
Â  Â  await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
Â  Â  await auth.signInWithEmailAndPassword(email, pass);
Â  Â  $('#authMsg').textContent = 'Signed in.';
Â  Â  showOverlay(false);
Â  Â  await loadPaddocks($('#propSel').value);
Â  Â  await refreshEntries();
Â  }catch(e){
Â  Â  $('#authMsg').textContent = 'Sign-in failed: ' + errText(e);
Â  }
};

$('#signOutBtn').onclick = async ()=>{ 
    try{ 
        await auth.signOut();
        location.reload();
    }catch(e){} 
};

$('#closeOverlayBtn').onclick = ()=>{ 
    showOverlay(false); 
};


async function requireSignedIn(){
Â  return new Promise(resolve=>{
Â  Â  auth.onAuthStateChanged(async u=>{
Â  Â  Â  if(u){
Â  Â  Â  Â  authWho.textContent = u.email ? `Signed in as ${u.email}` : 'Signed in';
Â  Â  Â  Â  signOutBtn.classList.remove('hidden');
Â  Â  Â  Â  showOverlay(false);
Â  Â  Â  Â  await loadPaddocks($('#propSel').value); 
Â  Â  Â  Â  await refreshEntries();
Â  Â  Â  Â  resolve(true);
Â  Â  Â  }else{
Â  Â  Â  Â  authWho.textContent = 'Not signed in';
Â  Â  Â  Â  signOutBtn.classList.add('hidden');
Â  Â  Â  Â  showOverlay(true);
Â  Â  Â  Â  resolve(false);
Â  Â  Â  }
Â  Â  });
Â  });
}

/* -------------------------------------------------------
Â  Â Data Loading
------------------------------------------------------- */
const paddockSel = $('#paddockSel');
const entriesTbody = $('#entriesTbody');

async function loadPaddocks(propertyId){
Â  if(!auth.currentUser) return; 
Â  paddockSel.innerHTML = '<option>(loadingâ€¦)</option>';
Â  try{
Â  Â  const snap = await db.collection('paddocks').where('propertyId','==',propertyId).get();
Â  Â  const rows=[]; snap.forEach(d=> rows.push({id:d.id, ...d.data()}));
Â  Â  
Â  Â  if (rows.length === 0) {
Â  Â  Â  paddockSel.innerHTML = '<option value="">(no paddocks found)</option>';
Â  Â  } else {
Â  Â  Â  rows.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));
Â  Â  Â  const paddockOption = p => `<option value="${p.id}" data-name="${p.name||''}">${p.name||'(unnamed)'}</option>`;
Â  Â  Â  paddockSel.innerHTML = '<option value="">(choose)</option>' + rows.map(paddockOption).join('');
Â  Â  }
Â  }catch(e){
Â  Â  paddockSel.innerHTML = '<option value="">(load error)</option>';
Â  Â  console.error('Paddocks load error:', e.message); 
Â  }
}

async function refreshEntries(){
Â  if(!auth.currentUser) { 
      entriesTbody.innerHTML = '<tr><td colspan="6" class="muted">Sign in to load entriesâ€¦</td></tr>';
      return; 
    } 
    
Â  const propertyId = $('#propSel').value;
Â  entriesTbody.innerHTML = '<tr><td colspan="6">Loading entriesâ€¦</td></tr>';
Â  try{
Â  Â  const snap = await db.collection('diaryEntries')
Â  Â  Â  .where('propertyId','==',propertyId)
Â  Â  Â  .orderBy('date','desc')
Â  Â  Â  .limit(50)
Â  Â  Â  .get();
Â  Â  
Â  Â  const rows=[];
Â  Â  snap.forEach(d=> rows.push({id:d.id, ...d.data()}));
Â  Â  
    if(!rows.length){ entriesTbody.innerHTML = '<tr><td colspan="6" class="muted">No entries.</td></tr>'; return; }
    entriesTbody.innerHTML = rows.map(r=>`<tr><td>${r.date||''}</td><td>${r.propertyName||''}</td><td>${r.activity||''}</td><td>${r.paddock||''}</td><td>${r.notes||''}</td><td><button data-id="${r.id}" class="danger btn" style="width: auto;">Delete</button></td></tr>`).join('');
Â  }catch(e){
Â  Â  entriesTbody.innerHTML = `<tr><td colspan="6" style="color:#b45309">Failed to read entries. Check console.</td></tr>`;
Â  Â  console.error('Entries load error:', e); 
Â  }
}


/* -------------------------------------------------------
Â  Â Page bootstrap
------------------------------------------------------- */
(async function init(){
Â  const base = location.origin || '';
Â  // Ensure nav links use full relative paths for consistency
Â  $('#navDiary').href = 'skyfarm-diary.html';
Â  $('#navMap').hrefÂ  Â = 'skyfarm-map.html';
Â  $('#navChem').hrefÂ  = 'skyfarm-chemical.html';

Â  $('#dateInp').value = new Date().toISOString().slice(0,10);
Â  
Â  const propSel = $('#propSel');
Â  propSel.innerHTML = PROPS.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
Â  propSel.value = DEFAULT_PROP_ID;
Â  propSel.onchange = ()=> { loadPaddocks(propSel.value); refreshEntries(); };
Â  $('#refreshBtn').onclick = refreshEntries;

Â  await requireSignedIn(); 
})();
</script>
</body>
</html>
