<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SkyFarm â€” Diary (Email/Password only)</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
    :root { --brand:#0B7A6E; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#f6fbf8; }
    *{box-sizing:border-box}
    body{margin:16px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink)}
    .wrap{max-width:1100px; margin:0 auto}
    h1{margin:0 0 12px; font-size:1.6rem}
    .card{background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0}
    .row{display:flex; flex-wrap:wrap; gap:10px; margin:8px 0}
    label{display:block; font-size:.9rem; color:#475569; margin-bottom:4px}
    input,select,button{padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff}
    button{cursor:pointer}
    .primary{background:var(--brand); border-color:var(--brand); color:#fff}
    .danger{background:#ef4444; border-color:#ef4444; color:#fff}
    .muted{color:var(--muted); font-size:.9rem}
    .spacer{flex:1}
    .hidden{display:none}
    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line); padding:8px; text-align:left}
    th{background:#f1f5f9}
    .pill{padding:2px 8px; border-radius:999px; background:#e2e8f0; font-size:.8rem}
    .topbar{display:flex; align-items:center; gap:10px; margin-bottom:8px}
    .topbar .brand{font-weight:600}
    .status-ok{color:#0B7A6E}
    .status-bad{color:#b45309}
    /* Sign-in overlay */
    #authOverlay{position:fixed; inset:0; background:rgba(15,23,42,.06); display:none; align-items:center; justify-content:center; z-index:50}
    #authCard{width:min(520px,92vw); background:#fff; border:1px solid var(--line); border-radius:16px; padding:20px}
    #authCard h2{margin:0 0 8px}
    .small{font-size:.9rem}
  </style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="topbar">
    <div class="brand">ðŸŒ± SkyFarm</div>
    <a id="navDiary" href="#" class="pill">Diary</a>
    <a id="navMap" href="#" class="pill">Map</a>
    <a id="navChem" href="#" class="pill">Chemicals</a>
    <span class="spacer"></span>
    <span id="authWho" class="muted">Checking sign-inâ€¦</span>
    <button id="signOutBtn" class="danger hidden">Sign out</button>
  </div>

  <h1>SkyFarm â€” Diary</h1>

  <!-- FORM -->
  <div class="card">
    <div class="row">
      <div>
        <label>Property</label>
        <select id="propSel" style="min-width:240px"></select>
      </div>
      <div>
        <label>Date</label>
        <input id="dateInp" type="date"/>
      </div>
      <div>
        <label>Time</label>
        <input id="timeInp" type="time"/>
      </div>
      <div>
        <label>Activity</label>
        <select id="activitySel" style="min-width:220px">
          <option value="Mustering / Moving stock">Mustering / Moving stock</option>
          <option value="Trucking">Trucking (sales/transfer)</option>
          <option value="Ploughing">Ploughing</option>
          <option value="Planting">Planting</option>
          <option value="Spraying">Spraying</option>
          <option value="General note">General note</option>
        </select>
      </div>
      <span class="spacer"></span>
      <div>
        <label>&nbsp;</label>
        <span id="status" class="muted">â€”</span>
      </div>
    </div>

    <div class="row">
      <div style="min-width:260px">
        <label>Paddock</label>
        <select id="paddockSel" style="min-width:260px"><option value="">(choose)</option></select>
        <div class="small"><a id="typePaddockLink" href="javascript:void(0)">Canâ€™t see it? Type paddock name instead.</a></div>
      </div>
      <div style="min-width:260px; flex:1">
        <label>Notes</label>
        <input id="notesInp" placeholder="optional"/>
      </div>
    </div>

    <!-- Weather quick stub -->
    <div class="row">
      <button id="getWeatherBtn">Get weather</button>
      <span id="weatherText" class="muted"></span>
    </div>

    <div class="row">
      <button id="saveBtn" class="primary">Save entry</button>
      <button id="resetBtn">Reset</button>
      <span id="msg" class="muted" aria-live="polite"></span>
    </div>
  </div>

  <!-- LIST -->
  <div class="card">
    <div class="row">
      <strong>Recent entries</strong>
      <span class="spacer"></span>
      <label>Year</label>
      <input id="yearInp" type="number" min="2000" max="2100" style="width:110px"/>
      <button id="refreshBtn">Refresh</button>
    </div>
    <table>
      <thead>
      <tr>
        <th>Date</th><th>Property</th><th>Activity</th><th>Paddock</th><th>Notes</th><th></th>
      </tr>
      </thead>
      <tbody id="entriesTbody"><tr><td colspan="6">Sign in to load entriesâ€¦</td></tr></tbody>
    </table>
  </div>
</div>

<!-- Sign-in overlay (email/password) -->
<div id="authOverlay">
  <div id="authCard">
    <h2>Sign in to SkyFarm</h2>
    <p class="small muted">Email &amp; password only. Anonymous sign-in is disabled.</p>
    <div class="row">
      <div style="flex:1; min-width:260px">
        <label>Email</label>
        <input id="siEmail" type="email" placeholder="you@example.com" autocomplete="username"/>
      </div>
      <div style="flex:1; min-width:220px">
        <label>Password</label>
        <input id="siPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
      </div>
    </div>
    <div class="row">
      <button id="signInBtn" class="primary">Sign in</button>
      <span id="authMsg" class="muted"></span>
      <span class="spacer"></span>
      <button id="closeOverlayBtn">Close</button>
    </div>
  </div>
</div>

<script>
/* -------------------------------------------------------
   Firebase init (compat) â€” Email/Password ONLY
------------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJlGvBwmW70",
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  storageBucket: "consentes-pastoral.appspot.com",
  messagingSenderId: "494858780013",
  appId: "1:494858780013:web:d87497b370c82eeab06e64",
  measurementId: "G-9MSLTVW70N"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* -------------------------------------------------------
   Helpers & small UI bits
------------------------------------------------------- */
const $ = s => document.querySelector(s);
const setStatus = t => {
  const el = $('#status');
  el.textContent = t || '';
  el.className = (/connected/i.test(t||'')) ? 'status-ok' : (/issue|error|denied/i.test(t||'') ? 'status-bad' : 'muted');
};
const setMsg = (t, ms=3000)=>{ $('#msg').textContent=t||''; if(t && ms){ setTimeout(()=>$('#msg').textContent='', ms); } };
const todayISO = ()=> new Date().toISOString().slice(0,10);
const escapeHtml = s => String(s ?? '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

/* -------------------------------------------------------
   Properties (IDs you provided)
------------------------------------------------------- */
const PROPS = [
  { id:"s7PlDM9wrEpxuJ6DGIab", name:"Consentes" },
  { id:"P0dQ0H2FWHeqqxejflZs", name:"Gerawin" },
  { id:"TRuxtRBX2zJlwZnRGYKJ", name:"Mt Myrtle" }
];
const DEFAULT_PROP_ID = "TRuxtRBX2zJlwZnRGYKJ"; // Mt Myrtle

/* -------------------------------------------------------
   Auth flow (no anonymous)
------------------------------------------------------- */
const overlay = $('#authOverlay');
const signOutBtn = $('#signOutBtn');
const authWho = $('#authWho');

function showOverlay(show){ overlay.style.display = show ? 'flex' : 'none'; }
function errText(e){ return e?.message || e?.code || 'Unknown error'; }

$('#signInBtn').onclick = async ()=>{
  const email = $('#siEmail').value.trim();
  const pass  = $('#siPass').value;
  $('#authMsg').textContent = 'Signing inâ€¦';
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithEmailAndPassword(email, pass);
    $('#authMsg').textContent = 'Signed in.';
    showOverlay(false);
  }catch(e){
    $('#authMsg').textContent = 'Sign-in failed: ' + errText(e);
  }
};
$('#closeOverlayBtn').onclick = ()=> showOverlay(false);

signOutBtn.onclick = async ()=>{
  try{ await auth.signOut(); }catch(e){}
};

async function requireSignedIn(){
  setStatus('Checking sign-inâ€¦');
  return new Promise(resolve=>{
    auth.onAuthStateChanged(u=>{
      if(u){
        authWho.textContent = u.email ? `Signed in as ${u.email}` : 'Signed in';
        signOutBtn.classList.remove('hidden');
        setStatus('Connected');
        resolve(true);
      }else{
        authWho.textContent = 'Not signed in';
        signOutBtn.classList.add('hidden');
        setStatus('Please sign in (Email/Password).');
        showOverlay(true);
        resolve(false);
      }
    });
  });
}

/* -------------------------------------------------------
   Diary UI bootstrap (runs after sign-in)
------------------------------------------------------- */
const propSel = $('#propSel'), dateInp = $('#dateInp'), timeInp = $('#timeInp'),
      activitySel = $('#activitySel'), notesInp = $('#notesInp'),
      paddockSel = $('#paddockSel'), entriesTbody = $('#entriesTbody');

$('#refreshBtn').onclick = refreshEntries;
$('#resetBtn').onclick = ()=> resetForm();
$('#saveBtn').onclick = ()=> saveEntry().catch(e=> setMsg('Save failed: ' + errText(e), 5000));

function populateProperties(){
  propSel.innerHTML = PROPS.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
  propSel.value = DEFAULT_PROP_ID;
}
function resetForm(){
  dateInp.value = todayISO(); timeInp.value = '';
  activitySel.value = 'Ploughing';
  notesInp.value = '';
}
function paddockOption(p){ return `<option value="${p.id}" data-name="${escapeHtml(p.name||'')}">${escapeHtml(p.name||'(unnamed)')}</option>`; }

async function loadPaddocks(propertyId){
  paddockSel.innerHTML = '<option>(loadingâ€¦)</option>';
  try{
    const snap = await db.collection('paddocks').where('propertyId','==',propertyId).get();
    const rows=[]; snap.forEach(d=> rows.push({id:d.id, ...d.data()}));
    rows.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));
    paddockSel.innerHTML = '<option value="">(choose)</option>' + rows.map(paddockOption).join('');
  }catch(e){
    paddockSel.innerHTML = '<option value="">(failed to load)</option>';
    console.warn('paddocks load error:', e);
    setMsg('Failed to load paddocks: ' + errText(e), 5000);
  }
}

async function saveEntry(){
  const propertyId = propSel.value;
  const propertyName = PROPS.find(p=>p.id===propertyId)?.name || '(unknown)';
  const date = dateInp.value || todayISO();
  const time = timeInp.value || '';
  const activity = activitySel.value;
  const paddock = paddockSel.selectedOptions[0]?.dataset?.name || '';
  const notes = notesInp.value || '';

  if(!propertyId){ throw new Error('Pick a property'); }
  const payload = {
    propertyId, propertyName, date, time, activity,
    paddock, user: (auth.currentUser?.email || 'User'),
    notes,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  await db.collection('diaryEntries').add(payload);
  setMsg('Saved.');
  await refreshEntries();
}

async function refreshEntries(){
  const propertyId = propSel.value;
  entriesTbody.innerHTML = '<tr><td colspan="6">Loadingâ€¦</td></tr>';
  try{
    const since = new Date(); since.setDate(since.getDate()-30);
    const q = db.collection('diaryEntries')
      .where('propertyId','==',propertyId)
      .orderBy('date','desc')
      .limit(50);
    const snap = await q.get();
    const rows=[];
    snap.forEach(d=> rows.push({id:d.id, ...d.data()}));
    if(!rows.length){
      entriesTbody.innerHTML = '<tr><td colspan="6" class="muted">No entries.</td></tr>';
      return;
    }
    entriesTbody.innerHTML = rows.map(r=>`
      <tr>
        <td>${escapeHtml(r.date||'')}</td>
        <td>${escapeHtml(r.propertyName||'')}</td>
        <td>${escapeHtml(r.activity||'')}</td>
        <td>${escapeHtml(r.paddock||'')}</td>
        <td>${escapeHtml(r.notes||'')}</td>
        <td><button data-id="${r.id}" class="danger btnDel">Delete</button></td>
      </tr>`).join('');
    document.querySelectorAll('.btnDel').forEach(b=>{
      b.onclick = async ()=>{
        if(confirm('Delete this diary entry?')){ await db.collection('diaryEntries').doc(b.dataset.id).delete(); refreshEntries(); }
      };
    });
  }catch(e){
    entriesTbody.innerHTML = `<tr><td colspan="6" style="color:#b45309">No permission to read entries. ${escapeHtml(errText(e))}</td></tr>`;
    console.warn('entries load error:', e);
  }
}

/* Weather stub (wired later) */
$('#getWeatherBtn').onclick = async ()=>{
  const propId = propSel.value;
  const coords = {
    "s7PlDM9wrEpxuJ6DGIab": { lat:-20.263323, lon:141.609607 }, // Consentes
    "P0dQ0H2FWHeqqxejflZs": { lat:-20.114428, lon:141.751857 }, // Gerawin
    "TRuxtRBX2zJlwZnRGYKJ": { lat:-26.566565, lon:149.997202 }  // Mt Myrtle
  }[propId] || {};
  const d = dateInp.value || todayISO();
  $('#weatherText').textContent = 'Fetchingâ€¦';
  try{
    // Stub â€” replace with your backend later
    const res = await fetch(`/weather?date=${encodeURIComponent(d)}&lat=${coords.lat}&lon=${coords.lon}`);
    if(!res.ok) throw new Error('weather fetch failed');
    const w = await res.json();
    $('#weatherText').textContent = `min ${w.minC}Â°C / max ${w.maxC}Â°C â€¢ ${w.mm}mm â€¢ wind ${w.windKph} kph`;
  }catch(e){
    $('#weatherText').textContent = 'Weather service not connected yet';
  }
};

/* -------------------------------------------------------
   Page bootstrap
------------------------------------------------------- */
(async function init(){
  // Basic nav (adjust if you have other files)
  const base = location.origin || '';
  $('#navDiary').href = base + '/skyfarm-diary.html';
  $('#navMap').href   = base + '/skyfarm-map.html';
  $('#navChem').href  = base + '/skyfarm-chemical.html';

  dateInp.value = todayISO();
  populateProperties();
  propSel.onchange = ()=> loadPaddocks(propSel.value);

  const signed = await requireSignedIn();
  if (signed){
    await loadPaddocks(propSel.value);
    await refreshEntries();
  }
})();
</script>
</body>
</html>
