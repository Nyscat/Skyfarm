<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SkyFarm — Diary</title>

  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>

  <style>
    :root { --brand:#0B7A6E; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#f6fbf8; margin:16px; color:#0f172a; }
    h1 { margin:0 0 12px; font-size:1.6rem; }
    .wrap { max-width:1100px; margin:0 auto; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:12px 0; }
    .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; }
    label { display:block; font-size:.9rem; color:#475569; margin-bottom:4px; }
    input, select, button { padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
    button { cursor:pointer; }
    .primary { background:var(--brand); border-color:var(--brand); color:#fff; }
    .danger { background:#ef4444; border-color:#ef4444; color:#fff; }
    .muted { color:#64748b; font-size:.9rem; }
    .spacer { flex:1; }
    .hidden { display:none; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #e5e7eb; padding:8px; text-align:left; }
    th { background:#f1f5f9; }
    .nowrap { white-space:nowrap; }
    .pill { padding:2px 8px; border-radius:999px; background:#e2e8f0; font-size:.8rem; }
    .w80 { width:80px; } .w110 { width:110px; } .w140 { width:140px; } .w200 { width:200px; }
    .status-ok { color:#0B7A6E; } .status-warn { color:#9a3412; }
    .small { font-size:.9rem; }
  </style>

<link rel="stylesheet" href="skyfarm-shared.css">
</head>
<body>
<div id="sf-header-root"></div>
<script src="skyfarm-header.js"></script>
<script>SkyFarmHeader.mount();</script>

  
<script>SkyFarmAuth.requireAuth();</script>
<script>
  (function(){
    // Link handler
    function pageUrl(slug){
      const base = location.origin;
      if (slug === 'diary') return `${base}/skyfarm-diary.html`;
      if (slug === 'map')   return `${base}/skyfarm-map.html`;
      if (slug === 'chem')  return `${base}/skyfarm-chemical.html`;
      if (slug === 'admin') return `${base}/skyfarm-admin-users.html`;
      return base + '/';
    }
    document.querySelectorAll('#skyfarm-header [data-nav]').forEach(a=>{
      a.onclick = (e)=>{ e.preventDefault(); location.href = pageUrl(a.getAttribute('data-nav')); };
    });

    // Optional: show simple auth state if Firebase is present on the page
    try {
      if (window.firebase?.auth) {
        const el = document.getElementById('sf-auth');
        firebase.auth().onAuthStateChanged(u=>{
          el.textContent = u ? (u.isAnonymous ? 'Connected (guest)' : `Signed in`) : 'Connecting…';
        });
      }
    } catch(e){}
  })();
</script>
<div class="wrap">
  <h1>SkyFarm — Diary</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Property</label>
        <select id="propSel" style="min-width:240px"></select>
      </div>
      <div>
        <label>Date</label>
        <input id="dateInp" type="date" />
      </div>
      <div>
        <label>Time</label>
        <input id="timeInp" type="time" />
      </div>
      <div>
        <label>Activity</label>
        <select id="activitySel" style="min-width:220px">
          <option value="Ploughing">Ploughing</option>
          <option value="Planting">Planting</option>
          <option value="Spraying paddocks">Spraying paddocks</option>
          <option value="Chemical (stock)">Chemical (stock)</option>
          <option value="Trucking (sale)">Trucking (sale)</option>
          <option value="Cattle Received (Purchase)">Cattle Received (Purchase)</option>
          <option value="Move stock">Move stock (Paddock to Paddock)</option>
          <option value="Transfer stock (In)">Transfer stock (Property In)</option>
          <option value="Transfer stock (Out)">Transfer stock (Property Out)</option>
          <option value="Mustering">Mustering</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <span class="spacer"></span>
      <div>
        <label>&nbsp;</label>
        <span id="status" class="muted">Connecting…</span>
      </div>
    </div>

    <div class="row">
      <div style="min-width:260px">
        <label>Paddock</label>
        <select id="paddockSel" style="min-width:260px"><option value="">(choose)</option></select>
      </div>
      <div id="transferPropRow" class="hidden">
        <label>To/From Property</label>
        <select id="transferPropSel" style="min-width:260px"><option value="">(choose)</option></select>
      </div>
      <div style="min-width:260px; flex:1">
        <label>Notes</label>
        <input id="notesInp" placeholder="optional" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Rain gauge</label>
        <select id="gaugeSel" style="min-width:260px"><option value="">(choose)</option></select>
      </div>
      <div>
        <label>Rainfall (mm)</label>
        <input id="rainMm" type="number" min="0" step="0.1" class="w110" />
      </div>
      <div class="muted">Adds to gauge total and per-day totals; auto-reverts on edit/delete.</div>
    </div>

    <div id="chemRow" class="row hidden">
      <div>
        <label>Chemical</label>
        <select id="chemSel" style="min-width:260px"><option value="">(choose)</option></select>
      </div>
      <div>
        <label>Qty used</label>
        <input id="chemQty" type="number" min="0" step="0.01" class="w110" />
      </div>
      <div>
        <label>Unit</label>
        <input id="chemUnit" placeholder="KG/L" class="w80" disabled />
      </div>
      <div><label>&nbsp;</label><span id="chemHint" class="pill">context</span></div>
    </div>

    <div id="stockRow" class="row hidden">
      <div>
        <label>Species</label>
        <select id="speciesSel">
          <option value="Cattle">Cattle</option>
          <option value="Sheep">Sheep</option>
          <option value="Goats">Goats</option>
        </select>
      </div>
      <div>
        <label>Class</label>
        <input id="classInp" placeholder="e.g. Weaners" class="w200" list="classOptions"/>
        <datalist id="classOptions"></datalist>
      </div>
      <div>
        <label>Head</label>
        <input id="headInp" type="number" min="0" step="1" class="w110" />
      </div>
      <div id="stockDetail1">
        <label>Buyer / Dest (Trucking)</label>
        <input id="truckBuyer" placeholder="e.g. Roma" class="w200" />
      </div>
      <div id="stockDetail2">
        <label>Docket / Ref</label>
        <input id="truckRef" placeholder="NVD / docket" class="w200" />
      </div>
    </div>

    <div id="musterBox" class="card hidden" style="margin-top:8px">
      <div class="row"><strong>Mustering details</strong></div>

      <div class="row small" id="musterContext" style="gap:6px; color:#334155;"></div>

      <div class="row">
        <div>
          <label>Expected (auto)</label>
          <input id="mExp" type="number" class="w110" disabled />
        </div>
        <div>
          <label>Actual</label>
          <input id="mAct" type="number" class="w110" />
        </div>
        <div>
          <label>Delta (auto)</label>
          <input id="mDelta" type="number" class="w110" disabled />
        </div>
        <div style="flex:1; min-width:260px">
          <label>Reason / notes</label>
          <input id="mReason" placeholder="e.g. counted late, moved to North 2…" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Add calves</label>
          <input id="mAddCalves" type="number" class="w110" />
        </div>
        <div>
          <label>Add weaners</label>
          <input id="mAddWeaners" type="number" class="w110" />
        </div>
        <div class="spacer"></div>
        <button id="addClassRowBtn">Add class row</button>
      </div>

      <div class="row">
        <strong>Reclass / counts by class</strong>
      </div>
      <div class="row">
        <table id="mClassTable">
          <thead>
            <tr>
              <th>Class</th>
              <th>Expected</th>
              <th>New count</th>
              <th>Reclass to</th>
              <th>Qty</th>
              <th>Missing</th>
            </tr>
          </thead>
        <tbody id="mClassBody"><tr><td colspan="6">Pick property + paddock + species to load current classes…</td></tr></tbody>
        </table>
      </div>
      <div class="muted">Set a <em>New count</em> to overwrite a class total, or use <em>Reclass to + Qty</em> to move headcounts between classes. Use <em>Missing</em> to hold animals that didn’t turn up — they’re tracked against the current financial year.</div>
    </div>

    <div class="row">
      <button id="saveBtn" class="primary">Save entry</button>
      <button id="cancelEditBtn" class="hidden">Cancel edit</button>
      <button id="resetBtn">Reset</button>
      <span id="msg" class="muted" aria-live="polite"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <strong>Recent entries</strong>
      <span class="spacer"></span>
      <label>Year</label>
      <input id="yearInp" type="number" min="2000" max="2100" class="w110" />
      <button id="exportCsvBtn">Export CSV</button>
      <button id="printBtn">Print year</button>
      <button id="refreshBtn">Refresh</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Property</th><th>Activity</th><th>Paddock</th><th>Rain (mm)</th><th>Chemical</th><th>Head</th><th></th>
        </tr>
      </thead>
      <tbody id="entriesTbody"><tr><td colspan="8">Loading…</td></tr></tbody>
    </table>
  </div>
</div>

<script>
/*** Firebase ***/
const firebaseConfig = {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/*** Helpers ***/
const $ = s => document.querySelector(s);
const setStatus = t => { const el=$('#status'); el.textContent = t||''; el.className = t?.toLowerCase().includes('connected') ? 'status-ok' : 'status-warn'; };
const setMsg = (t, ms=3000) => { $('#msg').textContent = t||''; if(t&&ms) setTimeout(()=>$('#msg').textContent='', ms); };
const todayISO = () => new Date().toISOString().slice(0,10);
const escapeHtml = s => String(s ?? '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
const yBounds = (y)=>({ start:`${y}-01-01`, end:`${y}-12-31` });
const fmtDateKey = d => d;
function fyLabel(dateStr){ const [y,m]=dateStr.split('-').map(Number); return (m>=7)?`${y}-${String(y+1).slice(2)}`:`${y-1}-${String(y).slice(2)}`; }
function missingDocId({propertyId, paddock, species, cls, fy}){ const safe=s=>String(s||'').replace(/[^\w.-]/g,'_'); return `${safe(propertyId)}__${safe(paddock)}__${safe(species)}__${safe(cls)}__${safe(fy)}`; }

/*** URL params (from Map) ***/
const url = new URL(location.href);
const urlPropId    = url.searchParams.get('propertyId') || '';
const urlPropName = url.searchParams.get('propertyName') || '';
const urlPaddock  = url.searchParams.get('paddock') || '';
const urlChemOnly = url.searchParams.get('chemOnly') === 'true';

/*** Suggested classes ***/
const SUGGESTED_CLASSES = ["Cows","Heifers","Bulls","Steers","PTIC cows","Joined cows","Calves","Weaners"];

/*** Properties ***/
const propertyIds = {
  "Consentes":"s7PlDM9wrEpxuJ6DGIab",
  "Mt Myrtle":"TRuxtRBx2zJlwZnRGYKJ",
  "Gerawin":"P0dQ0H2FWHeqqxejflZs"
};
const propertyNameById = Object.fromEntries(Object.entries(propertyIds).map(([n,i])=>[i,n]));
const allPropertyNames = Object.keys(propertyIds);

/*** Elements ***/
const propSel = $('#propSel'), dateInp = $('#dateInp'), timeInp = $('#timeInp'), activitySel = $('#activitySel');
const paddockSel = $('#paddockSel'), notesInp = $('#notesInp');
const transferPropRow = $('#transferPropRow'), transferPropSel = $('#transferPropSel');
const gaugeSel = $('#gaugeSel'), rainMm = $('#rainMm');
const chemRow = $('#chemRow'), chemSel = $('#chemSel'), chemQty = $('#chemQty'), chemUnit = $('#chemUnit'), chemHint = $('#chemHint');
const stockRow = $('#stockRow'), speciesSel = $('#speciesSel'), classInp = $('#classInp'), headInp = $('#headInp'), truckBuyer=$('#truckBuyer'), truckRef=$('#truckRef');
const stockDetail1 = $('#stockDetail1'), stockDetail2 = $('#stockDetail2'); // For hiding/showing Buyer/Ref
const musterBox = $('#musterBox'), mExp=$('#mExp'), mAct=$('#mAct'), mDelta=$('#mDelta'), mReason=$('#mReason'), mAddCalves=$('#mAddCalves'), mAddWeaners=$('#mAddWeaners'), mClassBody=$('#mClassBody'), addClassRowBtn=$('#addClassRowBtn'), musterContext=$('#musterContext');
const saveBtn = $('#saveBtn'), cancelEditBtn = $('#cancelEditBtn'), entriesTbody = $('#entriesTbody');
const yearInp = $('#yearInp'), exportCsvBtn = $('#exportCsvBtn'), printBtn = $('#printBtn');
const classOptions = $('#classOptions');

/*** Caches / state ***/
let paddocks=[], gauges=[], chems=[], entries=[];
let editingId = null, originalEntry = null;

/*** Bootstrap ***/
(async function init(){
  try {
    try { await firebase.firestore().enablePersistence({synchronizeTabs:true}); } catch(e) { console.warn('Persistence not available:', e && e.code); }
    setStatus('Connecting…');
    await auth.signInAnonymously().catch(err=>{ console.warn('Anon auth failed:', err?.code, err?.message); });
    setStatus('Connected');
  } catch(e){ console.error(e); setStatus('Auth issue (check Anonymous Sign-in & Authorized domains)'); }

  // properties (+ All)
  const propOptions = Object.keys(propertyIds).map(n=>`<option value="${propertyIds[n]}">${n}</option>`).join('');
  propSel.innerHTML = '<option value="ALL">(All properties)</option>' + propOptions;
  
  // Transfer properties (all properties excluding the "All" option)
  transferPropSel.innerHTML = '<option value="">(choose property)</option>' + propOptions;

  dateInp.value = todayISO(); yearInp.value = new Date().getFullYear();

  // events
  activitySel.onchange = onActivityChange;
  propSel.onchange = onPropertyChange;
  $('#refreshBtn').onclick = refreshEntries;
  $('#resetBtn').onclick = ()=>resetForm(false);
  cancelEditBtn.onclick = ()=>{ resetForm(false); setMsg('Edit cancelled'); };
  saveBtn.onclick = ()=> saveEntry().catch(e=>{console.error(e); setMsg('Save failed');});
  exportCsvBtn.onclick = exportYearCsv;
  printBtn.onclick = printYear;
  addClassRowBtn.onclick = addMusterClassRow;
  paddockSel.onchange = onPaddockOrSpeciesChange;
  speciesSel.onchange = onPaddockOrSpeciesChange;
  mAct.oninput = ()=>{ mDelta.value = (Number(mAct.value||0) - Number(mExp.value||0)) || 0; };
  transferPropSel.onchange = onTransferPropertyChange; // New: Trigger property change logic

  onActivityChange();

  // Preselect from URL (map deep-link)
  if (urlPropId || urlPropName){
    const pid = urlPropId || propertyIds[urlPropName] || '';
    if (pid && propSel.querySelector(`option[value="${pid}"]`)) propSel.value = pid;
  }
  await onPropertyChange();

  // If paddock provided via URL, attempt fuzzy-select
  if (urlPaddock) { trySelectPaddockByName(urlPaddock); }

  // If chemOnly flag from map, pre-pick “Spraying paddocks”
  if (urlChemOnly) { activitySel.value = 'Spraying paddocks'; onActivityChange(); }

  await refreshEntries();
})();

/*** UI Toggles ***/
function onActivityChange(){
  const act = activitySel.value;
  
  const needsChem = (act==='Spraying paddocks' || act==='Chemical (stock)' || act==='Trucking (sale)');
  chemRow.classList.toggle('hidden', !needsChem);
  chemHint.textContent = (act==='Spraying paddocks') ? 'paddock spray' : (act==='Trucking (sale)' ? 'backline before transport' : 'stock treatment');

  const needsStock = (act==='Trucking (sale)' || act==='Move stock' || act==='Chemical (stock)' || act==='Mustering' || act==='Cattle Received (Purchase)' || act.startsWith('Transfer stock'));
  stockRow.classList.toggle('hidden', !needsStock);
  
  const needsPaddock = !(act==='Transfer stock (In)' || act==='Transfer stock (Out)' || act==='Cattle Received (Purchase)');
  paddockSel.closest('div').classList.toggle('hidden', !needsPaddock);
  gaugeSel.closest('div').classList.toggle('hidden', act==='Transfer stock (Out)' || act==='Transfer stock (In)');
  
  const needsTransferProp = (act==='Transfer stock (In)' || act==='Transfer stock (Out)');
  transferPropRow.classList.toggle('hidden', !needsTransferProp);

  const needsTruckDetails = (act==='Trucking (sale)' || act==='Cattle Received (Purchase)');
  stockDetail1.classList.toggle('hidden', !needsTruckDetails);
  stockDetail2.classList.toggle('hidden', !needsTruckDetails);
  
  const label1 = (act==='Trucking (sale)') ? 'Buyer / Dest (Trucking)' : 'Seller / Source';
  stockDetail1.querySelector('label').textContent = label1;
  stockDetail1.querySelector('input').placeholder = (act==='Trucking (sale)') ? 'e.g. Roma' : 'e.g. Mt Myrtle';

  musterBox.classList.toggle('hidden', act!=='Mustering');
  saveBtn.disabled = (propSel.value==='ALL');
  
  // Set default species for purchase to Cattle
  if (act==='Cattle Received (Purchase)') { speciesSel.value = 'Cattle'; }

  buildChemDropdown();
}

// New: Logic to update UI/dropdowns when selecting a 'To/From Property' for transfer
function onTransferPropertyChange() {
    // If we're transferring OUT, we don't need to do anything with the paddocks on this page,
    // but if we're transferring IN, we need to load paddocks for the destination.
    const act = activitySel.value;
    if (act === 'Transfer stock (In)') {
        onPropertyChange(); // Re-trigger property change logic to reload destination paddocks
    }
}

/*** Property change: load paddocks, gauges, chems ***/
async function onPropertyChange(){
  const pid = propSel.value;
  
  // Update transfer dropdown to exclude the currently selected property
  transferPropSel.innerHTML = '<option value="">(choose property)</option>' + 
    Object.keys(propertyIds)
      .filter(n => propertyIds[n] !== pid)
      .map(n=>`<option value="${propertyIds[n]}">${n}</option>`).join('');
  
  if (pid==='ALL'){
    paddockSel.innerHTML = '<option value="">(choose a property to select paddock)</option>';
    gaugeSel.innerHTML = '<option value="">(choose a property to select gauge)</option>';
    chemSel.innerHTML = '<option value="">(choose a property to select chemical)</option>';
    classOptions.innerHTML = '';
    saveBtn.disabled = true;
    mClassBody.innerHTML = '<tr><td colspan="6">Pick property + paddock + species to load current classes…</td></tr>';
    musterContext.innerHTML = '';
  } else {
    saveBtn.disabled = false;

    // Determine the property ID for which to load Paddocks/Gauges/Chems
    let loadPid = pid;
    if (activitySel.value === 'Transfer stock (In)' && transferPropSel.value) {
        // When transferring IN, the destination paddock is on the current property (pid)
        loadPid = pid;
    } else if (activitySel.value === 'Transfer stock (Out)' && transferPropSel.value) {
        // When transferring OUT, the source paddock is on the current property (pid)
        loadPid = pid;
    }

    // paddocks
    paddocks=[]; paddockSel.innerHTML='<option>(loading…)</option>';
    const paddockSnap = await db.collection('paddocks').where('propertyId','==',loadPid).get();
    paddockSnap.forEach(d=>paddocks.push({id:d.id, ...d.data()}));
    paddockSel.innerHTML='<option value="">(choose)</option>'+paddocks.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))
      .map(p=>`<option value="${p.id}" data-name="${escapeHtml(p.name||'')}">${escapeHtml(p.name||'(unnamed)')}</option>`).join('');

    // gauges
    gauges=[]; gaugeSel.innerHTML='<option>(loading…)</option>';
    const gaugeSnap = await db.collection('gauges').where('propertyId','==',loadPid).get();
    gaugeSnap.forEach(d=>gauges.push({id:d.id, ...d.data()}));
    gaugeSel.innerHTML='<option value="">(choose)</option>'+gauges.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))
      .map(g=>`<option value="${g.id}" data-name="${escapeHtml(g.name||'')}">${escapeHtml(g.name||'(unnamed)')}</option>`).join('');

    // chems (always based on the *current* property for inventory)
    chems=[]; chemSel.innerHTML='<option>(loading…)</option>';
    const chemSnap = await db.collection('chemicals').where('propertyId','==',pid).get();
    chemSnap.forEach(d=>chems.push({id:d.id, ...d.data()}));
    buildChemDropdown();

    await onPaddockOrSpeciesChange();
  }
}

/*** Fuzzy paddock select for deep-links from Map ***/
const norm = s => String(s||'').toLowerCase().trim();
const strip = s => norm(s).replace(/[^a-z0-9]+/g,'');
function trySelectPaddockByName(name){
  const target = strip(name);
  if (!target) return;
  for (const opt of paddockSel.options){
    if (norm(opt.dataset?.name||'') === norm(name)) { paddockSel.value = opt.value; return; }
  }
  let bestOpt=null, bestScore=0;
  for (const opt of paddockSel.options){
    const s = strip(opt.dataset?.name||'');
    if (!s) continue;
    if (s.includes(target) || target.includes(s)) { paddockSel.value = opt.value; return; }
    const score = commonPrefix(s,target).length;
    if (score>bestScore){ bestScore=score; bestOpt=opt; }
  }
  if (bestOpt) paddockSel.value = bestOpt.value;
}
function commonPrefix(a,b){ let i=0; for(; i<Math.min(a.length,b.length); i++){ if(a[i]!==b[i]) break; } return a.slice(0,i); }

/*** Chemical dropdown (filtered by use) ***/
function buildChemDropdown(){
  const pid = propSel.value;
  if(pid==='ALL'){ chemSel.innerHTML='<option value="">(choose property)</option>'; chemUnit.value=''; return; }
  const act = activitySel.value;
  const target = act==='Spraying paddocks' ? 'paddock' : (act==='Chemical (stock)' || act==='Trucking (sale)' ? 'stock' : null);
  if(!target){ chemSel.innerHTML='<option value="">(not required)</option>'; chemUnit.value=''; return; }
  const list = chems.filter(c => String(c.useOn||'').toLowerCase()===target && Number(c.quantity||0)>0);
  if(!list.length){ chemSel.innerHTML='<option value="">(no chemicals available)</option>'; chemUnit.value=''; return; }
  chemSel.innerHTML = '<option value="">(choose chemical)</option>' +
    list.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))
      .map(c=>`<option value="${c.id}" data-unit="${c.unit||''}">${escapeHtml(c.name||'Unnamed')} (${c.unit||''}) — ${Number(c.quantity||0)} left</option>`).join('');
  chemSel.onchange = ()=> chemUnit.value = chemSel.selectedOptions[0]?.dataset?.unit || '';
  chemUnit.value = chemSel.selectedOptions[0]?.dataset?.unit || '';
}

/*** Case/field tolerant fetch of livestock rows for a paddock ***/
async function fetchLivestockRows(pid, paddockName, speciesUI){
  const speciesLC = String(speciesUI||'').toLowerCase();

  let snap = await db.collection('livestock')
    .where('propertyId','==',pid)
    .where('location','==',paddockName)
    .where('species','==',speciesUI)
    .get();

  if (snap.empty){
    const title = speciesLC.charAt(0).toUpperCase() + speciesLC.slice(1);
    const variants = [title, speciesLC.toUpperCase()];
    for (const v of variants){
      const s2 = await db.collection('livestock')
        .where('propertyId','==',pid)
        .where('location','==',paddockName)
        .where('species','==',v)
        .get();
      if (!s2.empty){ snap = s2; break; }
    }
  }

  let rows = [];
  if (snap.empty){
    const s3 = await db.collection('livestock')
      .where('propertyId','==',pid)
      .where('location','==',paddockName)
      .get();
    s3.forEach(d => rows.push({ id:d.id, ...(d.data()||{}) }));
    rows = rows.filter(r => String(r.species||'').toLowerCase() === speciesLC);
  } else {
    snap.forEach(d => rows.push({ id:d.id, ...(d.data()||{}) }));
  }
  return rows;
}

/*** Expected totals & mustering table build ***/
async function onPaddockOrSpeciesChange(){
  const pid = propSel.value;
  if (pid==='ALL'){ classOptions.innerHTML=''; return; }

  const act = activitySel.value;
  const isStockMove = (act==='Trucking (sale)' || act==='Move stock' || act==='Chemical (stock)' || act==='Mustering' || act==='Transfer stock (Out)');
  const isStockIn = (act==='Cattle Received (Purchase)' || act==='Transfer stock (In)');
  
  let paddockName = (paddockSel.selectedOptions[0]?.dataset?.name || '').trim();
  const speciesUI = speciesSel.value || 'Cattle';
  
  // If receiving stock, we don't need a current paddock stock list, but we still need class options.
  if (!isStockMove && !paddockName) {
    classOptions.innerHTML = SUGGESTED_CLASSES.map(r=>`<option value="${escapeHtml(r)}"></option>`).join('');
    musterContext.innerHTML='';
    mClassBody.innerHTML='<tr><td colspan="6">Pick property + paddock + species…</td></tr>';
    mExp.value='';
    return;
  }
  
  if (!paddockName){
    classOptions.innerHTML=''; musterContext.innerHTML='';
    mClassBody.innerHTML='<tr><td colspan="6">Pick property + paddock + species…</td></tr>';
    mExp.value=''; return;
  }

  let rows = [];
  if (isStockMove) {
    rows = await fetchLivestockRows(pid, paddockName, speciesUI);
  } else if (isStockIn) {
    // If receiving, just load suggested classes for the dropdown
    rows = SUGGESTED_CLASSES.map(cls => ({ id: null, class: cls, count: 0 }));
  }
  
  rows.sort((a,b)=>String(a.class||'').localeCompare(String(b.class||'')));

  classOptions.innerHTML = rows.map(r=>`<option value="${escapeHtml(r.class||'')}"></option>`).join('');

  if (rows.length===1 && (act==='Trucking (sale)' || act==='Move stock' || act==='Chemical (stock)' || act==='Transfer stock (Out)')){
    classInp.value = rows[0].class || '';
    headInp.value = Number(rows[0].count||0);
  }

  if (activitySel.value==='Mustering'){
    const total = rows.reduce((s,r)=>s+Number(r.count||0),0);
    mExp.value = total;
    mDelta.value = (Number(mAct.value||0) - Number(mExp.value||0)) || 0;

    const parts = rows.map(r=>`${escapeHtml(r.class||'')}: ${Number(r.count||0)}`);
    musterContext.innerHTML = `<span class="pill">Expected total: ${total}</span> ${parts.length? ' | ' + parts.join(', ') : ''}`;

    const existingClasses = new Set(rows.map(r=>String(r.class||'')));
    for (const cls of SUGGESTED_CLASSES){
      if (!existingClasses.has(cls)) rows.push({ id:null, class:cls, count:0, _new:true });
    }

    mClassBody.innerHTML = rows.map(r=>`
      <tr data-id="${r.id||''}" data-class="${escapeHtml(r.class||'')}">
        <td><input class="mc-class w200" value="${escapeHtml(r.class||'')}" ${r.id ? 'disabled' : ''} /></td>
        <td><input class="mc-current w110" value="${Number(r.count||0)}" disabled /></td>
        <td><input class="mc-new w110" type="number" min="0" /></td>
        <td><input class="mc-to w200" placeholder="e.g. Cows, Heifers, Joined cows" /></td>
        <td><input class="mc-qty w110" type="number" min="0" /></td>
        <td><input class="mc-miss w110" type="number" min="0" /></td>
      </tr>`).join('');
  }
}

function addMusterClassRow(){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="mc-class w200" placeholder="New class name" /></td>
    <td><input class="mc-current w110" value="0" disabled /></td>
    <td><input class="mc-new w110" type="number" min="0" /></td>
    <td><input class="mc-to w200" placeholder="e.g. Cows, Heifers, Joined cows" /></td>
    <td><input class="mc-qty w110" type="number" min="0" /></td>
    <td><input class="mc-miss w110" type="number" min="0" /></td>`;
  mClassBody.appendChild(tr);
}

/*** Save / Update (revert old -> apply new) ***/
async function saveEntry(){
  if (propSel.value==='ALL') return alert('Select a specific property to save.');
  const propId = propSel.value, propName = propertyNameById[propId] || '(unknown)';
  const date = dateInp.value || todayISO(), time = timeInp.value || '';
  const activity = activitySel.value;
  const paddockId = paddockSel.value || '', paddockName = paddockSel.selectedOptions[0]?.dataset?.name || '';
  const notes = notesInp.value || '';
  const gaugeId = gaugeSel.value || null, gaugeName = gaugeSel.selectedOptions[0]?.dataset?.name || null, rainfallVal = gaugeId ? Number(rainMm.value || 0) : null;
  const species = speciesSel.value || '', klass = classInp.value || '', head = parseInt(headInp.value||0,10);
  const chemId = chemSel.value || null, chemQ = parseFloat(chemQty.value||0), chemU = chemUnit.value || '', chemName = chemId ? (chems.find(c=>c.id===chemId)?.name || null) : null;
  
  const isTruckingSale = activity === 'Trucking (sale)';
  const isPurchase = activity === 'Cattle Received (Purchase)';
  const isMoveStock = activity === 'Move stock';
  const isTransferOut = activity === 'Transfer stock (Out)';
  const isTransferIn = activity === 'Transfer stock (In)';
  const isStockActivity = (isTruckingSale || isMoveStock || activity==='Chemical (stock)' || activity==='Mustering' || isPurchase || isTransferIn || isTransferOut);

  if ((activity==='Spraying paddocks' || activity==='Chemical (stock)' || isTruckingSale) && chemId && !(chemQ>0))
    return alert('Enter a chemical quantity > 0');
    
  if (isStockActivity && !(head > 0 && klass))
    return alert('Enter a Head count and a Class for this stock activity.');
    
  if ((isTransferOut || isTransferIn) && !transferPropSel.value)
      return alert('Select a To/From Property for the transfer.');

  const musterOps = [];
  if (activity==='Mustering'){
    document.querySelectorAll('#mClassBody tr').forEach(tr=>{
      const cls = tr.querySelector('.mc-class')?.value?.trim();
      if (!cls) return;
      const cur = Number(tr.querySelector('.mc-current')?.value||0);
      const newCount = tr.querySelector('.mc-new')?.value ? Number(tr.querySelector('.mc-new').value) : null;
      const to = tr.querySelector('.mc-to')?.value?.trim();
      const qty = tr.querySelector('.mc-qty')?.value ? Number(tr.querySelector('.mc-qty').value) : 0;
      const miss = tr.querySelector('.mc-miss')?.value ? Number(tr.querySelector('.mc-miss').value) : 0;
      const id = tr.getAttribute('data-id') || null;
      musterOps.push({id, cls, cur, newCount, to, qty, miss});
    });
  }

  const fy = fyLabel(date);
  
  const transferPropId = transferPropSel.value || null;
  const transferPropName = transferPropId ? propertyNameById[transferPropId] : null;

  const payload = {
    propertyId: propId, propertyName: propName,
    date, time, activity,
    paddockId: paddockId || null, paddock: paddockName || null,
    transferPropId, transferPropName, // New: To/From property details
    notes,
    rainfallGaugeId: gaugeId, rainfallGaugeName: gaugeName, rainfallMm: rainfallVal,
    species: isStockActivity ? species : null,
    livestockClass: isStockActivity ? klass : null,
    headCount: (isTruckingSale || isMoveStock || isPurchase || isTransferIn || isTransferOut) ? head : null,
    chemicalId: chemId || null, chemicalName: chemName, chemQty: chemId ? chemQ : null, chemUnit: chemId ? chemU : null,
    truckBuyer: isTruckingSale || isPurchase ? (truckBuyer.value || '') : null, // Used for Buyer (sale) or Seller (purchase)
    truckRef: isTruckingSale || isPurchase ? (truckRef.value || '') : null,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    musterExpected: activity==='Mustering' ? Number(mExp.value||0) : null,
    musterActual:  activity==='Mustering' ? Number(mAct.value||0) : null,
    musterDelta:     activity==='Mustering' ? (Number(mAct.value||0) - Number(mExp.value||0)) : null,
    musterReason:    activity==='Mustering' ? (mReason.value || '') : null,
    musterAdds:      activity==='Mustering' ? { calves:Number(mAddCalves.value||0), weaners:Number(mAddWeaners.value||0) } : null,
    musterMissing:  activity==='Mustering' ? musterOps.filter(r=>r.miss>0).map(r=>({cls:r.cls, qty: Number(r.miss||0), fy})) : null
  };

  try{
    await db.runTransaction(async (tx)=>{
      let entryId = editingId || db.collection('diaryEntries').doc().id;
      const entryRef = db.collection('diaryEntries').doc(entryId);

      // ======================================================================
      // 1. Revert OLD effects (if editing)
      // ======================================================================
      if (editingId){
        const oldSnap = await tx.get(entryRef);
        if (oldSnap.exists){
          const old = oldSnap.data() || {};
          const oldIsTruckingSale = old.activity === 'Trucking (sale)';
          const oldIsPurchase = old.activity === 'Cattle Received (Purchase)';
          const oldIsMoveStock = old.activity === 'Move stock';
          const oldIsTransferOut = old.activity === 'Transfer stock (Out)';
          const oldIsTransferIn = old.activity === 'Transfer stock (In)';
          const oldTransferPropId = old.transferPropId || null;

          // Revert Chemical
          if (old.chemicalId && Number(old.chemQty||0)>0){
            const cref = db.collection('chemicals').doc(old.chemicalId);
            const cs = await tx.get(cref); if (cs.exists) tx.update(cref, {quantity:Number(cs.data().quantity||0)+Number(old.chemQty||0)});
          }
          
          // Revert Stock Movements (Sale, Move, Transfer Out) - Add stock back to the source
          if ((oldIsTruckingSale || oldIsMoveStock || oldIsTransferOut) && Number(old.headCount||0)>0 && old.species && old.livestockClass){
            // Source property and paddock
            const revertPid = old.propertyId;
            const revertPaddock = old.paddock;
            
            // For Transfer Out, revert to the old property's livestock (must have been deleted)
            if (oldIsTransferOut) {
                // If the OUT entry was being edited, we must add the stock back to the source property's paddock
                const q = db.collection('livestock').where('propertyId','==',revertPid).where('location','==',revertPaddock).where('species','==',old.species).where('class','==',old.livestockClass);
                const s = await tx.get(q);
                if (s.empty) {
                    // Re-create the livestock doc if it was the last one and was deleted
                    const newRef = db.collection('livestock').doc();
                    tx.set(newRef, { propertyId: revertPid, location: revertPaddock, species: old.species, class: old.livestockClass, count: Number(old.headCount||0) }, { merge:true });
                } else {
                    s.forEach(doc=>{ tx.update(db.collection('livestock').doc(doc.id), {count:firebase.firestore.FieldValue.increment(Number(old.headCount||0))}); });
                }
            } else {
                // Trucking Sale/Move Stock: Simple increment on current property
                const q = db.collection('livestock').where('propertyId','==',revertPid).where('location','==',revertPaddock).where('species','==',old.species).where('class','==',old.livestockClass);
                const s = await tx.get(q); s.forEach(doc=>{ const cur=Number((doc.data()||{}).count||0); tx.update(db.collection('livestock').doc(doc.id), {count:cur+Number(old.headCount||0)}); });
            }
            
            // Revert Transfer IN - Remove stock from the destination
            if (oldIsTransferIn && oldTransferPropId) {
                const q = db.collection('livestock').where('propertyId','==',revertPid).where('location','==',revertPaddock).where('species','==',old.species).where('class','==',old.livestockClass);
                const s = await tx.get(q);
                s.forEach(doc=>{ 
                    const cur=Number((doc.data()||{}).count||0);
                    const next = cur - Number(old.headCount||0);
                    if (next < 0) {
                        // This shouldn't happen if the original logic was correct, but as a safety:
                        console.warn('Revert Transfer In: Would make class count negative. Setting to 0 and proceeding.');
                        tx.update(db.collection('livestock').doc(doc.id), {count: 0});
                    } else {
                        tx.update(db.collection('livestock').doc(doc.id), {count: next});
                    }
                });
            }
          }

          // Revert Purchase - Remove stock from the current property's paddock
          if (oldIsPurchase && Number(old.headCount||0)>0 && old.species && old.livestockClass && old.paddock){
              const q = db.collection('livestock').where('propertyId','==',old.propertyId).where('location','==',old.paddock).where('species','==',old.species).where('class','==',old.livestockClass);
              const s = await tx.get(q);
              s.forEach(doc=>{
                  const cur=Number((doc.data()||{}).count||0);
                  const next = cur - Number(old.headCount||0);
                  if (next < 0) {
                       console.warn('Revert Purchase: Would make class count negative. Setting to 0 and proceeding.');
                       tx.update(db.collection('livestock').doc(doc.id), {count: 0});
                  } else {
                      tx.update(db.collection('livestock').doc(doc.id), {count: next});
                  }
              });
          }
          
          // Revert Rainfall
          if (old.rainfallGaugeId && Number(old.rainfallMm||0)>0){
            const gref = db.collection('gauges').doc(old.rainfallGaugeId); const gs = await tx.get(gref);
            if (gs.exists){
              tx.update(gref,{ rainTotal: firebase.firestore.FieldValue.increment(-Number(old.rainfallMm||0)), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
              const dayRef = gref.collection('daily').doc(fmtDateKey(old.date || todayISO()));
              tx.set(dayRef, { mm: firebase.firestore.FieldValue.increment(-Number(old.rainfallMm||0)) , date: fmtDateKey(old.date || todayISO()) }, { merge:true });
              tx.set(gref.collection('readings').doc(entryId), { date: old.date || todayISO(), mm: 0, diaryEntryId: entryId }, { merge:true });
            }
          }
          
          // Revert Muster Missing Stock
          if (Array.isArray(old.musterMissing)){
            for (const m of old.musterMissing){
              const mid = missingDocId({propertyId: old.propertyId, paddock: old.paddock, species: old.species, cls: m.cls, fy: m.fy});
              const mref = db.collection('missingStock').doc(mid);
              tx.set(mref, {
                propertyId: old.propertyId, location: old.paddock, species: old.species,
                class: m.cls, fy: m.fy, count: firebase.firestore.FieldValue.increment(-Number(m.qty||0)),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              }, { merge:true });
            }
          }
        }
      }

      // ======================================================================
      // 2. Apply NEW effects
      // ======================================================================
      if (payload.chemicalId && Number(payload.chemQty||0)>0){
        const cref = db.collection('chemicals').doc(payload.chemicalId);
        const csnap = await tx.get(cref); if(!csnap.exists) throw new Error('Chemical not found');
        const next = Number(csnap.data().quantity||0) - Number(payload.chemQty||0);
        if (next < -0.0001) throw new Error('Not enough chemical in inventory'); tx.update(cref, {quantity: next});
      }
      
      // Stock Movements (Sale, Move, Transfer Out) - Remove stock from the source
      if ((isTruckingSale || isMoveStock || isTransferOut) && Number(payload.headCount||0)>0 && payload.species && payload.livestockClass && payload.paddock){
        const q = db.collection('livestock').where('propertyId','==',payload.propertyId).where('location','==',payload.paddock).where('species','==',payload.species).where('class','==',payload.livestockClass);
        const s = await tx.get(q); 
        if (s.empty) throw new Error(`Stock movement failed: No ${payload.livestockClass} in ${payload.paddock} to move/sell.`);
        s.forEach(doc=>{ 
          const cur=Number((doc.data()||{}).count||0); 
          const next=cur-Number(payload.headCount||0); 
          if(next<0) throw new Error(`${payload.activity} would make class count negative in ${payload.paddock}`); 
          // If the count hits zero and it's a Transfer Out, we delete the document. Otherwise, we just update the count.
          if (next === 0 && isTransferOut) {
              tx.delete(db.collection('livestock').doc(doc.id));
          } else {
              tx.update(db.collection('livestock').doc(doc.id), {count: next});
          }
        });
        
        // Transfer Out special: Create a corresponding "Transfer In" entry on the destination property
        if (isTransferOut) {
            const destPid = payload.transferPropId;
            const destPName = payload.transferPropName;
            const transferInId = db.collection('diaryEntries').doc().id; // Create a new ID for the paired IN entry
            
            const transferInPayload = {
                ...payload,
                propertyId: destPid, propertyName: destPName,
                transferPropId: payload.propertyId, transferPropName: payload.propertyName, // Source property is now the 'from'
                activity: 'Transfer stock (In)',
                paddockId: null, paddock: null, // Paddock must be set by the user on the receiving end
                headCount: payload.headCount,
                chemicalId: null, chemQty: null, chemUnit: null, chemicalName: null,
                notes: `Received from ${payload.propertyName}. [Link to OUT entry: ${entryId}]`,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            };
            
            // Write the paired IN entry to the destination property
            tx.set(db.collection('diaryEntries').doc(transferInId), transferInPayload, { merge:true });
            // Stock is *not* added here. It is expected to be recorded on the destination's diary page (the IN entry is just a reminder).
            // NOTE: For simplicity, the transfer logic below assumes that the "Transfer stock (In)" entry will be completed separately 
            // on the receiving property's page (setting the paddock and applying the stock count). 
            // We will make the "Transfer stock (In)" *add* the stock to the current property below.
        }
      }
      
      // Stock Movements (Purchase, Transfer In) - Add stock to the destination
      if ((isPurchase || isTransferIn) && Number(payload.headCount||0)>0 && payload.species && payload.livestockClass && payload.paddock){
          const q = db.collection('livestock').where('propertyId','==',payload.propertyId).where('location','==',payload.paddock).where('species','==',payload.species).where('class','==',payload.livestockClass);
          const s = await tx.get(q);
          
          if (s.empty) {
              // Create new livestock row
              const newRef = db.collection('livestock').doc();
              tx.set(newRef, { propertyId: payload.propertyId, location: payload.paddock, species: payload.species, class: payload.livestockClass, count: payload.headCount }, { merge:true });
          } else {
              // Increment existing livestock row
              s.forEach(doc=>{ 
                  tx.update(db.collection('livestock').doc(doc.id), {count: firebase.firestore.FieldValue.increment(payload.headCount)}); 
              });
          }
      }
      
      if (payload.rainfallGaugeId && Number(payload.rainfallMm||0)>0){
        const gref = db.collection('gauges').doc(payload.rainfallGaugeId);
        const gs = await tx.get(gref); if(!gs.exists) throw new Error('Gauge not found');
        tx.update(gref, { rainTotal: firebase.firestore.FieldValue.increment(Number(payload.rainfallMm||0)), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        const dayRef = gref.collection('daily').doc(fmtDateKey(payload.date));
        tx.set(dayRef, { date: fmtDateKey(payload.date), mm: firebase.firestore.FieldValue.increment(Number(payload.rainfallMm||0)) }, { merge:true });
        tx.set(gref.collection('readings').doc(entryId), { date: payload.date, mm: Number(payload.rainfallMm||0), diaryEntryId: entryId }, { merge:true });
      }
      
      if (activity==='Mustering'){
        const baseQ = db.collection('livestock').where('propertyId','==',payload.propertyId).where('location','==',payload.paddock).where('species','==',payload.species);

        // 1. Process muster ops (New Count, Reclass, Missing)
        for (const op of musterOps){
          const isNew = op.id === null;
          const ref = isNew ? baseQ.doc() : db.collection('livestock').doc(op.id);
          const data = isNew ? { propertyId: payload.propertyId, location: payload.paddock, species: payload.species, class: op.cls } : {};

          // NEW COUNT: Set the count to the specified number
          if (op.newCount !== null){
            data.count = op.newCount;
            tx.set(ref, data, { merge:true });
          }
          
          // RECLASS: Move head from this class to another
          if (op.to && op.qty > 0){
            // Decrease count in this class (from original if newCount not set, otherwise from newCount)
            const decreaseBy = op.qty;
            if (!isNew){ // Cannot reclass *from* a brand new class that doesn't exist yet
              const curCount = (op.newCount !== null) ? op.newCount : op.cur;
              if (curCount < decreaseBy) throw new Error(`Reclass: Not enough ${op.cls} to reclass ${decreaseBy} head`);
              tx.update(ref, { count: firebase.firestore.FieldValue.increment(-decreaseBy) });
            }

            // Find or create 'Reclass To' row and increase count
            const toQ = db.collection('livestock').where('propertyId','==',payload.propertyId).where('location','==',payload.paddock).where('species','==',payload.species).where('class','==',op.to);
            const toSnap = await tx.get(toQ);
            
            if (!toSnap.empty){
              toSnap.forEach(doc=>{ tx.update(db.collection('livestock').doc(doc.id), { count: firebase.firestore.FieldValue.increment(op.qty) }); });
            } else {
              const newRef = db.collection('livestock').doc();
              tx.set(newRef, { propertyId: payload.propertyId, location: payload.paddock, species: payload.species, class: op.to, count: op.qty }, { merge:true });
            }
          }

          // MISSING: Add to missing stock record
          if (op.miss > 0){
            const mid = missingDocId({propertyId: payload.propertyId, paddock: payload.paddock, species: payload.species, cls: op.cls, fy: fy});
            const mref = db.collection('missingStock').doc(mid);
            tx.set(mref, {
              propertyId: payload.propertyId, location: payload.paddock, species: payload.species,
              class: op.cls, fy: fy, count: firebase.firestore.FieldValue.increment(op.miss),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge:true });
          }
        }

        // 2. Add calves/weaners
        if (Number(mAddCalves.value||0) > 0){
          // We assume 'Calves' is an existing or suggested class. If not, this logic might need refinement based on your business rules.
          const q = db.collection('livestock').where('propertyId','==',payload.propertyId).where('location','==',payload.paddock).where('species','==',payload.species).where('class','==','Calves');
          const s = await tx.get(q);
          if (!s.empty){
            s.forEach(doc=>{ tx.update(db.collection('livestock').doc(doc.id), {count: firebase.firestore.FieldValue.increment(Number(mAddCalves.value))}); });
          } else {
            tx.set(db.collection('livestock').doc(), { propertyId: payload.propertyId, location: payload.paddock, species: payload.species, class: 'Calves', count: Number(mAddCalves.value) }, { merge:true });
          }
        }
        if (Number(mAddWeaners.value||0) > 0){
          const q = db.collection('livestock').where('propertyId','==',payload.propertyId).where('location','==',payload.paddock).where('species
