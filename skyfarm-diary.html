<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SkyFarm — Diary</title>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    :root { --brand:#0B7A6E; --br:#e5e7eb; --muted:#64748b; --ok:#0B7A6E; --warn:#9a3412; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#f6fbf8; margin:16px; color:#0f172a; }
    h1 { margin:0 0 12px; font-size:1.6rem; }
    .wrap { max-width:1100px; margin:0 auto; }
    .card { background:#fff; border:1px solid var(--br); border-radius:12px; padding:12px; margin:12px 0; }
    .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; align-items:center; }
    label { display:block; font-size:.9rem; color:#475569; margin-bottom:4px; }
    input, select, button { padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; font:inherit; }
    button { cursor:pointer; }
    .primary { background:var(--brand); border-color:var(--brand); color:#fff; }
    .danger { background:#ef4444; border-color:#ef4444; color:#fff; }
    .muted { color:var(--muted); font-size:.9rem; }
    .spacer { flex:1; }
    .hidden { display:none; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #e5e7eb; padding:8px; text-align:left; vertical-align:top; }
    th { background:#f1f5f9; position:sticky; top:0; }
    .nowrap { white-space:nowrap; }
    .pill { padding:2px 8px; border-radius:999px; background:#e2e8f0; font-size:.8rem; border:1px solid #cbd5e1; }
    .w80 { width:80px; } .w110 { width:110px; } .w140 { width:140px; } .w200 { width:200px; } .w240 { width:240px; }
    .status-ok { color:var(--ok); } .status-warn { color:var(--warn); }
    .small { font-size:.9rem; }
    .pill[role="button"] { cursor:pointer; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>SkyFarm — Diary</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Property</label>
        <select id="propSel" class="w240"></select>
      </div>
      <div>
        <label>Date</label>
        <input id="dateInp" type="date"/>
      </div>
      <div>
        <label>Time</label>
        <input id="timeInp" type="time"/>
      </div>
      <div>
        <label>Activity</label>
        <select id="activitySel" class="w240">
          <option value="Ploughing">Ploughing</option>
          <option value="Planting">Planting</option>
          <option value="Spraying paddocks">Spraying paddocks</option>
          <option value="Chemical (stock)">Chemical (stock)</option>
          <option value="Trucking (sale)">Trucking (sale)</option>
          <option value="Cattle Received (Purchase)">Cattle Received (Purchase)</option>
          <option value="Move stock">Move stock (Paddock to Paddock)</option>
          <option value="Transfer stock (In)">Transfer stock (Property In)</option>
          <option value="Transfer stock (Out)">Transfer stock (Property Out)</option>
          <option value="Mustering">Mustering</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <span class="spacer"></span>
      <div>
        <label>&nbsp;</label>
        <span id="status" class="muted">Connecting…</span>
      </div>
    </div>

    <div class="row">
      <div style="min-width:260px">
        <label>Paddock</label>
        <select id="paddockSel" class="w240"><option value="">(choose)</option></select>
      </div>

      <div id="transferPropRow" class="hidden" style="min-width:260px">
        <label>To/From Property</label>
        <select id="transferPropSel" class="w240"><option value="">(choose)</option></select>
      </div>

      <div style="min-width:260px; flex:1">
        <label>Notes</label>
        <input id="notesInp" placeholder="optional"/>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Rain gauge</label>
        <select id="gaugeSel" class="w240"><option value="">(choose)</option></select>
      </div>
      <div>
        <label>Rainfall (mm)</label>
        <input id="rainMm" type="number" min="0" step="0.1" class="w110"/>
      </div>
      <div class="muted">Adds to gauge total and per-day totals; auto-reverts on edit/delete.</div>
    </div>

    <div id="chemRow" class="row hidden">
      <div>
        <label>Chemical</label>
        <select id="chemSel" class="w240"><option value="">(choose)</option></select>
      </div>
      <div>
        <label>Qty used</label>
        <input id="chemQty" type="number" min="0" step="0.01" class="w110"/>
      </div>
      <div>
        <label>Unit</label>
        <input id="chemUnit" placeholder="KG/L" class="w80" disabled/>
      </div>
      <div><label>&nbsp;</label><span id="chemHint" class="pill">context</span></div>
    </div>

    <div id="stockRow" class="row hidden">
      <div>
        <label>Species</label>
        <select id="speciesSel">
          <option value="Cattle">Cattle</option>
          <option value="Sheep">Sheep</option>
          <option value="Goats">Goats</option>
        </select>
      </div>
      <div>
        <label>Class</label>
        <input id="classInp" placeholder="e.g. Weaners" class="w200" list="classOptions"/>
        <datalist id="classOptions"></datalist>
      </div>
      <div>
        <label>Head</label>
        <input id="headInp" type="number" min="0" step="1" class="w110"/>
      </div>
      <div id="stockDetail1">
        <label>Buyer / Dest (Trucking)</label>
        <input id="truckBuyer" placeholder="e.g. Roma" class="w200"/>
      </div>
      <div id="stockDetail2">
        <label>Docket / Ref</label>
        <input id="truckRef" placeholder="NVD / docket" class="w200"/>
      </div>
    </div>

    <!-- NEW: Live “what’s in paddock” context strip for Trucking/Move -->
    <div id="stockContext" class="row small" style="gap:6px; color:#334155;"></div>

    <!-- Mustering panel -->
    <div id="musterBox" class="card hidden" style="margin-top:8px">
      <div class="row"><strong>Mustering details</strong></div>

      <div class="row small" id="musterContext" style="gap:6px; color:#334155;"></div>

      <div class="row">
        <div>
          <label>Expected (auto)</label>
          <input id="mExp" type="number" class="w110" disabled/>
        </div>
        <div>
          <label>Actual</label>
          <input id="mAct" type="number" class="w110"/>
        </div>
        <div>
          <label>Delta (auto)</label>
          <input id="mDelta" type="number" class="w110" disabled/>
        </div>
        <div style="flex:1; min-width:260px">
          <label>Reason / notes</label>
          <input id="mReason" placeholder="e.g. counted late, moved to North 2…"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Add calves</label>
          <input id="mAddCalves" type="number" class="w110"/>
        </div>
        <div>
          <label>Add weaners</label>
          <input id="mAddWeaners" type="number" class="w110"/>
        </div>
        <div class="spacer"></div>
        <button id="addClassRowBtn">Add class row</button>
      </div>

      <div class="row">
        <strong>Reclass / counts by class</strong>
      </div>
      <div class="row" style="overflow:auto">
        <table id="mClassTable" style="min-width:760px">
          <thead>
            <tr>
              <th>Class</th>
              <th>Expected</th>
              <th>New count</th>
              <th>Reclass to</th>
              <th>Qty</th>
              <th>Missing</th>
            </tr>
          </thead>
          <tbody id="mClassBody"><tr><td colspan="6">Pick property + paddock + species to load current classes…</td></tr></tbody>
        </table>
      </div>
      <div class="muted">Set a <em>New count</em> to overwrite a class total, or use <em>Reclass to + Qty</em> to move headcounts between classes. Use <em>Missing</em> to hold animals that didn’t turn up — they’re tracked against the current financial year.</div>
    </div>

    <div class="row">
      <button id="saveBtn" class="primary">Save entry</button>
      <button id="cancelEditBtn" class="hidden">Cancel edit</button>
      <button id="resetBtn">Reset</button>
      <span id="msg" class="muted" aria-live="polite"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <strong>Recent entries</strong>
      <span class="spacer"></span>
      <label>Year</label>
      <input id="yearInp" type="number" min="2000" max="2100" class="w110"/>
      <button id="exportCsvBtn">Export CSV</button>
      <button id="printBtn">Print year</button>
      <button id="refreshBtn">Refresh</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Property</th><th>Activity</th><th>Paddock</th><th>Rain (mm)</th><th>Chemical</th><th>Head</th><th></th>
        </tr>
      </thead>
      <tbody id="entriesTbody"><tr><td colspan="8">Loading…</td></tr></tbody>
    </table>
  </div>
</div>

<script>
/*** Firebase ***/
const firebaseConfig = {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJlGvBwmW70", // corrected
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/*** Helpers ***/
const $ = s => document.querySelector(s);
const setStatus = t => { const el=$('#status'); el.textContent = t||''; el.className = t?.toLowerCase().includes('connected') ? 'status-ok' : 'status-warn'; };
const setMsg = (t, ms=3000) => { $('#msg').textContent = t||''; if(t&&ms) setTimeout(()=>$('#msg').textContent='', ms); };
const todayISO = () => new Date().toISOString().slice(0,10);
const escapeHtml = s => String(s ?? '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
const yBounds = (y)=>({ start:`${y}-01-01`, end:`${y}-12-31` });
const fmtDateKey = d => d;
function fyLabel(dateStr){ const [y,m]=dateStr.split('-').map(Number); return (m>=7)?`${y}-${String(y+1).slice(2)}`:`${y-1}-${String(y).slice(2)}`; }
function missingDocId({propertyId, paddock, species, cls, fy}){ const safe=s=>String(s||'').replace(/[^\w.-]/g,'_'); return `${safe(propertyId)}__${safe(paddock)}__${safe(species)}__${safe(cls)}__${safe(fy)}`; }

/*** URL params (from Map deep-links) ***/
const url = new URL(location.href);
const urlPropId    = url.searchParams.get('propertyId') || '';
const urlPropName  = url.searchParams.get('propertyName') || '';
const urlPaddock   = url.searchParams.get('paddock') || '';
const urlChemOnly  = url.searchParams.get('chemOnly') === 'true';

/*** Suggested classes ***/
const SUGGESTED_CLASSES = ["Cows","Heifers","Bulls","Steers","PTIC cows","Joined cows","Calves","Weaners"];

/*** Properties (fixed Mt Myrtle ID) ***/
const propertyIds = {
  "Consentes":"s7PlDM9wrEpxuJ6DGIab",
  "Mt Myrtle":"TRuxtRBX2zJlwZnRGYKJ",
  "Gerawin":"P0dQ0H2FWHeqqxejflZs"
};
const propertyNameById = Object.fromEntries(Object.entries(propertyIds).map(([n,i])=>[i,n]));

/*** Elements ***/
const propSel = $('#propSel'), dateInp = $('#dateInp'), timeInp = $('#timeInp'), activitySel = $('#activitySel');
const paddockSel = $('#paddockSel'), notesInp = $('#notesInp');
const transferPropRow = $('#transferPropRow'), transferPropSel = $('#transferPropSel');
const gaugeSel = $('#gaugeSel'), rainMm = $('#rainMm');
const chemRow = $('#chemRow'), chemSel = $('#chemSel'), chemQty = $('#chemQty'), chemUnit = $('#chemUnit'), chemHint = $('#chemHint');
const stockRow = $('#stockRow'), speciesSel = $('#speciesSel'), classInp = $('#classInp'), headInp = $('#headInp'), truckBuyer=$('#truckBuyer'), truckRef=$('#truckRef');
const stockDetail1 = $('#stockDetail1'), stockDetail2 = $('#stockDetail2');
const stockContext = $('#stockContext');
const musterBox = $('#musterBox'), mExp=$('#mExp'), mAct=$('#mAct'), mDelta=$('#mDelta'), mReason=$('#mReason'), mAddCalves=$('#mAddCalves'), mAddWeaners=$('#mAddWeaners'), mClassBody=$('#mClassBody'), addClassRowBtn=$('#addClassRowBtn'), musterContext=$('#musterContext');
const saveBtn = $('#saveBtn'), cancelEditBtn = $('#cancelEditBtn'), entriesTbody = $('#entriesTbody');
const yearInp = $('#yearInp'), exportCsvBtn = $('#exportCsvBtn'), printBtn = $('#printBtn');
const classOptions = $('#classOptions');

/*** Caches / state ***/
let paddocks=[], gauges=[], chems=[], entries=[];
let editingId = null, originalEntry = null;

/*** Bootstrap ***/
(async function init(){
  try {
    try { await firebase.firestore().enablePersistence({synchronizeTabs:true}); } catch(e) { console.warn('Persistence not available:', e && e.code); }
    setStatus('Connecting…');
    await auth.signInAnonymously().catch(err=>{ console.warn('Anon auth failed:', err?.code, err?.message); });
    setStatus('Connected');
  } catch(e){ console.error(e); setStatus('Auth issue (check Anonymous Sign-in & Authorized domains)'); }

  // properties (+ All)
  const propOptions = Object.keys(propertyIds).map(n=>`<option value="${propertyIds[n]}">${n}</option>`).join('');
  propSel.innerHTML = '<option value="ALL">(All properties)</option>' + propOptions;

  // Transfer properties (all except currently selected)
  transferPropSel.innerHTML = '<option value="">(choose property)</option>' + propOptions;

  dateInp.value = todayISO(); yearInp.value = new Date().getFullYear();

  // events
  activitySel.onchange = onActivityChange;
  propSel.onchange = onPropertyChange;
  $('#refreshBtn').onclick = refreshEntries;
  $('#resetBtn').onclick = ()=>resetForm(false);
  cancelEditBtn.onclick = ()=>{ resetForm(false); setMsg('Edit cancelled'); };
  saveBtn.onclick = ()=> saveEntry().catch(e=>{console.error(e); setMsg('Save failed: '+(e?.message||e));});
  exportCsvBtn.onclick = exportYearCsv;
  printBtn.onclick = printYear;
  addClassRowBtn.onclick = addMusterClassRow;
  paddockSel.onchange = onPaddockOrSpeciesChange;
  speciesSel.onchange = onPaddockOrSpeciesChange;
  mAct.oninput = ()=>{ mDelta.value = (Number(mAct.value||0) - Number(mExp.value||0)) || 0; };
  transferPropSel.onchange = onTransferPropertyChange;

  onActivityChange();

  // Preselect from URL (map deep-link)
  if (urlPropId || urlPropName){
    const pid = urlPropId || propertyIds[urlPropName] || '';
    if (pid && propSel.querySelector(`option[value="${pid}"]`)) propSel.value = pid;
  }
  await onPropertyChange();

  // If paddock provided via URL, attempt fuzzy-select
  if (urlPaddock) { trySelectPaddockByName(urlPaddock); }

  // If chemOnly flag from map, pre-pick “Spraying paddocks”
  if (urlChemOnly) { activitySel.value = 'Spraying paddocks'; onActivityChange(); }

  await refreshEntries();
})();

/*** UI Toggles ***/
function onActivityChange(){
  const act = activitySel.value;

  const needsChem = (act==='Spraying paddocks' || act==='Chemical (stock)' || act==='Trucking (sale)');
  chemRow.classList.toggle('hidden', !needsChem);
  chemHint.textContent = (act==='Spraying paddocks') ? 'paddock spray'
                     : (act==='Trucking (sale)' ? 'backline before transport' : 'stock treatment');

  const needsStock = (act==='Trucking (sale)' || act==='Move stock' || act==='Chemical (stock)' || act==='Mustering' || act==='Cattle Received (Purchase)' || act.startsWith('Transfer stock'));
  stockRow.classList.toggle('hidden', !needsStock);

  const needsPaddock = !(act==='Transfer stock (In)' || act==='Transfer stock (Out)' || act==='Cattle Received (Purchase)');
  paddockSel.closest('div').classList.toggle('hidden', !needsPaddock);
  gaugeSel.closest('div').classList.toggle('hidden', act==='Transfer stock (Out)' || act==='Transfer stock (In)');

  const needsTransferProp = (act==='Transfer stock (In)' || act==='Transfer stock (Out)');
  transferPropRow.classList.toggle('hidden', !needsTransferProp);

  const needsTruckDetails = (act==='Trucking (sale)' || act==='Cattle Received (Purchase)');
  stockDetail1.classList.toggle('hidden', !needsTruckDetails);
  stockDetail2.classList.toggle('hidden', !needsTruckDetails);

  // Labels
  const label1 = (act==='Trucking (sale)') ? 'Buyer / Dest (Trucking)' : 'Seller / Source';
  stockDetail1.querySelector('label').textContent = label1;
  stockDetail1.querySelector('input').placeholder = (act==='Trucking (sale)') ? 'e.g. Roma' : 'e.g. Mt Myrtle';

  musterBox.classList.toggle('hidden', act!=='Mustering');
  saveBtn.disabled = (propSel.value==='ALL');

  if (act==='Cattle Received (Purchase)') { speciesSel.value = 'Cattle'; }

  buildChemDropdown();

  // NEW: refresh paddock/species context when activity changes
  onPaddockOrSpeciesChange();
}

// Update UI/dropdowns when choosing transfer property
function onTransferPropertyChange() {
  const act = activitySel.value;
  if (act === 'Transfer stock (In)') {
    onPropertyChange(); // ensure paddocks for current property are loaded
  }
}

/*** Property change: load paddocks, gauges, chems ***/
async function onPropertyChange(){
  const pid = propSel.value;

  // Update transfer dropdown to exclude the currently selected property
  transferPropSel.innerHTML = '<option value="">(choose property)</option>' +
    Object.entries(propertyIds).filter(([n,id]) => id !== pid)
      .map(([n,id])=>`<option value="${id}">${n}</option>`).join('');

  if (pid==='ALL'){
    paddockSel.innerHTML = '<option value="">(choose a property to select paddock)</option>';
    gaugeSel.innerHTML = '<option value="">(choose a property to select gauge)</option>';
    chemSel.innerHTML = '<option value="">(choose a property to select chemical)</option>';
    classOptions.innerHTML = '';
    saveBtn.disabled = true;
    mClassBody.innerHTML = '<tr><td colspan="6">Pick property + paddock + species to load current classes…</td></tr>';
    musterContext.innerHTML = '';
    stockContext.innerHTML = '';
    return;
  }

  saveBtn.disabled = false;

  // paddocks for this property
  paddocks=[]; paddockSel.innerHTML='<option>(loading…)</option>';
  const paddockSnap = await db.collection('paddocks').where('propertyId','==',pid).get();
  paddockSnap.forEach(d=>paddocks.push({id:d.id, ...d.data()}));
  paddockSel.innerHTML='<option value="">(choose)</option>'+paddocks.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))
    .map(p=>`<option value="${p.id}" data-name="${escapeHtml(p.name||'')}">${escapeHtml(p.name||'(unnamed)')}</option>`).join('');

  // gauges for this property
  gauges=[]; gaugeSel.innerHTML='<option>(loading…)</option>';
  const gaugeSnap = await db.collection('gauges').where('propertyId','==',pid).get();
  gaugeSnap.forEach(d=>gauges.push({id:d.id, ...d.data()}));
  gaugeSel.innerHTML='<option value="">(choose)</option>'+gauges.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))
    .map(g=>`<option value="${g.id}" data-name="${escapeHtml(g.name||'')}">${escapeHtml(g.name||'(unnamed)')}</option>`).join('');

  // chems (top-level with propertyId filter)
  chems=[]; chemSel.innerHTML='<option>(loading…)</option>';
  const chemSnap = await db.collection('chemicals').where('propertyId','==',pid).get();
  chemSnap.forEach(d=>chems.push({id:d.id, ...d.data()}));
  buildChemDropdown();

  await onPaddockOrSpeciesChange();
}

/*** Fuzzy paddock select for deep-links from Map ***/
const norm = s => String(s||'').toLowerCase().trim();
const strip = s => norm(s).replace(/[^a-z0-9]+/g,'');
function trySelectPaddockByName(name){
  const target = strip(name);
  if (!target) return;
  for (const opt of paddockSel.options){
    if (norm(opt.dataset?.name||'') === norm(name)) { paddockSel.value = opt.value; return; }
  }
  let bestOpt=null, bestScore=0;
  for (const opt of paddockSel.options){
    const s = strip(opt.dataset?.name||'');
    if (!s) continue;
    if (s.includes(target) || target.includes(s)) { paddockSel.value = opt.value; return; }
    const score = commonPrefix(s,target).length;
    if (score>bestScore){ bestScore=score; bestOpt=opt; }
  }
  if (bestOpt) paddockSel.value = bestOpt.value;
}
function commonPrefix(a,b){ let i=0; for(; i<Math.min(a.length,b.length); i++){ if(a[i]!==b[i]) break; } return a.slice(0,i); }

/*** Chemical dropdown (filtered by use) ***/
function buildChemDropdown(){
  const pid = propSel.value;
  if(pid==='ALL'){ chemSel.innerHTML='<option value="">(choose property)</option>'; chemUnit.value=''; return; }
  const act = activitySel.value;
  const target = act==='Spraying paddocks' ? 'paddock' : (act==='Chemical (stock)' || act==='Trucking (sale)' ? 'stock' : null);
  if(!target){ chemSel.innerHTML='<option value="">(not required)</option>'; chemUnit.value=''; return; }
  const list = chems.filter(c => String(c.useOn||'').toLowerCase()===target && Number(c.quantity||0)>0);
  if(!list.length){ chemSel.innerHTML='<option value="">(no chemicals available)</option>'; chemUnit.value=''; return; }
  chemSel.innerHTML = '<option value="">(choose chemical)</option>' +
    list.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))
      .map(c=>`<option value="${c.id}" data-unit="${c.unit||''}">${escapeHtml(c.name||'Unnamed')} (${c.unit||''}) — ${Number(c.quantity||0)} left</option>`).join('');
  chemSel.onchange = ()=> chemUnit.value = chemSel.selectedOptions[0]?.dataset?.unit || '';
  chemUnit.value = chemSel.selectedOptions[0]?.dataset?.unit || '';
}

/*** Case/field tolerant fetch of livestock rows for a paddock ***/
async function fetchLivestockRows(pid, paddockName, speciesUI){
  const speciesLC = String(speciesUI||'').toLowerCase();

  // exact match first
  let snap = await db.collection('livestock')
    .where('propertyId','==',pid)
    .where('location','==',paddockName)
    .where('species','==',speciesUI)
    .get();

  // try title/upper variants
  if (snap.empty){
    const title = speciesLC.charAt(0).toUpperCase() + speciesLC.slice(1);
    const variants = [title, speciesLC.toUpperCase()];
    for (const v of variants){
      const s2 = await db.collection('livestock')
        .where('propertyId','==',pid)
        .where('location','==',paddockName)
        .where('species','==',v)
        .get();
      if (!s2.empty){ snap = s2; break; }
    }
  }

  let rows = [];
  if (snap.empty){
    const s3 = await db.collection('livestock')
      .where('propertyId','==',pid)
      .where('location','==',paddockName)
      .get();
    s3.forEach(d => rows.push({ id:d.id, ...(d.data()||{}) }));
    rows = rows.filter(r => String(r.species||'').toLowerCase() === speciesLC);
  } else {
    snap.forEach(d => rows.push({ id:d.id, ...(d.data()||{}) }));
  }
  return rows;
}

/*** Expected totals & mustering table build + NEW stock context for Trucking/Move ***/
async function onPaddockOrSpeciesChange(){
  const pid = propSel.value;
  if (pid==='ALL'){ classOptions.innerHTML=''; stockContext.innerHTML=''; return; }

  const act = activitySel.value;
  const isStockMove = (act==='Trucking (sale)' || act==='Move stock' || act==='Chemical (stock)' || act==='Mustering' || act==='Transfer stock (Out)');
  const isStockIn   = (act==='Cattle Received (Purchase)' || act==='Transfer stock (In)');

  let paddockName = (paddockSel.selectedOptions[0]?.dataset?.name || '').trim();
  const speciesUI = speciesSel.value || 'Cattle';

  if (!paddockName && !isStockIn){
    classOptions.innerHTML = SUGGESTED_CLASSES.map(r=>`<option value="${escapeHtml(r)}"></option>`).join('');
    musterContext.innerHTML=''; stockContext.innerHTML='';
    mClassBody.innerHTML='<tr><td colspan="6">Pick property + paddock + species…</td></tr>';
    mExp.value='';
    return;
  }

  let rows = [];
  if (isStockMove && paddockName) {
    rows = await fetchLivestockRows(pid, paddockName, speciesUI);
  } else if (isStockIn) {
    rows = SUGGESTED_CLASSES.map(cls => ({ id: null, class: cls, count: 0 }));
  }

  rows.sort((a,b)=>String(a.class||'').localeCompare(String(b.class||'')));
  classOptions.innerHTML = rows.map(r=>`<option value="${escapeHtml(r.class||'')}"></option>`).join('');

  // --- NEW: show current stock for Trucking/Move and add quick-pick chips ---
  if (isStockMove && paddockName){
    const total = rows.reduce((s,r)=> s + Number(r.count||0), 0);
    if (rows.length){
      stockContext.innerHTML = [
        `<span class="pill">In ${escapeHtml(paddockName)}: ${total} head</span>`,
        ...rows.map(r =>
          `<button type="button" class="pill" role="button" data-cls="${escapeHtml(r.class||'')}" data-head="${Number(r.count||0)}" title="Click to fill class & head">`+
          `${escapeHtml(r.class||'')}: ${Number(r.count||0)}</button>`
        )
      ].join(' ');
      stockContext.querySelectorAll('.pill[data-cls]').forEach(btn=>{
        btn.onclick = () => {
          classInp.value = btn.dataset.cls || '';
          headInp.value  = btn.dataset.head || '';
          headInp.focus();
        };
      });
    } else {
      stockContext.innerHTML = `<span class="muted">No livestock lines found for ${escapeHtml(paddockName)} (${escapeHtml(speciesUI)}).</span>`;
    }
  } else {
    stockContext.innerHTML = '';
  }

  // keep auto-fill when there’s a single class
  if (rows.length===1 && (act==='Trucking (sale)' || act==='Move stock' || act==='Chemical (stock)' || act==='Transfer stock (Out)')){
    classInp.value = rows[0].class || '';
    headInp.value  = Number(rows[0].count||0);
  }

  // Mustering UI
  if (activitySel.value==='Mustering'){
    const total = rows.reduce((s,r)=>s+Number(r.count||0),0);
    mExp.value = total;
    mDelta.value = (Number(mAct.value||0) - Number(mExp.value||0)) || 0;

    const parts = rows.map(r=>`${escapeHtml(r.class||'')}: ${Number(r.count||0)}`);
    musterContext.innerHTML = `<span class="pill">Expected total: ${total}</span> ${parts.length? ' | ' + parts.join(', ') : ''}`;

    const existingClasses = new Set(rows.map(r=>String(r.class||'')));
    for (const cls of SUGGESTED_CLASSES){
      if (!existingClasses.has(cls)) rows.push({ id:null, class:cls, count:0, _new:true });
    }

    mClassBody.innerHTML = rows.map(r=>`
      <tr data-id="${r.id||''}" data-class="${escapeHtml(r.class||'')}">
        <td><input class="mc-class w200" value="${escapeHtml(r.class||'')}" ${r.id ? 'disabled' : ''} /></td>
        <td><input class="mc-current w110" value="${Number(r.count||0)}" disabled /></td>
        <td><input class="mc-new w110" type="number" min="0" /></td>
        <td><input class="mc-to w200" placeholder="e.g. Cows, Heifers, Joined cows" /></td>
        <td><input class="mc-qty w110" type="number" min="0" /></td>
        <td><input class="mc-miss w110" type="number" min="0" /></td>
      </tr>`).join('');
  } else {
    mClassBody.innerHTML = '<tr><td colspan="6" class="muted">Mustering not selected.</td></tr>';
  }
}

function addMusterClassRow(){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="mc-class w200" placeholder="New class name" /></td>
    <td><input class="mc-current w110" value="0" disabled /></td>
    <td><input class="mc-new w110" type="number" min="0" /></td>
    <td><input class="mc-to w200" placeholder="e.g. Cows, Heifers, Joined cows" /></td>
    <td><input class="mc-qty w110" type="number" min="0" /></td>
    <td><input class="mc-miss w110" type="number" min="0" /></td>`;
  mClassBody.appendChild(tr);
}

/*** Save / Update (revert old -> apply new) ***/
async function saveEntry(){
  if (propSel.value==='ALL') return alert('Select a specific property to save.');
  const propId = propSel.value, propName = propertyNameById[propId] || '(unknown)';
  const date = dateInp.value || todayISO(), time = timeInp.value || '';
  const activity = activitySel.value;
  const paddockId = paddockSel.value || '', paddockName = paddockSel.selectedOptions[0]?.dataset?.name || '';
  const notes = notesInp.value || '';
  const gaugeId = gaugeSel.value || null, gaugeName = gaugeSel.selectedOptions[0]?.dataset?.name || null, rainfallVal = gaugeId ? Number(rainMm.value || 0) : null;
  const species = speciesSel.value || '', klass = classInp.value || '', head = parseInt(headInp.value||0,10);
  const chemId = chemSel.value || null, chemQ = parseFloat(chemQty.value||0), chemU = chemUnit.value || '', chemName = chemId ? (chems.find(c=>c.id===chemId)?.name || null) : null;

  const isTruckingSale = activity === 'Trucking (sale)';
  const isPurchase     = activity === 'Cattle Received (Purchase)';
  const isMoveStock    = activity === 'Move stock';
  const isTransferOut  = activity === 'Transfer stock (Out)';
  const isTransferIn   = activity === 'Transfer stock (In)';
  const isStockActivity = (isTruckingSale || isMoveStock || activity==='Chemical (stock)' || activity==='Mustering' || isPurchase || isTransferIn || isTransferOut);

  if ((activity==='Spraying paddocks' || activity==='Chemical (stock)' || isTruckingSale) && chemId && !(chemQ>0))
    return alert('Enter a chemical quantity > 0');

  if (isStockActivity && (isTruckingSale || isMoveStock || isPurchase || isTransferIn || isTransferOut) && !(head > 0 && klass))
    return alert('Enter a Head count and a Class for this stock activity.');

  if ((isTransferOut || isTransferIn) && !transferPropSel.value)
      return alert('Select a To/From Property for the transfer.');

  // muster rows
  const musterOps = [];
  if (activity==='Mustering'){
    document.querySelectorAll('#mClassBody tr').forEach(tr=>{
      const cls = tr.querySelector('.mc-class')?.value?.trim();
      if (!cls) return;
      const cur = Number(tr.querySelector('.mc-current')?.value||0);
      const newCount = tr.querySelector('.mc-new')?.value ? Number(tr.querySelector('.mc-new').value) : null;
      const to = tr.querySelector('.mc-to')?.value?.trim();
      const qty = tr.querySelector('.mc-qty')?.value ? Number(tr.querySelector('.mc-qty').value) : 0;
      const miss = tr.querySelector('.mc-miss')?.value ? Number(tr.querySelector('.mc-miss').value) : 0;
      const id = tr.getAttribute('data-id') || null;
      musterOps.push({id, cls, cur, newCount, to, qty, miss});
    });
  }

  const fy = fyLabel(date);

  const transferPropId = transferPropSel.value || null;
  const transferPropName = transferPropId ? propertyNameById[transferPropId] : null;

  const payload = {
    propertyId: propId, propertyName: propName,
    date, time, activity,
    paddockId: paddockId || null, paddock: paddockName || null,
    transferPropId, transferPropName,
    notes,
    rainfallGaugeId: gaugeId, rainfallGaugeName: gaugeName, rainfallMm: rainfallVal,
    species: isStockActivity ? species : null,
    livestockClass: isStockActivity ? klass : null,
    headCount: (isTruckingSale || isMoveStock || isPurchase || isTransferIn || isTransferOut) ? head : null,
    chemicalId: chemId || null, chemicalName: chemName, chemQty: chemId ? chemQ : null, chemUnit: chemId ? chemU : null,
    truckBuyer: isTruckingSale || isPurchase ? (truckBuyer.value || '') : null,
    truckRef:   isTruckingSale || isPurchase ? (truckRef.value || '')   : null,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    musterExpected: activity==='Mustering' ? Number(mExp.value||0) : null,
    musterActual:  activity==='Mustering' ? Number(mAct.value||0) : null,
    musterDelta:   activity==='Mustering' ? (Number(mAct.value||0) - Number(mExp.value||0)) : null,
    musterReason:  activity==='Mustering' ? (mReason.value || '') : null,
    musterAdds:    activity==='Mustering' ? { calves:Number(mAddCalves.value||0), weaners:Number(mAddWeaners.value||0) } : null,
    musterMissing: activity==='Mustering' ? musterOps.filter(r=>r.miss>0).map(r=>({cls:r.cls, qty: Number(r.miss||0), fy})) : null,
    createdAt: editingId ? undefined : firebase.firestore.FieldValue.serverTimestamp()
  };

  try{
    await db.runTransaction(async (tx)=>{
      let entryId = editingId || db.collection('diaryEntries').doc().id;
      const entryRef = db.collection('diaryEntries').doc(entryId);

      // ===================== 1) REVERT OLD EFFECTS (if editing) =====================
      if (editingId){
        const oldSnap = await tx.get(entryRef);
        if (oldSnap.exists){
          const old = oldSnap.data() || {};
          const oldIsTruckingSale = old.activity === 'Trucking (sale)';
          const oldIsPurchase     = old.activity === 'Cattle Received (Purchase)';
          const oldIsMoveStock    = old.activity === 'Move stock';
          const oldIsTransferOut  = old.activity === 'Transfer stock (Out)';
          const oldIsTransferIn   = old.activity === 'Transfer stock (In)';

          // Revert chemical
          if (old.chemicalId && Number(old.chemQty||0)>0){
            const cref = db.collection('chemicals').doc(old.chemicalId);
            const cs = await tx.get(cref); if (cs.exists) tx.update(cref, {quantity:Number(cs.data().quantity||0)+Number(old.chemQty||0)});
          }

          // Revert stock movements
          if ((oldIsTruckingSale || oldIsMoveStock || oldIsTransferOut) && Number(old.headCount||0)>0 && old.species && old.livestockClass && old.paddock){
            const q = db.collection('livestock').where('propertyId','==',old.propertyId).where('location','==',old.paddock).where('species','==',old.species).where('class','==',old.livestockClass);
            const s = await tx.get(q);
            if (s.empty){
              const newRef = db.collection('livestock').doc();
              tx.set(newRef, { propertyId: old.propertyId, location: old.paddock, species: old.species, class: old.livestockClass, count: Number(old.headCount||0) }, { merge:true });
            } else {
              s.forEach(doc=> tx.update(doc.ref, {count: firebase.firestore.FieldValue.increment(Number(old.headCount||0))}) );
            }
          }
          if (oldIsTransferIn && Number(old.headCount||0)>0 && old.species && old.livestockClass && old.paddock){
            const q = db.collection('livestock').where('propertyId','==',old.propertyId).where('location','==',old.paddock).where('species','==',old.species).where('class','==',old.livestockClass);
            const s = await tx.get(q);
            s.forEach(doc=> tx.update(doc.ref, {count: firebase.firestore.FieldValue.increment(-Number(old.headCount||0))}) );
          }
          if (oldIsPurchase && Number(old.headCount||0)>0 && old.species && old.livestockClass && old.paddock){
            const q = db.collection('livestock').where('propertyId','==',old.propertyId).where('location','==',old.paddock).where('species','==',old.species).where('class','==',old.livestockClass);
            const s = await tx.get(q);
            s.forEach(doc=> tx.update(doc.ref, {count: firebase.firestore.FieldValue.increment(-Number(old.headCount||0))}) );
          }

          // Revert rainfall
          if (old.rainfallGaugeId && Number(old.rainfallMm||0)>0){
            const gref = db.collection('gauges').doc(old.rainfallGaugeId); const gs = await tx.get(gref);
            if (gs.exists){
              tx.update(gref,{ rainTotal: firebase.firestore.FieldValue.increment(-Number(old.rainfallMm||0)), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
              const dayRef = gref.collection('daily').doc(fmtDateKey(old.date || todayISO()));
              tx.set(dayRef, { mm: firebase.firestore.FieldValue.increment(-Number(old.rainfallMm||0)) , date: fmtDateKey(old.date || todayISO()) }, { merge:true });
              tx.set(gref.collection('readings').doc(entryId), { date: old.date || todayISO(), mm: 0, diaryEntryId: entryId }, { merge:true });
            }
          }

          // Revert muster missing
          if (Array.isArray(old.musterMissing)){
            for (const m of old.musterMissing){
              const mid = missingDocId({propertyId: old.propertyId, paddock: old.paddock, species: old.species, cls: m.cls, fy: m.fy});
              const mref = db.collection('missingStock').doc(mid);
              tx.set(mref, {
                propertyId: old.propertyId, location: old.paddock, species: old.species,
                class: m.cls, fy: m.fy, count: firebase.firestore.FieldValue.increment(-Number(m.qty||0)),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              }, { merge:true });
            }
          }
        }
      }

      // ===================== 2) APPLY NEW EFFECTS =====================
      // Chemical deduction
      if (payload.chemicalId && Number(payload.chemQty||0)>0){
        const cref = db.collection('chemicals').doc(payload.chemicalId);
        const csnap = await tx.get(cref); if(!csnap.exists) throw new Error('Chemical not found');
        const next = Number(csnap.data().quantity||0) - Number(payload.chemQty||0);
        if (next < -0.0001) throw new Error('Not enough chemical in inventory');
        tx.update(cref, {quantity: next});
      }

      // Stock: Sale, Move, Transfer Out => remove from source
      if ((isTruckingSale || isMoveStock || isTransferOut) && Number(payload.headCount||0)>0 && payload.species && payload.livestockClass && payload.paddock){
        const q = db.collection('livestock').where('propertyId','==',payload.propertyId).where('location','==',payload.paddock).where('species','==',payload.species).where('class','==',payload.livestockClass);
        const s = await tx.get(q);
        if (s.empty) throw new Error(`No ${payload.livestockClass} in ${payload.paddock} to move/sell.`);
        s.forEach(doc=>{
          const cur=Number((doc.data()||{}).count||0);
          const next=cur-Number(payload.headCount||0);
          if(next<0) throw new Error(`${payload.activity} would make class count negative in ${payload.paddock}`);
          tx.update(doc.ref, {count: next});
        });

        // Optional: create a paired IN record as a reminder (no stock add yet)
        if (isTransferOut) {
          const destPid = payload.transferPropId, destPName = payload.transferPropName;
          const transferInId = db.collection('diaryEntries').doc().id;
          const transferInPayload = {
            ...payload,
            propertyId: destPid, propertyName: destPName,
            transferPropId: payload.propertyId, transferPropName: payload.propertyName,
            activity: 'Transfer stock (In)',
            paddockId: null, paddock: null,
            chemicalId: null, chemQty: null, chemUnit: null, chemicalName: null,
            notes: `Received from ${payload.propertyName}. [Link to OUT entry: ${entryId}]`,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          };
          tx.set(db.collection('diaryEntries').doc(transferInId), transferInPayload, { merge:true });
        }
      }

      // Stock: Purchase, Transfer In => add to destination
      if ((isPurchase || isTransferIn) && Number(payload.headCount||0)>0 && payload.species && payload.livestockClass && payload.paddock){
        const q = db.collection('livestock').where('propertyId','==',payload.propertyId).where('location','==',payload.paddock).where('species','==',payload.species).where('class','==',payload.livestockClass);
        const s = await tx.get(q);
        if (s.empty) {
          const newRef = db.collection('livestock').doc();
          tx.set(newRef, { propertyId: payload.propertyId, location: payload.paddock, species: payload.species, class: payload.livestockClass, count: payload.headCount }, { merge:true });
        } else {
          s.forEach(doc=> tx.update(doc.ref, {count: firebase.firestore.FieldValue.increment(payload.headCount)}) );
        }
      }

      // Rainfall
      if (payload.rainfallGaugeId && Number(payload.rainfallMm||0)>0){
        const gref = db.collection('gauges').doc(payload.rainfallGaugeId);
        const gs = await tx.get(gref); if(!gs.exists) throw new Error('Gauge not found');
        tx.update(gref, { rainTotal: firebase.firestore.FieldValue.increment(Number(payload.rainfallMm||0)), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        const dayRef = gref.collection('daily').doc(fmtDateKey(payload.date));
        tx.set(dayRef, { date: fmtDateKey(payload.date), mm: firebase.firestore.FieldValue.increment(Number(payload.rainfallMm||0)) }, { merge:true });
        tx.set(gref.collection('readings').doc(entryId), { date: payload.date, mm: Number(payload.rainfallMm||0), diaryEntryId: entryId }, { merge:true });
      }

      // Mustering ops
      if (activity==='Mustering'){
        const baseQ = db.collection('livestock').where('propertyId','==',payload.propertyId).where('location','==',payload.paddock).where('species','==',payload.species);

        for (const op of musterOps){
          const isNew = op.id === null;
          let ref;
          if (isNew){
            ref = db.collection('livestock').doc();
            tx.set(ref, { propertyId: payload.propertyId, location: payload.paddock, species: payload.species, class: op.cls, count: Number(op.cur||0) }, { merge:true });
          } else {
            ref = db.collection('livestock').doc(op.id);
          }

          if (op.newCount !== null){
            tx.set(ref, { count: op.newCount }, { merge:true });
          }

          if (op.to && op.qty > 0){
            if (!isNew){
              tx.update(ref, { count: firebase.firestore.FieldValue.increment(-op.qty) });
            }
            const toQ = db.collection('livestock').where('propertyId','==',payload.propertyId).where('location','==',payload.paddock).where('species','==',payload.species).where('class','==',op.to);
            const toSnap = await tx.get(toQ);
            if (!toSnap.empty){
              toSnap.forEach(doc=> tx.update(doc.ref, { count: firebase.firestore.FieldValue.increment(op.qty) }) );
            } else {
              tx.set(db.collection('livestock').doc(), { propertyId: payload.propertyId, location: payload.paddock, species: payload.species, class: op.to, count: op.qty }, { merge:true });
            }
          }

          if (op.miss > 0){
            const mid = missingDocId({propertyId: payload.propertyId, paddock: payload.paddock, species: payload.species, cls: op.cls, fy: fy});
            const mref = db.collection('missingStock').doc(mid);
            tx.set(mref, {
              propertyId: payload.propertyId, location: payload.paddock, species: payload.species,
              class: op.cls, fy: fy, count: firebase.firestore.FieldValue.increment(op.miss),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge:true });
          }
        }

        if (Number(mAddCalves.value||0) > 0){
          const q = db.collection('livestock').where('propertyId','==',payload.propertyId).where('location','==',payload.paddock).where('species','==',payload.species).where('class','==','Calves');
          const s = await tx.get(q);
          if (!s.empty){
            s.forEach(doc=> tx.update(doc.ref, {count: firebase.firestore.FieldValue.increment(Number(mAddCalves.value))}) );
          } else {
            tx.set(db.collection('livestock').doc(), { propertyId: payload.propertyId, location: payload.paddock, species: payload.species, class: 'Calves', count: Number(mAddCalves.value) }, { merge:true });
          }
        }
        if (Number(mAddWeaners.value||0) > 0){
          const q = db.collection('livestock').where('propertyId','==',payload.propertyId).where('location','==',payload.paddock).where('species','==',payload.species).where('class','==','Weaners');
          const s = await tx.get(q);
          if (!s.empty){
            s.forEach(doc=> tx.update(doc.ref, {count: firebase.firestore.FieldValue.increment(Number(mAddWeaners.value))}) );
          } else {
            tx.set(db.collection('livestock').doc(), { propertyId: payload.propertyId, location: payload.paddock, species: payload.species, class: 'Weaners', count: Number(mAddWeaners.value) }, { merge:true });
          }
        }
      }

      // Finally write diary entry
      tx.set(entryRef, payload, { merge:true });
    });

    setMsg('Saved.');
    editingId = null; originalEntry=null;
    await refreshEntries();
  }catch(e){
    console.error(e);
    alert(e?.message || 'Save failed');
  }
}

/*** Listing (simple recent list for the year filter) ***/
async function refreshEntries(){
  entriesTbody.innerHTML = '<tr><td colspan="8">Loading…</td></tr>';
  const y = Number(yearInp.value || new Date().getFullYear());
  const {start,end} = yBounds(y);
  let q = db.collection('diaryEntries').where('date','>=',start).where('date','<=',end).orderBy('date','desc').limit(100);
  const snap = await q.get();
  const rows=[];
  snap.forEach(doc=>{
    const d = { id:doc.id, ...doc.data() };
    rows.push(`<tr>
      <td>${escapeHtml(d.date||'')}</td>
      <td>${escapeHtml(d.propertyName||'')}</td>
      <td>${escapeHtml(d.activity||'')}</td>
      <td>${escapeHtml(d.paddock||'')}</td>
      <td>${Number(d.rainfallMm||0) || ''}</td>
      <td>${escapeHtml(d.chemicalName||'')}</td>
      <td>${Number(d.headCount||0) || ''}</td>
      <td class="nowrap">
        <button onclick="editEntry('${d.id}')">Edit</button>
        <button class="danger" onclick="delEntry('${d.id}')">Delete</button>
      </td>
    </tr>`);
  });
  entriesTbody.innerHTML = rows.length? rows.join('') : '<tr><td colspan="8">No entries.</td></tr>';
}

window.editEntry = async function(id){
  try{
    const doc = await db.collection('diaryEntries').doc(id).get();
    if(!doc.exists) return;
    const d = { id:doc.id, ...doc.data() };
    editingId = id; originalEntry = d;

    propSel.value = d.propertyId || 'ALL'; await onPropertyChange();
    dateInp.value = d.date || todayISO(); timeInp.value = d.time || '';
    activitySel.value = d.activity || 'Other'; onActivityChange();
    notesInp.value = d.notes || '';

    // paddock
    if (d.paddockId && paddockSel.querySelector(`option[value="${d.paddockId}"]`)) {
      paddockSel.value = d.paddockId;
    } else {
      // try fuzzy by name
      if (d.paddock) trySelectPaddockByName(d.paddock);
    }

    // transfer property
    if (d.transferPropId && transferPropSel.querySelector(`option[value="${d.transferPropId}"]`)){
      transferPropSel.value = d.transferPropId;
    }

    // stock / chem
    speciesSel.value = d.species || 'Cattle';
    classInp.value = d.livestockClass || '';
    headInp.value  = d.headCount || '';
    truckBuyer.value = d.truckBuyer || '';
    truckRef.value   = d.truckRef || '';
    chemSel.value = d.chemicalId || '';
    chemQty.value = d.chemQty || '';
    chemUnit.value = d.chemUnit || '';

    mExp.value = d.musterExpected || '';
    mAct.value = d.musterActual || '';
    mDelta.value = d.musterDelta || '';
    mReason.value = d.musterReason || '';

    // show cancel
    cancelEditBtn.classList.remove('hidden');

    await onPaddockOrSpeciesChange();
    setMsg('Editing ' + id.slice(0,6) + '…', 2000);
  }catch(e){ alert('Edit error: ' + (e?.message||e)); }
};

window.delEntry = async function(id){
  if(!confirm('Delete this entry? This will reverse its effects.')) return;
  try{
    // load entry and reuse save logic by doing a revert then delete
    const doc = await db.collection('diaryEntries').doc(id).get();
    if(doc.exists){
      // Temporarily set editing state to reuse revert path
      editingId = id; originalEntry = doc.data();
      // Create a no-op payload and run transaction that only reverts+deletes
      await db.runTransaction(async (tx)=>{
        const ref = db.collection('diaryEntries').doc(id);
        const snap = await tx.get(ref);
        if (!snap.exists) return;
        // Reuse revert part: set up as if saving with empty effects
        // Simple revert route: call saveEntry-like revert by mimicking edits is heavy.
        // Here we directly perform reversal similar to save flow above:

        const old = snap.data()||{};
        // Revert chemical
        if (old.chemicalId && Number(old.chemQty||0)>0){
          const cref = db.collection('chemicals').doc(old.chemicalId);
          const cs = await tx.get(cref); if (cs.exists) tx.update(cref, {quantity:Number(cs.data().quantity||0)+Number(old.chemQty||0)});
        }
        // Revert stock
        const oldIsTruckingSale = old.activity === 'Trucking (sale)';
        const oldIsPurchase     = old.activity === 'Cattle Received (Purchase)';
        const oldIsMoveStock    = old.activity === 'Move stock';
        const oldIsTransferOut  = old.activity === 'Transfer stock (Out)';
        const oldIsTransferIn   = old.activity === 'Transfer stock (In)';

        if ((oldIsTruckingSale || oldIsMoveStock || oldIsTransferOut) && Number(old.headCount||0)>0 && old.species && old.livestockClass && old.paddock){
          const q = db.collection('livestock').where('propertyId','==',old.propertyId).where('location','==',old.paddock).where('species','==',old.species).where('class','==',old.livestockClass);
          const s = await tx.get(q);
          if (s.empty){
            tx.set(db.collection('livestock').doc(), { propertyId: old.propertyId, location: old.paddock, species: old.species, class: old.livestockClass, count: Number(old.headCount||0) }, { merge:true });
          } else {
            s.forEach(doc=> tx.update(doc.ref, {count: firebase.firestore.FieldValue.increment(Number(old.headCount||0))}) );
          }
        }
        if (oldIsTransferIn && Number(old.headCount||0)>0 && old.species && old.livestockClass && old.paddock){
          const q = db.collection('livestock').where('propertyId','==',old.propertyId).where('location','==',old.paddock).where('species','==',old.species).where('class','==',old.livestockClass);
          const s = await tx.get(q);
          s.forEach(doc=> tx.update(doc.ref, {count: firebase.firestore.FieldValue.increment(-Number(old.headCount||0))}) );
        }
        if (oldIsPurchase && Number(old.headCount||0)>0 && old.species && old.livestockClass && old.paddock){
          const q = db.collection('livestock').where('propertyId','==',old.propertyId).where('location','==',old.paddock).where('species','==',old.species).where('class','==',old.livestockClass);
          const s = await tx.get(q);
          s.forEach(doc=> tx.update(doc.ref, {count: firebase.firestore.FieldValue.increment(-Number(old.headCount||0))}) );
        }

        // Revert rainfall
        if (old.rainfallGaugeId && Number(old.rainfallMm||0)>0){
          const gref = db.collection('gauges').doc(old.rainfallGaugeId); const gs = await tx.get(gref);
          if (gs.exists){
            tx.update(gref,{ rainTotal: firebase.firestore.FieldValue.increment(-Number(old.rainfallMm||0)), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
            const dayRef = gref.collection('daily').doc(fmtDateKey(old.date || todayISO()));
            tx.set(dayRef, { mm: firebase.firestore.FieldValue.increment(-Number(old.rainfallMm||0)) , date: fmtDateKey(old.date || todayISO()) }, { merge:true });
            tx.set(gref.collection('readings').doc(id), { date: old.date || todayISO(), mm: 0, diaryEntryId: id }, { merge:true });
          }
        }

        // Revert muster missing
        if (Array.isArray(old.musterMissing)){
          for (const m of old.musterMissing){
            const mid = missingDocId({propertyId: old.propertyId, paddock: old.paddock, species: old.species, cls: m.cls, fy: m.fy});
            const mref = db.collection('missingStock').doc(mid);
            tx.set(mref, {
              propertyId: old.propertyId, location: old.paddock, species: old.species,
              class: m.cls, fy: m.fy, count: firebase.firestore.FieldValue.increment(-Number(m.qty||0)),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge:true });
          }
        }

        // Delete entry
        tx.delete(ref);
      });

      await refreshEntries();
      setMsg('Deleted.');
    }
  }catch(e){ alert('Delete error: ' + (e?.message||e)); }
};

function resetForm(clearProp=false){
  if (clearProp){ propSel.value='ALL'; }
  dateInp.value = todayISO();
  timeInp.value=''; notesInp.value='';
  activitySel.value='Ploughing'; onActivityChange();
  paddockSel.value=''; rainMm.value='';
  chemSel.value=''; chemQty.value=''; chemUnit.value='';
  speciesSel.value='Cattle'; classInp.value=''; headInp.value='';
  truckBuyer.value=''; truckRef.value='';
  mExp.value=''; mAct.value=''; mDelta.value=''; mReason.value='';
  mAddCalves.value=''; mAddWeaners.value='';
  mClassBody.innerHTML='<tr><td colspan="6">Pick property + paddock + species…</td></tr>';
  stockContext.innerHTML='';
  cancelEditBtn.classList.add('hidden');
  editingId=null; originalEntry=null;
}

function exportYearCsv(){
  // Minimal CSV export for current year table
  const rows = [['Date','Property','Activity','Paddock','Rain (mm)','Chemical','Head']];
  document.querySelectorAll('#entriesTbody tr').forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    if (tds.length>=7){
      rows.push([0,1,2,3,4,5,6].map(i => (tds[i]?.textContent||'').replace(/[\n\r]+/g,' ').trim()));
    }
  });
  const csv = rows.map(r=>r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `skyfarm-diary-${yearInp.value||new Date().getFullYear()}.csv`; a.click();
}

function printYear(){ window.print(); }
</script>
</body>
</html>
