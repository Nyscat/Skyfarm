<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SkyFarm â€” Diary</title>

  <!-- Firebase (compat SDKs) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
    :root { --brand:#0B7A6E; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#f6fbf8; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); margin:0; color:var(--ink); }
    a { color: var(--brand); text-decoration: none; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { margin: 12px 0; font-size: 1.6rem; }

    /* Header (self-contained) */
    .header { position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--line); }
    .bar { display:flex; align-items:center; gap:12px; padding:10px 14px; }
    .brand { display:flex; align-items:center; gap:10px; color:var(--brand); font-weight:700; }
    nav a { color:var(--brand); font-weight:600; margin-right:10px; }
    nav a[aria-current="page"] { text-decoration: underline; }
    .spacer { flex:1; }
    .muted { color:var(--muted); font-size:.9rem; }

    /* Cards / controls */
    .card { background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0; }
    .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; align-items:center; }
    label { font-size:.9rem; color:#475569; margin-bottom:4px; display:block; }
    input, select, textarea { padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
    textarea { resize:vertical; min-height:38px; }
    button { padding:8px 12px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; cursor:pointer; }
    .btn { border:1px solid #cbd5e1; background:#fff; }
    .primary { background:var(--brand); color:#fff; border-color:var(--brand); }
    .danger { background:#ef4444; color:#fff; border-color:#ef4444; }
    .disabled { opacity:.55; pointer-events:none; }
    .small { font-size:.9rem; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#e2e8f0; font-size:.8rem; margin-right:6px; }

    table { width:100%; border-collapse:collapse; }
    th,td { border-bottom:1px solid var(--line); padding:8px; text-align:left; font-size:.95rem; }
    th { background:#f1f5f9; }
    .nowrap { white-space:nowrap; }

    /* Sign-in modal */
    #authOverlay { position:fixed; inset:0; background:rgba(15,23,42,.10); display:none; align-items:center; justify-content:center; z-index:50; }
    #authCard { width:min(520px,92vw); background:#fff; border:1px solid var(--line); border-radius:16px; padding:20px; }
    #authCard h2 { margin:0 0 8px; }
  </style>
</head>
<body>
  <!-- Self-contained header -->
  <header class="header">
    <div class="bar">
      <a class="brand" href="skyfarm-diary.html">ðŸŒ± SkyFarm</a>
      <nav>
        <a href="skyfarm-diary.html" aria-current="page">Diary</a>
        <a href="skyfarm-map.html">Map</a>
        <a href="skyfarm-chemical.html">Chemicals</a>
      </nav>
      <span class="spacer"></span>
      <span id="authWho" class="muted">Checking sign-inâ€¦</span>
      <button id="signOutBtn" class="danger" style="display:none">Sign out</button>
    </div>
  </header>

  <div class="wrap">
    <h1>Diary</h1>

    <!-- Form -->
    <div class="card">
      <div class="row">
        <div>
          <label>Property</label>
          <select id="propSel" style="min-width:240px"></select>
        </div>
        <div>
          <label>Date</label>
          <input id="dateInp" type="date" />
        </div>
        <div>
          <label>Time</label>
          <input id="timeInp" type="time" />
        </div>
        <div>
          <label>Activity</label>
          <select id="activitySel" style="min-width:220px">
            <option>Mustering / Moving stock</option>
            <option>Trucking (sales/transfer)</option>
            <option>Ploughing</option>
            <option>Planting</option>
            <option>Spraying</option>
            <option>General note</option>
          </select>
        </div>
        <div>
          <label>User</label>
          <input id="userInp" placeholder="Nyssa/Paul" />
        </div>
        <span class="spacer"></span>
        <span id="status" class="muted">Connectingâ€¦</span>
      </div>

      <div class="row">
        <div style="min-width:260px">
          <label>Paddock</label>
          <select id="paddockSel" style="min-width:260px"><option value="">(choose)</option></select>
          <div class="small"><a id="paddockTextToggle" href="javascript:void(0)">Canâ€™t see it? Type paddock name instead.</a></div>
          <input id="paddockText" class="hidden" placeholder="Type paddock name" style="display:none" />
        </div>
        <div style="flex:1; min-width:260px">
          <label>Notes</label>
          <input id="notesInp" placeholder="optional" />
        </div>
      </div>

      <div class="row">
        <button id="saveBtn" class="primary">Save entry</button>
        <button id="resetBtn" class="btn" type="button">Reset</button>
        <button id="weatherBtn" class="btn" type="button">Get weather</button>
        <span id="msg" class="muted" aria-live="polite"></span>
      </div>
      <div id="weatherBox" class="small muted"></div>
    </div>

    <!-- List -->
    <div class="card">
      <div class="row">
        <strong>Recent entries</strong>
        <span class="spacer"></span>
        <div>
          <label>Year</label>
          <input id="yearInp" type="number" min="2000" max="2100" style="width:110px" />
        </div>
        <button id="refreshBtn" class="btn" type="button">Refresh</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Property</th><th>Activity</th><th>Paddock</th><th>Notes</th><th class="nowrap">Actions</th>
          </tr>
        </thead>
        <tbody id="entriesTbody"><tr><td colspan="6">Loadingâ€¦</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <strong>Info</strong>
      <div class="small" style="margin-top:6px">
        Saves to <span class="pill">diaryEntries</span>. Paddocks load from <span class="pill">paddocks</span> on the selected property.
      </div>
    </div>
  </div>

  <!-- Sign-in modal -->
  <div id="authOverlay">
    <div id="authCard">
      <h2>Sign in to SkyFarm</h2>
      <p class="small muted">Email &amp; password only.</p>
      <div class="row">
        <div style="flex:1; min-width:260px">
          <label>Email</label>
          <input id="siEmail" type="email" placeholder="you@example.com" autocomplete="username"/>
        </div>
        <div style="flex:1; min-width:220px">
          <label>Password</label>
          <input id="siPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
        </div>
      </div>
      <div class="row">
        <button id="signInBtn" class="primary">Sign in</button>
        <span id="authMsg" class="muted"></span>
        <span class="spacer"></span>
        <button id="closeOverlayBtn" class="btn" type="button">Close</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Firebase init (use the CORRECT config) ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJlGvBwmW70",
      authDomain: "consentes-pastoral.firebaseapp.com",
      projectId: "consentes-pastoral",
      storageBucket: "consentes-pastoral.appspot.com",
      appId: "1:494858780013:web:d87497b370c82eeab06e64"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    /* ---------- Helpers & constants ---------- */
    const $ = s => document.querySelector(s);
    const setMsg = (t, ms=2500)=>{ $('#msg').textContent=t||''; if(t&&ms) setTimeout(()=>$('#msg').textContent='',ms); };
    const escapeHtml = s => String(s ?? '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    const todayISO = ()=> new Date().toISOString().slice(0,10);
    const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x.toISOString().slice(0,10); };

    // Properties (exact IDs)
    const PROPERTY_IDS = {
      "Consentes":"s7PlDM9wrEpxuJ6DGIab",
      "Gerawin":"P0dQ0H2FWHeqqxejflZs",
      "Mt Myrtle":"TRuxtRBX2zJlwZnRGYKJ"
    };
    const PROPERTY_NAME_BY_ID = Object.fromEntries(Object.entries(PROPERTY_IDS).map(([n,i])=>[i,n]));
    const DEFAULT_PROP_ID = PROPERTY_IDS["Mt Myrtle"];

    // Weather coords
    const WEATHER_COORDS = {
      [PROPERTY_IDS["Consentes"]]: {lat:-20.263323, lon:141.609607},
      [PROPERTY_IDS["Gerawin"]]:   {lat:-20.114428, lon:141.751857},
      [PROPERTY_IDS["Mt Myrtle"]]: {lat:-26.566565, lon:149.997202},
    };

    // Elements
    const authOverlay = $('#authOverlay');
    const signInBtn = $('#signInBtn');
    const closeOverlayBtn = $('#closeOverlayBtn');
    const authWho = $('#authWho');
    const signOutBtn = $('#signOutBtn');

    const propSel = $('#propSel'), dateInp = $('#dateInp'), timeInp = $('#timeInp'),
          activitySel = $('#activitySel'), paddockSel = $('#paddockSel'), paddockText = $('#paddockText'),
          paddockTextToggle = $('#paddockTextToggle'), notesInp = $('#notesInp'),
          userInp = $('#userInp'), yearInp = $('#yearInp'), statusEl = $('#status'),
          entriesTbody=$('#entriesTbody'), weatherBox=$('#weatherBox');

    let editingId = null, editingOriginal = null;

    /* ---------- Sign-in UI ---------- */
    function showOverlay(show){ authOverlay.style.display = show ? 'flex' : 'none'; }
    signInBtn.onclick = async ()=>{
      const email = $('#siEmail').value.trim();
      const pass  = $('#siPass').value;
      $('#authMsg').textContent = 'Signing inâ€¦';
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        await auth.signInWithEmailAndPassword(email, pass);
        $('#authMsg').textContent = 'Signed in.';
        showOverlay(false);
      }catch(e){
        $('#authMsg').textContent = 'Sign-in failed: ' + (e?.message || e?.code || 'Unknown error');
      }
    };
    closeOverlayBtn.onclick = ()=> showOverlay(false);
    signOutBtn.onclick = async ()=>{ try{ await auth.signOut(); location.reload(); }catch(e){} };

    /* ---------- Bootstrap ---------- */
    (async function init(){
      // Build property select
      propSel.innerHTML = Object.keys(PROPERTY_IDS)
        .sort()
        .map(n=>`<option value="${PROPERTY_IDS[n]}">${n}</option>`).join('');
      propSel.value = DEFAULT_PROP_ID;

      dateInp.value = todayISO();
      yearInp.value = new Date().getFullYear();
      userInp.value = "Nyssa/Paul";

      paddockTextToggle.onclick = ()=>{
        const manual = paddockText.style.display === 'none' || paddockText.style.display === '';
        paddockText.style.display = manual ? 'block' : 'none';
        paddockSel.style.display   = manual ? 'none'  : 'block';
      };

      $('#resetBtn').onclick = resetForm;
      $('#saveBtn').onclick = ()=> saveEntry().catch(e=>{ console.error(e); setMsg('Save failed'); });
      $('#refreshBtn').onclick = refreshEntries;
      $('#weatherBtn').onclick = fetchWeather;
      propSel.onchange = ()=>{ loadPaddocks(); refreshEntries(); };

      auth.onAuthStateChanged(async u=>{
        if (u){
          authWho.textContent = u.email ? `Signed in as ${u.email}` : 'Signed in';
          signOutBtn.style.display = '';
          statusEl.textContent = 'Connected';
          showOverlay(false);
          await loadPaddocks();
          await refreshEntries();
        }else{
          authWho.textContent = 'Not signed in';
          signOutBtn.style.display = 'none';
          statusEl.textContent = 'Please sign in (Email/Password).';
          entriesTbody.innerHTML = `<tr><td colspan="6" class="muted">Sign in to load entriesâ€¦</td></tr>`;
          showOverlay(true);
        }
      });
    })();

    /* ---------- Data ---------- */
    async function loadPaddocks(){
      paddockSel.innerHTML = '<option>(loadingâ€¦)</option>';
      const pid = propSel.value;
      try{
        const snap = await db.collection('paddocks').where('propertyId','==',pid).get();
        const rows=[]; snap.forEach(d=>rows.push({id:d.id, ...d.data()}));
        rows.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')));
        paddockSel.innerHTML = '<option value="">(choose)</option>' +
          rows.map(p=>`<option value="${p.id}" data-name="${escapeHtml(p.name||'')}">${escapeHtml(p.name||'(unnamed)')}</option>`).join('');
        paddockSel.style.display='block'; paddockText.style.display='none';
      }catch(e){
        paddockSel.innerHTML = '<option value="">(load error)</option>';
      }
    }

    async function saveEntry(){
      if (!auth.currentUser) { alert('Please sign in.'); return; }
      const pid = propSel.value;
      const pname = PROPERTY_NAME_BY_ID[pid] || '(Unknown)';
      const date = dateInp.value || todayISO();
      const time = timeInp.value || '';
      const activity = activitySel.value;
      const manualPaddock = (paddockText.style.display === 'block') ? (paddockText.value || '').trim() : '';
      const paddockId = (paddockText.style.display === 'block') ? '' : (paddockSel.value || '');
      const paddockName = (paddockText.style.display === 'block')
        ? manualPaddock
        : (paddockSel.selectedOptions[0]?.dataset?.name || '');
      const notes = notesInp.value || '';
      const user = userInp.value || '';

      const payload = {
        propertyId: pid, propertyName: pname,
        date, time, activity,
        paddockId: paddockId || null,
        paddock: paddockName || manualPaddock || null,
        user: user || null,
        notes: notes || null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      const col = db.collection('diaryEntries');
      if (editingId){
        await col.doc(editingId).set(payload, { merge:true });
        setMsg('Updated');
      }else{
        await col.add(payload);
        setMsg('Saved');
      }
      resetForm();
      await refreshEntries();
    }

    function resetForm(){
      editingId = null; editingOriginal = null;
      $('#saveBtn').textContent = 'Save entry';
      notesInp.value = ''; timeInp.value = '';
      activitySel.value = 'Mustering / Moving stock';
      paddockText.value = '';
      paddockSel.value = '';
    }

    async function refreshEntries(){
      if (!auth.currentUser) return;
      const pid = propSel.value;
      const end = todayISO();
      const start = addDays(end, -30);
      entriesTbody.innerHTML = '<tr><td colspan="6">Loadingâ€¦</td></tr>';
      try{
        const snap = await db.collection('diaryEntries')
          .where('propertyId','==',pid)
          .where('date','>=',start)
          .where('date','<=',end)
          .orderBy('date','desc')
          .limit(200).get();
        const rows=[]; snap.forEach(d=>rows.push({id:d.id, ...d.data()}));
        if (!rows.length){ entriesTbody.innerHTML = '<tr><td colspan="6" class="muted">No entries in the last 30 days.</td></tr>'; return; }
        entriesTbody.innerHTML = rows.map(r=>`
          <tr>
            <td>${escapeHtml(r.date||'')}</td>
            <td>${escapeHtml(r.propertyName||'')}</td>
            <td>${escapeHtml(r.activity||'')}</td>
            <td>${escapeHtml(r.paddock||'')}</td>
            <td>${escapeHtml(r.notes||'')}</td>
            <td class="nowrap">
              <button class="btn" data-edit="${r.id}">Edit</button>
              <button class="btn danger" data-del="${r.id}">Del</button>
            </td>
          </tr>
        `).join('');

        // actions
        entriesTbody.querySelectorAll('[data-edit]').forEach(b=>{
          b.onclick = ()=>{
            const id = b.getAttribute('data-edit');
            const r = rows.find(x=>x.id===id); if (!r) return;
            editingId = id; editingOriginal = r;
            dateInp.value = r.date || todayISO();
            timeInp.value = r.time || '';
            activitySel.value = r.activity || 'General note';
            userInp.value = r.user || 'Nyssa/Paul';
            notesInp.value = r.notes || '';
            // paddock select vs text
            const opt = [...paddockSel.options].find(o => (o.dataset?.name||'') === (r.paddock||''));
            if (opt){ paddockSel.style.display='block'; paddockText.style.display='none'; paddockSel.value = opt.value; }
            else { paddockSel.style.display='none'; paddockText.style.display='block'; paddockText.value = r.paddock || ''; }
            $('#saveBtn').textContent = 'Save changes';
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };
        });
        entriesTbody.querySelectorAll('[data-del]').forEach(b=>{
          b.onclick = async ()=>{
            const id = b.getAttribute('data-del');
            if (!confirm('Delete this entry?')) return;
            await db.collection('diaryEntries').doc(id).delete();
            setMsg('Deleted');
            await refreshEntries();
          };
        });
      }catch(e){
        console.error(e);
        entriesTbody.innerHTML = '<tr><td colspan="6" class="muted">Failed to load entries.</td></tr>';
      }
    }

    async function fetchWeather(){
      const pid = propSel.value; const coords = WEATHER_COORDS[pid]; const date = dateInp.value || todayISO();
      const url = `/weather?date=${encodeURIComponent(date)}&lat=${coords.lat}&lon=${coords.lon}`;
      weatherBox.textContent = `Weather URL: ${url}`;
    }
  </script>
</body>
</html>
