<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8"/>
Â  <meta name="viewport" content="width=device-width, initial-scale=1"/>
Â  <title>SkyFarm â€” Diary</title>

Â  Â  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

Â  <style>
Â  Â  :root { --brand:#0B7A6E; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#f6fbf8; }
Â  Â  *{box-sizing:border-box}
Â  Â  body{margin:16px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink)}
Â  Â  .wrap{max-width:1100px; margin:0 auto}
Â  Â  h1{margin:0 0 12px; font-size:1.6rem}
Â  Â  .topbar{display:flex; align-items:center; gap:12px; margin-bottom:8px}
Â  Â  .brand{font-weight:700}
Â  Â  .pill{padding:4px 10px; border-radius:999px; background:#e2e8f0; text-decoration:none; color:#0f172a; font-size:.9rem}
Â  Â  .card{background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0}
Â  Â  .row{display:flex; flex-wrap:wrap; gap:10px; margin:8px 0}
Â  Â  label{display:block; font-size:.9rem; color:#475569; margin-bottom:4px}
Â  Â  input,select,button{padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff}
Â  Â  button{cursor:pointer}
Â  Â  .primary{background:var(--brand); border-color:var(--brand); color:#fff}
Â  Â  .danger{background:#ef4444; border-color:#ef4444; color:#fff}
Â  Â  .muted{color:var(--muted); font-size:.9rem}
Â  Â  .spacer{flex:1}
Â  Â  .hidden{display:none}
Â  Â  table{width:100%; border-collapse:collapse}
Â  Â  th,td{border-bottom:1px solid var(--line); padding:8px; text-align:left}
Â  Â  th{background:#f1f5f9}
Â  Â  /* Sign-in overlay */
Â  Â  #authOverlay{position:fixed; inset:0; background:rgba(15,23,42,.06); display:none; align-items:center; justify-content:center; z-index:50}
Â  Â  #authCard{width:min(520px,92vw); background:#fff; border:1px solid var(--line); border-radius:16px; padding:20px}
Â  Â  #authCard h2{margin:0 0 8px}
Â  Â  .small{font-size:.9rem}
Â  Â  .status-ok{color:#0B7A6E}
Â  Â  .status-bad{color:#b45309}
Â  </style>
</head>
<body>
<div class="wrap">

Â  Â  <div class="topbar">
Â  Â  <div class="brand">ðŸŒ± SkyFarm</div>
Â  Â  <a id="navDiary" class="pill" href="#">Diary</a>
Â  Â  <a id="navMap" class="pill" href="#">Map</a>
Â  Â  <a id="navChem" class="pill" href="#">Chemicals</a>
Â  Â  <span class="spacer"></span>
Â  Â  <span id="authWho" class="muted">Checking sign-inâ€¦</span>
Â  Â  <button id="signOutBtn" class="danger hidden">Sign out</button>
Â  </div>

Â  <h1>SkyFarm â€” Diary</h1>

Â  Â  <div class="card">
Â  Â  <div class="row">
Â  Â  Â  <div>
Â  Â  Â  Â  <label>Property</label>
Â  Â  Â  Â  <select id="propSel" style="min-width:240px"></select>
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <label>Date</label>
Â  Â  Â  Â  <input id="dateInp" type="date"/>
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <label>Time</label>
Â  Â  Â  Â  <input id="timeInp" type="time"/>
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <label>Activity</label>
Â  Â  Â  Â  <select id="activitySel" style="min-width:220px">
Â  Â  Â  Â  Â  <option>Mustering / Moving stock</option>
Â  Â  Â  Â  Â  <option>Trucking (sales/transfer)</option>
Â  Â  Â  Â  Â  <option>Ploughing</option>
Â  Â  Â  Â  Â  <option>Planting</option>
Â  Â  Â  Â  Â  <option>Spraying</option>
Â  Â  Â  Â  Â  <option>General note</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>
Â  Â  Â  <span class="spacer"></span>
Â  Â  Â  <div>
Â  Â  Â  Â  <label>&nbsp;</label>
Â  Â  Â  Â  <span id="status" class="muted">â€”</span>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <div style="min-width:260px">
Â  Â  Â  Â  <label>Paddock</label>
Â  Â  Â  Â  <select id="paddockSel" style="min-width:260px"><option value="">(choose)</option></select>
Â  Â  Â  Â  <div class="small"><a href="javascript:void(0)">Canâ€™t see it? Type paddock name instead.</a></div>
Â  Â  Â  </div>
Â  Â  Â  <div style="min-width:260px; flex:1">
Â  Â  Â  Â  <label>Notes</label>
Â  Â  Â  Â  <input id="notesInp" placeholder="optional"/>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="row">
Â  Â  Â  <button id="saveBtn" class="primary">Save entry</button>
Â  Â  Â  <button id="resetBtn">Reset</button>
Â  Â  Â  <span id="msg" class="muted" aria-live="polite"></span>
Â  Â  </div>
Â  </div>

Â  Â  <div class="card">
Â  Â  <div class="row">
Â  Â  Â  <strong>Recent entries</strong>
Â  Â  Â  <span class="spacer"></span>
Â  Â  Â  <label>Year</label>
Â  Â  Â  <input id="yearInp" type="number" min="2000" max="2100" style="width:110px"/>
Â  Â  Â  <button id="refreshBtn">Refresh</button>
Â  Â  </div>
Â  Â  <table>
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th>Date</th><th>Property</th><th>Activity</th><th>Paddock</th><th>Notes</th><th></th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody id="entriesTbody"><tr><td colspan="6">Sign in to load entriesâ€¦</td></tr></tbody>
Â  Â  </table>
Â  </div>
</div>

<div id="authOverlay">
Â  <div id="authCard">
Â  Â  <h2>Sign in to SkyFarm</h2>
Â  Â  <p class="small muted">Email &amp; password only. Anonymous sign-in is disabled.</p>
Â  Â  <div class="row">
Â  Â  Â  <div style="flex:1; min-width:260px">
Â  Â  Â  Â  <label>Email</label>
Â  Â  Â  Â  <input id="siEmail" type="email" placeholder="you@example.com" autocomplete="username"/>
Â  Â  Â  </div>
Â  Â  Â  <div style="flex:1; min-width:220px">
Â  Â  Â  Â  <label>Password</label>
Â  Â  Â  Â  <input id="siPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="row">
Â  Â  Â  <button id="signInBtn" class="primary">Sign in</button>
Â  Â  Â  <span id="authMsg" class="muted"></span>
Â  Â  Â  <span class="spacer"></span>
Â  Â  Â  <button id="closeOverlayBtn">Close</button>
Â  Â  </div>
Â  </div>
</div>

<script>
/* -------------------------------------------------------
Â  Â Firebase init (compat) â€” Email/Password ONLY
Â  Â (Must have ALL config details below)
------------------------------------------------------- */
const firebaseConfig = {
Â  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70", // <-- REPLACE THIS WITH YOUR VALID KEY
Â  authDomain: "consentes-pastoral.firebaseapp.com",
Â  projectId: "consentes-pastoral",
Â  storageBucket: "consentes-pastoral.appspot.com", // Using .appspot.com for compat
Â  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const dbÂ  Â = firebase.firestore();

/* -------------------------------------------------------
Â  Â Helpers
------------------------------------------------------- */
const $ = s => document.querySelector(s);
const setStatus = t => {
Â  const el = $('#status');
Â  el.textContent = t || '';
Â  el.className = (/connected/i.test(t||'')) ? 'status-ok' : (/issue|error|denied|sign in/i.test(t||'') ? 'status-bad' : 'muted');
};
const setMsg = (t, ms=3000)=>{ $('#msg').textContent=t||''; if(t && ms){ setTimeout(()=>$('#msg').textContent='', ms); } };
const todayISO = ()=> new Date().toISOString().slice(0,10);
const escapeHtml = s => String(s ?? '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
const errText = e => e?.message || e?.code || 'Unknown error';

/* -------------------------------------------------------
Â  Â Properties (IDs you gave)
------------------------------------------------------- */
const PROPS = [
Â  { id:"s7PlDM9wrEpxuJ6DGIab", name:"Consentes", lat:-20.263323, lon:141.609607 },
Â  { id:"P0dQ0H2FWHeqqxejflZs", name:"Gerawin",Â  Â lat:-20.114428, lon:141.751857 },
Â  { id:"TRuxtRBX2zJlwZnRGYKJ", name:"Mt Myrtle", lat:-26.566565, lon:149.997202 }
];
const DEFAULT_PROP_ID = "TRuxtRBX2zJlwZnRGYKJ";

/* -------------------------------------------------------
Â  Â Auth (Handles persistence check on load)
------------------------------------------------------- */
const overlay = $('#authOverlay');
const signOutBtn = $('#signOutBtn');
const authWho = $('#authWho');

function showOverlay(show){ overlay.style.display = show ? 'flex' : 'none'; }

$('#signInBtn').onclick = async ()=>{
Â  const email = $('#siEmail').value.trim();
Â  const passÂ  = $('#siPass').value;
Â  $('#authMsg').textContent = 'Signing inâ€¦';
Â  try{
Â  Â  // Key line for persistence across pages:
Â  Â  await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
Â  Â  await auth.signInWithEmailAndPassword(email, pass);
Â  Â  $('#authMsg').textContent = 'Signed in.';
Â  Â  showOverlay(false);
Â  Â  // On successful sign-in, load data
Â  Â  await loadPaddocks(propSel.value);
Â  Â  await refreshEntries();
Â  }catch(e){
Â  Â  $('#authMsg').textContent = 'Sign-in failed: ' + errText(e);
Â  }
};
$('#closeOverlayBtn').onclick = ()=> showOverlay(false);
signOutBtn.onclick = async ()=>{ 
    try{ 
        await auth.signOut();
        // Force a page reload to reset state after sign-out
        location.reload();
    }catch(e){} 
};

// This function checks for a persisted session immediately on page load
async function requireSignedIn(){
Â  setStatus('Checking sign-inâ€¦');
Â  return new Promise(resolve=>{
Â  Â  auth.onAuthStateChanged(async u=>{
Â  Â  Â  if(u){
Â  Â  Â  Â  authWho.textContent = u.email ? `Signed in as ${u.email}` : 'Signed in';
Â  Â  Â  Â  signOutBtn.classList.remove('hidden');
Â  Â  Â  Â  setStatus('Connected');
Â  Â  Â  Â  // Load data if signed in
Â  Â  Â  Â  await loadPaddocks(propSel.value);
Â  Â  Â  Â  await refreshEntries();
Â  Â  Â  Â  resolve(true);
Â  Â  Â  }else{
Â  Â  Â  Â  authWho.textContent = 'Not signed in';
Â  Â  Â  Â  signOutBtn.classList.add('hidden');
Â  Â  Â  Â  setStatus('Please sign in (Email/Password).');
Â  Â  Â  Â  showOverlay(true);
Â  Â  Â  Â  resolve(false);
Â  Â  Â  }
Â  Â  });
Â  });
}

/* -------------------------------------------------------
Â  Â UI & Data
------------------------------------------------------- */
const propSel = $('#propSel'), dateInp = $('#dateInp'), timeInp = $('#timeInp'),
Â  Â  Â  activitySel = $('#activitySel'), notesInp = $('#notesInp'),
Â  Â  Â  paddockSel = $('#paddockSel'), entriesTbody = $('#entriesTbody');

$('#refreshBtn').onclick = refreshEntries;
$('#resetBtn').onclick = ()=> resetForm();
$('#saveBtn').onclick = ()=> saveEntry().catch(e=> setMsg('Save failed: ' + errText(e), 5000));

function populateProperties(){
Â  propSel.innerHTML = PROPS.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
Â  propSel.value = DEFAULT_PROP_ID;
}
function resetForm(){
Â  dateInp.value = todayISO(); timeInp.value = '';
Â  activitySel.value = 'Ploughing';
Â  notesInp.value = '';
}
function paddockOption(p){ return `<option value="${p.id}" data-name="${escapeHtml(p.name||'')}">${escapeHtml(p.name||'(unnamed)')}</option>`; }

async function loadPaddocks(propertyId){
Â  // Check sign-in state before attempting Firestore read
Â  if(!auth.currentUser) return; 

Â  paddockSel.innerHTML = '<option>(loadingâ€¦)</option>';
Â  try{
Â  Â  const snap = await db.collection('paddocks').where('propertyId','==',propertyId).get();
Â  Â  const rows=[]; snap.forEach(d=> rows.push({id:d.id, ...d.data()}));
Â  Â  rows.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));
Â  Â  paddockSel.innerHTML = '<option value="">(choose)</option>' + rows.map(paddockOption).join('');
Â  }catch(e){
Â  Â  paddockSel.innerHTML = '<option value="">(failed to load)</option>';
Â  Â  console.warn('Paddocks load error:', e.message); // Log error message for debugging
Â  Â  setMsg('Failed to load paddocks (Permissions/Index issue?): ' + errText(e), 5000);
Â  }
}

async function saveEntry(){
Â  // Check sign-in state before attempting Firestore write
Â  if(!auth.currentUser){ setMsg('Error: Must be signed in to save.', 5000); return; } 

Â  const propertyId = propSel.value;
Â  // ... (rest of saveEntry logic remains the same)
Â  const propertyName = PROPS.find(p=>p.id===propertyId)?.name || '(unknown)';
Â  const date = dateInp.value || todayISO();
Â  const time = timeInp.value || '';
Â  const activity = activitySel.value;
Â  const paddock = paddockSel.selectedOptions[0]?.dataset?.name || '';
Â  const notes = notesInp.value || '';
Â  if(!propertyId){ throw new Error('Pick a property'); }

Â  const payload = {
Â  Â  propertyId, propertyName, date, time, activity,
Â  Â  paddock, user: (auth.currentUser?.email || 'User'),
Â  Â  notes,
Â  Â  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
Â  Â  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
Â  };
Â  await db.collection('diaryEntries').add(payload);
Â  setMsg('Saved.');
Â  await refreshEntries();
}

async function refreshEntries(){
Â  // Check sign-in state before attempting Firestore read
Â  if(!auth.currentUser) { 
      entriesTbody.innerHTML = '<tr><td colspan="6" class="muted">Sign in to load entriesâ€¦</td></tr>';
      return; 
    } 
    
Â  const propertyId = propSel.value;
Â  entriesTbody.innerHTML = '<tr><td colspan="6">Loadingâ€¦</td></tr>';
Â  try{
Â  Â  const snap = await db.collection('diaryEntries')
Â  Â  Â  .where('propertyId','==',propertyId)
Â  Â  Â  .orderBy('date','desc')
Â  Â  Â  .limit(50)
Â  Â  Â  .get();

Â  Â  const rows=[];
Â  Â  snap.forEach(d=> rows.push({id:d.id, ...d.data()}));

Â  Â  if(!rows.length){
Â  Â  Â  entriesTbody.innerHTML = '<tr><td colspan="6" class="muted">No entries.</td></tr>';
Â  Â  Â  return;
Â  Â  }
Â  Â  // ... (rest of table rendering logic remains the same)
    entriesTbody.innerHTML = rows.map(r=>`
Â  Â  Â  <tr>
Â  Â  Â  Â  <td>${escapeHtml(r.date||'')}</td>
Â  Â  Â  Â  <td>${escapeHtml(r.propertyName||'')}</td>
Â  Â  Â  Â  <td>${escapeHtml(r.activity||'')}</td>
Â  Â  Â  Â  <td>${escapeHtml(r.paddock||'')}</td>
Â  Â  Â  Â  <td>${escapeHtml(r.notes||'')}</td>
Â  Â  Â  Â  <td><button data-id="${r.id}" class="danger btnDel">Delete</button></td>
Â  Â  Â  </tr>`).join('');
Â  Â  document.querySelectorAll('.btnDel').forEach(b=>{
Â  Â  Â  b.onclick = async ()=>{
Â  Â  Â  Â  if(confirm('Delete this diary entry?')){
Â  Â  Â  Â  Â  await db.collection('diaryEntries').doc(b.dataset.id).delete();
Â  Â  Â  Â  Â  refreshEntries();
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  });

Â  }catch(e){
Â  Â  // Enhanced error message to help identify if it's a security rule or index issue
Â  Â  entriesTbody.innerHTML = `<tr><td colspan="6" style="color:#b45309">Failed to read entries. Check console for Index/Permission error.</td></tr>`;
Â  Â  console.error('Entries load error:', e); 
Â  }
}


/* -------------------------------------------------------
Â  Â Page bootstrap
------------------------------------------------------- */
(async function init(){
Â  // Simple nav (adjust if you have other files deployed)
Â  const base = location.origin || '';
Â  $('#navDiary').href = base + '/skyfarm-diary.html';
Â  $('#navMap').hrefÂ  Â = base + '/skyfarm-map.html';
Â  $('#navChem').hrefÂ  = base + '/skyfarm-chemical.html';

Â  dateInp.value = todayISO();
Â  populateProperties();
Â  propSel.onchange = ()=> loadPaddocks(propSel.value);

Â  // This is the crucial step: checking for a saved session immediately on load
Â  await requireSignedIn(); 
})();
</script>
</body>
</html>
