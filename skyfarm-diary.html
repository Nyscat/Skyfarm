<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SkyFarm — Diary</title>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#f6fbf8;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#6b7280;
      --brand:#0f766e;
      --brand-soft:#d1fae5;
      --danger:#b91c1c;
      --border:#e5e7eb;
      --radius:10px;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif;
      background:var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
    }
    a{color:#0f766e;text-decoration:none;}
    a:hover{text-decoration:underline;}

    /* Header */
    #sf-header{
      position:sticky;
      top:0;
      z-index:40;
      background:rgba(255,255,255,.96);
      backdrop-filter:blur(18px);
      border-bottom:1px solid #e5e7eb;
    }
    #sf-header-inner{
      max-width:1200px;
      margin:0 auto;
      padding:10px 16px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    #sf-header-logo{
      font-weight:600;
      letter-spacing:.04em;
      font-size:.95rem;
      display:flex;
      align-items:center;
      gap:6px;
    }
    #sf-header-logo span.logo-dot{
      display:inline-block;
      width:9px;
      height:9px;
      border-radius:999px;
      background:var(--brand);
    }
    #sf-header-nav{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .nav-link{
      font-size:.85rem;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid transparent;
      color:#4b5563;
      text-decoration:none;
      white-space:nowrap;
    }
    .nav-link:hover{
      background:#f3f4f6;
    }
    .nav-link.active{
      border-color:#0f766e;
      background:#ecfdf5;
      color:#0f766e;
      font-weight:500;
    }

    /* Layout */
    #page{
      max-width:1200px;
      margin:12px auto 40px;
      padding:0 16px 24px;
    }

    .page-title{
      display:flex;
      align-items:flex-end;
      gap:10px;
      margin-bottom:4px;
    }
    .page-title h1{
      font-size:1.55rem;
      margin:12px 0 2px;
    }
    .page-title span.tagline{
      font-size:.9rem;
      color:var(--muted);
    }
    .page-sub{
      font-size:.85rem;
      color:var(--muted);
      margin-bottom:16px;
    }

    .layout{
      display:grid;
      grid-template-columns:minmax(0, 320px) minmax(0, 1.5fr);
      gap:18px;
      align-items:flex-start;
    }
    @media (max-width:900px){
      .layout{
        grid-template-columns:minmax(0,1fr);
      }
    }

    /* Cards */
    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid #e5e7eb;
      box-shadow:0 10px 25px rgba(15,23,42,.06);
    }
    .card-header{
      padding:10px 14px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .card-header h2{
      font-size:.98rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      font-weight:600;
      color:#374151;
      margin:0;
    }
    .card-header small{
      font-size:.8rem;
      color:var(--muted);
    }
    .card-body{
      padding:10px 14px 14px;
    }
    .card-body.compact-top{
      padding-top:4px;
    }

    /* Form styles */
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:8px 10px;
      margin-bottom:8px;
      align-items:flex-end;
    }
    .row > *{
      flex:1 1 120px;
      min-width:120px;
    }
    .row.cols-3 > *{flex-basis:33%;}
    .row.cols-4 > *{flex-basis:24%;}
    .row.cols-2 > *{flex-basis:48%;}
    .row.cols-auto > *{flex:0 0 auto;}
    @media (max-width:700px){
      .row.cols-3 > *,
      .row.cols-4 > *,
      .row.cols-2 > *{
        flex-basis:100%;
      }
    }

    label{
      display:block;
      font-size:.78rem;
      font-weight:500;
      color:#4b5563;
      margin-bottom:2px;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea{
      width:100%;
      border-radius:7px;
      border:1px solid #d1d5db;
      padding:6px 7px;
      font-size:.85rem;
      font-family:inherit;
      color:var(--ink);
      background:#fff;
    }
    input:focus, select:focus, textarea:focus{
      outline:2px solid #0f766e33;
      border-color:#0f766e;
    }
    textarea{
      min-height:46px;
      resize:vertical;
    }

    .muted{
      color:var(--muted);
    }
    .small{
      font-size:.8rem;
    }
    .nowrap{
      white-space:nowrap;
    }

    /* Buttons */
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      border:1px solid transparent;
      background:#0f766e;
      color:#fff;
      padding:6px 10px;
      font-size:.8rem;
      font-weight:500;
      cursor:pointer;
      gap:5px;
      white-space:nowrap;
    }
    .btn.small{
      padding:4px 9px;
      font-size:.78rem;
    }
    .btn.secondary{
      background:#fff;
      color:#374151;
      border-color:#d1d5db;
    }
    .btn.secondary:hover{
      background:#f3f4f6;
    }
    .btn.danger{
      background:#b91c1c;
    }
    .btn:disabled{
      opacity:.6;
      cursor:default;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:2px 6px;
      font-size:.75rem;
      border:1px solid #d1d5db;
      color:#4b5563;
      gap:4px;
    }
    .badge-dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:#10b981;
    }

    .pill-select{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .pill-option{
      border-radius:999px;
      padding:2px 7px;
      font-size:.76rem;
      border:1px solid #d1d5db;
      cursor:pointer;
      background:#fff;
      color:#4b5563;
    }
    .pill-option.active{
      background:#ecfdf5;
      border-color:#0f766e;
      color:#0f766e;
      font-weight:500;
    }

    /* Status */
    #statusBar{
      margin-top:6px;
      font-size:.8rem;
      color:#6b7280;
    }
    #statusBar strong{
      font-weight:600;
      color:#111827;
    }

    /* Filters / controls */
    .filters-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
      margin-bottom:8px;
    }
    .filters-row > *{
      flex:1 1 150px;
      min-width:130px;
    }
    .filters-row .right{
      margin-left:auto;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    @media (max-width:900px){
      .filters-row{
        flex-direction:column;
        align-items:flex-start;
      }
      .filters-row .right{
        margin-left:0;
        width:100%;
        justify-content:flex-start;
      }
    }

    .chip{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:2px 8px;
      border:1px solid #e5e7eb;
      font-size:.78rem;
      gap:4px;
      color:#4b5563;
      background:#f9fafb;
    }
    .chip strong{
      font-weight:500;
      color:#111827;
    }

    /* Table */
    .table-desktop{
      display:block;
    }
    .table-mobile{
      display:none;
    }
    @media (max-width:760px){
      .table-desktop{display:none;}
      .table-mobile{display:block;}
    }

    .table-scroll{
      overflow:auto;
      border-radius:var(--radius);
      border:1px solid #e5e7eb;
      background:#fff;
      box-shadow:0 12px 30px rgba(15,23,42,.07);
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:.8rem;
    }
    thead{
      background:#f9fafb;
      position:sticky;
      top:0;
      z-index:10;
    }
    thead th{
      text-align:left;
      font-weight:500;
      color:#4b5563;
      padding:7px 8px;
      border-bottom:1px solid #e5e7eb;
      white-space:nowrap;
      font-size:.78rem;
    }
    tbody td{
      padding:6px 8px;
      border-bottom:1px solid #f3f4f6;
      vertical-align:top;
    }
    tbody tr:nth-child(even){
      background:#fcfcfd;
    }
    tbody tr:hover{
      background:#f3f4ff;
    }

    .table-scroll::-webkit-scrollbar{
      height:8px;
    }
    .table-scroll::-webkit-scrollbar-thumb{
      background:#cbd5f5;
      border-radius:999px;
    }

    .tag{
      display:inline-block;
      padding:1px 6px;
      border-radius:999px;
      font-size:.72rem;
      border:1px solid #d1d5db;
      color:#374151;
      background:#f9fafb;
    }

    .entry-card{
      border-radius:var(--radius);
      border:1px solid #e5e7eb;
      padding:9px 10px;
      margin-bottom:8px;
      background:#fff;
      box-shadow:0 6px 18px rgba(15,23,42,.05);
    }
    .ec-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
      font-size:.85rem;
      font-weight:500;
    }
    .ec-line{
      display:flex;
      font-size:.8rem;
      margin-bottom:2px;
    }
    .ec-label{
      width:90px;
      flex:0 0 auto;
      font-weight:500;
      color:#4b5563;
    }

    .pill-sort{
      display:inline-flex;
      border-radius:999px;
      border:1px solid #d1d5db;
      overflow:hidden;
    }
    .pill-sort button{
      border:none;
      background:none;
      padding:3px 8px;
      font-size:.78rem;
      cursor:pointer;
      color:#4b5563;
    }
    .pill-sort button.active{
      background:#ecfdf5;
      color:#0f766e;
      font-weight:500;
    }

    .badge-role{
      border-radius:999px;
      padding:2px 7px;
      font-size:.72rem;
      border:1px solid #e5e7eb;
      color:#4b5563;
      background:#f9fafb;
    }

    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      border:0;
    }

    .hidden{display:none !important;}

    .no-print{}
    @media print{
      body{
        background:#fff;
      }
      #sf-header,
      #statusBar,
      .no-print,
      #newEntryCard,
      .filters-row,
      #printBtn{
        display:none !important;
      }
      #page{
        margin:0;
        padding:0;
      }
      .table-scroll{
        box-shadow:none;
        border:none;
      }
      table{
        font-size:.78rem;
      }
      thead th{
        position:static;
      }
    }

    .pill-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      font-size:.76rem;
      color:#4b5563;
      background:#f9fafb;
    }

    .w80{max-width:80px;}
    .w100{max-width:100px;}
    .w120{max-width:120px;}
    .w150{max-width:150px;}
    .w180{max-width:180px;}
    .w220{max-width:220px;}
    .w260{max-width:260px;}

    .login-container{
      max-width:360px;
      margin:40px auto;
      background:#fff;
      padding:18px 18px 16px;
      border-radius:var(--radius);
      border:1px solid #e5e7eb;
      box-shadow:0 18px 45px rgba(15,23,42,.12);
    }
    .login-container h1{
      margin:0 0 4px;
      font-size:1.45rem;
    }
    .login-container p{
      margin:0 0 12px;
      font-size:.9rem;
      color:#6b7280;
    }
    .login-container label{
      margin-top:6px;
    }
    .login-footer{
      margin-top:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      font-size:.8rem;
      color:#6b7280;
    }

    .alert{
      border-radius:8px;
      padding:6px 8px;
      font-size:.8rem;
      margin-bottom:8px;
    }
    .alert.error{
      background:#fef2f2;
      border:1px solid #fecaca;
      color:#7f1d1d;
    }
    .alert.info{
      background:#eff6ff;
      border:1px solid #bfdbfe;
      color:#1d4ed8;
    }

    .spacer{flex:1;}
  </style>
</head>
<body>
<header id="sf-header">
  <div id="sf-header-inner">
    <div id="sf-header-logo">
      <span class="logo-dot"></span>
      <span>SkyFarm</span>
    </div>
    <nav id="sf-header-nav">
      <a href="skyfarm-index.html" class="nav-link">Map</a>
      <a href="skyfarm-rainfall.html" class="nav-link">Rainfall</a>
      <a href="skyfarm-livestock.html" class="nav-link">Livestock</a>
      <a href="skyfarm-chemicals.html" class="nav-link">Chemicals</a>
      <a href="skyfarm-fodder.html" class="nav-link">Fodder</a>
      <a href="skyfarm-diary.html" class="nav-link active">Diary</a>
      <a href="skyfarm-users.html" class="nav-link">Users & roles</a>
    </nav>
  </div>
</header>

<main id="page">
  <div class="page-title">
    <h1>Diary</h1>
    <span class="tagline">Daily activities, rainfall, inputs and stock movements.</span>
  </div>
  <div class="page-sub">
    Entries feed into your rainfall, livestock, chemicals and fodder records.
  </div>

  <div class="layout" id="appRoot">

    <!-- New entry + status -->
    <section id="newEntryCard" class="card no-print">
      <div class="card-header">
        <h2>New entry</h2>
        <small id="userChip" class="muted small"></small>
      </div>
      <div class="card-body">
        <div class="row">
          <div>
            <label>Property</label>
            <select id="propSel" class="w220"></select>
          </div>
          <div>
            <label>Date</label>
            <input id="dateInp" type="date" class="w160"/>
          </div>
          <div class="hidden">
            <label>Time</label>
            <input id="timeInp" type="time" class="w120"/>
          </div>
          <div>
            <label>Activity</label>
            <select id="activitySel" class="w220">
              <option value="Ploughing">Plough paddock</option>
              <option value="Planting">Plant paddock</option>
              <option value="Spraying paddocks">Spraying paddocks</option>
              <option value="Chemical (stock)">Chemical (stock)</option>
              <option value="Trucking (sale)">Trucking (sale)</option>
              <option value="Mustering">Mustering</option>
              <option value="Move stock">Move stock</option>
              <option value="Feeding (fodder)">Feeding (fodder)</option>
              <option value="Rainfall">Rainfall</option>
              <option value="Purchase inputs">Purchase inputs</option>
              <option value="General">General</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div id="paddockRow">
            <label>Paddock / yards</label>
            <select id="paddockSel"></select>
          </div>
          <div id="toPaddockWrap" class="hidden">
            <label>Move to paddock</label>
            <select id="toPaddockSel"></select>
          </div>
          <div id="transferRow" class="hidden">
            <label>Transfer to property</label>
            <select id="transferPropertySel"></select>
          </div>
        </div>

        <div id="stockRow" class="row hidden">
          <div>
            <label>Species</label>
            <select id="speciesSel" class="w150">
              <option value="">(choose)</option>
              <option value="Cattle">Cattle</option>
              <option value="Sheep">Sheep</option>
            </select>
          </div>
          <div>
            <label>Class</label>
            <input id="classInp" type="text" placeholder="e.g. Weaner heifers" class="w220"/>
          </div>
          <div>
            <label>Head</label>
            <input id="headInp" type="number" min="0" step="1" class="w100"/>
          </div>
        </div>

        <div id="chemRow" class="row hidden">
          <div>
            <label>Chemical / product</label>
            <select id="chemSel" class="w220"></select>
          </div>
          <div>
            <label>Rate</label>
            <input id="chemRateInp" type="text" placeholder="e.g. 1.5 L/ha" class="w150"/>
          </div>
          <div>
            <label>Total used</label>
            <input id="chemTotalInp" type="text" placeholder="e.g. 120 L" class="w150"/>
          </div>
        </div>

        <div id="seedRow" class="row hidden">
          <div>
            <label>Seed</label>
            <select id="seedSel" class="w220"></select>
          </div>
          <div>
            <label>Rate</label>
            <input id="seedRateInp" type="text" placeholder="e.g. 4 kg/ha" class="w150"/>
          </div>
          <div>
            <label>Total used</label>
            <input id="seedTotalInp" type="text" placeholder="e.g. 240 kg" class="w150"/>
          </div>
        </div>

        <div id="fodderRow" class="row hidden">
          <div>
            <label>Fodder</label>
            <select id="fodderSel" class="w220"></select>
          </div>
          <div>
            <label>Amount</label>
            <input id="fodderAmtInp" type="text" placeholder="e.g. 5 bales" class="w150"/>
          </div>
        </div>

        <div id="purchaseRow" class="row hidden">
          <div>
            <label>Purchase type</label>
            <select id="purchaseTypeSel" class="w150">
              <option value="">(choose)</option>
              <option value="Chemical">Chemical</option>
              <option value="Seed">Seed</option>
              <option value="Fodder">Fodder</option>
            </select>
          </div>
          <div>
            <label>Supplier</label>
            <input id="supplierInp" type="text" placeholder="e.g. CRT, Nutrien" class="w180"/>
          </div>
          <div>
            <label>Invoice / ref</label>
            <input id="invoiceInp" type="text" class="w150"/>
          </div>
        </div>

        <div id="rainRow" class="row hidden">
          <div>
            <label>Gauge</label>
            <select id="gaugeSel" class="w220"></select>
          </div>
          <div>
            <label>Rain (mm)</label>
            <input id="rainMmInp" type="number" min="0" step="0.2" class="w100"/>
          </div>
          <div class="muted small">
            Rainfall recorded to 9am for previous 24 hours.
          </div>
        </div>

        <div class="row">
          <div>
            <label>Notes / weather</label>
            <textarea id="notesInp" placeholder="Notes, weather, job details…" class="w260"></textarea>
          </div>
        </div>

        <div class="row">
          <div>
            <button id="saveBtn" class="btn">
              <span>Save entry</span>
            </button>
          </div>
          <div class="spacer"></div>
          <div id="statusBar" class="muted small"></div>
        </div>
      </div>
    </section>

    <!-- Entries list -->
    <section class="card">
      <div class="card-header">
        <h2>Entries</h2>
        <div>
          <button id="printBtn" class="btn secondary small no-print">Print</button>
        </div>
      </div>
      <div class="card-body compact-top">

        <div class="filters-row no-print">
          <div>
            <label>Property filter</label>
            <select id="filterPropertySel"></select>
          </div>
          <div>
            <label>Activity filter</label>
            <select id="filterActivitySel"></select>
          </div>
          <div>
            <label>Rainfall / stock</label>
            <select id="filterTypeSel">
              <option value="">All entries</option>
              <option value="Rainfall">Rainfall only</option>
              <option value="Stock">Livestock only</option>
            </select>
          </div>
          <div>
            <label>User filter</label>
            <select id="filterUserSel">
              <option value="">All users</option>
            </select>
          </div>
          <div class="right">
            <div>
              <label>Sort</label>
              <div class="pill-sort">
                <button type="button" data-sort="newest" class="active" id="sortNewestBtn">Newest</button>
                <button type="button" data-sort="oldest" id="sortOldestBtn">Oldest</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Desktop table -->
        <div class="table-desktop">
          <div class="table-scroll">
            <table>
              <thead>
              <tr>
                <th>Date</th>
                <th>Property</th>
                <th>Paddock</th>
                <th>Activity</th>
                <th>Stock</th>
                <th>Chemical / inputs</th>
                <th>Rain (mm)</th>
                <th>Notes</th>
                <th>User</th>
                <th class="no-print"></th>
              </tr>
              </thead>
              <tbody id="entriesBody">
              <tr><td colspan="10" class="muted small">Loading…</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Mobile cards -->
        <div class="table-mobile">
          <div id="entriesCards"></div>
        </div>

      </div>
    </section>
  </div>
</main>

<div id="loginRoot" class="hidden">
  <div class="login-container">
    <h1>SkyFarm sign in</h1>
    <p>Sign in to view and update diary entries.</p>

    <div id="loginError" class="alert error hidden"></div>
    <div id="loginInfo" class="alert info hidden"></div>

    <label>Email
      <input id="siEmail" type="email" autocomplete="email"/>
    </label>
    <label>Password
      <input id="siPass" type="password" autocomplete="current-password"/>
    </label>

    <div class="row" style="margin-top:10px;">
      <button id="signInBtn" class="btn"><span>Sign in</span></button>
      <button id="signOutBtn" class="btn secondary hidden"><span>Sign out</span></button>
    </div>

    <div class="login-footer">
      <span class="muted small">Access is managed by your SkyFarm admin.</span>
      <span class="small">Need help? Contact your admin.</span>
    </div>
  </div>
</div>

<script>
  // ---------- Firebase init ----------
  const firebaseConfig = {
    apiKey: "YOUR_KEY_HERE",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ---------- DOM refs ----------
  const appRoot = document.getElementById('appRoot');
  const loginRoot = document.getElementById('loginRoot');

  const propSel = document.getElementById('propSel');
  const dateInp = document.getElementById('dateInp');
  const timeInp = document.getElementById('timeInp');
  const activitySel = document.getElementById('activitySel');
  const paddockSel = document.getElementById('paddockSel');
  const toPaddockSel = document.getElementById('toPaddockSel');
  const transferPropertySel = document.getElementById('transferPropertySel');

  const paddockRow = document.getElementById('paddockRow');
  const toPaddockWrap = document.getElementById('toPaddockWrap');
  const transferRow = document.getElementById('transferRow');

  const stockRow = document.getElementById('stockRow');
  const chemRow = document.getElementById('chemRow');
  const seedRow = document.getElementById('seedRow');
  const fodderRow = document.getElementById('fodderRow');
  const purchaseRow = document.getElementById('purchaseRow');
  const rainRow = document.getElementById('rainRow');

  const speciesSel = document.getElementById('speciesSel');
  const classInp = document.getElementById('classInp');
  const headInp = document.getElementById('headInp');

  const chemSel = document.getElementById('chemSel');
  const chemRateInp = document.getElementById('chemRateInp');
  const chemTotalInp = document.getElementById('chemTotalInp');

  const seedSel = document.getElementById('seedSel');
  const seedRateInp = document.getElementById('seedRateInp');
  const seedTotalInp = document.getElementById('seedTotalInp');

  const fodderSel = document.getElementById('fodderSel');
  const fodderAmtInp = document.getElementById('fodderAmtInp');

  const purchaseTypeSel = document.getElementById('purchaseTypeSel');
  const supplierInp = document.getElementById('supplierInp');
  const invoiceInp = document.getElementById('invoiceInp');

  const gaugeSel = document.getElementById('gaugeSel');
  const rainMmInp = document.getElementById('rainMmInp');
  const notesInp = document.getElementById('notesInp');

  const saveBtn = document.getElementById('saveBtn');
  const statusBar = document.getElementById('statusBar');
  const userChip = document.getElementById('userChip');

  const entriesBody = document.getElementById('entriesBody');
  const entriesCards = document.getElementById('entriesCards');

  const filterPropertySel = document.getElementById('filterPropertySel');
  const filterActivitySel = document.getElementById('filterActivitySel');
  const filterUserSel = document.getElementById('filterUserSel');
  const filterTypeSel = document.getElementById('filterTypeSel');
  const sortNewestBtn = document.getElementById('sortNewestBtn');
  const sortOldestBtn = document.getElementById('sortOldestBtn');
  const printBtn = document.getElementById('printBtn');

  const siEmail = document.getElementById('siEmail');
  const siPass = document.getElementById('siPass');
  const signInBtn = document.getElementById('signInBtn');
  const signOutBtn = document.getElementById('signOutBtn');
  const loginError = document.getElementById('loginError');
  const loginInfo = document.getElementById('loginInfo');

  const USERS = {};
  let PROPERTIES = [];
  let PADDOCKS_BY_PROPERTY = {};
  let CHEMICALS = [];
  let SEEDS = [];
  let FODDER = [];
  let RAIN_GAUGES = [];

  let currentUser = null;
  let entries = [];
  let sortDir = 'newest';

  function setStatus(msg, isError){
    if (!msg){
      statusBar.textContent = '';
      statusBar.classList.remove('muted');
      return;
    }
    statusBar.textContent = msg;
    if (isError){
      statusBar.classList.remove('muted');
      statusBar.style.color = '#b91c1c';
    }else{
      statusBar.classList.add('muted');
      statusBar.style.color = '';
    }
  }

  function escapeHtml(str){
    if (str === null || str === undefined) return '';
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function formatDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }

  function initDateTime(){
    const now = new Date();
    dateInp.value = formatDate(now);
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    timeInp.value = `${hh}:${mm}`;
  }

  function onActivityChange(){
    const act = activitySel.value;

    if (act === 'Rainfall'){
      paddockRow.classList.add('hidden');
      rainRow.classList.remove('hidden');
    }else{
      paddockRow.classList.remove('hidden');
      rainRow.classList.add('hidden');
    }

    if (act === 'Move stock'){
      toPaddockWrap.classList.remove('hidden');
    }else{
      toPaddockWrap.classList.add('hidden');
    }

    if (act === 'Trucking (sale)'){
      transferRow.classList.remove('hidden');
    }else{
      transferRow.classList.add('hidden');
    }

    const usesStockActivity =
      act === 'Move stock' ||
      act === 'Trucking (sale)' ||
      act === 'Mustering' ||
      act === 'Feeding (fodder)';

    stockRow.classList.toggle('hidden', !usesStockActivity && act !== 'Purchase inputs');

    purchaseRow.classList.toggle('hidden', act !== 'Purchase inputs');

    updateInputRows();
  }

  function onPurchaseTypeChange(){
    updateInputRows();
  }

  function updateInputRows(){
    const act = activitySel.value;
    const purchaseType = purchaseTypeSel.value;

    const usesChemActivity =
      act === 'Spraying paddocks' ||
      act === 'Chemical (stock)';

    const purchaseChem   = (act === 'Purchase inputs' && purchaseType === 'Chemical');
    const purchaseSeed   = (act === 'Purchase inputs' && purchaseType === 'Seed');
    const purchaseFodder = (act === 'Purchase inputs' && purchaseType === 'Fodder');
    const feedingFodder  = (act === 'Feeding (fodder)');

    chemRow.classList.toggle('hidden', !(usesChemActivity || purchaseChem));
    seedRow.classList.toggle('hidden', !(act === 'Planting' || purchaseSeed));
    fodderRow.classList.toggle('hidden', !(feedingFodder || purchaseFodder));
  }

  function loadStaticData(){
    const propsRef = db.collection('properties');
    const usersRef = db.collection('users');
    const paddocksRef = db.collection('paddocks');
    const chemsRef = db.collection('chemicals');
    const seedRef = db.collection('seeds');
    const fodderRef = db.collection('fodder');
    const rainRef = db.collection('rain_gauges');

    return Promise.all([
      propsRef.get(),
      usersRef.get(),
      paddocksRef.get(),
      chemsRef.get(),
      seedRef.get(),
      fodderRef.get(),
      rainRef.get()
    ]).then(([propsSnap, usersSnap, paddocksSnap, chemsSnap, seedsSnap, fodderSnap, rainSnap])=>{
      PROPERTIES = propsSnap.docs.map(d=>({id:d.id, ...d.data()}));

      usersSnap.docs.forEach(d=>{
        const u = d.data();
        const email = (u.email || '').toLowerCase();
        if (!email) return;
        const fullName = [u.firstName, u.lastName].filter(Boolean).join(' ').trim();
        USERS[email] = {
          id: d.id,
          email,
          firstName: u.firstName || '',
          lastName: u.lastName || '',
          fullName
        };
      });

      PADDOCKS_BY_PROPERTY = {};
      paddocksSnap.docs.forEach(d=>{
        const p = d.data();
        const propId = p.propertyId;
        if (!PADDOCKS_BY_PROPERTY[propId]) PADDOCKS_BY_PROPERTY[propId] = [];
        PADDOCKS_BY_PROPERTY[propId].push({id:d.id, ...p});
      });

      CHEMICALS = chemsSnap.docs.map(d=>({id:d.id, ...d.data()}));
      SEEDS = seedsSnap.docs.map(d=>({id:d.id, ...d.data()}));
      FODDER = fodderSnap.docs.map(d=>({id:d.id, ...d.data()}));
      RAIN_GAUGES = rainSnap.docs.map(d=>({id:d.id, ...d.data()}));
    });
  }

  function populatePropertySelects(){
    const makeOpts = sel=>{
      sel.innerHTML = '';
      PROPERTIES.forEach(p=>{
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name || '(unnamed)';
        sel.appendChild(opt);
      });
    };
    makeOpts(propSel);
    makeOpts(filterPropertySel);
    makeOpts(transferPropertySel);

    const optAll = document.createElement('option');
    optAll.value = '';
    optAll.textContent = 'All properties';
    filterPropertySel.insertBefore(optAll, filterPropertySel.firstChild);
    filterPropertySel.value = '';
  }

  function populatePaddocks(){
    const propId = propSel.value;
    const paddocks = PADDOCKS_BY_PROPERTY[propId] || [];

    const fillSel = (sel, includeBlank)=>{
      sel.innerHTML = '';
      if (includeBlank){
        const o = document.createElement('option');
        o.value = '';
        o.textContent = '(none)';
        sel.appendChild(o);
      }
      paddocks.forEach(p=>{
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name || p.id;
        sel.appendChild(opt);
      });
    };

    fillSel(paddockSel, false);
    fillSel(toPaddockSel, true);
  }

  function populateChemicals(){
    chemSel.innerHTML = '';
    const blank = document.createElement('option');
    blank.value = '';
    blank.textContent = '(none)';
    chemSel.appendChild(blank);
    CHEMICALS.forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.name || c.id;
      chemSel.appendChild(opt);
    });
  }

  function populateSeeds(){
    seedSel.innerHTML = '';
    const blank = document.createElement('option');
    blank.value = '';
    blank.textContent = '(none)';
    seedSel.appendChild(blank);
    SEEDS.forEach(s=>{
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.name || s.id;
      seedSel.appendChild(opt);
    });
  }

  function populateFodder(){
    fodderSel.innerHTML = '';
    const blank = document.createElement('option');
    blank.value = '';
    blank.textContent = '(none)';
    fodderSel.appendChild(blank);
    FODDER.forEach(f=>{
      const opt = document.createElement('option');
      opt.value = f.id;
      opt.textContent = f.name || f.id;
      fodderSel.appendChild(opt);
    });
  }

  function populateRainGauges(){
    gaugeSel.innerHTML = '';
    RAIN_GAUGES.forEach(g=>{
      const opt = document.createElement('option');
      opt.value = g.id;
      opt.textContent = g.name || g.id;
      gaugeSel.appendChild(opt);
    });
  }

  function populateActivityFilter(){
    const activities = [
      'Ploughing',
      'Planting',
      'Spraying paddocks',
      'Chemical (stock)',
      'Trucking (sale)',
      'Mustering',
      'Move stock',
      'Feeding (fodder)',
      'Rainfall',
      'Purchase inputs',
      'General'
    ];
    filterActivitySel.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = '';
    optAll.textContent = 'All activities';
    filterActivitySel.appendChild(optAll);
    activities.forEach(a=>{
      const opt = document.createElement('option');
      opt.value = a;
      opt.textContent = a;
      filterActivitySel.appendChild(opt);
    });
  }

  const userLabelFor = r=>{
    if (!r.createdByEmail) return '';
    const email = String(r.createdByEmail).toLowerCase();
    const u = USERS[email];
    if (u){
      if (u.fullName) return u.fullName;
      if (u.firstName) return u.firstName;
    }
    return email.split('@')[0];
  };

  function applyFiltersAndRender(){
    if (!entries || !Array.isArray(entries)){
      entriesBody.innerHTML = '<tr><td colspan="10" class="muted small">No entries.</td></tr>';
      if (entriesCards) entriesCards.innerHTML = '';
      return;
    }

    const propId = filterPropertySel.value || '';
    const act = filterActivitySel.value || '';
    const typeFilter = filterTypeSel.value || '';
    const userFilter = filterUserSel.value || '';

    let filtered = entries.slice();

    if (propId){
      filtered = filtered.filter(r=>r.propertyId === propId);
    }
    if (act){
      filtered = filtered.filter(r=>r.activity === act);
    }
    if (typeFilter === 'Rainfall'){
      filtered = filtered.filter(r=>r.activity === 'Rainfall');
    }else if (typeFilter === 'Stock'){
      filtered = filtered.filter(r=>{
        return r.species || r.head || r.classText || r.activity === 'Move stock' || r.activity === 'Trucking (sale)' || r.activity === 'Mustering';
      });
    }
    if (userFilter){
      filtered = filtered.filter(r=>userLabelFor(r) === userFilter);
    }

    filtered.sort((a,b)=>{
      const aKey = (a.date || '') + 'T' + (a.time || '');
      const bKey = (b.date || '') + 'T' + (b.time || '');
      if (sortDir === 'newest'){
        return aKey < bKey ? 1 : aKey > bKey ? -1 : 0;
      }else{
        return aKey > bKey ? 1 : aKey < bKey ? -1 : 0;
      }
    });

    if (!filtered.length){
      entriesBody.innerHTML = '<tr><td colspan="10" class="muted small">No entries match filters.</td></tr>';
      if (entriesCards) entriesCards.innerHTML = '<div class="muted small">No entries match filters.</div>';
      return;
    }

    const tableHtml = filtered.map(r=>{
      const stockBits = [];
      if (r.species) stockBits.push(r.species);
      if (r.classText) stockBits.push(r.classText);
      if (r.head) stockBits.push(`${r.head} head`);
      const stock = stockBits.join(', ');

      let inputs = '';
      const bits = [];
      if (r.chemicalId) bits.push('Chemical');
      if (r.seedId) bits.push('Seed');
      if (r.fodderId) bits.push('Fodder');
      if (bits.length) inputs = bits.join(', ');

      const rain = r.activity === 'Rainfall' ? (r.rainMm || '') : '';

      const notes = r.notes || r.weather || '';

      const userLabel = userLabelFor(r);

      const delHtml = '<button type="button" class="btn small danger no-print" data-del-id="'+r.id+'">Delete</button>';

      return `<tr data-id="${r.id}">
          <td class="nowrap">${escapeHtml(r.date||'')}</td>
          <td>${escapeHtml(r.propertyName||'')}</td>
          <td>${escapeHtml(r.paddock||'')}</td>
          <td>${escapeHtml(r.activity||'')}</td>
          <td>${escapeHtml(stock)}</td>
          <td>${escapeHtml(inputs)}</td>
          <td>${escapeHtml(rain)}</td>
          <td>${escapeHtml(notes)}</td>
          <td>${escapeHtml(userLabel)}</td>
          <td class="no-print">${delHtml}</td>
        </tr>`;
    }).join('');

    entriesBody.innerHTML = tableHtml || '<tr><td colspan="10" class="muted small">No entries.</td></tr>';

    if (entriesCards){
      const cardsHtml = filtered.map(r=>{
        const stockBits = [];
        if (r.species) stockBits.push(r.species);
        if (r.classText) stockBits.push(r.classText);
        if (r.head) stockBits.push(`${r.head} head`);
        const stock = stockBits.join(', ');

        const inputBits = [];
        if (r.chemicalId && r.chemicalName) inputBits.push(`Chemical: ${r.chemicalName}`);
        if (r.seedId && r.seedName)       inputBits.push(`Seed: ${r.seedName}`);
        if (r.fodderId && r.fodderName)   inputBits.push(`Fodder: ${r.fodderName}`);
        const inputs = inputBits.join(' | ');

        const rain = r.activity === 'Rainfall' ? (r.rainMm || '') : '';

        const notes = r.notes || r.weather || '';

        const userLabel = userLabelFor(r);

        return `<div class="entry-card" data-id="${r.id}">
            <div class="ec-header">
              <div>${escapeHtml(r.date || '')}</div>
            </div>
            <div class="ec-line">
              <span class="ec-label">Property</span>${escapeHtml(r.propertyName || '')}
            </div>
            ${userLabel ? `<div class="ec-line"><span class="ec-label">User</span>${escapeHtml(userLabel)}</div>` : ''}
            <div class="ec-line">
              <span class="ec-label">Activity</span>${escapeHtml(r.activity || '')}
            </div>
            ${stock ? `<div class="ec-line"><span class="ec-label">Stock</span>${escapeHtml(stock)}</div>` : ''}
            ${inputs ? `<div class="ec-line"><span class="ec-label">Inputs</span>${escapeHtml(inputs)}</div>` : ''}
            ${rain ? `<div class="ec-line"><span class="ec-label">Rain</span>${escapeHtml(rain)} mm</div>` : ''}
            ${notes ? `<div class="ec-line"><span class="ec-label">Notes</span>${escapeHtml(notes)}</div>` : ''}
            <div class="ec-line no-print" style="margin-top:4px;">
              <button type="button" class="btn small danger" data-del-id="${r.id}">Delete</button>
            </div>
          </div>`;
      }).join('');

      entriesCards.innerHTML = cardsHtml || '<div class="muted small">No entries.</div>';
    }
  }

  function loadEntries(){
    if (!currentUser) return;
    setStatus('Loading entries…');
    return db.collection('diary_entries')
      .where('farmId','==',currentUser.farmId)
      .get()
      .then(snap=>{
        entries = snap.docs.map(d=>{
          const data = d.data();
          const prop = PROPERTIES.find(p=>p.id === data.propertyId);
          const paddArr = PADDOCKS_BY_PROPERTY[data.propertyId] || [];
          const padd = paddArr.find(p=>p.id === data.paddockId);

          const chem = CHEMICALS.find(c=>c.id === data.chemicalId);
          const seed = SEEDS.find(s=>s.id === data.seedId);
          const fodder = FODDER.find(f=>f.id === data.fodderId);

          return {
            id: d.id,
            ...data,
            propertyName: prop ? (prop.name || prop.id) : '',
            paddock: padd ? (padd.name || padd.id) : '',
            chemicalName: chem ? (chem.name || chem.id) : '',
            seedName: seed ? (seed.name || seed.id) : '',
            fodderName: fodder ? (fodder.name || fodder.id) : ''
          };
        });

        const existingSelection = filterUserSel.value || '';
        const userSet = new Set();
        rows = entries;
        rows.forEach(r=>{
          if (r.createdByEmail){
            const email = String(r.createdByEmail).toLowerCase();
            const u = USERS[email];
            const label = (u && (u.fullName || u.firstName))
              ? (u.fullName || u.firstName)
              : email.split('@')[0];
            if (label) userSet.add(label);
          }
        });
        filterUserSel.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = '';
        optAll.textContent = 'All users';
        filterUserSel.appendChild(optAll);
        Array.from(userSet).sort().forEach(label=>{
          const opt = document.createElement('option');
          opt.value = label;
          opt.textContent = label;
          filterUserSel.appendChild(opt);
        });
        if (existingSelection && Array.from(userSet).includes(existingSelection)){
          filterUserSel.value = existingSelection;
        }else{
          filterUserSel.value = '';
        }

        applyFiltersAndRender();
        setStatus('');
      })
      .catch(err=>{
        console.error(err);
        setStatus('Error loading entries', true);
      });
  }

  function onSave(){
    if (!currentUser) return;

    const propertyId = propSel.value || '';
    const date = dateInp.value || '';
    const time = timeInp.value || '';
    const activity = activitySel.value || '';

    if (!propertyId || !date || !activity){
      setStatus('Property, date and activity are required.', true);
      return;
    }

    const paddockId = paddockSel.value || '';
    const toPaddockId = toPaddockSel.value || '';
    const transferPropertyId = transferPropertySel.value || '';

    const species = speciesSel.value || '';
    const classText = classInp.value || '';
    const head = headInp.value ? Number(headInp.value) : null;

    const chemicalId = chemSel.value || '';
    const chemRate = chemRateInp.value || '';
    const chemTotal = chemTotalInp.value || '';

    const seedId = seedSel.value || '';
    const seedRate = seedRateInp.value || '';
    const seedTotal = seedTotalInp.value || '';

    const fodderId = fodderSel.value || '';
    const fodderAmt = fodderAmtInp.value || '';

    const purchaseType = purchaseTypeSel.value || '';
    const supplier = supplierInp.value || '';
    const invoice = invoiceInp.value || '';

    const gaugeId = gaugeSel.value || '';
    const rainMm = rainMmInp.value ? Number(rainMmInp.value) : null;

    const notes = notesInp.value || '';
    const weather = '';

    const payload = {
      farmId: currentUser.farmId,
      propertyId,
      date,
      time,
      activity,
      paddockId,
      toPaddockId,
      transferPropertyId,
      species,
      classText,
      head,
      chemicalId,
      chemRate,
      chemTotal,
      seedId,
      seedRate,
      seedTotal,
      fodderId,
      fodderAmt,
      purchaseType,
      supplier,
      invoice,
      gaugeId,
      rainMm,
      notes,
      weather,
      createdByEmail: currentUser.email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    setStatus('Saving entry…');
    saveBtn.disabled = true;
    db.collection('diary_entries').add(payload)
      .then(()=>{
        setStatus('Saved');
        saveBtn.disabled = false;
        notesInp.value = '';
        headInp.value = '';
        classInp.value = '';
        chemRateInp.value = '';
        chemTotalInp.value = '';
        seedRateInp.value = '';
        seedTotalInp.value = '';
        fodderAmtInp.value = '';
        supplierInp.value = '';
        invoiceInp.value = '';
        rainMmInp.value = '';
        return loadEntries();
      })
      .catch(err=>{
        console.error(err);
        saveBtn.disabled = false;
        setStatus('Error saving entry', true);
      });
  }

  function onDelete(id){
    if (!currentUser || !id) return;
    if (!confirm('Delete this entry?')) return;
    setStatus('Deleting…');
    db.collection('diary_entries').doc(id).delete()
      .then(()=>{
        setStatus('Deleted');
        entries = entries.filter(e=>e.id !== id);
        applyFiltersAndRender();
      })
      .catch(err=>{
        console.error(err);
        setStatus('Error deleting entry', true);
      });
  }

  function onEntriesClick(e){
    const btn = e.target.closest('[data-del-id]');
    if (!btn) return;
    const id = btn.getAttribute('data-del-id');
    onDelete(id);
  }

  function onSortClick(dir){
    sortDir = dir;
    if (dir === 'newest'){
      sortNewestBtn.classList.add('active');
      sortOldestBtn.classList.remove('active');
    }else{
      sortOldestBtn.classList.add('active');
      sortNewestBtn.classList.remove('active');
    }
    applyFiltersAndRender();
  }

  function showLogin(){
    appRoot.classList.add('hidden');
    loginRoot.classList.remove('hidden');
  }

  function showApp(){
    loginRoot.classList.add('hidden');
    appRoot.classList.remove('hidden');
  }

  function setLoginError(msg){
    if (!msg){
      loginError.classList.add('hidden');
      loginError.textContent = '';
      return;
    }
    loginError.textContent = msg;
    loginError.classList.remove('hidden');
  }

  function setLoginInfo(msg){
    if (!msg){
      loginInfo.classList.add('hidden');
      loginInfo.textContent = '';
      return;
    }
    loginInfo.textContent = msg;
    loginInfo.classList.remove('hidden');
  }

  function signIn(){
    const email = (siEmail.value || '').trim();
    const pass  = siPass.value || '';
    if (!email || !pass){
      setLoginError('Email and password required.');
      return;
    }
    setLoginError('');
    setLoginInfo('Signing in…');
    auth.signInWithEmailAndPassword(email, pass)
      .then(()=>{
        setLoginInfo('');
      })
      .catch(err=>{
        console.error(err);
        setLoginInfo('');
        setLoginError('Sign in failed.');
      });
  }

  function signOut(){
    auth.signOut().catch(err=>{
      console.error(err);
    });
  }

  auth.onAuthStateChanged(user=>{
    if (!user){
      currentUser = null;
      showLogin();
      return;
    }
    const email = (user.email || '').toLowerCase();
    db.collection('users').where('email','==',email).limit(1).get()
      .then(snap=>{
        if (snap.empty){
          currentUser = {
            uid: user.uid,
            email,
            farmId: ''
          };
        }else{
          const u = snap.docs[0].data();
          const fullName = [u.firstName, u.lastName].filter(Boolean).join(' ').trim();
          currentUser = {
            uid: user.uid,
            email,
            farmId: u.farmId || '',
            fullName
          };
        }

        const label = currentUser.fullName || currentUser.email.split('@')[0] || currentUser.email;
        userChip.textContent = `Signed in as ${label}`;
        showApp();

        Promise.resolve()
          .then(loadStaticData)
          .then(()=>{
            populatePropertySelects();
            populatePaddocks();
            populateChemicals();
            populateSeeds();
            populateFodder();
            populateRainGauges();
            populateActivityFilter();
            initDateTime();
            onActivityChange();
            return loadEntries();
          })
          .catch(err=>{
            console.error(err);
            setStatus('Error loading data', true);
          });

      })
      .catch(err=>{
        console.error(err);
        showLogin();
      });
  });

  propSel.addEventListener('change', ()=>{
    populatePaddocks();
  });
  activitySel.addEventListener('change', onActivityChange);
  purchaseTypeSel.addEventListener('change', onPurchaseTypeChange);
  saveBtn.addEventListener('click', onSave);
  printBtn.addEventListener('click', ()=>window.print());

  entriesBody.addEventListener('click', onEntriesClick);
  if (entriesCards){
    entriesCards.addEventListener('click', onEntriesClick);
  }

  filterPropertySel.addEventListener('change', applyFiltersAndRender);
  filterActivitySel.addEventListener('change', applyFiltersAndRender);
  filterTypeSel.addEventListener('change', applyFiltersAndRender);
  filterUserSel.addEventListener('change', applyFiltersAndRender);
  sortNewestBtn.addEventListener('click', ()=>onSortClick('newest'));
  sortOldestBtn.addEventListener('click', ()=>onSortClick('oldest'));

  signInBtn.addEventListener('click', signIn);
  signOutBtn.addEventListener('click', signOut);

  siEmail.addEventListener('keydown', e=>{ if (e.key === 'Enter') signIn(); });
  siPass.addEventListener('keydown', e=>{ if (e.key === 'Enter') signIn(); });

  document.addEventListener('DOMContentLoaded', ()=>{
    showLogin();
  });
</script>

</body>
</html>
