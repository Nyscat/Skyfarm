<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SkyFarm ‚Äî Diary</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>

  <style>
    :root { --brand:#0B7A6E; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#f6fbf8; margin:0; color:var(--ink); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { margin: 12px 0; font-size: 1.6rem; }

    /* Header (match chemical page look) */
    #skyfarm-header { position:sticky; top:0; z-index:10; }
    #skyfarm-header .bar { display:flex; align-items:center; gap:12px; padding:10px 14px; background:#fff; border-bottom:1px solid #e5e7eb; }
    #skyfarm-header .brand { display:flex; align-items:center; gap:10px; color:var(--brand); font-weight:700; text-decoration:none; }
    #skyfarm-header nav a { color:var(--brand); text-decoration:none; font-weight:600; margin-right:10px; }
    #skyfarm-header nav a[aria-current="page"] { text-decoration:underline; }
    .spacer { flex:1; }
    .muted { color:var(--muted); font-size:.9rem; }
    .hidden { display:none; }

    /* Cards / Controls */
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:12px 0; }
    .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; align-items:center; }
    label { font-size:.9rem; color:#475569; margin-bottom:4px; display:block; }
    input, select, button { padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; font:inherit; }
    button { cursor:pointer; }
    .btn { border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
    .primary { background:var(--brand); color:#fff; border-color:var(--brand); }
    .danger { background:#ef4444; color:#fff; border-color:#ef4444; }
    .disabled { opacity:.55; pointer-events:none; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#e2e8f0; font-size:.8rem; margin-right:6px; border:1px solid #cbd5e1; }
    .small { font-size:.9rem; }
    .nowrap { white-space:nowrap; }
    .w80 { width:80px; } .w110 { width:110px; } .w140 { width:140px; } .w200 { width:200px; } .w240 { width:240px; }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: 8px; text-align: left; font-size: .95rem; }
    th { background:#f1f5f9; }

    /* Sign-in overlay */
    #authOverlay{position:fixed; inset:0; background:rgba(15,23,42,.06); display:none; align-items:center; justify-content:center; z-index:50}
    #authCard{width:min(520px,92vw); background:#fff; border:1px solid var(--line); border-radius:16px; padding:20px}
    #authCard h2{margin:0 0 8px}
    #authMsg{min-height:1.4em}
  </style>

  <!-- optional shared header/css (safe to keep; will no-op if not present) -->
  <link rel="stylesheet" href="skyfarm-shared.css">
</head>
<body>

<!-- Header -->
<div id="skyfarm-header">
  <div class="bar">
    <a class="brand" href="skyfarm-diary.html">üå± SkyFarm</a>
    <nav>
      <a href="skyfarm-diary.html" aria-current="page">Diary</a>
      <a href="skyfarm-map.html">Map</a>
      <a href="skyfarm-chemical.html">Chemicals</a>
    </nav>
    <span class="spacer"></span>
    <span id="authWho" class="muted">Checking sign-in‚Ä¶</span>
    <button id="signOutBtn" class="danger hidden">Sign out</button>
  </div>
</div>

<div class="wrap">
  <h1>Diary</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Property</label>
        <select id="propSel" class="w240"></select>
      </div>
      <div>
        <label>Date</label>
        <input id="dateInp" type="date"/>
      </div>
      <div>
        <label>Time</label>
        <input id="timeInp" type="time"/>
      </div>
      <div>
        <label>Activity</label>
        <select id="activitySel" class="w240">
          <option value="Ploughing">Ploughing</option>
          <option value="Planting">Planting</option>
          <option value="Spraying paddocks">Spraying</option>
          <option value="Chemical (stock)">Chemical (stock)</option>
          <option value="Trucking (sale)">Trucking (sale)</option>
          <option value="Move stock">Move stock (paddock‚Üípaddock)</option>
          <option value="Mustering">Mustering</option>
          <option value="Other">General note</option>
        </select>
      </div>
      <span class="spacer"></span>
      <div>
        <label>&nbsp;</label>
        <span id="status" class="muted">‚Äî</span>
      </div>
    </div>

    <div class="row">
      <div style="min-width:260px">
        <label>Paddock</label>
        <select id="paddockSel" class="w240"><option value="">(choose)</option></select>
      </div>
      <div style="flex:1; min-width:260px">
        <label>Notes</label>
        <input id="notesInp" placeholder="optional"/>
      </div>
    </div>

    <div id="chemRow" class="row hidden">
      <div>
        <label>Chemical</label>
        <select id="chemSel" class="w240"><option value="">(choose)</option></select>
      </div>
      <div>
        <label>Qty used</label>
        <input id="chemQty" type="number" min="0" step="0.01" class="w110"/>
      </div>
      <div>
        <label>Unit</label>
        <input id="chemUnit" placeholder="KG/L" class="w80" disabled/>
      </div>
      <div><label>&nbsp;</label><span id="chemHint" class="pill">context</span></div>
    </div>

    <div id="stockRow" class="row hidden">
      <div>
        <label>Species</label>
        <select id="speciesSel">
          <option value="Cattle">Cattle</option>
          <option value="Sheep">Sheep</option>
          <option value="Goats">Goats</option>
        </select>
      </div>
      <div>
        <label>Class</label>
        <input id="classInp" placeholder="e.g. Weaners" class="w200" list="classOptions"/>
        <datalist id="classOptions"></datalist>
      </div>
      <div>
        <label>Head</label>
        <input id="headInp" type="number" min="0" step="1" class="w110"/>
      </div>
    </div>

    <!-- Live ‚Äúwhat‚Äôs in paddock‚Äù context for Trucking/Move -->
    <div id="stockContext" class="row small" style="gap:6px; color:#334155;"></div>

    <div class="row">
      <button id="saveBtn" class="primary">Save entry</button>
      <button id="resetBtn" class="btn" type="button">Reset</button>
      <span id="msg" class="muted" aria-live="polite"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <strong>Recent entries</strong>
      <span class="spacer"></span>
      <div>
        <label>Year</label>
        <input id="yearInp" type="number" min="2000" max="2100" class="w110"/>
      </div>
      <button id="refreshBtn" class="btn" type="button">Refresh</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Property</th><th>Activity</th><th>Paddock</th><th>Notes</th><th></th>
        </tr>
      </thead>
      <tbody id="entriesTbody"><tr><td colspan="6">Loading‚Ä¶</td></tr></tbody>
    </table>
  </div>
</div>

<!-- Email/password sign-in (no anonymous) -->
<div id="authOverlay">
  <div id="authCard">
    <h2>Sign in to SkyFarm</h2>
    <p class="small muted">Email &amp; password only. Anonymous sign-in is disabled.</p>
    <div class="row">
      <div style="flex:1; min-width:260px">
        <label>Email</label>
        <input id="siEmail" type="email" placeholder="you@example.com" autocomplete="username"/>
      </div>
      <div style="flex:1; min-width:220px">
        <label>Password</label>
        <input id="siPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
      </div>
    </div>
    <div class="row">
      <button id="signInBtn" class="primary">Sign in</button>
      <span id="authMsg" class="muted"></span>
      <span class="spacer"></span>
      <button id="closeOverlayBtn" class="btn" type="button">Close</button>
    </div>
  </div>
</div>

<script>
/* -------------------------------------------------------
   Firebase init (compat) ‚Äî CORRECT CONFIG
------------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJlGvBwmW70",
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  storageBucket: "consentes-pastoral.appspot.com",
  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* -------------------------------------------------------
   Helpers / constants (match Chemical page patterns)
------------------------------------------------------- */
const $ = s => document.querySelector(s);
const setMsg = (t, ms=3000)=>{ $('#msg').textContent=t||''; if(t&&ms){ setTimeout(()=>$('#msg').textContent='', ms); } };
const errText = e => e?.message || e?.code || 'Unknown error';

const PROPS = [
  { id:"s7PlDM9wrEpxuJ6DGIab", name:"Consentes",  lat:-20.263323, lon:141.609607 },
  { id:"P0dQ0H2FWHeqqxejflZs", name:"Gerawin",     lat:-20.114428, lon:141.751857 },
  { id:"TRuxtRBX2zJlwZnRGYKJ", name:"Mt Myrtle",  lat:-26.566565, lon:149.997202 }
];
const NAME_BY_ID = Object.fromEntries(PROPS.map(p=>[p.id,p.name]));
const DEFAULT_PROP_ID = "TRuxtRBX2zJlwZnRGYKJ";

/* -------------------------------------------------------
   Auth (email/password only)
------------------------------------------------------- */
const overlay = $('#authOverlay');
const authWho = $('#authWho');
const signOutBtn = $('#signOutBtn');

function showOverlay(show){ overlay.style.display = show ? 'flex' : 'none'; }

$('#signInBtn').onclick = async ()=>{
  const email = $('#siEmail').value.trim();
  const pass  = $('#siPass').value;
  $('#authMsg').textContent = 'Signing in‚Ä¶';
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithEmailAndPassword(email, pass);
    $('#authMsg').textContent = 'Signed in.';
    showOverlay(false);
    // after sign-in, (re)load data
    await onPropertyChange();
    await refreshEntries();
  }catch(e){
    $('#authMsg').textContent = 'Sign-in failed: ' + errText(e);
  }
};
$('#closeOverlayBtn').onclick = ()=> showOverlay(false);
$('#signOutBtn').onclick = async ()=>{ try{ await auth.signOut(); location.reload(); }catch(e){} };

function onAuth(){
  return new Promise(resolve=>{
    auth.onAuthStateChanged(async u=>{
      if(u){
        authWho.textContent = u.email ? `Signed in as ${u.email}` : 'Signed in';
        signOutBtn.classList.remove('hidden');
        showOverlay(false);
        resolve(true);
      }else{
        authWho.textContent = 'Not signed in';
        signOutBtn.classList.add('hidden');
        showOverlay(true);
        resolve(false);
      }
    });
  });
}

/* -------------------------------------------------------
   Elements & state
------------------------------------------------------- */
const propSel = $('#propSel'), dateInp = $('#dateInp'), timeInp = $('#timeInp'), activitySel = $('#activitySel');
const paddockSel = $('#paddockSel'), notesInp = $('#notesInp');
const chemRow = $('#chemRow'), chemSel = $('#chemSel'), chemQty = $('#chemQty'), chemUnit = $('#chemUnit'), chemHint = $('#chemHint');
const stockRow = $('#stockRow'), speciesSel = $('#speciesSel'), classInp = $('#classInp'), headInp = $('#headInp');
const stockContext = $('#stockContext');
const entriesTbody = $('#entriesTbody');

let chems = []; // current property‚Äôs chemicals for dropdown

/* -------------------------------------------------------
   UI & data wiring
------------------------------------------------------- */
function initUI(){
  // property selector
  propSel.innerHTML = PROPS.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  propSel.value = DEFAULT_PROP_ID;

  // defaults
  dateInp.value = new Date().toISOString().slice(0,10);

  // events
  propSel.onchange = onPropertyChange;
  activitySel.onchange = onActivityChange;
  $('#refreshBtn').onclick = refreshEntries;
  $('#resetBtn').onclick   = resetForm;
  $('#saveBtn').onclick    = ()=> saveEntry().catch(e=>{ console.error(e); alert(errText(e)); });

  paddockSel.onchange = onPaddockOrSpeciesChange;
  speciesSel.onchange = onPaddockOrSpeciesChange;

  onActivityChange();
}

function onActivityChange(){
  const act = activitySel.value;

  const needsChem = (act==='Spraying paddocks' || act==='Chemical (stock)' || act==='Trucking (sale)');
  chemRow.classList.toggle('hidden', !needsChem);
  chemHint.textContent =
    act==='Spraying paddocks' ? 'paddock spray'
    : act==='Trucking (sale)' ? 'backline before transport'
    : 'stock treatment';

  const needsStock = (act==='Trucking (sale)' || act==='Move stock' || act==='Chemical (stock)' || act==='Mustering');
  stockRow.classList.toggle('hidden', !needsStock);

  onPaddockOrSpeciesChange();
}

/* -------------------------------------------------------
   Property change ‚Üí load paddocks, chems
------------------------------------------------------- */
async function onPropertyChange(){
  const pid = propSel.value;
  // paddocks
  paddockSel.innerHTML = '<option>(loading‚Ä¶)</option>';
  try{
    if(!auth.currentUser){ paddockSel.innerHTML = '<option value="">(sign in first)</option>'; return; }
    const snap = await db.collection('paddocks').where('propertyId','==',pid).get();
    const pads=[]; snap.forEach(d=> pads.push({id:d.id, ...d.data()}));
    pads.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));
    paddockSel.innerHTML = '<option value="">(choose)</option>' +
      pads.map(p => `<option value="${p.id}" data-name="${escapeHtml(p.name||'')}">${escapeHtml(p.name||'(unnamed)')}</option>`).join('');
  }catch(e){
    paddockSel.innerHTML = '<option value="">(load error)</option>';
    console.error('Paddocks load error:', e);
  }

  // chems
  chems = [];
  chemSel.innerHTML = '<option>(loading‚Ä¶)</option>';
  try{
    if(auth.currentUser){
      const cs = await db.collection('chemicals').where('propertyId','==',pid).get();
      cs.forEach(d=> chems.push({id:d.id, ...d.data()}));
    }
  }catch(e){ console.warn('Chem load error', e); }
  buildChemDropdown();
  onPaddockOrSpeciesChange();
}

/* -------------------------------------------------------
   Chemical dropdown filter by activity
------------------------------------------------------- */
function buildChemDropdown(){
  const act = activitySel.value;
  const target = act==='Spraying paddocks' ? 'Use on paddock'
               : (act==='Chemical (stock)' || act==='Trucking (sale)') ? 'Use on stock'
               : null;
  if(!target){
    chemSel.innerHTML = '<option value="">(not required)</option>';
    chemUnit.value = '';
    return;
  }
  const list = chems.filter(c => String(c.useOn||'')===target && Number(c.quantity||0)>0);
  if(!list.length){
    chemSel.innerHTML = '<option value="">(no chemicals available)</option>';
    chemUnit.value = '';
    return;
  }
  chemSel.innerHTML = '<option value="">(choose)</option>' + list
    .sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')))
    .map(c => `<option value="${c.id}" data-unit="${c.unit||''}">${escapeHtml(c.name||'Unnamed')} (${c.unit||''}) ‚Äî ${Number(c.quantity||0)} left</option>`)
    .join('');
  chemSel.onchange = ()=> { chemUnit.value = chemSel.selectedOptions[0]?.dataset?.unit || ''; };
  chemUnit.value = chemSel.selectedOptions[0]?.dataset?.unit || '';
}

/* -------------------------------------------------------
   Livestock ‚Äúwhat‚Äôs in paddock‚Äù (chips you can click)
------------------------------------------------------- */
const SUGGESTED_CLASSES = ["Cows","Heifers","Bulls","Steers","PTIC cows","Joined cows","Calves","Weaners"];
function escapeHtml(s){ return String(s ?? '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

async function fetchLivestockRows(pid, paddockName, speciesUI){
  // try exact species match, then title/upper variants, then filter
  let snap = await db.collection('livestock')
    .where('propertyId','==',pid)
    .where('location','==',paddockName)
    .where('species','==',speciesUI)
    .get();

  if (snap.empty){
    const lc = (speciesUI||'').toLowerCase();
    const title = lc.charAt(0).toUpperCase()+lc.slice(1);
    const variants = [title, lc.toUpperCase()];
    for (const v of variants){
      const s2 = await db.collection('livestock')
        .where('propertyId','==',pid)
        .where('location','==',paddockName)
        .where('species','==',v).get();
      if(!s2.empty){ snap = s2; break; }
    }
  }

  const rows=[];
  if (snap.empty){
    const s3 = await db.collection('livestock').where('propertyId','==',pid).where('location','==',paddockName).get();
    s3.forEach(d=> rows.push({ id:d.id, ...(d.data()||{}) }));
    rows.splice(0, rows.length, ...rows.filter(r => String(r.species||'').toLowerCase()===(speciesUI||'').toLowerCase()));
  } else {
    snap.forEach(d=> rows.push({ id:d.id, ...(d.data()||{}) }));
  }
  return rows;
}

async function onPaddockOrSpeciesChange(){
  const pid = propSel.value;
  const paddockName = paddockSel.selectedOptions[0]?.dataset?.name || '';
  const act = activitySel.value;
  const speciesUI = speciesSel.value || 'Cattle';

  // build datalist for classes & also chips for Trucking/Move
  if (!pid || !paddockName){
    $('#classOptions').innerHTML = SUGGESTED_CLASSES.map(c=>`<option value="${escapeHtml(c)}"></option>`).join('');
    stockContext.innerHTML = '';
    return;
  }

  // only show context when selling/moving/stock activity
  const isStockMove = (act==='Trucking (sale)' || act==='Move stock' || act==='Chemical (stock)');
  const rows = await fetchLivestockRows(pid, paddockName, speciesUI);
  rows.sort((a,b)=> String(a.class||'').localeCompare(String(b.class||'')));

  $('#classOptions').innerHTML = rows.map(r=>`<option value="${escapeHtml(r.class||'')}"></option>`).join('');

  if (isStockMove){
    const total = rows.reduce((s,r)=> s + Number(r.count||0), 0);
    if (rows.length){
      stockContext.innerHTML = [
        `<span class="pill">In ${escapeHtml(paddockName)}: ${total} head</span>`,
        ...rows.map(r =>
          `<button type="button" class="pill" data-cls="${escapeHtml(r.class||'')}" data-head="${Number(r.count||0)}" title="Click to fill class & head">${escapeHtml(r.class||'')}: ${Number(r.count||0)}</button>`
        )
      ].join(' ');
      stockContext.querySelectorAll('.pill[data-cls]').forEach(btn=>{
        btn.onclick = ()=>{ $('#classInp').value = btn.dataset.cls||''; $('#headInp').value = btn.dataset.head||''; $('#headInp').focus(); };
      });
    } else {
      stockContext.innerHTML = `<span class="muted">No livestock rows found for ${escapeHtml(paddockName)} (${escapeHtml(speciesUI)}).</span>`;
    }
  } else {
    stockContext.innerHTML = '';
  }
}

/* -------------------------------------------------------
   Save minimal diary entry (kept simple & reliable)
------------------------------------------------------- */
async function saveEntry(){
  if (!auth.currentUser) { alert('Please sign in first.'); return; }
  const pid = propSel.value;
  const pname = NAME_BY_ID[pid] || '(Unknown)';
  const date = $('#dateInp').value || new Date().toISOString().slice(0,10);
  const time = $('#timeInp').value || '';
  const activity = $('#activitySel').value;
  const paddockName = paddockSel.selectedOptions[0]?.dataset?.name || '';
  const notes = $('#notesInp').value || '';

  const isStock = (activity==='Trucking (sale)' || activity==='Move stock' || activity==='Chemical (stock)');
  const isChem  = (activity==='Spraying paddocks' || activity==='Chemical (stock)' || activity==='Trucking (sale)');

  const species = isStock ? ($('#speciesSel').value||'') : null;
  const livestockClass = isStock ? ($('#classInp').value||'') : null;
  const headCount = isStock ? (parseInt($('#headInp').value||'0',10)||0) : null;

  const chemId   = isChem ? ($('#chemSel').value||null) : null;
  const chemQtyV = isChem ? (parseFloat($('#chemQty').value||'0')||0) : null;
  const chemUnitV= isChem ? ($('#chemUnit').value||'') : null;
  const chemName = isChem && chemId ? (chems.find(c=>c.id===chemId)?.name || null) : null;

  if (!pid) return alert('Choose a property.');
  if (!date) return alert('Choose a date.');
  if ((activity==='Trucking (sale)' || activity==='Move stock') && (!paddockName || !livestockClass || !headCount)) {
    return alert('For Trucking/Move: select paddock, class, and head.');
  }
  if ((activity==='Spraying paddocks' || activity==='Chemical (stock)') && chemId && !(chemQtyV>0)) {
    return alert('Enter a chemical quantity > 0');
  }

  const payload = {
    propertyId: pid, propertyName: pname,
    date, time, activity,
    paddock: paddockName || null,
    notes,
    species: species || null,
    livestockClass: livestockClass || null,
    headCount: headCount || null,
    spraying: (isChem && activity==='Spraying paddocks' && chemId) ? [{ chemId, chemName, qty:chemQtyV, unit:chemUnitV }] : null,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try{
    await db.collection('diaryEntries').add(payload);
    setMsg('Saved.');
    resetForm();
    await refreshEntries();
  }catch(e){
    console.error(e);
    alert('Save failed: ' + errText(e));
  }
}

function resetForm(){
  $('#dateInp').value = new Date().toISOString().slice(0,10);
  $('#timeInp').value = '';
  $('#activitySel').value = 'Ploughing';
  $('#paddockSel').value = '';
  $('#notesInp').value = '';
  $('#chemSel').value = '';
  $('#chemQty').value = '';
  $('#chemUnit').value = '';
  $('#speciesSel').value = 'Cattle';
  $('#classInp').value = '';
  $('#headInp').value = '';
  stockContext.innerHTML = '';
  onActivityChange();
}

/* -------------------------------------------------------
   Recent entries (lightweight view)
------------------------------------------------------- */
async function refreshEntries(){
  if (!auth.currentUser){ entriesTbody.innerHTML = '<tr><td colspan="6" class="muted">Sign in to load entries‚Ä¶</td></tr>'; return; }
  entriesTbody.innerHTML = '<tr><td colspan="6">Loading‚Ä¶</td></tr>';

  const y = Number($('#yearInp').value || new Date().getFullYear());
  const start = `${y}-01-01`, end = `${y}-12-31`;

  try{
    const snap = await db.collection('diaryEntries')
      .where('date','>=',start).where('date','<=',end)
      .orderBy('date','desc')
      .limit(100).get();

    const rows=[];
    snap.forEach(d=>{
      const r = { id:d.id, ...d.data() };
      rows.push(`<tr>
        <td>${escapeHtml(r.date||'')}</td>
        <td>${escapeHtml(r.propertyName||'')}</td>
        <td>${escapeHtml(r.activity||'')}</td>
        <td>${escapeHtml(r.paddock||'')}</td>
        <td>${escapeHtml(r.notes||'')}</td>
        <td class="nowrap">
          <button class="btn danger" onclick="delEntry('${r.id}')">Delete</button>
        </td>
      </tr>`);
    });
    entriesTbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="6">No entries.</td></tr>';
  }catch(e){
    console.error(e);
    entriesTbody.innerHTML = '<tr><td colspan="6">Failed to load entries.</td></tr>';
  }
}

window.delEntry = async function(id){
  if(!confirm('Delete this entry?')) return;
  try{
    await db.collection('diaryEntries').doc(id).delete();
    await refreshEntries();
    setMsg('Deleted.');
  }catch(e){
    console.error(e);
    alert('Delete failed: ' + errText(e));
  }
};

/* -------------------------------------------------------
   Bootstrap
------------------------------------------------------- */
(async function init(){
  // optional header JS if present
  try {
    if (window.SkyFarmHeader?.mount) { SkyFarmHeader.mount(); }
    if (window.SkyFarmAuth?.requireAuth) { /* we handle auth here, so ignore */ }
  } catch(e){}

  $('#yearInp').value = new Date().getFullYear();

  initUI();
  await onAuth();        // show sign-in if needed
  if (auth.currentUser){ // if already signed in (persisted), load data
    await onPropertyChange();
    await refreshEntries();
  }
})();
</script>
</body>
</html>
