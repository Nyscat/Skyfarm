<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SkyFarm â€” Diary</title>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    :root { --brand:#0B7A6E; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#f6fbf8; --warn:#9a3412; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); margin:0; color:var(--ink); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }

    /* Header */
    #sf-header { position:sticky; top:0; z-index:10; }
    #sf-header .bar { display:flex; align-items:center; gap:12px; padding:10px 14px; background:#fff; border-bottom:1px solid var(--line); }
    #sf-header .brand { display:flex; align-items:center; gap:8px; color:var(--brand); font-weight:700; text-decoration:none; }
    #sf-header nav a { color:var(--brand); text-decoration:none; font-weight:600; margin-right:10px; }
    #sf-header nav a[aria-current="page"] { text-decoration:underline; }
    .spacer { flex:1; }
    .muted { color:var(--muted); font-size:.9rem; }
    .hidden { display:none; }

    .nav-db { position:relative; }
    .nav-db button { font-size:.9rem; }
    .db-menu {
      position:absolute;
      top:100%;
      left:0;
      background:#fff;
      border:1px solid var(--line);
      border-radius:10px;
      min-width:160px;
      padding:4px 0;
      box-shadow:0 10px 25px rgba(15,23,42,.12);
      z-index:20;
    }
    .db-menu a {
      display:block;
      padding:6px 12px;
      color:var(--ink);
      text-decoration:none;
      font-size:.9rem;
    }
    .db-menu a:hover { background:#f1f5f9; }

    /* Cards / form */
    h1 { margin: 12px 0; font-size: 1.6rem; }
    .card { background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0; }
    .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; align-items:center; }
    label { font-size:.9rem; color:#475569; margin-bottom:4px; display:block; }
    input, select, button { padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; font:inherit; }
    button { cursor:pointer; }
    .btn { border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
    .primary { background:var(--brand); color:#fff; border-color:var(--brand); }
    .danger { background:#ef4444; color:#fff; border-color:#ef4444; }
    .disabled { opacity:.55; pointer-events:none; }

    .w80{width:80px}.w110{width:110px}.w140{width:140px}.w200{width:200px}.w240{width:240px}
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#e2e8f0; font-size:.8rem; margin-right:6px; border:1px solid #cbd5e1; }
    .small { font-size:.9rem; }
    .status-warn{ color:var(--warn) }

    /* Table */
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--line); padding: 8px; text-align: left; font-size: .95rem; vertical-align: top; }
    th { background:#f1f5f9; position:sticky; top:0; }
    .nowrap { white-space: nowrap; }

    /* Auth overlay */
    #authOverlay{position:fixed; inset:0; background:rgba(15,23,42,.06); display:none; align-items:center; justify-content:center; z-index:50}
    #authCard{width:min(520px,92vw); background:#fff; border:1px solid var(--line); border-radius:16px; padding:20px}
    #authCard h2{margin:0 0 10px}
  </style>
</head>
<body>
  <!-- Header -->
  <div id="sf-header">
    <div class="bar">
      <a class="brand" href="skyfarm-diary.html">ðŸŒ± SkyFarm</a>
      <nav>
        <a href="skyfarm-diary.html" aria-current="page">Diary</a>
        <a href="skyfarm-map.html">Map</a>
        <a href="skyfarm-rain.html">Rain</a>
      </nav>
      <div class="nav-db">
        <button id="dbMenuBtn" class="btn small" type="button">Database â–¾</button>
        <div id="dbMenu" class="db-menu hidden">
          <a href="skyfarm-livestock.html">Livestock</a>
          <a href="skyfarm-chemical.html">Chemicals</a>
          <a href="skyfarm-seeds.html">Seeds</a>
          <a href="skyfarm-barcode.html">Barcode Scanner</a>
          <a href="skyfarm-users.html">Users &amp; Roles</a>
        </div>
      </div>
      <span class="spacer"></span>
      <span id="authWho" class="muted">Checking sign-inâ€¦</span>
      <button id="signOutBtn" class="danger hidden">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <h1>Diary</h1>

    <!-- Main form -->
    <div class="card" id="formCard">
      <div class="row">
        <div>
          <label>Property</label>
          <select id="propSel" class="w240"></select>
        </div>
        <div>
          <label>Date</label>
          <input id="dateInp" type="date"/>
        </div>
        <div>
          <label>Time</label>
          <input id="timeInp" type="time"/>
        </div>
        <div>
          <label>Activity</label>
          <select id="activitySel" class="w240">
            <option value="Ploughing">Ploughing</option>
            <option value="Planting">Planting</option>
            <option value="Spraying paddocks">Spraying paddocks</option>
            <option value="Chemical (stock)">Chemical (stock)</option>
            <option value="Trucking (sale)">Trucking (sale)</option>
            <option value="Move stock">Move stock (Paddock â†’ Paddock/Yards)</option>
            <option value="Transfer stock (In)">Transfer stock (In)</option>
            <option value="Transfer stock (Out)">Transfer stock (Out)</option>
            <option value="Cattle Received (Purchase)">Cattle Received (Purchase)</option>
            <option value="Mustering">Mustering</option>
            <option value="Rainfall">Rainfall (gauge only)</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <span class="spacer"></span>
        <div class="muted" id="status">â€”</div>
      </div>

      <div class="row">
        <div style="min-width:260px">
          <label>Paddock</label>
          <select id="paddockSel" class="w240"><option value="">(choose)</option></select>
          <div class="small muted">Yards appear at the top.</div>
        </div>

        <div id="toPaddockRow" class="hidden" style="min-width:260px">
          <label>To paddock</label>
          <select id="toPaddockSel" class="w240"><option value="">(choose)</option></select>
        </div>

        <div id="transferPropRow" class="hidden" style="min-width:260px">
          <label>To/From Property</label>
          <select id="transferPropSel" class="w240"><option value="">(choose)</option></select>
        </div>

        <div>
          <label>Rainfall (mm to 9am)</label>
          <input id="rainMmInp" type="number" min="0" step="0.1" class="w110"/>
        </div>
        <div>
          <label>Gauge</label>
          <select id="gaugeSel" class="w200">
            <option value="">(none)</option>
          </select>
        </div>

        <div style="flex:1; min-width:260px">
          <label>Notes</label>
          <input id="notesInp" placeholder="optional"/>
        </div>
      </div>

      <!-- Stock fields -->
      <div id="stockRow" class="row hidden">
        <div>
          <label>Species</label>
          <select id="speciesSel" class="w140">
            <option value="Cattle">Cattle</option>
            <option value="Sheep">Sheep</option>
            <option value="Goats">Goats</option>
          </select>
        </div>
        <div>
          <label>Class</label>
          <input id="classInp" list="classOptions" class="w200" placeholder="e.g. Weaners"/>
          <datalist id="classOptions"></datalist>
        </div>
        <div>
          <label>Head</label>
          <input id="headInp" type="number" min="0" step="1" class="w110"/>
        </div>
        <div id="stockDetail1">
          <label>Buyer / Dest (Trucking)</label>
          <input id="truckBuyer" class="w200" placeholder="e.g. Roma"/>
        </div>
        <div id="stockDetail2">
          <label>Docket / Ref</label>
          <input id="truckRef" class="w200" placeholder="NVD / docket"/>
        </div>
      </div>

      <!-- Chemical fields -->
      <div id="chemRow" class="row hidden">
        <div>
          <label>Chemical</label>
          <select id="chemSel" class="w240"><option value="">(choose)</option></select>
        </div>
        <div>
          <label>Qty used</label>
          <input id="chemQty" type="number" min="0" step="0.01" class="w110"/>
        </div>
        <div>
          <label>Unit</label>
          <input id="chemUnit" class="w80" placeholder="KG/L" disabled/>
        </div>
        <div><label>&nbsp;</label><span id="chemHint" class="pill">context</span></div>
      </div>

      <!-- Live paddock stock context -->
      <div id="stockContext" class="row small" style="gap:6px; color:#334155;"></div>

      <!-- Mustering panel (simple) -->
      <div id="musterBox" class="card hidden" style="margin-top:8px">
        <div class="row"><strong>Mustering details</strong></div>
        <div class="row small" id="musterContext" style="gap:6px; color:#334155;"></div>

        <div class="row">
          <div>
            <label>Expected (auto)</label>
            <input id="mExp" type="number" class="w110" disabled/>
          </div>
          <div>
            <label>Actual</label>
            <input id="mAct" type="number" class="w110"/>
          </div>
          <div>
            <label>Delta (auto)</label>
            <input id="mDelta" type="number" class="w110" disabled/>
          </div>
          <div style="flex:1; min-width:260px">
            <label>Reason / notes</label>
            <input id="mReason" placeholder="e.g. moved, missed, deadâ€¦"/>
          </div>
        </div>
      </div>

      <!-- Save + multi-action -->
      <div class="row">
        <button id="saveBtn" class="primary">Save entry</button>
        <button id="resetBtn" class="btn" type="button">Reset</button>
        <span id="msg" class="muted" aria-live="polite"></span>
      </div>

      <div class="row">
        <button id="addActionBtn" class="btn">Add action</button>
        <button id="saveBatchBtn" class="primary">Save all actions</button>
        <span id="batchMsg" class="muted"></span>
      </div>

      <div id="actionsList" class="card small" style="display:none">
        <strong>Actions queued for this day</strong>
        <ol id="actionsOl" style="margin-top:6px"></ol>
      </div>
    </div>

    <!-- Recent entries -->
    <div class="card">
      <div class="row">
        <strong>Recent entries</strong>
        <span class="spacer"></span>
        <label>Year</label>
        <input id="yearInp" type="number" min="2000" max="2100" class="w110"/>
        <button id="refreshBtn" class="btn">Refresh</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Property</th><th>Activity</th><th>Paddock</th><th>Rain (mm)</th><th>Chemical</th><th>Head</th><th></th>
          </tr>
        </thead>
        <tbody id="entriesTbody"><tr><td colspan="8">Loadingâ€¦</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Auth overlay -->
  <div id="authOverlay">
    <div id="authCard">
      <h2>Sign in to SkyFarm</h2>
      <p class="small muted">Email &amp; password only. Anonymous sign-in is disabled.</p>
      <div class="row">
        <div style="flex:1; min-width:260px">
          <label>Email</label>
          <input id="siEmail" type="email" placeholder="you@example.com" autocomplete="username"/>
        </div>
        <div style="flex:1; min-width:220px">
          <label>Password</label>
          <input id="siPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
        </div>
      </div>
      <div class="row">
        <button id="signInBtn" class="primary">Sign in</button>
        <span id="authMsg" class="muted"></span>
        <span class="spacer"></span>
        <button id="closeOverlayBtn" class="btn" type="button">Close</button>
      </div>
    </div>
  </div>

<script>
/* -------------------------------------------------------
   Firebase init (compat)
------------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const db   = firebase.firestore();
const auth = firebase.auth();

/* -------------------------------------------------------
   Helpers & constants
------------------------------------------------------- */
const $ = s => document.querySelector(s);
const setMsg = (t, ms=3000)=>{ $('#msg').textContent=t||''; if(t && ms){ setTimeout(()=>$('#msg').textContent='', ms); } };
const setStatus = (t, warn=false)=>{ const el=$('#status'); el.textContent=t||''; el.classList.toggle('status-warn', !!warn); };
const escapeHtml = s => String(s ?? '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
const todayISO = () => new Date().toISOString().slice(0,10);
const yBounds = y => ({ start:`${y}-01-01`, end:`${y}-12-31` });

const PROPERTY_IDS = {
  "Consentes": "s7PlDM9wrEpxuJ6DGIab",
  "Mt Myrtle": "TRuxtRBx2zJlwZnRGYKJ",
  "Gerawin":   "P0dQ0H2FWHeqqxejflZs"
};
const PROPERTY_NAME_BY_ID = Object.fromEntries(Object.entries(PROPERTY_IDS).map(([n,i])=>[i,n]));
const SUGGESTED_CLASSES = ["Cows","Heifers","Bulls","Steers","PTIC cows","Joined cows","Calves","Weaners"];

/* -------------------------------------------------------
   Elements
------------------------------------------------------- */
const propSel = $('#propSel'), dateInp = $('#dateInp'), timeInp = $('#timeInp'), activitySel = $('#activitySel');
const paddockSel = $('#paddockSel'), toPaddockRow = $('#toPaddockRow'), toPaddockSel = $('#toPaddockSel'), notesInp = $('#notesInp');
const rainMmInp = $('#rainMmInp'), gaugeSel = $('#gaugeSel');
const transferPropRow = $('#transferPropRow'), transferPropSel = $('#transferPropSel');
const speciesSel = $('#speciesSel'), classInp = $('#classInp'), headInp = $('#headInp'), truckBuyer=$('#truckBuyer'), truckRef=$('#truckRef');
const chemRow = $('#chemRow'), chemSel = $('#chemSel'), chemQty = $('#chemQty'), chemUnit = $('#chemUnit'), chemHint = $('#chemHint');
const stockRow = $('#stockRow'), stockDetail1 = $('#stockDetail1'), stockDetail2 = $('#stockDetail2');
const stockContext = $('#stockContext');
const musterBox = $('#musterBox'), mExp=$('#mExp'), mAct=$('#mAct'), mDelta=$('#mDelta'), mReason=$('#mReason'), musterContext=$('#musterContext');
const yearInp = $('#yearInp'), refreshBtn = $('#refreshBtn'), entriesTbody = $('#entriesTbody');

const addActionBtn = $('#addActionBtn'), saveBatchBtn = $('#saveBatchBtn'), actionsListEl = $('#actionsList'), actionsOl = $('#actionsOl'), batchMsg = $('#batchMsg');

const authOverlay = $('#authOverlay'), authWho = $('#authWho'), signOutBtn = $('#signOutBtn');
const signInBtn = $('#signInBtn'), closeOverlayBtn = $('#closeOverlayBtn');

const dbMenuBtn = $('#dbMenuBtn'), dbMenu = $('#dbMenu');

/* -------------------------------------------------------
   Auth overlay helpers
------------------------------------------------------- */
function showOverlay(show){ authOverlay.style.display = show ? 'flex' : 'none'; }

signInBtn.onclick = async ()=>{
  const email = $('#siEmail').value.trim();
  const pass  = $('#siPass').value;
  $('#authMsg').textContent = 'Signing inâ€¦';
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithEmailAndPassword(email, pass);
    $('#authMsg').textContent = 'Signed in.';
    showOverlay(false);
    await initAfterAuth();
  }catch(e){
    $('#authMsg').textContent = 'Sign-in failed: ' + (e?.message || e?.code || 'Unknown');
  }
};
signOutBtn.onclick = async ()=>{ try{ await auth.signOut(); location.reload(); }catch(e){} };
closeOverlayBtn.onclick = ()=> showOverlay(false);

if (dbMenuBtn && dbMenu) {
  dbMenuBtn.onclick = (e)=>{
    e.stopPropagation();
    dbMenu.classList.toggle('hidden');
  };
  document.addEventListener('click', (e)=>{
    if (!dbMenu.contains(e.target) && e.target !== dbMenuBtn) {
      dbMenu.classList.add('hidden');
    }
  });
}

/* -------------------------------------------------------
   Paddocks / Chemicals / Gauges / Livestock helpers
------------------------------------------------------- */
async function loadPaddocksForProperty(propertyId) {
  if (!propertyId || propertyId === 'ALL') {
    paddockSel.innerHTML = '<option value="">(choose a property)</option>';
    toPaddockSel.innerHTML = '<option value="">(choose a property)</option>';
    return;
  }
  paddockSel.innerHTML = '<option value="">(loadingâ€¦)</option>';
  toPaddockSel.innerHTML = '<option value="">(loadingâ€¦)</option>';

  try {
    const snap = await db.collection('paddocks').where('propertyId','==',propertyId).get();
    const rows = [];
    snap.forEach(d => rows.push({ id:d.id, ...(d.data()||{}) }));

    rows.sort((a,b) => {
      const ya = !!a.isYards, yb = !!b.isYards;
      if (ya !== yb) return ya ? -1 : 1;
      return String(a.name||'').localeCompare(String(b.name||''));
    });

    if (!rows.length) {
      paddockSel.innerHTML = '<option value="">(no paddocks found)</option>';
      toPaddockSel.innerHTML = '<option value="">(no paddocks found)</option>';
      return;
    }

    const optionsHtml =
      '<option value="">(choose)</option>' +
      rows.map(p => `<option value="${p.id}" data-name="${escapeHtml(p.name||'')}">${escapeHtml(p.name||'(unnamed)')}${p.isYards?' â€” Yards':''}</option>`).join('');

    paddockSel.innerHTML = optionsHtml;
    toPaddockSel.innerHTML = optionsHtml;
  } catch (e) {
    console.error('Paddock load error:', e);
    paddockSel.innerHTML = '<option value="">(load error)</option>';
    toPaddockSel.innerHTML = '<option value="">(load error)</option>';
  }
}

async function loadChemicalsForProperty(propertyId){
  chemSel.innerHTML = '<option value="">(loadingâ€¦)</option>';
  if (!propertyId || propertyId === 'ALL'){ chemSel.innerHTML='<option value="">(choose property)</option>'; return; }
  try{
    const snap = await db.collection('chemicals').where('propertyId','==',propertyId).get();
    const rows=[]; snap.forEach(d=> rows.push({id:d.id, ...(d.data()||{})}));
    rows.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));
    chemSel.innerHTML = '<option value="">(choose)</option>' + rows.map(c => {
      return `<option value="${c.id}" data-unit="${escapeHtml(c.unit||'')}">${escapeHtml(c.name||'Unnamed')} (${escapeHtml(c.unit||'')}) â€” ${Number(c.quantity||0)} left</option>`;
    }).join('');
    chemSel.onchange = ()=> chemUnit.value = chemSel.selectedOptions[0]?.dataset?.unit || '';
    chemUnit.value = chemSel.selectedOptions[0]?.dataset?.unit || '';
  }catch(e){
    console.error('Chem load error:', e);
    chemSel.innerHTML='<option value="">(load error)</option>';
  }
}

async function loadGaugesForProperty(propertyId){
  gaugeSel.innerHTML = '<option value="">(none)</option>';
  if (!propertyId || propertyId === 'ALL') {
    gaugeSel.innerHTML = '<option value="">(choose property)</option>';
    return;
  }
  try{
    const snap = await db.collection('gauges').where('propertyId','==',propertyId).where('active','==',true).get();
    const rows=[]; snap.forEach(d=> rows.push({id:d.id, ...(d.data()||{})}));
    rows.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));
    gaugeSel.innerHTML = '<option value="">(none)</option>' +
      rows.map(g=>`<option value="${g.id}">${escapeHtml(g.name||'(unnamed)')}</option>`).join('');
  }catch(e){
    console.error('Gauge load error:', e);
    gaugeSel.innerHTML = '<option value="">(load error)</option>';
  }
}

async function fetchLivestockClasses(propertyId, paddockName, speciesUI){
  if (!propertyId || !paddockName) return [];
  const speciesLC = String(speciesUI||'Cattle').toLowerCase();

  let snap = await db.collection('livestock')
    .where('propertyId','==',propertyId)
    .where('location','==',paddockName)
    .where('species','==',speciesUI)
    .get();

  if (snap.empty){
    const title = speciesLC.charAt(0).toUpperCase() + speciesLC.slice(1);
    for (const sp of [title, speciesLC.toUpperCase()]){
      const s2 = await db.collection('livestock')
        .where('propertyId','==',propertyId)
        .where('location','==',paddockName)
        .where('species','==',sp)
        .get();
      if (!s2.empty){ snap = s2; break; }
    }
  }

  const rows=[];
  if (snap.empty){
    const s3 = await db.collection('livestock')
      .where('propertyId','==',propertyId)
      .where('location','==',paddockName)
      .get();
    s3.forEach(d => rows.push({ id:d.id, ...(d.data()||{}) }));
    return rows.filter(r => String(r.species||'').toLowerCase() === speciesLC);
  } else {
    snap.forEach(d => rows.push({ id:d.id, ...(d.data()||{}) }));
    return rows;
  }
}

async function fetchUsedClasses(propertyId, speciesUI){
  if (!propertyId) return [];
  const speciesLC = String(speciesUI||'Cattle').toLowerCase();
  const variants = [speciesUI, speciesLC.toUpperCase(), speciesLC.charAt(0).toUpperCase()+speciesLC.slice(1)];
  const seen = new Set();

  for (const sp of variants){
    const snap = await db.collection('livestock')
      .where('propertyId','==',propertyId)
      .where('species','==',sp)
      .get();
    snap.forEach(d => {
      const cls = (d.data()||{}).class;
      if (cls) seen.add(String(cls));
    });
  }

  const list = Array.from(seen).filter(Boolean).sort((a,b)=>a.localeCompare(b));
  return list;
}

/* -------------------------------------------------------
   Inventory side-effects
------------------------------------------------------- */
async function applyChemicalUsage({ activity, propertyId, chemId, chemQty }) {
  if (!chemId || !chemQty || chemQty <= 0) return;
  const affectsChem =
    activity === 'Spraying paddocks' ||
    activity === 'Chemical (stock)' ||
    activity === 'Trucking (sale)';
  if (!affectsChem) return;

  const ref = db.collection('chemicals').doc(chemId);
  try {
    await db.runTransaction(async tx => {
      const snap = await tx.get(ref);
      if (!snap.exists) return;
      const data = snap.data() || {};
      const current = Number(data.quantity || 0);
      const next = Math.max(0, current - Number(chemQty));
      tx.update(ref, {
        quantity: next,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
  } catch (e) {
    console.error('Chemical update failed', e);
  }
}

// generic livestock adjuster
async function adjustLivestockLine({ propertyId, paddockName, species, livestockClass, delta }) {
  if (!propertyId || !paddockName || !species || !livestockClass) return;
  if (!delta || !Number.isFinite(delta)) return;

  const headInt = Math.floor(Math.abs(delta));
  if (!headInt) return;

  const speciesVariants = [
    species,
    String(species).toLowerCase(),
    String(species).toUpperCase(),
    String(species).charAt(0).toUpperCase()+String(species).slice(1).toLowerCase()
  ];

  try {
    let docToUpdate = null;
    for (const sp of speciesVariants) {
      const snap = await db.collection('livestock')
        .where('propertyId','==',propertyId)
        .where('location','==',paddockName)
        .where('species','==',sp)
        .where('class','==',livestockClass)
        .limit(1)
        .get();
      if (!snap.empty) { docToUpdate = snap.docs[0]; break; }
    }

    if (docToUpdate) {
      await db.runTransaction(async tx => {
        const snap = await tx.get(docToUpdate.ref);
        if (!snap.exists) return;
        const data = snap.data() || {};
        const current = Number(data.count || 0);
        const next = current + delta;
        tx.set(docToUpdate.ref, {
          ...data,
          count: Math.max(0, next),
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      });
    } else if (delta > 0) {
      await db.collection('livestock').add({
        propertyId,
        location: paddockName,
        species,
        class: livestockClass,
        count: headInt,
        movedIn: todayISO(),
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      console.warn('No livestock line found to subtract from', {
        propertyId,
        paddockName,
        species,
        livestockClass
      });
    }
  } catch (e) {
    console.error('adjustLivestockLine failed', e);
  }
}

async function findYardNameForProperty(propertyId) {
  if (!propertyId) return null;
  try {
    const snap = await db.collection('paddocks')
      .where('propertyId','==',propertyId)
      .where('isYards','==',true)
      .orderBy('name')
      .limit(1)
      .get();
    if (snap.empty) return null;
    const d = snap.docs[0].data() || {};
    return d.name || '(unnamed)';
  } catch (e) {
    console.error('findYardNameForProperty failed', e);
    return null;
  }
}

async function applyLivestockChange({
  activity,
  propertyId,
  paddockName,
  species,
  livestockClass,
  head,
  transferPropertyId
}) {
  if (!propertyId || !species || !livestockClass || !head || head <= 0) return;

  let delta = 0;

  if (activity === 'Trucking (sale)') {
    delta = -Math.abs(head);
  } else if (activity === 'Cattle Received (Purchase)') {
    delta = Math.abs(head);
  } else if (activity === 'Transfer stock (Out)') {
    delta = -Math.abs(head);
  } else if (activity === 'Transfer stock (In)') {
    delta = Math.abs(head);
  } else {
    return;
  }

  // adjust current property / paddock
  if (paddockName) {
    await adjustLivestockLine({
      propertyId,
      paddockName,
      species,
      livestockClass,
      delta
    });
  }

  // cross-property transfer: add to yards on destination property
  if (activity === 'Transfer stock (Out)' && transferPropertyId) {
    const yardName = await findYardNameForProperty(transferPropertyId);
    if (!yardName) {
      console.warn('No yard paddock found on destination property for transfer', { transferPropertyId });
      return;
    }
    await adjustLivestockLine({
      propertyId: transferPropertyId,
      paddockName: yardName,
      species,
      livestockClass,
      delta: Math.abs(head)
    });
  }
}

async function moveLivestockWithinProperty({
  propertyId,
  fromPaddock,
  toPaddock,
  species,
  livestockClass,
  head
}) {
  if (!propertyId || !fromPaddock || !toPaddock) return;
  if (fromPaddock === toPaddock) return;
  if (!species || !livestockClass || !head || head <= 0) return;

  const headInt = Math.floor(Number(head));
  const speciesVariants = [
    species,
    String(species).toLowerCase(),
    String(species).toUpperCase(),
    String(species).charAt(0).toUpperCase() + String(species).slice(1).toLowerCase()
  ];

  try {
    let fromDoc = null;
    for (const sp of speciesVariants) {
      const snap = await db.collection('livestock')
        .where('propertyId','==',propertyId)
        .where('location','==',fromPaddock)
        .where('species','==',sp)
        .where('class','==',livestockClass)
        .limit(1)
        .get();
      if (!snap.empty) { fromDoc = snap.docs[0]; break; }
    }

    if (fromDoc) {
      await db.runTransaction(async tx => {
        const snap = await tx.get(fromDoc.ref);
        if (!snap.exists) return;
        const data = snap.data() || {};
        const current = Number(data.count || 0);
        const next = Math.max(0, current - headInt);
        tx.update(fromDoc.ref, {
          count: next,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
    } else {
      console.warn('Move stock: no FROM mob line', { propertyId, fromPaddock, species, livestockClass });
    }

    let toDoc = null;
    for (const sp of speciesVariants) {
      const snap = await db.collection('livestock')
        .where('propertyId','==',propertyId)
        .where('location','==',toPaddock)
        .where('species','==',sp)
        .where('class','==',livestockClass)
        .limit(1)
        .get();
      if (!snap.empty) { toDoc = snap.docs[0]; break; }
    }

    if (toDoc) {
      await db.runTransaction(async tx => {
        const snap = await tx.get(toDoc.ref);
        if (!snap.exists) return;
        const data = snap.data() || {};
        const current = Number(data.count || 0);
        const next = current + headInt;
        tx.update(toDoc.ref, {
          count: next,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
    } else {
      await db.collection('livestock').add({
        propertyId,
        location: toPaddock,
        species,
        class: livestockClass,
        count: headInt,
        movedIn: todayISO(),
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  } catch (e) {
    console.error('Move stock inventory update failed', e);
  }
}

// rainfall mirror -> gauges/{gaugeId}/daily/{dateISO}
async function applyRainfallEntry({ gaugeId, rainfallMm, dateISO }) {
  if (!gaugeId || !rainfallMm || rainfallMm <= 0 || !dateISO) return;
  try {
    const ref = db.collection('gauges').doc(gaugeId)
      .collection('daily').doc(dateISO);
    await ref.set({
      date: dateISO,
      total: Number(rainfallMm),
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
  } catch(e) {
    console.error('applyRainfallEntry failed', e);
  }
}

/* -------------------------------------------------------
   UI logic
------------------------------------------------------- */
function onActivityChange(){
  const act = activitySel.value;

  const needsChem = (act==='Spraying paddocks' || act==='Chemical (stock)' || act==='Trucking (sale)');
  chemRow.classList.toggle('hidden', !needsChem);
  chemHint.textContent = (act==='Spraying paddocks') ? 'paddock spray'
                     : (act==='Trucking (sale)' ? 'backline before transport' : 'stock treatment');

  const needsStock = (act==='Trucking (sale)' || act==='Move stock' || act==='Chemical (stock)' || act==='Mustering' || act==='Cattle Received (Purchase)' || act.startsWith('Transfer stock'));
  stockRow.classList.toggle('hidden', !needsStock);

  const needsTransferProp = (act==='Transfer stock (In)' || act==='Transfer stock (Out)');
  transferPropRow.classList.toggle('hidden', !needsTransferProp);

  const needsToPaddock = (act === 'Move stock');
  toPaddockRow.classList.toggle('hidden', !needsToPaddock);

  const needsTruckDetails = (act==='Trucking (sale)' || act==='Cattle Received (Purchase)');
  stockDetail1.classList.toggle('hidden', !needsTruckDetails);
  stockDetail2.classList.toggle('hidden', !needsTruckDetails);

  const needsMuster = (act === 'Mustering');
  musterBox.classList.toggle('hidden', !needsMuster);
}

async function refreshStockContext(){
  const propertyId = propSel.value;
  const paddockOpt = paddockSel.selectedOptions[0];
  const paddockName = paddockOpt?.dataset?.name || '';
  if (!propertyId || !paddockName) {
    stockContext.innerHTML = '';
    musterContext.textContent = '';
    mExp.value = '';
    mAct.value = '';
    mDelta.value = '';
    return;
  }

  try {
    const snap = await db.collection('livestock')
      .where('propertyId','==',propertyId)
      .where('location','==',paddockName)
      .get();
    const rows=[];
    snap.forEach(d => rows.push(d.data()||{}));
    if (!rows.length){
      stockContext.innerHTML = '<span class="muted small">No livestock recorded in this paddock.</span>';
    } else {
      stockContext.innerHTML = rows.map(r=>(
        `<span class="pill">${escapeHtml(r.species||'Cattle')} â€” ${escapeHtml(r.class||'Unknown')} : ${Number(r.count||0)}</span>`
      )).join('');
    }

    const species = speciesSel.value || 'Cattle';
    const expectedTotal = rows
      .filter(r => String(r.species||'').toLowerCase() === String(species).toLowerCase())
      .reduce((sum,r)=> sum + Number(r.count||0), 0);
    if (expectedTotal){
      mExp.value = expectedTotal;
      mAct.value = '';
      mDelta.value = '';
      musterContext.textContent = `${species} in ${paddockName}: expected ${expectedTotal} head.`;
    } else {
      mExp.value = '';
      mAct.value = '';
      mDelta.value = '';
      musterContext.textContent = '';
    }
  } catch(e){
    console.error('refreshStockContext failed', e);
    stockContext.innerHTML = '<span class="muted small">Error loading stock.</span>';
  }
}

mAct.addEventListener('input', ()=>{
  const exp = Number(mExp.value||0);
  const act = Number(mAct.value||0);
  if (exp || act){
    mDelta.value = act - exp;
  } else {
    mDelta.value = '';
  }
});

async function onPropertyChange(){
  const propertyId = propSel.value;
  await Promise.all([
    loadPaddocksForProperty(propertyId),
    loadChemicalsForProperty(propertyId),
    loadGaugesForProperty(propertyId)
  ]);
  await refreshStockContext();

  // populate transfer property dropdown (other properties)
  const options = Object.entries(PROPERTY_IDS).map(([name,id])=>{
    if (id === propertyId) return '';
    return `<option value="${id}">${escapeHtml(name)}</option>`;
  }).join('');
  transferPropSel.innerHTML = '<option value="">(choose)</option>' + options;
}

paddockSel.addEventListener('change', async ()=>{
  await refreshStockContext();
  await refreshClassOptions();
});
speciesSel.addEventListener('change', async ()=>{
  await refreshClassOptions();
  await refreshStockContext();
});
activitySel.addEventListener('change', onActivityChange);

async function refreshClassOptions(){
  const propertyId = propSel.value;
  const paddockOpt = paddockSel.selectedOptions[0];
  const paddockName = paddockOpt?.dataset?.name || '';
  const species = speciesSel.value || 'Cattle';

  const classes = new Set(SUGGESTED_CLASSES);
  try{
    const usedGlobal = await fetchUsedClasses(propertyId, species);
    usedGlobal.forEach(c=>classes.add(c));
    const usedHere  = await fetchLivestockClasses(propertyId, paddockName, species);
    usedHere.forEach(r => { if (r.class) classes.add(String(r.class)); });
  }catch(e){
    console.warn('refreshClassOptions skipped', e);
  }
  const list = Array.from(classes).filter(Boolean).sort((a,b)=>a.localeCompare(b));
  const dl = $('#classOptions');
  dl.innerHTML = list.map(c=>`<option value="${escapeHtml(c)}"></option>`).join('');
}

/* -------------------------------------------------------
   Build payload
------------------------------------------------------- */
function buildPayloadFromUI(){
  const propertyId = propSel.value;
  const propertyName = PROPERTY_NAME_BY_ID[propertyId] || '(unknown)';
  const activity = activitySel.value;
  const date = dateInp.value || todayISO();
  const time = timeInp.value || '00:00';

  const paddockOpt = paddockSel.selectedOptions[0];
  const paddockId  = paddockOpt?.value || '';
  const paddockName = paddockOpt?.dataset?.name || '';

  const toPaddockOpt = toPaddockSel.selectedOptions[0];
  const toPaddockId  = toPaddockOpt?.value || '';
  const toPaddockName = toPaddockOpt?.dataset?.name || '';

  const transferPropertyId = transferPropSel.value || '';
  const transferPropertyName = PROPERTY_NAME_BY_ID[transferPropertyId] || '';

  const species = speciesSel.value || null;
  const klass   = classInp.value || null;
  const head    = headInp.value ? Number(headInp.value) : null;

  const rainMm = rainMmInp.value ? Number(rainMmInp.value) : null;
  const gaugeId = gaugeSel.value || null;
  const gaugeName = gaugeSel.selectedOptions[0]?.textContent || null;

  const chemId = chemSel.value || null;
  const chemUnitVal = chemUnit.value || null;
  const chemQ = chemQty.value ? Number(chemQty.value) : null;

  const notes = notesInp.value || '';

  const payload = {
    date,
    time,
    propertyId,
    propertyName,
    activity,
    paddockId: paddockId || null,
    paddock: paddockName || null,
    toPaddockId: toPaddockId || null,
    toPaddock: toPaddockName || null,

    transferPropertyId: transferPropertyId || null,
    transferPropertyName: transferPropertyName || null,

    species: species || null,
    livestockClass: klass || null,
    headCount: head || null,

    chemicalId: chemId || null,
    chemicalUnit: chemUnitVal,
    chemicalQty: chemQ || null,

    rainfallMm: (rainMm != null && isFinite(rainMm) && rainMm>0) ? rainMm : null,
    gaugeId: gaugeId || null,
    gaugeName: gaugeName || null,

    buyer: truckBuyer.value || null,
    truckRef: truckRef.value || null,

    musterExpected: mExp.value || null,
    musterActual: mAct.value || null,
    musterDelta: mDelta.value || null,
    musterReason: mReason.value || null,

    notes: notes || null,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  return {
    payload,
    propertyId,
    activity,
    paddockName,
    paddockNameTo: toPaddockName,
    species,
    klass,
    head,
    chemId,
    chemQ,
    transferPropertyId,
    gaugeId,
    rainfallMm: payload.rainfallMm,
    dateISO: date
  };
}

/* -------------------------------------------------------
   Save single entry
------------------------------------------------------- */
async function saveEntry(){
  if (propSel.value==='ALL' || !propSel.value) return alert('Select a specific property to save.');

  const {
    payload,
    propertyId,
    activity,
    paddockName,
    paddockNameTo,
    species,
    klass,
    head,
    chemId,
    chemQ,
    transferPropertyId,
    gaugeId,
    rainfallMm,
    dateISO
  } = buildPayloadFromUI();

  if (activity === 'Move stock') {
    if (!paddockName) return alert('Choose the paddock you are moving FROM.');
    if (!paddockNameTo) return alert('Choose the paddock you are moving TO.');
    if (!klass || !head || head <= 0) return alert('For Move stock you must set Class and Head.');
  }
  if (activity.startsWith('Transfer stock')) {
    if (!paddockName) return alert('Choose the paddock the cattle are leaving/entering.');
    if (!transferPropertyId) return alert('Choose the other property for Transfer stock.');
    if (!klass || !head || head <= 0) return alert('For Transfer stock you must set Class and Head.');
  }

  try {
    await db.collection('diaryEntries').add(payload);

    const sideEffects = [
      applyChemicalUsage({
        activity,
        propertyId,
        chemId,
        chemQty: chemQ
      }),
      applyLivestockChange({
        activity,
        propertyId,
        paddockName,
        species,
        livestockClass: klass,
        head,
        transferPropertyId
      }),
      applyRainfallEntry({
        gaugeId,
        rainfallMm,
        dateISO
      })
    ];

    if (activity === 'Move stock') {
      sideEffects.push(
        moveLivestockWithinProperty({
          propertyId,
          fromPaddock: paddockName,
          toPaddock: paddockNameTo,
          species,
          livestockClass: klass,
          head
        })
      );
    }

    await Promise.all(sideEffects);

    setMsg('Saved');
    await refreshEntries();
  } catch(e){
    console.error(e);
    setMsg('Save failed', 3000);
  }
}

/* -------------------------------------------------------
   Multi-action batch
------------------------------------------------------- */
const actions = [];
function renderQueued(){
  actionsListEl.style.display = actions.length ? 'block' : 'none';
  actionsOl.innerHTML = actions.map((a,i)=>(
    `<li><span class="pill">${escapeHtml(a.activity)}</span> ${escapeHtml(a.propertyName)} â€” ${escapeHtml(a.paddock||'(no paddock)')}${a.notes? ' â€” ' + escapeHtml(a.notes) : ''} <button data-i="${i}" class="btn">Remove</button></li>`
  )).join('');
  actionsOl.querySelectorAll('button[data-i]').forEach(b=>{
    b.onclick = () => { actions.splice(Number(b.dataset.i),1); renderQueued(); };
  });
}
function currentActionFromUI(){
  const {
    payload,
    propertyId,
    activity,
    paddockName,
    paddockNameTo,
    species,
    klass,
    head,
    chemId,
    chemQ,
    transferPropertyId,
    gaugeId,
    rainfallMm,
    dateISO
  } = buildPayloadFromUI();
  return {
    ...payload,
    payload,
    propertyId,
    activity,
    paddock: payload.paddock,
    toPaddockId: payload.toPaddockId,
    toPaddock: payload.toPaddock,
    transferPropertyId,
    species,
    livestockClass: klass,
    headCount: payload.headCount,
    chemicalId: chemId,
    chemicalName: null,
    chemQty: chemQ,
    chemUnit: payload.chemicalUnit,
    gaugeId,
    rainfallMm,
    dateISO
  };
}
addActionBtn.onclick = ()=>{
  if (propSel.value==='ALL' || !propSel.value) { alert('Choose a specific property'); return; }
  const a = currentActionFromUI();
  actions.push(a);
  renderQueued();
  batchMsg.textContent = 'Action added.'; setTimeout(()=>batchMsg.textContent='', 1500);
};
saveBatchBtn.onclick = async ()=>{
  if (!actions.length) { alert('No actions queued. Click â€œAdd actionâ€ first.'); return; }
  const batchId = 'b_'+Date.now();
  batchMsg.textContent = 'Savingâ€¦';
  try{
    const batch = db.batch();
    actions.forEach((a, idx)=>{
      const ref = db.collection('diaryEntries').doc();
      batch.set(ref, { ...a, batchId, batchIndex: idx, createdAt: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    });
    await batch.commit();

    await Promise.all(actions.map(a => {
      const sideEffects = [
        applyChemicalUsage({
          activity: a.activity,
          propertyId: a.propertyId,
          chemId: a.chemicalId,
          chemQty: a.chemQty
        }),
        applyLivestockChange({
          activity: a.activity,
          propertyId: a.propertyId,
          paddockName: a.paddock,
          species: a.species,
          livestockClass: a.livestockClass,
          head: a.headCount,
          transferPropertyId: a.transferPropertyId
        }),
        applyRainfallEntry({
          gaugeId: a.gaugeId,
          rainfallMm: a.rainfallMm,
          dateISO: a.date || a.dateISO
        })
      ];
      if (a.activity === 'Move stock') {
        sideEffects.push(
          moveLivestockWithinProperty({
            propertyId: a.propertyId,
            fromPaddock: a.paddock,
            toPaddock: a.toPaddock,
            species: a.species,
            livestockClass: a.livestockClass,
            head: a.headCount
          })
        );
      }
      return Promise.all(sideEffects);
    }));

    batchMsg.textContent = 'Batch saved.';
    actions.length = 0;
    renderQueued();
    await refreshEntries();
  } catch(e){
    console.error(e);
    batchMsg.textContent = 'Batch save failed.';
  }
};

/* -------------------------------------------------------
   Recent entries list
------------------------------------------------------- */
async function refreshEntries(){
  const y = yearInp.value ? Number(yearInp.value) : (new Date().getFullYear());
  yearInp.value = y;
  const { start, end } = yBounds(y);

  entriesTbody.innerHTML = '<tr><td colspan="8">Loadingâ€¦</td></tr>';
  try{
    const snap = await db.collection('diaryEntries')
      .where('date','>=',start)
      .where('date','<=',end)
      .orderBy('date','desc')
      .orderBy('time','desc')
      .limit(200)
      .get();
    if (snap.empty){
      entriesTbody.innerHTML = '<tr><td colspan="8">No entries for this year.</td></tr>';
      return;
    }
    const rows=[];
    snap.forEach(d => rows.push({id:d.id, ...(d.data()||{})}));
    entriesTbody.innerHTML = rows.map(r=>{
      const dt = `${escapeHtml(r.date||'')} ${escapeHtml(r.time||'')}`;
      const prop = escapeHtml(r.propertyName || PROPERTY_NAME_BY_ID[r.propertyId] || '');
      const act = escapeHtml(r.activity||'');
      const pad = escapeHtml(r.paddock||'');
      const rain = r.rainfallMm != null ? Number(r.rainfallMm).toFixed(1) : '';
      const chem = r.chemicalId ? `${escapeHtml(r.chemicalId)} (${r.chemicalQty||''} ${r.chemicalUnit||''})` : '';
      const head = r.headCount != null ? Number(r.headCount) : '';
      return `<tr>
        <td class="nowrap">${dt}</td>
        <td>${prop}</td>
        <td>${act}</td>
        <td>${pad}</td>
        <td>${rain}</td>
        <td>${chem}</td>
        <td>${head}</td>
        <td></td>
      </tr>`;
    }).join('');
  }catch(e){
    console.error('refreshEntries failed', e);
    entriesTbody.innerHTML = '<tr><td colspan="8">Error loading entries.</td></tr>';
  }
}

/* -------------------------------------------------------
   Init
------------------------------------------------------- */
async function initAfterAuth(){
  const user = auth.currentUser;
  if (!user){
    authWho.textContent = 'Not signed in';
    showOverlay(true);
    return;
  }
  authWho.textContent = user.email || 'Signed in';
  signOutBtn.classList.remove('hidden');

  // Properties from constant map
  const opts = Object.entries(PROPERTY_IDS)
    .map(([name,id])=>`<option value="${id}">${escapeHtml(name)}</option>`)
    .join('');
  propSel.innerHTML = '<option value="ALL">(All properties)</option>' + opts;

  dateInp.value = todayISO();
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  timeInp.value = `${hh}:${mm}`;

  yearInp.value = now.getFullYear();

  propSel.onchange = onPropertyChange;
  refreshBtn.onclick = refreshEntries;
  $('#saveBtn').onclick = saveEntry;
  $('#resetBtn').onclick = ()=>{
    notesInp.value = '';
    headInp.value = '';
    classInp.value = '';
    rainMmInp.value = '';
    gaugeSel.selectedIndex = 0;
    truckBuyer.value = '';
    truckRef.value = '';
    mExp.value = '';
    mAct.value = '';
    mDelta.value = '';
    mReason.value = '';
  };

  await onPropertyChange();
  onActivityChange();
  await refreshEntries();
}

// auth state
auth.onAuthStateChanged(async user=>{
  if (!user){
    authWho.textContent = 'Not signed in';
    showOverlay(true);
  } else {
    authWho.textContent = user.email || 'Signed in';
    signOutBtn.classList.remove('hidden');
    showOverlay(false);
    await initAfterAuth();
  }
});
</script>
</body>
</html>
