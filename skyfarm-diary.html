<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SkyFarm — Diary</title>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    :root { --brand:#0B7A6E; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#f6fbf8; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); margin:0; color:var(--ink); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { margin: 12px 0; font-size: 1.6rem; }

    /* Header */
    #sf-header { position:sticky; top:0; z-index:10; }
    #sf-header .bar { display:flex; align-items:center; gap:12px; padding:10px 14px; background:#fff; border-bottom:1px solid var(--line); }
    #sf-header .brand { display:flex; align-items:center; gap:10px; color:var(--brand); font-weight:700; text-decoration:none; }
    #sf-header nav a { color:var(--brand); text-decoration:none; font-weight:600; margin-right:10px; }
    #sf-header nav a[aria-current="page"] { text-decoration:underline; }
    .spacer { flex:1; }
    .muted { color:var(--muted); font-size:.9rem; }
    .hidden { display:none; }

    /* Cards / Controls */
    .card { background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0; }
    .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; align-items:center; }
    label { font-size:.9rem; color:#475569; margin-bottom:4px; display:block; }
    input, select, button { padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; font:inherit; }
    button { cursor:pointer; }
    .btn { border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
    .primary { background:var(--brand); color:#fff; border-color:var(--brand); }
    .danger { background:#ef4444; color:#fff; border-color:#ef4444; }
    .disabled { opacity:.55; pointer-events:none; }

    .w80{width:80px} .w110{width:110px} .w140{width:140px} .w200{width:200px} .w240{width:240px}

    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid var(--line); padding:8px; text-align:left; font-size:.95rem; }
    th { background:#f1f5f9; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#e2e8f0; font-size:.8rem; margin-right:6px; border:1px solid #cbd5e1; }
    .small { font-size:.9rem; }

    /* Auth overlay */
    #authOverlay{position:fixed; inset:0; background:rgba(15,23,42,.08); display:none; align-items:center; justify-content:center; z-index:50}
    #authCard{width:min(520px,92vw); background:#fff; border:1px solid var(--line); border-radius:16px; padding:20px}
  </style>
</head>
<body>

<!-- Header -->
<div id="sf-header">
  <div class="bar">
    <a class="brand" href="#">🌱 SkyFarm</a>
    <nav>
      <a href="skyfarm-diary.html" aria-current="page">Diary</a>
      <a href="skyfarm-map.html">Map</a>
      <a href="skyfarm-chemical.html">Chemicals</a>
    </nav>
    <span class="spacer"></span>
    <span id="authWho" class="muted">Checking sign-in…</span>
    <button id="signOutBtn" class="danger hidden">Sign out</button>
  </div>
</div>

<div class="wrap">
  <h1>Diary</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Property</label>
        <select id="propSel" class="w240"></select>
      </div>
      <div>
        <label>Date</label>
        <input id="dateInp" type="date"/>
      </div>
      <div>
        <label>Time</label>
        <input id="timeInp" type="time"/>
      </div>
      <div>
        <label>Activity</label>
        <select id="activitySel" class="w240">
          <option>Ploughing</option>
          <option>Planting</option>
          <option>Spraying paddocks</option>
          <option>Mustering</option>
          <option>Move stock</option>
          <option>Trucking (sale)</option>
          <option>Other</option>
        </select>
      </div>
      <span class="spacer"></span>
      <div class="muted" id="status">—</div>
    </div>

    <div class="row">
      <div style="min-width:260px">
        <label>Paddock</label>
        <select id="paddockSel" class="w240"><option value="">(choose)</option></select>
        <div class="small muted"><em>Yards</em> paddocks appear first.</div>
      </div>
      <div style="flex:1; min-width:260px">
        <label>Notes</label>
        <input id="notesInp" placeholder="optional"/>
      </div>
    </div>

    <!-- Mustering UI -->
    <div id="musterBox" class="card hidden" style="margin-top:8px">
      <div class="row"><strong>Mustering details</strong></div>

      <div class="row">
        <div>
          <label>Species</label>
          <select id="speciesSel">
            <option value="Cattle">Cattle</option>
            <option value="Sheep">Sheep</option>
            <option value="Goats">Goats</option>
          </select>
        </div>
        <div>
          <label>Expected total (auto)</label>
          <input id="mExp" class="w110" disabled/>
        </div>
        <div>
          <label>Actual</label>
          <input id="mAct" class="w110" type="number" min="0"/>
        </div>
        <div>
          <label>Delta (auto)</label>
          <input id="mDelta" class="w110" disabled/>
        </div>
      </div>

      <div class="row small" id="musterContext" style="gap:6px; color:#334155;"></div>

      <div class="row">
        <strong>Classes in paddock</strong>
        <span class="muted small">(You can reuse class names via the picker below.)</span>
      </div>

      <div class="row" style="overflow:auto">
        <table id="mClassTable" style="min-width:720px">
          <thead>
            <tr>
              <th>Class</th>
              <th>Current</th>
              <th>New count (optional)</th>
            </tr>
          </thead>
          <tbody id="mClassBody">
            <tr><td colspan="3" class="muted">Pick property + paddock + species…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="row" style="align-items:flex-end">
        <div>
          <label>Quick pick class</label>
          <input id="classQuick" list="classOptions" class="w200" placeholder="e.g. Weaners"/>
          <datalist id="classOptions"></datalist>
        </div>
        <button id="addClassRowBtn" class="btn">Add row</button>
      </div>
    </div>

    <div class="row">
      <button id="saveBtn" class="primary">Save entry</button>
      <button id="resetBtn" class="btn" type="button">Reset</button>
      <span id="msg" class="muted" aria-live="polite"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <strong>Recent entries</strong>
      <span class="spacer"></span>
      <label>Year</label>
      <input id="yearInp" type="number" min="2000" max="2100" class="w110"/>
      <button id="refreshBtn" class="btn">Refresh</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Property</th><th>Activity</th><th>Paddock</th><th>Notes</th><th></th>
        </tr>
      </thead>
      <tbody id="entriesTbody"><tr><td colspan="6">Loading…</td></tr></tbody>
    </table>
  </div>
</div>

<!-- Sign-in overlay -->
<div id="authOverlay">
  <div id="authCard">
    <h2>Sign in to SkyFarm</h2>
    <p class="small muted">Email &amp; password only. Anonymous sign-in is disabled.</p>
    <div class="row">
      <div style="flex:1; min-width:260px">
        <label>Email</label>
        <input id="siEmail" type="email" placeholder="you@example.com" autocomplete="username"/>
      </div>
      <div style="flex:1; min-width:220px">
        <label>Password</label>
        <input id="siPass" type="password" placeholder="••••••••" autocomplete="current-password"/>
      </div>
    </div>
    <div class="row">
      <button id="signInBtn" class="primary">Sign in</button>
      <span id="authMsg" class="muted"></span>
      <span class="spacer"></span>
      <button id="closeOverlayBtn" class="btn" type="button">Close</button>
    </div>
  </div>
</div>

<script>
/* ------------------------ Firebase init ------------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJlGvBwmW70",   // <-- corrected “…Jl…”
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const db   = firebase.firestore();
const auth = firebase.auth();

/* ------------------------ Helpers ------------------------ */
const $ = s => document.querySelector(s);
const todayISO = () => new Date().toISOString().slice(0,10);
const setMsg = (t, ms=3000)=>{ $('#msg').textContent=t||''; if(t&&ms) setTimeout(()=>$('#msg').textContent='', ms); };
const escapeHtml = s => String(s ?? '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
function showOverlay(show){ $('#authOverlay').style.display = show ? 'flex' : 'none'; }

/* ------------------------ Elements ------------------------ */
const authWho = $('#authWho');
const signOutBtn = $('#signOutBtn');

const propSel = $('#propSel'), dateInp=$('#dateInp'), timeInp=$('#timeInp'), activitySel=$('#activitySel');
const paddockSel = $('#paddockSel'), notesInp=$('#notesInp');
const musterBox = $('#musterBox'), speciesSel=$('#speciesSel');
const mExp=$('#mExp'), mAct=$('#mAct'), mDelta=$('#mDelta'), mClassBody=$('#mClassBody'), classOptions=$('#classOptions'), classQuick=$('#classQuick');
const entriesTbody=$('#entriesTbody'), yearInp=$('#yearInp');

/* ------------------------ Auth UI ------------------------ */
$('#signInBtn').onclick = async ()=>{
  $('#authMsg').textContent = 'Signing in…';
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithEmailAndPassword($('#siEmail').value.trim(), $('#siPass').value);
    $('#authMsg').textContent = 'Signed in.';
    showOverlay(false);
    await loadProperties();
    await onPropertyChange();
    await refreshEntries();
  }catch(e){
    $('#authMsg').textContent = 'Sign-in failed: ' + (e?.message || e?.code || 'Unknown error');
  }
};
$('#signOutBtn').onclick = async ()=>{ try { await auth.signOut(); location.reload(); } catch(e){} };
$('#closeOverlayBtn').onclick = ()=> showOverlay(false);

async function requireSignedIn(){
  return new Promise(resolve=>{
    auth.onAuthStateChanged(async u=>{
      if(u){
        authWho.textContent = u.email ? `Signed in as ${u.email}` : 'Signed in';
        signOutBtn.classList.remove('hidden');
        showOverlay(false);
        resolve(true);
      }else{
        authWho.textContent = 'Not signed in';
        signOutBtn.classList.add('hidden');
        showOverlay(true);
        resolve(false);
      }
    });
  });
}

/* ------------------------ Data loads ------------------------ */
let propertyNameById = {};
let paddockCache = []; // last loaded paddocks (for quick lookups)

async function loadProperties(){
  propSel.innerHTML = '<option value="">(loading…)</option>';
  propertyNameById = {};
  try{
    const snap = await db.collection('properties').get();
    const rows=[];
    snap.forEach(d => rows.push({id:d.id, ...d.data()}));
    rows.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));
    propertyNameById = Object.fromEntries(rows.map(r => [r.id, r.name || '(Unnamed)']));
    propSel.innerHTML = rows.map(r => `<option value="${r.id}">${escapeHtml(r.name||'(Unnamed)')}</option>`).join('');
  }catch(e){
    console.error('Properties load error:', e);
    propSel.innerHTML = '<option value="">(no properties found)</option>';
  }
}

async function loadPaddocks(propertyId){
  if(!auth.currentUser || !propertyId) return;
  paddockSel.innerHTML = '<option>(loading…)</option>';
  try{
    const snap = await db.collection('paddocks')
      .where('propertyId','==',propertyId)
      .get();

    const rows=[];
    snap.forEach(d => rows.push({id:d.id, ...d.data()}));
    // yards first, then alpha
    rows.sort((a,b)=>{
      const ay=a.isYards?0:1, by=b.isYards?0:1;
      return ay-by || String(a.name||'').localeCompare(String(b.name||''));
    });
    paddockCache = rows;

    paddockSel.innerHTML = '<option value="">(choose)</option>' +
      rows.map(p=>{
        const label = `${p.name || '(unnamed)'}${p.isYards ? ' (Yards)' : ''}`;
        return `<option value="${p.id}" data-name="${escapeHtml(p.name||'')}" data-yards="${!!p.isYards}">${escapeHtml(label)}</option>`;
      }).join('');
  }catch(e){
    console.error('Paddocks load error:', e);
    paddockSel.innerHTML = '<option value="">(load error)</option>';
  }
}

/* Load current livestock classes for the paddock/species */
async function loadPaddockClasses(propertyId, paddockName, species){
  const rows = [];
  if(!propertyId || !paddockName) return rows;

  // exact
  let snap = await db.collection('livestock')
    .where('propertyId','==',propertyId)
    .where('location','==',paddockName)
    .where('species','==',species)
    .get();

  if (snap.empty){
    // fallback: any species casing
    const s2 = await db.collection('livestock')
      .where('propertyId','==',propertyId)
      .where('location','==',paddockName)
      .get();
    s2.forEach(d => {
      const data = d.data()||{};
      if (String(data.species||'').toLowerCase() === String(species).toLowerCase()){
        rows.push({id:d.id, ...data});
      }
    });
  } else {
    snap.forEach(d => rows.push({id:d.id, ...(d.data()||{})}));
  }
  return rows;
}

/* ------------------------ UI behaviors ------------------------ */
activitySel.onchange = onActivityChange;
propSel.onchange = onPropertyChange;
paddockSel.onchange = onPaddockOrSpeciesChange;
speciesSel.onchange = onPaddockOrSpeciesChange;
mAct.oninput = ()=>{ mDelta.value = (Number(mAct.value||0) - Number(mExp.value||0)) || 0; };

function onActivityChange(){
  const act = activitySel.value;
  musterBox.classList.toggle('hidden', act !== 'Mustering');
  if (act === 'Mustering'){
    onPaddockOrSpeciesChange();
  }
}

async function onPropertyChange(){
  await loadPaddocks(propSel.value);
  await onPaddockOrSpeciesChange();
}

async function onPaddockOrSpeciesChange(){
  const act = activitySel.value;
  if (act !== 'Mustering'){ return; }

  const propId = propSel.value;
  const paddockName = paddockSel.selectedOptions[0]?.dataset?.name || '';
  const species = speciesSel.value || 'Cattle';

  if (!propId || !paddockName){
    mClassBody.innerHTML = '<tr><td colspan="3" class="muted">Pick property + paddock + species…</td></tr>';
    classOptions.innerHTML = '';
    mExp.value = ''; mDelta.value = ''; return;
  }

  const rows = await loadPaddockClasses(propId, paddockName, species);
  rows.sort((a,b)=> String(a.class||'').localeCompare(String(b.class||'')));

  // datalist for quick pick
  classOptions.innerHTML = rows.map(r => `<option value="${escapeHtml(r.class||'')}"></option>`).join('');

  const total = rows.reduce((s,r)=> s + Number(r.count||0), 0);
  mExp.value = total;
  mDelta.value = (Number(mAct.value||0) - Number(mExp.value||0)) || 0;

  const body = rows.length
    ? rows.map(r => `
        <tr>
          <td><input class="mc-class w200" value="${escapeHtml(r.class||'')}" disabled/></td>
          <td><input class="mc-current w110" value="${Number(r.count||0)}" disabled/></td>
          <td><input class="mc-new w110" type="number" min="0" placeholder="leave blank to keep" /></td>
        </tr>
      `).join('')
    : '<tr><td colspan="3" class="muted">No class rows for this paddock/species.</td></tr>';

  mClassBody.innerHTML = body;
}

$('#addClassRowBtn').onclick = ()=>{
  const val = classQuick.value.trim();
  const cls = val || '';
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="mc-class w200" value="${escapeHtml(cls)}" /></td>
    <td><input class="mc-current w110" value="0" disabled/></td>
    <td><input class="mc-new w110" type="number" min="0" /></td>`;
  mClassBody.appendChild(tr);
  classQuick.value = '';
};

/* ------------------------ Save / list ------------------------ */
$('#saveBtn').onclick = saveEntry;
$('#resetBtn').onclick = resetForm;
$('#refreshBtn').onclick = refreshEntries;

function resetForm(){
  dateInp.value = todayISO();
  timeInp.value = '';
  activitySel.value = 'Ploughing'; onActivityChange();
  paddockSel.value = '';
  notesInp.value = '';
  mAct.value = ''; mDelta.value = ''; mExp.value = '';
  mClassBody.innerHTML = '<tr><td colspan="3" class="muted">Pick property + paddock + species…</td></tr>';
}

async function saveEntry(){
  if (!auth.currentUser) return alert('Please sign in');

  const propId = propSel.value;
  if (!propId) return alert('Select a property');

  const paddockName = paddockSel.selectedOptions[0]?.dataset?.name || '';
  const paddockId   = paddockSel.value || '';
  const act = activitySel.value;
  const payload = {
    propertyId: propId,
    propertyName: propertyNameById[propId] || '(Unknown)',
    date: dateInp.value || todayISO(),
    time: timeInp.value || '',
    activity: act,
    paddockId: paddockId || null,
    paddock: paddockName || null,
    notes: notesInp.value || '',
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  // When mustering, include a lightweight summary of classes
  if (act === 'Mustering'){
    const rows = [];
    document.querySelectorAll('#mClassBody tr').forEach(tr=>{
      const cls  = tr.querySelector('.mc-class')?.value?.trim();
      const cur  = Number(tr.querySelector('.mc-current')?.value||0);
      const next = tr.querySelector('.mc-new')?.value ? Number(tr.querySelector('.mc-new')?.value) : null;
      if (cls){ rows.push({class: cls, current: cur, newCount: next}); }
    });
    payload.mustering = {
      species: speciesSel.value || 'Cattle',
      expected: Number(mExp.value||0),
      actual: Number(mAct.value||0) || null,
      delta: Number(mDelta.value||0) || null,
      classes: rows
    };
  }

  try{
    await db.collection('diaryEntries').add(payload);
    setMsg('Saved');
    await refreshEntries();
  }catch(e){
    console.error(e);
    alert('Save failed: ' + (e?.message || e));
  }
}

async function refreshEntries(){
  entriesTbody.innerHTML = '<tr><td colspan="6">Loading…</td></tr>';
  const y = Number(yearInp.value || new Date().getFullYear());
  const start = `${y}-01-01`, end = `${y}-12-31`;
  try{
    const snap = await db.collection('diaryEntries')
      .where('date','>=',start)
      .where('date','<=',end)
      .orderBy('date','desc')
      .limit(100)
      .get();
    const rows=[];
    snap.forEach(doc=>{
      const d = { id:doc.id, ...doc.data() };
      rows.push(`<tr>
        <td>${escapeHtml(d.date||'')}</td>
        <td>${escapeHtml(d.propertyName||'')}</td>
        <td>${escapeHtml(d.activity||'')}</td>
        <td>${escapeHtml(d.paddock||'')}</td>
        <td>${escapeHtml(d.notes||'')}</td>
        <td><button class="btn danger" onclick="delEntry('${d.id}')">Delete</button></td>
      </tr>`);
    });
    entriesTbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="6">No entries.</td></tr>';
  }catch(e){
    console.error(e);
    entriesTbody.innerHTML = '<tr><td colspan="6">Failed to load.</td></tr>';
  }
}

window.delEntry = async function(id){
  if(!confirm('Delete this entry?')) return;
  try{
    await db.collection('diaryEntries').doc(id).delete();
    await refreshEntries();
    setMsg('Deleted');
  }catch(e){
    console.error(e);
    alert('Delete failed');
  }
};

/* ------------------------ Boot ------------------------ */
(async function init(){
  dateInp.value = todayISO();
  yearInp.value = new Date().getFullYear();
  await requireSignedIn();
  if (auth.currentUser){
    await loadProperties();
    await onPropertyChange();
    await refreshEntries();
  }
})();
</script>
</body>
</html>
