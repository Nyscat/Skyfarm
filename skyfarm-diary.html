<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SkyFarm — Diary</title>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    :root { --brand:#0B7A6E; --br:#e5e7eb; --muted:#64748b; --ok:#0B7A6E; --warn:#9a3412; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#f6fbf8; margin:16px; color:#0f172a; }
    h1 { margin:0 0 12px; font-size:1.6rem; }
    .wrap { max-width:1100px; margin:0 auto; }
    .card { background:#fff; border:1px solid var(--br); border-radius:12px; padding:12px; margin:12px 0; }
    .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; align-items:center; }
    label { display:block; font-size:.9rem; color:#475569; margin-bottom:4px; }
    input, select, button { padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; font:inherit; }
    button { cursor:pointer; }
    .primary { background:var(--brand); border-color:var(--brand); color:#fff; }
    .danger { background:#ef4444; border-color:#ef4444; color:#fff; }
    .muted { color:var(--muted); font-size:.9rem; }
    .spacer { flex:1; }
    .hidden { display:none; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #e5e7eb; padding:8px; text-align:left; vertical-align:top; }
    th { background:#f1f5f9; }
    .nowrap { white-space:nowrap; }
    .pill { padding:2px 8px; border-radius:999px; background:#e2e8f0; font-size:.8rem; border:1px solid #cbd5e1; }
    .w80 { width:80px; } .w110 { width:110px; } .w140 { width:140px; } .w200 { width:200px; } .w240 { width:240px; }
    .status-ok { color:var(--ok); } .status-warn { color:var(--warn); }
    .small { font-size:.9rem; }
    .linklike { color:#0b5; text-decoration:underline; cursor:pointer; font-size:.9rem; }
    .error { color:#b91c1c; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>SkyFarm — Diary</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Property</label>
        <select id="propSel" class="w240"></select>
      </div>
      <div>
        <label>Date</label>
        <input id="dateInp" type="date"/>
      </div>
      <div>
        <label>Time</label>
        <input id="timeInp" type="time"/>
      </div>
      <div>
        <label>Activity</label>
        <select id="activitySel" class="w240">
          <option value="Ploughing">Ploughing</option>
          <option value="Planting">Planting</option>
          <option value="Spraying paddocks">Spraying paddocks</option>
          <option value="Chemical (stock)">Chemical (stock)</option>
          <option value="Trucking (sale)">Trucking (sale)</option>
          <option value="Cattle Received (Purchase)">Cattle Received (Purchase)</option>
          <option value="Move stock">Move stock (Paddock to Paddock)</option>
          <option value="Transfer stock (In)">Transfer stock (Property In)</option>
          <option value="Transfer stock (Out)">Transfer stock (Property Out)</option>
          <option value="Mustering">Mustering</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <span class="spacer"></span>
      <div>
        <label>&nbsp;</label>
        <span id="status" class="muted">Connecting…</span>
      </div>
    </div>

    <!-- Paddock picker with text fallback -->
    <div class="row" id="paddockRow">
      <div style="min-width:260px">
        <label>Paddock <span id="paddockModeHint" class="muted">(select)</span></label>
        <div id="paddockSelectWrap">
          <select id="paddockSel" class="w240"><option value="">(loading…)</option></select>
        </div>
        <div id="paddockTextWrap" class="hidden">
          <input id="paddockText" class="w240" placeholder="Type paddock name"/>
        </div>
        <div class="muted small">
          <span id="togglePaddockMode" class="linklike">Can’t see it? Type paddock name instead.</span>
          <span id="paddockErr" class="error"></span>
        </div>
      </div>

      <div id="transferPropRow" class="hidden" style="min-width:260px">
        <label>To/From Property</label>
        <select id="transferPropSel" class="w240"><option value="">(choose)</option></select>
      </div>

      <div style="min-width:260px; flex:1">
        <label>Notes</label>
        <input id="notesInp" placeholder="optional"/>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Rain gauge</label>
        <select id="gaugeSel" class="w240"><option value="">(choose)</option></select>
        <div class="muted small"><span id="gaugeErr" class="error"></span></div>
      </div>
      <div>
        <label>Rainfall (mm)</label>
        <input id="rainMm" type="number" min="0" step="0.1" class="w110"/>
      </div>
      <div class="muted">Adds to gauge total and per-day totals; auto-reverts on edit/delete.</div>
    </div>

    <div id="chemRow" class="row hidden">
      <div>
        <label>Chemical</label>
        <select id="chemSel" class="w240"><option value="">(choose)</option></select>
        <div class="muted small"><span id="chemErr" class="error"></span></div>
      </div>
      <div>
        <label>Qty used</label>
        <input id="chemQty" type="number" min="0" step="0.01" class="w110"/>
      </div>
      <div>
        <label>Unit</label>
        <input id="chemUnit" placeholder="KG/L" class="w80" disabled/>
      </div>
      <div><label>&nbsp;</label><span id="chemHint" class="pill">context</span></div>
    </div>

    <div id="stockRow" class="row hidden">
      <div>
        <label>Species</label>
        <select id="speciesSel">
          <option value="Cattle">Cattle</option>
          <option value="Sheep">Sheep</option>
          <option value="Goats">Goats</option>
        </select>
      </div>
      <div>
        <label>Class</label>
        <input id="classInp" placeholder="e.g. Weaners" class="w200" list="classOptions"/>
        <datalist id="classOptions"></datalist>
      </div>
      <div>
        <label>Head</label>
        <input id="headInp" type="number" min="0" step="1" class="w110"/>
      </div>
      <div id="stockDetail1">
        <label>Buyer / Dest (Trucking)</label>
        <input id="truckBuyer" placeholder="e.g. Roma" class="w200"/>
      </div>
      <div id="stockDetail2">
        <label>Docket / Ref</label>
        <input id="truckRef" placeholder="NVD / docket" class="w200"/>
      </div>
    </div>

    <!-- Live “what’s in paddock” context strip for Trucking/Move -->
    <div id="stockContext" class="row small" style="gap:6px; color:#334155;"></div>

    <!-- Mustering -->
    <div id="musterBox" class="card hidden" style="margin-top:8px">
      <div class="row"><strong>Mustering details</strong></div>
      <div class="row small" id="musterContext" style="gap:6px; color:#334155;"></div>
      <div class="row">
        <div><label>Expected (auto)</label><input id="mExp" type="number" class="w110" disabled/></div>
        <div><label>Actual</label><input id="mAct" type="number" class="w110"/></div>
        <div><label>Delta (auto)</label><input id="mDelta" type="number" class="w110" disabled/></div>
        <div style="flex:1; min-width:260px"><label>Reason / notes</label><input id="mReason" placeholder="e.g. counted late, moved to North 2…"/></div>
      </div>
      <div class="row">
        <div><label>Add calves</label><input id="mAddCalves" type="number" class="w110"/></div>
        <div><label>Add weaners</label><input id="mAddWeaners" type="number" class="w110"/></div>
      </div>
      <div class="row"><strong>Reclass / counts by class</strong></div>
      <div class="row" style="overflow:auto">
        <table id="mClassTable" style="min-width:760px">
          <thead><tr><th>Class</th><th>Expected</th><th>New count</th><th>Reclass to</th><th>Qty</th><th>Missing</th></tr></thead>
          <tbody id="mClassBody"><tr><td colspan="6">Pick property + paddock + species…</td></tr></tbody>
        </table>
      </div>
      <div class="muted">Set a <em>New count</em> or use <em>Reclass to + Qty</em>. “Missing” is tracked by FY.</div>
    </div>

    <div class="row">
      <button id="saveBtn" class="primary">Save entry</button>
      <button id="cancelEditBtn" class="hidden">Cancel edit</button>
      <button id="resetBtn">Reset</button>
      <span id="msg" class="muted" aria-live="polite"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <strong>Recent entries</strong>
      <span class="spacer"></span>
      <label>Year</label>
      <input id="yearInp" type="number" min="2000" max="2100" class="w110"/>
      <button id="exportCsvBtn">Export CSV</button>
      <button id="printBtn">Print year</button>
      <button id="refreshBtn">Refresh</button>
    </div>
    <table>
      <thead>
        <tr><th>Date</th><th>Property</th><th>Activity</th><th>Paddock</th><th>Rain (mm)</th><th>Chemical</th><th>Head</th><th></th></tr>
      </thead>
      <tbody id="entriesTbody"><tr><td colspan="8">Loading…</td></tr></tbody>
    </table>
  </div>
</div>

<script>
/*** Firebase ***/
const firebaseConfig = window.SF_PUBLIC ?? {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJlGvBwmW70",
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/*** Helpers ***/
const $ = s => document.querySelector(s);
const setStatus = t => { const el=$('#status'); el.textContent = t||''; el.className = t?.toLowerCase().includes('connected') ? 'status-ok' : 'status-warn'; };
const setMsg = (t, ms=3000) => { $('#msg').textContent = t||''; if(t&&ms) setTimeout(()=>$('#msg').textContent='', ms); };
const todayISO = () => new Date().toISOString().slice(0,10);
const escapeHtml = s => String(s ?? '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
const yBounds = (y)=>({ start:`${y}-01-01`, end:`${y}-12-31` });
const fmtDateKey = d => d;
function fyLabel(dateStr){ const [y,m]=dateStr.split('-').map(Number); return (m>=7)?`${y}-${String(y+1).slice(2)}`:`${y-1}-${String(y).slice(2)}`; }
function missingDocId({propertyId, paddock, species, cls, fy}){ const safe=s=>String(s||'').replace(/[^\w.-]/g,'_'); return `${safe(propertyId)}__${safe(paddock)}__${safe(species)}__${safe(cls)}__${safe(fy)}`; }

/*** Properties (exact IDs) ***/
const propertyIds = {
  "Consentes":"s7PlDM9wrEpxuJ6DGIab",
  "Gerawin":"P0dQ0H2FWHeqqxejflZs",
  "Mt Myrtle":"TRuxtRBX2zJlwZnRGYKJ"
};
const propertyNameById = Object.fromEntries(Object.entries(propertyIds).map(([n,i])=>[i,n]));

/*** Elements ***/
const propSel = $('#propSel'), dateInp = $('#dateInp'), timeInp = $('#timeInp'), activitySel = $('#activitySel');
const paddockSel = $('#paddockSel'), paddockText = $('#paddockText'), paddockModeHint = $('#paddockModeHint');
const paddockSelectWrap=$('#paddockSelectWrap'), paddockTextWrap=$('#paddockTextWrap'), togglePaddockMode=$('#togglePaddockMode'), paddockErr=$('#paddockErr');
const notesInp = $('#notesInp');
const transferPropRow = $('#transferPropRow'), transferPropSel = $('#transferPropSel');
const gaugeSel = $('#gaugeSel'), rainMm = $('#rainMm'), gaugeErr=$('#gaugeErr');
const chemRow = $('#chemRow'), chemSel = $('#chemSel'), chemQty = $('#chemQty'), chemUnit = $('#chemUnit'), chemHint = $('#chemHint'), chemErr=$('#chemErr');
const stockRow = $('#stockRow'), speciesSel = $('#speciesSel'), classInp = $('#classInp'), headInp = $('#headInp'), truckBuyer=$('#truckBuyer'), truckRef=$('#truckRef');
const stockDetail1 = $('#stockDetail1'), stockDetail2 = $('#stockDetail2');
const stockContext = $('#stockContext');
const musterBox = $('#musterBox'), mExp=$('#mExp'), mAct=$('#mAct'), mDelta=$('#mDelta'), mReason=$('#mReason'), mAddCalves=$('#mAddCalves'), mAddWeaners=$('#mAddWeaners'), mClassBody=$('#mClassBody'), musterContext=$('#musterContext');
const saveBtn = $('#saveBtn'), cancelEditBtn = $('#cancelEditBtn'), entriesTbody = $('#entriesTbody');
const yearInp = $('#yearInp'), exportCsvBtn = $('#exportCsvBtn'), printBtn = $('#printBtn');
const classOptions = document.getElementById('classOptions');

/*** Caches / state ***/
let paddocks=[], gauges=[], chems=[];
let editingId = null;

/*** Bootstrap ***/
(async function init(){
  try {
    try { await firebase.firestore().enablePersistence({synchronizeTabs:true}); } catch(e) { console.warn('Persistence not available:', e && e.code); }
    setStatus('Connecting…');
    await auth.signInAnonymously();
    setStatus('Connected');
  } catch(e){ console.error(e); setStatus('Auth issue (check Anonymous Sign-in & Authorized domains)'); }

  // properties (+ All)
  const propOptions = Object.keys(propertyIds).map(n=>`<option value="${propertyIds[n]}">${n}</option>`).join('');
  propSel.innerHTML = '<option value="ALL">(All properties)</option>' + propOptions;
  transferPropSel.innerHTML = '<option value="">(choose property)</option>' + propOptions;

  dateInp.value = todayISO(); yearInp.value = new Date().getFullYear();

  // events
  activitySel.onchange = onActivityChange;
  propSel.onchange = onPropertyChange;
  document.getElementById('refreshBtn').onclick = refreshEntries;
  document.getElementById('resetBtn').onclick = ()=>resetForm(false);
  cancelEditBtn.onclick = ()=>{ resetForm(false); setMsg('Edit cancelled'); };
  saveBtn.onclick = ()=> saveEntry().catch(e=>{console.error(e); setMsg('Save failed: '+(e?.message||e));});
  exportCsvBtn.onclick = exportYearCsv;
  printBtn.onclick = ()=>window.print();
  paddockSel.onchange = onPaddockOrSpeciesChange;
  paddockText.oninput = onPaddockOrSpeciesChange;
  speciesSel.onchange = onPaddockOrSpeciesChange;
  mAct.oninput = ()=>{ mDelta.value = (Number(mAct.value||0) - Number(mExp.value||0)) || 0; };
  transferPropSel.onchange = onTransferPropertyChange;

  togglePaddockMode.onclick = ()=>{
    const toText = paddockTextWrap.classList.contains('hidden');
    setPaddockMode(toText ? 'text':'select', true);
  };

  onActivityChange();
  await onPropertyChange();
  await refreshEntries();
})();

/*** Paddock mode (select or text) ***/
function setPaddockMode(mode, focus=false){
  if (mode==='text'){
    paddockSelectWrap.classList.add('hidden');
    paddockTextWrap.classList.remove('hidden');
    paddockModeHint.textContent = '(type)';
    togglePaddockMode.textContent = 'Switch back to dropdown';
    if (focus) paddockText.focus();
  } else {
    paddockSelectWrap.classList.remove('hidden');
    paddockTextWrap.classList.add('hidden');
    paddockModeHint.textContent = '(select)';
    togglePaddockMode.textContent = 'Can’t see it? Type paddock name instead.';
    if (focus) paddockSel.focus();
  }
}

/*** Activity toggles ***/
function onActivityChange(){
  const act = activitySel.value;

  const needsChem = (act==='Spraying paddocks' || act==='Chemical (stock)' || act==='Trucking (sale)');
  chemRow.classList.toggle('hidden', !needsChem);
  chemHint.textContent = (act==='Spraying paddocks') ? 'paddock spray'
                     : (act==='Trucking (sale)' ? 'backline before transport' : 'stock treatment');

  const needsStock = (act==='Trucking (sale)' || act==='Move stock' || act==='Chemical (stock)' || act==='Mustering' || act==='Cattle Received (Purchase)' || act.startsWith('Transfer stock'));
  stockRow.classList.toggle('hidden', !needsStock);

  const needsPaddock = !(act==='Transfer stock (In)' || act==='Transfer stock (Out)' || act==='Cattle Received (Purchase)');
  document.getElementById('paddockRow').classList.toggle('hidden', !needsPaddock);

  const needsTransferProp = (act==='Transfer stock (In)' || act==='Transfer stock (Out)');
  transferPropRow.classList.toggle('hidden', !needsTransferProp);

  const needsTruckDetails = (act==='Trucking (sale)' || act==='Cattle Received (Purchase)');
  stockDetail1.classList.toggle('hidden', !needsTruckDetails);
  stockDetail2.classList.toggle('hidden', !needsTruckDetails);

  if (act==='Cattle Received (Purchase)') speciesSel.value = 'Cattle';

  buildChemDropdown();
  onPaddockOrSpeciesChange();
}

function onTransferPropertyChange() {
  if (activitySel.value === 'Transfer stock (In)') onPropertyChange();
}

/*** Load paddocks/gauges/chems with robust error handling ***/
async function onPropertyChange(){
  const pid = propSel.value;

  // Update transfer dropdown to exclude current
  transferPropSel.innerHTML = '<option value="">(choose property)</option>' +
    Object.entries(propertyIds).filter(([_,id])=>id!==pid).map(([n,id])=>`<option value="${id}">${n}</option>`).join('');

  paddockErr.textContent=''; gaugeErr.textContent=''; chemErr.textContent='';

  if (pid==='ALL'){
    paddockSel.innerHTML = '<option value="">(choose a property)</option>';
    gaugeSel.innerHTML = '<option value="">(choose a property)</option>';
    chemSel.innerHTML = '<option value="">(choose a property)</option>';
    setPaddockMode('select');
    document.getElementById('saveBtn').disabled = true;
    return;
  }
  document.getElementById('saveBtn').disabled = false;

  // paddocks
  setPaddockMode('select');
  paddockSel.innerHTML = '<option>(loading…)</option>';
  try{
    paddocks = [];
    const snap = await db.collection('paddocks').where('propertyId','==',pid).get();
    snap.forEach(d=>paddocks.push({id:d.id, ...d.data()}));
    if (!paddocks.length){
      paddockSel.innerHTML = '<option value="">(none set for this property)</option>';
      // auto switch to text fallback so user isn’t blocked
      setPaddockMode('text');
      paddockErr.textContent = '';
    } else {
      paddockSel.innerHTML = '<option value="">(choose)</option>' +
        paddocks.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))
          .map(p=>`<option value="${p.id}" data-name="${escapeHtml(p.name||'')}">${escapeHtml(p.name||'(unnamed)')}</option>`).join('');
      paddockErr.textContent = '';
    }
  }catch(e){
    console.error('Paddocks load error:', e);
    paddockSel.innerHTML = '<option value="">(unavailable)</option>';
    setPaddockMode('text');
    paddockErr.textContent = friendlyFsError(e, 'paddocks');
  }

  // gauges
  gaugeSel.innerHTML = '<option>(loading…)</option>';
  try{
    gauges=[];
    const gsnap = await db.collection('gauges').where('propertyId','==',pid).get();
    gsnap.forEach(d=>gauges.push({id:d.id, ...d.data()}));
    gaugeSel.innerHTML = '<option value="">(choose)</option>' + gauges
      .sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))
      .map(g=>`<option value="${g.id}" data-name="${escapeHtml(g.name||'')}">${escapeHtml(g.name||'(unnamed)')}</option>`).join('');
  }catch(e){
    console.error('Gauges load error:', e);
    gaugeSel.innerHTML = '<option value="">(unavailable)</option>';
    gaugeErr.textContent = friendlyFsError(e, 'gauges');
  }

  // chems
  chemSel.innerHTML = '<option>(loading…)</option>';
  try{
    chems=[];
    const csnap = await db.collection('chemicals').where('propertyId','==',pid).get();
    csnap.forEach(d=>chems.push({id:d.id, ...d.data()}));
    buildChemDropdown();
  }catch(e){
    console.error('Chemicals load error:', e);
    chemSel.innerHTML = '<option value="">(unavailable)</option>';
    chemErr.textContent = friendlyFsError(e, 'chemicals');
  }

  onPaddockOrSpeciesChange();
}

function friendlyFsError(e, thing){
  const code = e?.code || '';
  if (code==='permission-denied') return `No permission to read ${thing}. Check Firestore rules for anonymous users.`;
  if (code==='failed-precondition') return `Missing index or offline. Try again.`;
  return `Couldn’t load ${thing}. (${code||'error'})`;
}

/*** Chems dropdown ***/
function buildChemDropdown(){
  const pid = propSel.value;
  if(pid==='ALL'){ chemSel.innerHTML='<option value="">(choose property)</option>'; chemUnit.value=''; return; }
  const act = activitySel.value;
  const target = act==='Spraying paddocks' ? 'paddock' : (act==='Chemical (stock)' || act==='Trucking (sale)' ? 'stock' : null);
  if(!target){ chemSel.innerHTML='<option value="">(not required)</option>'; chemUnit.value=''; return; }
  const list = (chems||[]).filter(c => String(c.useOn||'').toLowerCase()===target && Number(c.quantity||0)>0);
  if(!list.length){ chemSel.innerHTML='<option value="">(no chemicals available)</option>'; chemUnit.value=''; return; }
  chemSel.innerHTML = '<option value="">(choose chemical)</option>' +
    list.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))
      .map(c=>`<option value="${c.id}" data-unit="${c.unit||''}">${escapeHtml(c.name||'Unnamed')} (${c.unit||''}) — ${Number(c.quantity||0)} left</option>`).join('');
  chemSel.onchange = ()=> chemUnit.value = chemSel.selectedOptions[0]?.dataset?.unit || '';
  chemUnit.value = chemSel.selectedOptions[0]?.dataset?.unit || '';
}

/*** Stock context + datalist ***/
async function onPaddockOrSpeciesChange(){
  const pid = propSel.value;
  if (pid==='ALL') { stockContext.innerHTML=''; return; }

  const act = activitySel.value;
  const isStockMove = (act==='Trucking (sale)' || act==='Move stock' || act==='Chemical (stock)' || act==='Mustering' || act==='Transfer stock (Out)');
  const isStockIn   = (act==='Cattle Received (Purchase)' || act==='Transfer stock (In)');

  const paddockName = getChosenPaddockName();
  const speciesUI = speciesSel.value || 'Cattle';

  if (!paddockName && !isStockIn){
    classOptions.innerHTML='';
    stockContext.innerHTML='';
    mClassBody.innerHTML='<tr><td colspan="6">Pick property + paddock + species…</td></tr>';
    mExp.value='';
    return;
  }

  let rows = [];
  if (isStockMove && paddockName){
    rows = await fetchLivestockRows(pid, paddockName, speciesUI);
  } else if (isStockIn) {
    rows = ["Cows","Heifers","Bulls","Steers","PTIC cows","Joined cows","Calves","Weaners"].map(cls=>({class:cls,count:0}));
  }

  rows.sort((a,b)=>String(a.class||'').localeCompare(String(b.class||'')));
  classOptions.innerHTML = rows.map(r=>`<option value="${escapeHtml(r.class||'')}"></option>`).join('');

  if (isStockMove && paddockName){
    const total = rows.reduce((s,r)=> s + Number(r.count||0), 0);
    if (rows.length){
      stockContext.innerHTML = [
        `<span class="pill">In ${escapeHtml(paddockName)}: ${total} head</span>`,
        ...rows.map(r =>
          `<button type="button" class="pill" role="button" data-cls="${escapeHtml(r.class||'')}" data-head="${Number(r.count||0)}" title="Click to fill class & head">`+
          `${escapeHtml(r.class||'')}: ${Number(r.count||0)}</button>`
        )
      ].join(' ');
      stockContext.querySelectorAll('.pill[data-cls]').forEach(btn=>{
        btn.onclick = () => { classInp.value = btn.dataset.cls || ''; headInp.value = btn.dataset.head || ''; headInp.focus(); };
      });
    } else {
      stockContext.innerHTML = `<span class="muted">No livestock lines found for ${escapeHtml(paddockName)} (${escapeHtml(speciesUI)}).</span>`;
    }
  } else {
    stockContext.innerHTML = '';
  }

  if (rows.length===1 && (act==='Trucking (sale)' || act==='Move stock' || act==='Chemical (stock)' || act==='Transfer stock (Out)')){
    classInp.value = rows[0].class || '';
    headInp.value  = Number(rows[0].count||0);
  }

  if (activitySel.value==='Mustering'){
    const total = rows.reduce((s,r)=>s+Number(r.count||0),0);
    mExp.value = total;
    mDelta.value = (Number(mAct.value||0) - Number(mExp.value||0)) || 0;

    const parts = rows.map(r=>`${escapeHtml(r.class||'')}: ${Number(r.count||0)}`);
    musterContext.innerHTML = `<span class="pill">Expected total: ${total}</span> ${parts.length? ' | ' + parts.join(', ') : ''}`;

    mClassBody.innerHTML = rows.map(r=>`
      <tr data-class="${escapeHtml(r.class||'')}">
        <td><input class="mc-class w200" value="${escapeHtml(r.class||'')}" /></td>
        <td><input class="mc-current w110" value="${Number(r.count||0)}" disabled /></td>
        <td><input class="mc-new w110" type="number" min="0" /></td>
        <td><input class="mc-to w200" placeholder="e.g. Cows, Heifers, Joined cows" /></td>
        <td><input class="mc-qty w110" type="number" min="0" /></td>
        <td><input class="mc-miss w110" type="number" min="0" /></td>
      </tr>`).join('');
  }
}

function getChosenPaddockName(){
  if (!paddockTextWrap.classList.contains('hidden')){
    return paddockText.value.trim();
  }
  return paddockSel.selectedOptions[0]?.dataset?.name || '';
}

/*** Firestore helpers ***/
async function fetchLivestockRows(pid, paddockName, speciesUI){
  const speciesLC = String(speciesUI||'').toLowerCase();
  try{
    let snap = await db.collection('livestock')
      .where('propertyId','==',pid).where('location','==',paddockName).where('species','==',speciesUI).get();

    if (snap.empty){
      const title = speciesLC.charAt(0).toUpperCase() + speciesLC.slice(1);
      const variants = [title, speciesLC.toUpperCase()];
      for (const v of variants){
        const s2 = await db.collection('livestock')
          .where('propertyId','==',pid).where('location','==',paddockName).where('species','==',v).get();
        if (!s2.empty){ snap = s2; break; }
      }
    }

    let rows=[];
    if (snap.empty){
      const s3 = await db.collection('livestock').where('propertyId','==',pid).where('location','==',paddockName).get();
      s3.forEach(d => rows.push({ id:d.id, ...(d.data()||{}) }));
      rows = rows.filter(r => String(r.species||'').toLowerCase() === speciesLC);
    } else {
      snap.forEach(d => rows.push({ id:d.id, ...(d.data()||{}) }));
    }
    return rows;
  }catch(e){
    console.error('Livestock fetch error:', e);
    setMsg(friendlyFsError(e, 'livestock'), 4000);
    return [];
  }
}

/*** Save/Update — trimmed to essentials for this fix ***/
async function saveEntry(){
  if (propSel.value==='ALL') return alert('Select a specific property to save.');
  const propId = propSel.value, propName = propertyNameById[propId] || '(unknown)';
  const date = dateInp.value || todayISO(), time = timeInp.value || '';
  const activity = activitySel.value;
  const paddockName = getChosenPaddockName();
  const notes = notesInp.value || '';
  const species = speciesSel.value || '', klass = classInp.value || '', head = parseInt(headInp.value||0,10);
  const chemId = chemSel.value || null, chemQ = parseFloat(chemQty.value||0), chemU = chemUnit.value || '', chemName = chemId ? (chems.find(c=>c.id===chemId)?.name || null) : null;

  const payload = {
    propertyId: propId, propertyName: propName,
    date, time, activity,
    paddock: paddockName || null,
    notes,
    species: (activity!=='Ploughing' && activity!=='Planting' && activity!=='Other') ? species : null,
    livestockClass: (activity!=='Ploughing' && activity!=='Planting' && activity!=='Other') ? klass : null,
    headCount: (activity==='Trucking (sale)' || activity==='Move stock' || activity==='Cattle Received (Purchase)' || activity.startsWith('Transfer stock')) ? (head||null) : null,
    chemicalId: chemId || null, chemicalName: chemName, chemQty: chemId ? chemQ : null, chemUnit: chemId ? chemU : null,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: editingId ? undefined : firebase.firestore.FieldValue.serverTimestamp()
  };

  try{
    const id = editingId || db.collection('diaryEntries').doc().id;
    await db.collection('diaryEntries').doc(id).set(payload, {merge:true});
    setMsg('Saved.');
    editingId=null;
    await refreshEntries();
  }catch(e){
    console.error(e);
    alert(e?.message || 'Save failed');
  }
}

/*** Listing ***/
async function refreshEntries(){
  entriesTbody.innerHTML = '<tr><td colspan="8">Loading…</td></tr>';
  const y = Number(yearInp.value || new Date().getFullYear());
  const {start,end} = yBounds(y);
  try{
    const snap = await db.collection('diaryEntries').where('date','>=',start).where('date','<=',end).orderBy('date','desc').limit(100).get();
    const rows=[];
    snap.forEach(doc=>{
      const d = { id:doc.id, ...doc.data() };
      rows.push(`<tr>
        <td>${escapeHtml(d.date||'')}</td>
        <td>${escapeHtml(d.propertyName||'')}</td>
        <td>${escapeHtml(d.activity||'')}</td>
        <td>${escapeHtml(d.paddock||'')}</td>
        <td>${Number(d.rainfallMm||0) || ''}</td>
        <td>${escapeHtml(d.chemicalName||'')}</td>
        <td>${Number(d.headCount||0) || ''}</td>
        <td class="nowrap"><button onclick="editEntry('${d.id}')">Edit</button> <button class="danger" onclick="delEntry('${d.id}')">Delete</button></td>
      </tr>`);
    });
    entriesTbody.innerHTML = rows.length? rows.join('') : '<tr><td colspan="8">No entries.</td></tr>';
  }catch(e){
    console.error(e);
    entriesTbody.innerHTML = `<tr><td colspan="8" class="error">${friendlyFsError(e,'entries')}</td></tr>`;
  }
}

window.editEntry = async function(id){
  try{
    const doc = await db.collection('diaryEntries').doc(id).get();
    if(!doc.exists) return;
    const d = doc.data()||{};
    editingId = id;

    propSel.value = d.propertyId || 'ALL';
    await onPropertyChange();

    dateInp.value = d.date || todayISO(); timeInp.value = d.time || '';
    activitySel.value = d.activity || 'Other'; onActivityChange();
    notesInp.value = d.notes || '';

    // paddock (prefer dropdown if present)
    const opt = [...paddockSel.options].find(o=> (o.dataset?.name||'') === (d.paddock||''));
    if (opt){ setPaddockMode('select'); paddockSel.value = opt.value; }
    else { setPaddockMode('text'); paddockText.value = d.paddock || ''; }

    speciesSel.value = d.species || 'Cattle';
    classInp.value = d.livestockClass || '';
    headInp.value  = d.headCount || '';
    chemSel.value = d.chemicalId || '';
    chemQty.value = d.chemQty || '';
    chemUnit.value = d.chemUnit || '';

    setMsg('Editing…', 1500);
  }catch(e){ alert('Edit error: ' + (e?.message||e)); }
};

window.delEntry = async function(id){
  if(!confirm('Delete this entry?')) return;
  try{ await db.collection('diaryEntries').doc(id).delete(); await refreshEntries(); setMsg('Deleted.'); }
  catch(e){ alert('Delete error: ' + (e?.message||e)); }
};

/*** Misc ***/
function resetForm(){
  dateInp.value = todayISO(); timeInp.value=''; notesInp.value='';
  activitySel.value='Ploughing'; onActivityChange();
  setPaddockMode('select'); paddockSel.value=''; paddockText.value='';
  chemSel.value=''; chemQty.value=''; chemUnit.value='';
  speciesSel.value='Cattle'; classInp.value=''; headInp.value='';
  stockContext.innerHTML='';
  cancelEditBtn.classList.add('hidden');
  editingId=null;
}
function exportYearCsv(){
  const rows = [['Date','Property','Activity','Paddock','Rain (mm)','Chemical','Head']];
  document.querySelectorAll('#entriesTbody tr').forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    if (tds.length>=7){
      rows.push([0,1,2,3,4,5,6].map(i => (tds[i]?.textContent||'').replace(/[\n\r]+/g,' ').trim()));
    }
  });
  const csv = rows.map(r=>r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `skyfarm-diary-${yearInp.value||new Date().getFullYear()}.csv`; a.click();
}
</script>
</body>
</html>
