<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SkyFarm â€” Diary</title>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#f6fbf8;
      --card:#ffffff;
      --line:#e2e8f0;
      --ink:#0f172a;
      --muted:#64748b;
      --accent:#047857;
      --danger:#b91c1c;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
    }
    a{color:#0f766e;text-decoration:none;}
    a:hover{text-decoration:underline;}

    /* Header */
    #sf-header{
      position:sticky;
      top:0;
      z-index:40;
      background:rgba(255,255,255,.96);
      backdrop-filter:blur(18px);
      border-bottom:1px solid rgba(148,163,184,.4);
    }
    #sf-header .bar{
      max-width:1200px;
      margin:0 auto;
      padding:8px 14px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    #sf-header .brand{
      font-weight:600;
      font-size:1rem;
      padding:4px 10px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 10%,#e0f2fe,#0f766e);
      color:#ecfdf3;
      box-shadow:0 10px 20px rgba(15,23,42,.25);
    }
    #sf-header nav a{
      padding:4px 10px;
      border-radius:999px;
      font-size:.85rem;
      color:#0f172a;
      text-decoration:none;
    }
    #sf-header nav a[aria-current="page"]{
      background:#e0f2fe;
      font-weight:500;
    }
    .nav-db{position:relative;}
    .spacer{flex:1;}
    .muted{color:var(--muted);}
    .small{font-size:.8rem;}
    .status-warn{color:var(--danger);}

    .btn{
      border-radius:999px;
      border:1px solid #cbd5e1;
      padding:6px 12px;
      font-size:.82rem;
      background:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#ecfdf3;
    }
    .btn.danger{
      border-color:#ef4444;
      color:#ef4444;
      background:#fff;
    }
    .btn.small{
      padding:4px 10px;
      font-size:.78rem;
    }
    .btn[disabled]{opacity:.5;cursor:default;}

    .db-menu{
      position:absolute;
      top:100%;
      right:0;
      background:#fff;
      border:1px solid var(--line);
      border-radius:10px;
      min-width:180px;
      padding:4px 0;
      box-shadow:0 10px 25px rgba(15,23,42,.12);
      z-index:20;
    }
    .db-menu a{
      display:block;
      padding:6px 12px;
      font-size:.9rem;
      color:#0f172a;
      text-decoration:none;
    }
    .db-menu a:hover{background:#f1f59;}
    .hidden{display:none;}

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:12px;
    }
    h1{margin:10px 0;font-size:1.5rem;}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      margin:10px 0;
      box-shadow:0 10px 25px rgba(15,23,42,.04);
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin:6px 0;
    }
    label{
      display:block;
      font-size:.8rem;
      color:#475569;
      margin-bottom:3px;
    }
    input,select,textarea{
      border-radius:10px;
      border:1px solid #cbd5e1;
      padding:6px 8px;
      font-size:.85rem;
      font-family:inherit;
      background:#fff;
    }
    textarea{resize:vertical;min-height:40px;}
    input:focus,select:focus,textarea:focus{
      outline:none;
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,.2);
    }

    .w90{width:90px;}
    .w120{width:120px;}
    .w160{width:160px;}
    .w220{width:220px;}
    .pill{
      display:inline-block;
      padding:2px 7px;
      border-radius:999px;
      font-size:.75rem;
      background:#e5f3ff;
      border:1px solid #bfdbfe;
      margin-right:4px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.8rem;
    }
    th,td{
      border-bottom:1px solid #e5e7eb;
      padding:6px 6px;
      text-align:left;
      vertical-align:top;
    }
    th{background:#f9fafb;color:#374151;}
    tr:nth-child(even) td{background:#f9fafb;}
    .nowrap{white-space:nowrap;}

    .table-scroll{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }

    /* Card list for mobile */
    .entries-cards{
      margin-top:8px;
      display:none;
      flex-direction:column;
      gap:8px;
    }
    .entry-card{
      border-radius:12px;
      border:1px solid var(--line);
      background:#f9fafb;
      padding:8px 10px;
    }
    .ec-header{
      display:flex;
      justify-content:space-between;
      font-size:.78rem;
      font-weight:500;
      margin-bottom:4px;
    }
    .ec-line{
      font-size:.78rem;
      margin-bottom:2px;
    }
    .ec-label{
      font-weight:600;
      color:#475569;
      margin-right:4px;
    }
    .ec-activity{
      font-weight:600;
    }
    .ec-notes{
      color:var(--muted);
    }
    .ec-actions{
      margin-top:4px;
      text-align:right;
    }

    @media (max-width:800px){
      .table-desktop{display:none;}
      .entries-cards{display:flex;}
      .row{flex-direction:column;align-items:flex-start;}
      .w220,.w160,.w120,.w90{width:100%;}
      #sf-header .bar{flex-wrap:wrap;}
    }
    @media (min-width:801px){
      .table-desktop{display:block;}
      .entries-cards{display:none;}
    }

    /* Auth overlay */
    #authOverlay{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top,#020617 0,rgba(15,23,42,.94) 40%,rgba(15,23,42,.97) 100%);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    #authCard{
      width:min(520px,92vw);
      background:#fff;
      border-radius:16px;
      border:1px solid var(--line);
      padding:20px;
    }
    #authCard h2{margin:0 0 8px;}

    @media print{
      #sf-header,.no-print{display:none!important;}
      body{background:#fff;}
      .wrap{padding:8px;}
      .card{box-shadow:none;border:none;margin:6px 0;}
      .table-desktop{display:block!important;}
      .entries-cards{display:none!important;}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div id="sf-header">
    <div class="bar">
      <a class="brand" href="skyfarm-diary.html">ðŸŒ± SkyFarm</a>
      <nav>
        <a href="skyfarm-diary.html" aria-current="page">Diary</a>
        <a href="skyfarm-map.html">Map</a>
        <a href="skyfarm-rain.html">Rain</a>
      </nav>
      <div class="nav-db">
        <button id="dbMenuBtn" class="btn small" type="button">Database â–¾</button>
        <div id="dbMenu" class="db-menu hidden">
          <a href="skyfarm-livestock.html">Livestock</a>
          <a href="skyfarm-chemical.html">Chemicals</a>
          <a href="skyfarm-seeds.html">Seeds</a>
          <a href="skyfarm-fodder.html">Fodder</a>
          <a href="skyfarm-barcode.html">Barcode scanner</a>
          <a href="skyfarm-users.html">Users &amp; roles</a>
        </div>
      </div>
      <span class="spacer"></span>
      <span id="authWho" class="muted small">Checking sign-inâ€¦</span>
      <button id="signOutBtn" class="btn small danger hidden">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <h1>Diary</h1>

    <!-- Entry form -->
    <div class="card no-print">
      <div class="row">
        <div>
          <label>Property</label>
          <select id="propSel" class="w220"></select>
        </div>
        <div>
          <label>Date</label>
          <input id="dateInp" type="date" class="w160"/>
        </div>
        <div>
          <label>Time</label>
          <input id="timeInp" type="time" class="w120"/>
        </div>
        <div>
          <label>Activity</label>
          <select id="activitySel" class="w220">
            <option value="Ploughing">Plough paddock</option>
            <option value="Planting">Plant paddock</option>
            <option value="Spraying paddocks">Spray paddock</option>
            <option value="Chemical (stock)">Chemical (stock)</option>
            <option value="Trucking (sale)">Truck cattle (sale)</option>
            <option value="Mustering">Muster cattle</option>
            <option value="Move stock">Move cattle (within property)</option>
            <option value="Transfer stock (Out)">Transfer cattle to another property</option>
            <option value="Cattle purchase">Buy cattle</option>
            <option value="Feeding (fodder)">Feeding (fodder / lick)</option>
            <option value="Rainfall">Rainfall</option>
            <option value="Purchase inputs">Purchase â€“ inputs</option>
            <option value="General">General</option>
          </select>
        </div>
        <span class="spacer"></span>
        <div id="status" class="muted small">Ready</div>
      </div>

      <div class="row">
        <div style="min-width:240px">
          <label>Paddock</label>
          <select id="paddockSel" class="w220">
            <option value="">(choose)</option>
          </select>
          <div class="small muted">Yards appear at the top.</div>
        </div>

        <div id="toPaddockWrap" class="hidden" style="min-width:240px">
          <label>To paddock</label>
          <select id="toPaddockSel" class="w220">
            <option value="">(choose)</option>
          </select>
        </div>

        <div id="transferPropWrap" class="hidden" style="min-width:240px">
          <label>To property</label>
          <select id="transferPropSel" class="w220">
            <option value="">(choose)</option>
          </select>
        </div>

        <div>
          <label>Rainfall (mm to 9am)</label>
          <input id="rainMmInp" type="number" min="0" step="0.1" class="w120"/>
        </div>
        <div>
          <label>Gauge</label>
          <select id="gaugeSel" class="w220">
            <option value="">(none)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div style="flex:1;min-width:260px">
          <label>Notes / description</label>
          <textarea id="notesInp" placeholder="What happened?"></textarea>
        </div>
        <div style="min-width:220px">
          <label>Weather (optional)</label>
          <input id="weatherInp" placeholder="Hot & windy, storm, etc"/>
        </div>
      </div>

      <!-- Stock section -->
      <div id="stockRow" class="row hidden">
        <div>
          <label>Species</label>
          <select id="speciesSel" class="w160">
            <option value="Cattle">Cattle</option>
            <option value="Sheep">Sheep</option>
            <option value="Goats">Goats</option>
          </select>
        </div>
        <div>
          <label>Class</label>
          <input id="classInp" list="classOptions" class="w160" placeholder="Weaners, PTIC cowsâ€¦"/>
          <datalist id="classOptions"></datalist>
        </div>
        <div>
          <label>Head</label>
          <input id="headInp" type="number" min="0" step="1" class="w90"/>
        </div>
      </div>

      <!-- Chemical row -->
      <div id="chemRow" class="row hidden">
        <div>
          <label>Chemical</label>
          <select id="chemSel" class="w220">
            <option value="">(choose)</option>
          </select>
        </div>
        <div>
          <label>Quantity</label>
          <input id="chemQty" type="number" min="0" step="0.01" class="w120"/>
        </div>
        <div>
          <label>Unit</label>
          <input id="chemUnit" class="w90" disabled/>
        </div>
      </div>

      <!-- Seed row -->
      <div id="seedRow" class="row hidden">
        <div>
          <label>Seed</label>
          <select id="seedSel" class="w220">
            <option value="">(choose)</option>
          </select>
        </div>
        <div>
          <label>Seed quantity</label>
          <input id="seedQty" type="number" min="0" step="0.01" class="w120"/>
        </div>
        <div>
          <label>Unit</label>
          <input id="seedUnit" class="w90" disabled/>
        </div>
      </div>

      <!-- Fodder row -->
      <div id="fodderRow" class="row hidden">
        <div>
          <label>Fodder</label>
          <select id="fodderSel" class="w220">
            <option value="">(choose)</option>
          </select>
        </div>
        <div>
          <label>Fodder quantity</label>
          <input id="fodderQty" type="number" min="0" step="0.01" class="w120"/>
        </div>
        <div>
          <label>Unit</label>
          <input id="fodderUnit" class="w90" disabled/>
        </div>
      </div>

      <!-- Purchase meta -->
      <div id="purchaseRow" class="row hidden">
        <div>
          <label>Purchase type</label>
          <select id="purchaseTypeSel" class="w160">
            <option value="Chemical">Chemical</option>
            <option value="Seed">Seed</option>
            <option value="Fodder">Fodder</option>
          </select>
        </div>
        <div>
          <label>Supplier / source</label>
          <input id="purchaseSupplier" class="w220" placeholder="CRT, Landmarkâ€¦"/>
        </div>
        <div>
          <label>Invoice / ref</label>
          <input id="purchaseRef" class="w160" placeholder="Invoice #"/>
        </div>
      </div>

      <div id="stockContext" class="row small" style="color:#374151;"></div>

      <div class="row">
        <button id="saveBtn" class="btn primary" type="button">Save entry</button>
        <button id="resetBtn" class="btn" type="button">Reset</button>
        <span id="saveMsg" class="muted small"></span>
      </div>
    </div>

    <!-- Recent entries -->
    <div class="card">
      <div class="row no-print">
        <strong>Recent entries</strong>
        <div>
          <label class="small">Property</label>
          <select id="filterPropSel" class="w160"></select>
        </div>
        <div>
          <label class="small">Year</label>
          <input id="filterYear" type="number" class="w90" min="2000" max="2100"/>
        </div>
        <div>
          <label class="small">User</label>
          <select id="filterUserSel" class="w160"></select>
        </div>
        <div>
          <label class="small">Sort</label>
          <select id="sortSel" class="w160">
            <option value="dateDesc">Newest first</option>
            <option value="dateAsc">Oldest first</option>
            <option value="userAsc">User Aâ€“Z</option>
            <option value="userDesc">User Zâ€“A</option>
          </select>
        </div>
        <div>
          <label class="small">&nbsp;</label>
          <button id="refreshBtn" class="btn small" type="button">Refresh</button>
        </div>
        <span class="spacer"></span>
        <button id="printBtn" class="btn small" type="button">Print / PDF</button>
      </div>

      <!-- Desktop/tablet view -->
      <div class="table-desktop">
        <div class="table-scroll">
          <table>
            <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Property</th>
              <th>Paddock</th>
              <th>Activity</th>
              <th>Stock</th>
              <th>Chemical / inputs</th>
              <th>Rain (mm)</th>
              <th>Notes</th>
              <th>User</th>
              <th class="no-print"></th>
            </tr>
            </thead>
            <tbody id="entriesBody">
            <tr><td colspan="11" class="muted small">Loadingâ€¦</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Mobile card view -->
      <div id="entriesCards" class="entries-cards"></div>
    </div>
  </div>

  <!-- Auth overlay -->
  <div id="authOverlay">
    <div id="authCard">
      <h2>Sign in to SkyFarm</h2>
      <p class="small muted">Email &amp; password only.</p>
      <div class="row">
        <div style="flex:1;min-width:240px">
          <label>Email</label>
          <input id="siEmail" type="email" autocomplete="username" placeholder="you@example.com"/>
        </div>
        <div style="flex:1;min-width:200px">
          <label>Password</label>
          <input id="siPass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
        </div>
      </div>
      <div class="row">
        <button id="signInBtn" class="btn primary" type="button">Sign in</button>
        <span id="authMsg" class="muted small"></span>
        <span class="spacer"></span>
        <button id="closeOverlayBtn" class="btn" type="button">Close</button>
      </div>
    </div>
  </div>

<script>
  // ---------- Firebase init ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
    authDomain: "consentes-pastoral.firebaseapp.com",
    projectId: "consentes-pastoral",
    appId: "1:494858780013:web:d87497b370c82eeab06e64"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // ---------- Helpers ----------
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const todayISO = () => new Date().toISOString().slice(0,10);
  const escapeHtml = s => String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  function setStatus(msg, warn){
    const el = $('#status');
    el.textContent = msg || '';
    el.classList.toggle('status-warn', !!warn);
  }
  function setSaveMsg(msg, ms){
    const el = $('#saveMsg');
    el.textContent = msg || '';
    if (ms){
      setTimeout(()=>{ if (el.textContent===msg) el.textContent=''; }, ms);
    }
  }

  const SUGGESTED_CLASSES = [
    'Cows','PTIC cows','Heifers','Steers','Bulls',
    'Cows & calves','Weaners','Calves'
  ];
  let ALL_PROPERTIES = [];
  let USERS = {};  // email -> {firstName, fullName}

  // Current user/role
  let CURRENT_USER = null;
  let CURRENT_UID = null;
  let CURRENT_EMAIL = null;
  let CURRENT_ROLE = 'worker';       // admin | manager | worker
  let ALLOWED_PROPERTY_IDS = null;   // Set of propertyIds, or null = all

  // DOM refs
  const propSel = $('#propSel');
  const dateInp = $('#dateInp');
  const timeInp = $('#timeInp');
  const activitySel = $('#activitySel');
  const paddockSel = $('#paddockSel');
  const toPaddockWrap = $('#toPaddockWrap');
  const toPaddockSel = $('#toPaddockSel');
  const transferPropWrap = $('#transferPropWrap');
  const transferPropSel = $('#transferPropSel');
  const rainMmInp = $('#rainMmInp');
  const gaugeSel = $('#gaugeSel');
  const notesInp = $('#notesInp');
  const weatherInp = $('#weatherInp');

  const stockRow = $('#stockRow');
  const speciesSel = $('#speciesSel');
  const classInp = $('#classInp');
  const headInp = $('#headInp');

  const chemRow = $('#chemRow');
  const chemSel = $('#chemSel');
  const chemQty = $('#chemQty');
  const chemUnit = $('#chemUnit');

  const seedRow = $('#seedRow');
  const seedSel = $('#seedSel');
  const seedQty = $('#seedQty');
  const seedUnit = $('#seedUnit');

  const fodderRow = $('#fodderRow');
  const fodderSel = $('#fodderSel');
  const fodderQty = $('#fodderQty');
  const fodderUnit = $('#fodderUnit');

  const purchaseRow = $('#purchaseRow');
  const purchaseTypeSel = $('#purchaseTypeSel');
  const purchaseSupplier = $('#purchaseSupplier');
  const purchaseRef = $('#purchaseRef');

  const stockContext = $('#stockContext');

  const filterPropSel = $('#filterPropSel');
  const filterYear = $('#filterYear');
  const filterUserSel = $('#filterUserSel');
  const sortSel = $('#sortSel');
  const entriesBody = $('#entriesBody');
  const entriesCards = $('#entriesCards');

  const authOverlay = $('#authOverlay');
  const authWho = $('#authWho');
  const signOutBtn = $('#signOutBtn');
  const dbMenuBtn = $('#dbMenuBtn');
  const dbMenu = $('#dbMenu');

  // Header DB menu
  if (dbMenuBtn && dbMenu){
    dbMenuBtn.onclick = e => {
      e.stopPropagation();
      dbMenu.classList.toggle('hidden');
    };
    document.addEventListener('click', e=>{
      if (!dbMenu.contains(e.target) && e.target !== dbMenuBtn){
        dbMenu.classList.add('hidden');
      }
    });
  }

  // Auth
  const siEmail = $('#siEmail');
  const siPass = $('#siPass');
  const signInBtn = $('#signInBtn');
  const authMsg = $('#authMsg');
  const closeOverlayBtn = $('#closeOverlayBtn');

  function showOverlay(show){ authOverlay.style.display = show ? 'flex' : 'none'; }

  signInBtn.onclick = async ()=>{
    const email = (siEmail.value || '').trim();
    const pass  = siPass.value || '';
    if (!email || !pass){
      authMsg.textContent = 'Enter email and password.';
      return;
    }
    authMsg.textContent = 'Signing inâ€¦';
    try{
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      await auth.signInWithEmailAndPassword(email, pass);
      authMsg.textContent = 'Signed in.';
      showOverlay(false);
    }catch(e){
      console.error(e);
      authMsg.textContent = e.message || 'Sign-in failed.';
    }
  };
  closeOverlayBtn.onclick = ()=> showOverlay(false);
  signOutBtn.onclick = async ()=>{ try{ await auth.signOut(); location.reload(); }catch(e){} };

  async function loadCurrentUserRole(user){
    CURRENT_USER = user;
    CURRENT_UID = user?.uid || null;
    CURRENT_EMAIL = (user?.email || '').toLowerCase() || null;
    CURRENT_ROLE = 'worker';
    ALLOWED_PROPERTY_IDS = null;

    if (!CURRENT_EMAIL) return;
    const docId = CURRENT_EMAIL.replace(/[^\w.-]/g,'_');
    try{
      const snap = await db.collection('users').doc(docId).get();
      if (snap.exists){
        const data = snap.data() || {};
        CURRENT_ROLE = data.role || 'worker';
        const allowed = data.allowedProperties || [];
        if (Array.isArray(allowed) && allowed.length){
          ALLOWED_PROPERTY_IDS = new Set(allowed);
        }
      }
    }catch(e){
      console.error('loadCurrentUserRole failed', e);
    }
  }

  auth.onAuthStateChanged(async user=>{
    if (user){
      authWho.textContent = user.email || 'Signed in';
      signOutBtn.classList.remove('hidden');
      showOverlay(false);
      try{ await db.enablePersistence({synchronizeTabs:true}); }catch(e){}
      await loadCurrentUserRole(user);
      await initAfterAuth();
    }else{
      authWho.textContent = 'Not signed in';
      signOutBtn.classList.add('hidden');
      showOverlay(true);
    }
  });

  // Load properties
  async function loadProperties(){
    const snap = await db.collection('properties').get();
    let props = [];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      props.push({id:doc.id, name:d.name || '(Property)'});
    });
    props.sort((a,b)=>a.name.localeCompare(b.name));

    if (ALLOWED_PROPERTY_IDS instanceof Set){
      props = props.filter(p=>ALLOWED_PROPERTY_IDS.has(p.id));
    }

    ALL_PROPERTIES = props;

    if (!props.length){
      propSel.innerHTML = '<option value="">(no properties available)</option>';
      filterPropSel.innerHTML = '<option value="">(none)</option>';
      return;
    }

    propSel.innerHTML = props.map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
    filterPropSel.innerHTML = '<option value="">(All properties)</option>' +
      props.map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
  }

  function refreshTransferPropertyOptions(currentPropertyId){
    if (!ALL_PROPERTIES.length) return;
    const html = '<option value="">(choose)</option>' +
      ALL_PROPERTIES
        .filter(p => p.id !== currentPropertyId)
        .map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`)
        .join('');
    transferPropSel.innerHTML = html;
  }

  async function loadPaddocksForProperty(propertyId){
    paddockSel.innerHTML = '<option value="">(loadingâ€¦)</option>';
    toPaddockSel.innerHTML = '<option value="">(loadingâ€¦)</option>';
    if (!propertyId){
      paddockSel.innerHTML = '<option value="">(choose property)</option>';
      toPaddockSel.innerHTML = '<option value="">(choose property)</option>';
      return;
    }
    const snap = await db.collection('paddocks').where('propertyId','==',propertyId).get();
    const pads = [];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      pads.push({id:doc.id, name:d.name || '(paddock)', isYards: !!d.isYards});
    });
    pads.sort((a,b)=>{
      if (a.isYards !== b.isYards) return a.isYards ? -1 : 1;
      return a.name.localeCompare(b.name);
    });
    const html = '<option value="">(choose)</option>' +
      pads.map(p=>`<option value="${p.id}" data-name="${escapeHtml(p.name)}">${escapeHtml(p.name)}${p.isYards?' â€” Yards':''}</option>`).join('');
    paddockSel.innerHTML = html;
    toPaddockSel.innerHTML = html;
  }

  async function loadGaugesForProperty(propertyId){
    gaugeSel.innerHTML = '<option value="">(none)</option>';
    if (!propertyId) return;
    const snap = await db.collection('gauges').where('propertyId','==',propertyId).get();
    const gs = [];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      if (d.active === false) return;
      gs.push({id:doc.id, name:d.name || '(Gauge)'});
    });
    gs.sort((a,b)=>a.name.localeCompare(b.name));
    gaugeSel.innerHTML = '<option value="">(none)</option>' +
      gs.map(g=>`<option value="${g.id}">${escapeHtml(g.name)}</option>`).join('');
  }

  async function loadChemicalsForProperty(propertyId){
    chemSel.innerHTML = '<option value="">(none)</option>';
    chemUnit.value = '';
    if (!propertyId) return;
    const snap = await db.collection('chemicals').where('propertyId','==',propertyId).get();
    const rows = [];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      rows.push({id:doc.id,name:d.name||'(chemical)', unit:d.unit||'', qty:Number(d.quantity||0)});
    });
    rows.sort((a,b)=>a.name.localeCompare(b.name));
    chemSel.innerHTML = '<option value="">(none)</option>' +
      rows.map(c=>`<option value="${c.id}" data-unit="${escapeHtml(c.unit)}">${escapeHtml(c.name)} (${escapeHtml(c.unit)}) â€” ${c.qty}</option>`).join('');
  }

  async function loadSeedsForProperty(propertyId){
    seedSel.innerHTML = '<option value="">(none)</option>';
    seedUnit.value = '';
    if (!propertyId) return;
    const snap = await db.collection('seeds').where('propertyId','==',propertyId).get();
    const rows = [];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      rows.push({id:doc.id,name:d.name||'(seed)', unit:d.unit||'', qty:Number(d.quantity||0)});
    });
    rows.sort((a,b)=>a.name.localeCompare(b.name));
    seedSel.innerHTML = '<option value="">(none)</option>' +
      rows.map(s=>`<option value="${s.id}" data-unit="${escapeHtml(s.unit)}">${escapeHtml(s.name)} (${escapeHtml(s.unit)}) â€” ${s.qty}</option>`).join('');
  }

  async function loadFodderForProperty(propertyId){
    fodderSel.innerHTML = '<option value="">(none)</option>';
    fodderUnit.value = '';
    if (!propertyId) return;
    const snap = await db.collection('fodder').where('propertyId','==',propertyId).get();
    const rows = [];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      rows.push({id:doc.id,name:d.name||'(fodder)', unit:d.unit||'', qty:Number(d.quantity||0)});
    });
    rows.sort((a,b)=>a.name.localeCompare(b.name));
    fodderSel.innerHTML = '<option value="">(none)</option>' +
      rows.map(f=>`<option value="${f.id}" data-unit="${escapeHtml(f.unit)}">${escapeHtml(f.name)} (${escapeHtml(f.unit)}) â€” ${f.qty}</option>`).join('');
  }

  async function refreshStockContext(){
    const propertyId = propSel.value;
    const padName = paddockSel.selectedOptions[0]?.dataset?.name || '';
    if (!propertyId || !padName){
      stockContext.innerHTML = '';
      return;
    }
    try{
      const snap = await db.collection('livestock')
        .where('propertyId','==',propertyId)
        .get();
      const mobs = [];
      snap.forEach(doc=>{
        const d = doc.data() || {};
        if (d.location === padName){
          mobs.push({species:d.species||'Cattle', klass:d.class||'', count:Number(d.count||0)});
        }
      });
      if (!mobs.length){
        stockContext.innerHTML = '<span class="muted small">No livestock recorded in this paddock.</span>';
      }else{
        stockContext.innerHTML = mobs.map(m=>`<span class="pill">${escapeHtml(m.species)} â€” ${escapeHtml(m.klass)}: ${m.count}</span>`).join('');
      }
    }catch(e){
      console.error(e);
      stockContext.innerHTML = '<span class="muted small">Error loading paddock stock.</span>';
    }
  }

  async function refreshClassOptions(){
    const propertyId = propSel.value;
    const padName = paddockSel.selectedOptions[0]?.dataset?.name || '';
    const classes = new Set(SUGGESTED_CLASSES);
    if (propertyId && padName){
      try{
        const snap = await db.collection('livestock').where('propertyId','==',propertyId).get();
        snap.forEach(doc=>{
          const d = doc.data() || {};
          if (d.location === padName && d.species){
            classes.add(String(d.class||'').trim());
          }
        });
      }catch(e){}
    }
    const list = Array.from(classes).filter(Boolean).sort((a,b)=>a.localeCompare(b));
    $('#classOptions').innerHTML = list.map(c=>`<option value="${escapeHtml(c)}"></option>`).join('');
  }

  // Side-effect helpers
  async function adjustChemicalStock(chemId, deltaQty){
    if (!chemId || !deltaQty) return;
    const ref = db.collection('chemicals').doc(chemId);
    try{
      await db.runTransaction(async tx=>{
        const snap = await tx.get(ref);
        if (!snap.exists) return;
        const data = snap.data() || {};
        const current = Number(data.quantity || 0);
        const next = current + deltaQty;
        tx.update(ref,{
          quantity: next,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
    }catch(e){
      console.error('Chemical stock adjustment failed', e);
    }
  }

  async function adjustSeedStock(seedId, deltaQty){
    if (!seedId || !deltaQty) return;
    const ref = db.collection('seeds').doc(seedId);
    try{
      await db.runTransaction(async tx=>{
        const snap = await tx.get(ref);
        if (!snap.exists) return;
        const data = snap.data() || {};
        const current = Number(data.quantity || 0);
        const next = current + deltaQty;
        tx.update(ref,{
          quantity: next,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
    }catch(e){
      console.error('Seed stock adjustment failed', e);
    }
  }

  async function adjustFodderStock(fodderId, deltaQty){
    if (!fodderId || !deltaQty) return;
    const ref = db.collection('fodder').doc(fodderId);
    try{
      await db.runTransaction(async tx=>{
        const snap = await tx.get(ref);
        if (!snap.exists) return;
        const data = snap.data() || {};
        const current = Number(data.quantity || 0);
        const next = current + deltaQty;
        tx.update(ref,{
          quantity: next,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
    }catch(e){
      console.error('Fodder stock adjustment failed', e);
    }
  }

  async function adjustLivestockLine(propertyId, paddockName, species, klass, deltaHead){
    if (!propertyId || !paddockName || !species || !klass || !deltaHead) return;
    const head = Math.round(deltaHead);
    if (!head) return;

    try{
      const snap = await db.collection('livestock').where('propertyId','==',propertyId).get();
      let targetDoc = null;
      snap.forEach(doc=>{
        const d = doc.data() || {};
        if (d.location === paddockName &&
            String(d.species||'').toLowerCase() === String(species).toLowerCase() &&
            String(d.class||'') === String(klass)){
          targetDoc = {ref:doc.ref,data:d};
        }
      });

      if (targetDoc){
        await db.runTransaction(async tx=>{
          const s = await tx.get(targetDoc.ref);
          if (!s.exists) return;
          const d = s.data() || {};
          const current = Number(d.count || 0);
          const next = Math.max(0, current + head);
          tx.update(targetDoc.ref,{
            count: next,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
      }else if (head > 0){
        await db.collection('livestock').add({
          propertyId,
          location:paddockName,
          species,
          class:klass,
          count:head,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }catch(e){
      console.error('adjustLivestockLine failed', e);
    }
  }

  async function moveLivestockWithinProperty(propertyId, fromPaddock, toPaddock, species, klass, head){
    if (!propertyId || !fromPaddock || !toPaddock || !species || !klass || !head) return;
    await adjustLivestockLine(propertyId, fromPaddock, species, klass, -Math.abs(head));
    await adjustLivestockLine(propertyId, toPaddock,   species, klass,  Math.abs(head));
  }

  async function findYardNameForProperty(propertyId){
    if (!propertyId) return null;
    try{
      const snap = await db.collection('paddocks')
        .where('propertyId','==',propertyId)
        .get();
      const yards = [];
      snap.forEach(doc=>{
        const d = doc.data() || {};
        if (d.isYards){
          yards.push(d.name || '(unnamed)');
        }
      });
      yards.sort((a,b)=>String(a||'').localeCompare(String(b||'')));
      return yards[0] || null;
    }catch(e){
      console.error('findYardNameForProperty failed', e);
      return null;
    }
  }

  async function applyRainfallMirror(gaugeId, mm, dateISO){
    const v = Number(mm);
    if (!gaugeId || !Number.isFinite(v) || v<=0 || !dateISO) return;
    const docId = dateISO.slice(0,10);
    const ref = db.collection('gauges').doc(gaugeId).collection('daily').doc(docId);
    try{
      await db.runTransaction(async tx=>{
        const snap = await tx.get(ref);
        const existing = snap.exists ? Number((snap.data()||{}).mm || 0) : 0;
        const next = existing + v;
        tx.set(ref,{
          mm: next,
          source:'diary',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
      });
    }catch(e){
      console.error('applyRainfallMirror failed', e);
    }
  }

  // Activity / purchase visibility
  function updateInputRows(){
    const act = activitySel.value;
    const purchaseType = purchaseTypeSel.value;

    const usesChemActivity =
      act === 'Spraying paddocks' ||
      act === 'Chemical (stock)' ||
      act === 'Trucking (sale)';
    const purchaseChem   = (act === 'Purchase inputs' && purchaseType === 'Chemical');
    const purchaseSeed   = (act === 'Purchase inputs' && purchaseType === 'Seed');
    const purchaseFodder = (act === 'Purchase inputs' && purchaseType === 'Fodder');
    const feedingFodder  = (act === 'Feeding (fodder)');

    chemRow.classList.toggle('hidden', !(usesChemActivity || purchaseChem));
    seedRow.classList.toggle('hidden', !(act === 'Planting' || purchaseSeed));
    fodderRow.classList.toggle('hidden', !(feedingFodder || purchaseFodder));
  }

  function onActivityChange(){
    const act = activitySel.value;
    const needsStock = (
      act === 'Trucking (sale)' ||
      act === 'Move stock' ||
      act === 'Transfer stock (Out)' ||
      act === 'Cattle purchase' ||
      act === 'Chemical (stock)' ||
      act === 'Mustering'
    );
    stockRow.classList.toggle('hidden', !needsStock);

    const needsToPaddock = (act === 'Move stock');
    toPaddockWrap.classList.toggle('hidden', !needsToPaddock);

    const needsTransferProp = (act === 'Transfer stock (Out)');
    transferPropWrap.classList.toggle('hidden', !needsTransferProp);

    const isPurchase = (act === 'Purchase inputs');
    purchaseRow.classList.toggle('hidden', !isPurchase);

    updateInputRows();
  }

  paddockSel.onchange = async ()=>{
    await refreshStockContext();
    await refreshClassOptions();
  };
  speciesSel.onchange = refreshClassOptions;
  activitySel.onchange = onActivityChange;
  purchaseTypeSel.onchange = updateInputRows;
  chemSel.onchange   = ()=> chemUnit.value   = chemSel.selectedOptions[0]?.dataset?.unit   || '';
  seedSel.onchange   = ()=> seedUnit.value   = seedSel.selectedOptions[0]?.dataset?.unit   || '';
  fodderSel.onchange = ()=> fodderUnit.value = fodderSel.selectedOptions[0]?.dataset?.unit || '';

  // Build payload
  function buildPayloadFromUI(){
    const propertyId = propSel.value;
    const propertyName = propSel.selectedOptions[0]?.textContent || '';
    const date = dateInp.value || todayISO();
    const time = timeInp.value || '00:00';
    const activity = activitySel.value;

    const padOpt = paddockSel.selectedOptions[0];
    const paddockId = padOpt?.value || '';
    const paddockName = padOpt?.dataset?.name || '';

    const toPadOpt = toPaddockSel.selectedOptions[0];
    const toPaddockId = toPadOpt?.value || '';
    const toPaddockName = toPadOpt?.dataset?.name || '';

    const transferPropertyId = transferPropSel.value || null;
    const transferPropertyName = transferPropertyId
      ? (ALL_PROPERTIES.find(p=>p.id===transferPropertyId)?.name || '')
      : null;

    const weather = weatherInp.value || '';

    const species = stockRow.classList.contains('hidden') ? null : (speciesSel.value || null);
    const klass = stockRow.classList.contains('hidden') ? null : (classInp.value || null);
    const headVal = stockRow.classList.contains('hidden') ? null : Number(headInp.value || 0);
    const head = headVal && Number.isFinite(headVal) && headVal>0 ? headVal : null;

    const rainVal = Number(rainMmInp.value || 0);
    const rainfallMm = (rainVal>0 && Number.isFinite(rainVal)) ? rainVal : null;
    const gaugeId = gaugeSel.value || null;
    const gaugeName = gaugeSel.selectedOptions[0]?.textContent || null;

    const chemId = chemRow.classList.contains('hidden') ? null : (chemSel.value || null);
    const chemQtyVal = chemRow.classList.contains('hidden') ? null : Number(chemQty.value || 0);
    const chemQtyNum = chemQtyVal && chemQtyVal>0 ? chemQtyVal : null;
    const chemUnitVal = chemRow.classList.contains('hidden') ? null : (chemUnit.value || null);

    const seedId = seedRow.classList.contains('hidden') ? null : (seedSel.value || null);
    const seedQtyVal = seedRow.classList.contains('hidden') ? null : Number(seedQty.value || 0);
    const seedQtyNum = seedQtyVal && seedQtyVal>0 ? seedQtyVal : null;
    const seedUnitVal = seedRow.classList.contains('hidden') ? null : (seedUnit.value || null);

    const fodderId = fodderRow.classList.contains('hidden') ? null : (fodderSel.value || null);
    const fodderQtyVal = fodderRow.classList.contains('hidden') ? null : Number(fodderQty.value || 0);
    const fodderQtyNum = fodderQtyVal && fodderQtyVal>0 ? fodderQtyVal : null;
    const fodderUnitVal = fodderRow.classList.contains('hidden') ? null : (fodderUnit.value || null);

    const notes = notesInp.value || '';

    const purchaseType = purchaseRow.classList.contains('hidden') ? null : (purchaseTypeSel.value || null);
    const purchaseSupplierVal = purchaseRow.classList.contains('hidden') ? null : (purchaseSupplier.value || null);
    const purchaseRefVal = purchaseRow.classList.contains('hidden') ? null : (purchaseRef.value || null);

    const user = auth.currentUser || CURRENT_USER;
    const createdByUid   = user?.uid || CURRENT_UID || null;
    const createdByEmail = (user?.email || CURRENT_EMAIL || null);

    const payload = {
      date,
      time,
      propertyId,
      propertyName,
      activity,
      paddockId: paddockId || null,
      paddock: paddockName || null,
      toPaddockId: toPaddockId || null,
      toPaddock: toPaddockName || null,
      transferPropertyId,
      transferPropertyName,
      notes: notes || null,
      weather: weather || null,

      species: species || null,
      livestockClass: klass || null,
      headCount: head || null,

      chemicalId: chemId || null,
      chemicalQty: chemQtyNum || null,
      chemicalUnit: chemUnitVal || null,

      seedId: seedId || null,
      seedQty: seedQtyNum || null,
      seedUnit: seedUnitVal || null,

      fodderId: fodderId || null,
      fodderQty: fodderQtyNum || null,
      fodderUnit: fodderUnitVal || null,

      rainfallMm,
      gaugeId,
      gaugeName,

      purchaseType,
      purchaseSupplier: purchaseSupplierVal || null,
      purchaseRef: purchaseRefVal || null,

      createdByUid,
      createdByEmail,
      createdByRole: CURRENT_ROLE || null,

      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    return {
      payload,
      propertyId,
      activity,
      paddockName,
      toPaddockName,
      transferPropertyId,
      species,
      klass,
      head,
      chemId,
      chemQty:chemQtyNum,
      seedId,
      seedQty:seedQtyNum,
      fodderId,
      fodderQty:fodderQtyNum,
      gaugeId,
      rainfallMm
    };
  }

  // Save
  async function saveEntry(){
    if (!propSel.value){
      alert('Choose a property.');
      return;
    }
    const {
      payload,
      propertyId,
      activity,
      paddockName,
      toPaddockName,
      transferPropertyId,
      species,
      klass,
      head,
      chemId,
      chemQty,
      seedId,
      seedQty,
      fodderId,
      fodderQty,
      gaugeId,
      rainfallMm
    } = buildPayloadFromUI();

    if (activity === 'Move stock'){
      if (!paddockName || !toPaddockName) {
        alert('For Move cattle choose FROM and TO paddocks.');
        return;
      }
      if (!klass || !head){
        alert('For Move cattle set Class and Head.');
        return;
      }
    }
    if (activity === 'Trucking (sale)' || activity === 'Cattle purchase'){
      if (!paddockName || !klass || !head){
        alert('For stock movements set paddock, class and head.');
        return;
      }
    }
    if (activity === 'Transfer stock (Out)'){
      if (!paddockName || !transferPropertyId || !klass || !head){
        alert('For transfer set FROM paddock, TO property, class and head.');
        return;
      }
    }
    if (activity === 'Rainfall'){
      if (!gaugeId || !rainfallMm){
        alert('For Rainfall choose a gauge and enter mm.');
        return;
      }
    }
    if (activity === 'Planting' && (!seedId || !seedQty)){
      alert('For Planting choose a seed and quantity.');
      return;
    }
    if (activity === 'Feeding (fodder)' && (!fodderId || !fodderQty)){
      alert('For Feeding choose a fodder and quantity.');
      return;
    }
    if (activity === 'Purchase inputs' && payload.purchaseType === 'Fodder' && (!fodderId || !fodderQty)){
      alert('For Fodder purchases choose a fodder item and quantity.');
      return;
    }

    try{
      setStatus('Savingâ€¦');
      await db.collection('diaryEntries').add(payload);

      const sideEffects = [];

      // Chemical use / purchases
      if (chemId && chemQty){
        const chemDelta = (activity === 'Purchase inputs' && payload.purchaseType === 'Chemical') ? chemQty : -chemQty;
        sideEffects.push(adjustChemicalStock(chemId, chemDelta));
      }

      // Seed use / purchases
      if (activity === 'Planting' && seedId && seedQty){
        sideEffects.push(adjustSeedStock(seedId, -seedQty));
      }else if (activity === 'Purchase inputs' && payload.purchaseType === 'Seed' && seedId && seedQty){
        sideEffects.push(adjustSeedStock(seedId, +seedQty));
      }

      // Fodder use / purchases
      if (activity === 'Feeding (fodder)' && fodderId && fodderQty){
        sideEffects.push(adjustFodderStock(fodderId, -fodderQty));
      }else if (activity === 'Purchase inputs' && payload.purchaseType === 'Fodder' && fodderId && fodderQty){
        sideEffects.push(adjustFodderStock(fodderId, +fodderQty));
      }

      // Livestock movements
      if (activity === 'Trucking (sale)' && paddockName && species && klass && head){
        sideEffects.push(adjustLivestockLine(propertyId, paddockName, species, klass, -head));
      }else if (activity === 'Cattle purchase' && paddockName && species && klass && head){
        sideEffects.push(adjustLivestockLine(propertyId, paddockName, species, klass, +head));
      }else if (activity === 'Move stock' && paddockName && toPaddockName && species && klass && head){
        sideEffects.push(moveLivestockWithinProperty(propertyId, paddockName, toPaddockName, species, klass, head));
      }else if (activity === 'Transfer stock (Out)' && paddockName && transferPropertyId && species && klass && head){
        // subtract from current paddock
        sideEffects.push(adjustLivestockLine(propertyId, paddockName, species, klass, -head));
        // add to yards on destination property
        sideEffects.push((async ()=>{
          const yardName = await findYardNameForProperty(transferPropertyId);
          if (!yardName){
            console.warn('No yard paddock found on destination property for transfer', {transferPropertyId});
            return;
          }
          await adjustLivestockLine(transferPropertyId, yardName, species, klass, +head);
        })());
      }
      // Mustering: no stock change

      // Rainfall mirror
      if (activity === 'Rainfall' && gaugeId && rainfallMm){
        sideEffects.push(applyRainfallMirror(gaugeId, rainfallMm, payload.date));
      }

      await Promise.all(sideEffects);

      setStatus('Saved');
      setSaveMsg('Saved.', 1500);
      await refreshEntries();
    }catch(e){
      console.error(e);
      setStatus('Save failed', true);
      setSaveMsg('Save failed.', 3000);
    }
  }

  // Recent entries (table + cards)
  async function refreshEntries(){
    entriesBody.innerHTML = '<tr><td colspan="11" class="muted small">Loadingâ€¦</td></tr>';
    if (entriesCards){
      entriesCards.innerHTML = '<div class="muted small">Loadingâ€¦</div>';
    }
    try{
      const snap = await db.collection('diaryEntries')
        .orderBy('date','desc')
        .limit(200)
        .get();
      const rows = [];
      snap.forEach(doc=>{
        rows.push({id:doc.id, ...(doc.data()||{})});
      });

      // Build user filter options
      const existingSelection = filterUserSel.value || '';
      const userSet = new Set();
      rows.forEach(r=>{
        if (r.createdByEmail){
          const email = String(r.createdByEmail).toLowerCase();
          const u = USERS[email];
          const label = u && u.firstName ? u.firstName : email.split('@')[0];
          if (label) userSet.add(label);
        }
      });
      const userList = Array.from(userSet).sort((a,b)=>a.localeCompare(b));

      const isWorker = CURRENT_ROLE === 'worker';
      if (isWorker){
        // worker can't filter by user; they only see themselves
        filterUserSel.parentElement.style.display = 'none';
      }else{
        filterUserSel.parentElement.style.display = '';
        let optionsHtml = '<option value="">All users</option>';
        optionsHtml += userList.map(u=>`<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`).join('');
        filterUserSel.innerHTML = optionsHtml;
        if (existingSelection && userList.includes(existingSelection)){
          filterUserSel.value = existingSelection;
        }
      }

      const yearFilter = parseInt(filterYear.value || '', 10) || null;
      const propFilter = filterPropSel.value || '';
      const selectedUser = (filterUserSel.value || '').trim();

      const workerUid = CURRENT_UID;
      const workerEmail = (CURRENT_EMAIL || '').toLowerCase();

      let filtered = rows.filter(r=>{
        if (yearFilter){
          if (!r.date || String(r.date).slice(0,4) !== String(yearFilter)) return false;
        }
        if (propFilter && r.propertyId !== propFilter) return false;

        // role-based visibility
        if (isWorker){
          const uidMatch = r.createdByUid && workerUid && r.createdByUid === workerUid;
          const emailMatch = r.createdByEmail && workerEmail &&
            String(r.createdByEmail).toLowerCase() === workerEmail;
          if (!(uidMatch || emailMatch)) return false;
        }

        if (!isWorker && selectedUser){
          const email = (r.createdByEmail || '').toLowerCase();
          const u = USERS[email];
          const label = u && u.firstName ? u.firstName : (email ? email.split('@')[0] : '');
          if (label !== selectedUser) return false;
        }

        return true;
      });

      // Sort
      const sortMode = sortSel.value || 'dateDesc';
      filtered.sort((a,b)=>{
        const dateA = String(a.date || '');
        const dateB = String(b.date || '');
        const timeA = String(a.time || '');
        const timeB = String(b.time || '');

        const getUserName = (r)=>{
          const email = (r.createdByEmail || '').toLowerCase();
          const u = USERS[email];
          return u && u.firstName ? u.firstName : (email ? email.split('@')[0] : '');
        };
        const userA = getUserName(a);
        const userB = getUserName(b);

        if (sortMode === 'dateAsc'){
          if (dateA !== dateB) return dateA.localeCompare(dateB);
          return timeA.localeCompare(timeB);
        }
        if (sortMode === 'dateDesc'){
          if (dateA !== dateB) return dateB.localeCompare(dateA);
          return timeB.localeCompare(timeA);
        }
        if (sortMode === 'userAsc'){
          const cmp = userA.localeCompare(userB);
          if (cmp !== 0) return cmp;
          if (dateA !== dateB) return dateB.localeCompare(dateA);
          return timeB.localeCompare(timeA);
        }
        if (sortMode === 'userDesc'){
          const cmp = userB.localeCompare(userA);
          if (cmp !== 0) return cmp;
          if (dateA !== dateB) return dateB.localeCompare(dateA);
          return timeB.localeCompare(timeA);
        }
        return 0;
      });

      if (!filtered.length){
        entriesBody.innerHTML = '<tr><td colspan="11" class="muted small">No entries.</td></tr>';
        if (entriesCards){
          entriesCards.innerHTML = '<div class="muted small">No entries.</div>';
        }
        return;
      }

      const canDeleteEntry = (r)=>{
        if (CURRENT_ROLE !== 'worker') return true;
        const uidMatch = r.createdByUid && CURRENT_UID && r.createdByUid === CURRENT_UID;
        const emailMatch = r.createdByEmail && CURRENT_EMAIL &&
          String(r.createdByEmail).toLowerCase() === CURRENT_EMAIL;
        return uidMatch || emailMatch;
      };

      const userLabelFor = r=>{
        if (!r.createdByEmail) return '';
        const email = String(r.createdByEmail).toLowerCase();
        const u = USERS[email];
        if (u && u.firstName) return u.firstName;
        return email.split('@')[0];
      };

      // Build table rows
      const tableHtml = filtered.map(r=>{
        const stock = r.headCount ? `${r.headCount} ${r.species||''} ${r.livestockClass||''}`.trim() : '';

        let inputs = '';
        if (r.purchaseType){
          inputs = r.purchaseType;
          const bits = [];
          if (r.chemicalId && r.chemicalQty) bits.push(`${r.chemicalQty} ${r.chemicalUnit||''} chem`);
          if (r.seedId && r.seedQty)       bits.push(`${r.seedQty} ${r.seedUnit||''} seed`);
          if (r.fodderId && r.fodderQty)   bits.push(`${r.fodderQty} ${r.fodderUnit||''} fodder`);
          if (bits.length) inputs += ' (' + bits.join('; ') + ')';
        }else{
          if (r.chemicalId && r.chemicalQty) inputs = `${r.chemicalQty} ${r.chemicalUnit||''} chem`;
          else if (r.seedId && r.seedQty)    inputs = `${r.seedQty} ${r.seedUnit||''} seed`;
          else if (r.fodderId && r.fodderQty)inputs = `${r.fodderQty} ${r.fodderUnit||''} fodder`;
        }

        const rain = r.rainfallMm != null ? Number(r.rainfallMm).toFixed(1) : '';
        const notes = [r.notes||'', r.weather||''].filter(Boolean).join(' Â· ');

        const userLabel = userLabelFor(r);

        const delHtml = canDeleteEntry(r)
          ? `<button type="button" class="btn small danger" data-del="${r.id}">Delete</button>`
          : '';

        return `<tr data-id="${r.id}">
          <td class="nowrap">${escapeHtml(r.date||'')}</td>
          <td class="nowrap">${escapeHtml(r.time||'')}</td>
          <td>${escapeHtml(r.propertyName||'')}</td>
          <td>${escapeHtml(r.paddock||'')}</td>
          <td>${escapeHtml(r.activity||'')}</td>
          <td>${escapeHtml(stock)}</td>
          <td>${escapeHtml(inputs)}</td>
          <td>${escapeHtml(rain)}</td>
          <td>${escapeHtml(notes)}</td>
          <td>${escapeHtml(userLabel)}</td>
          <td class="no-print">${delHtml}</td>
        </tr>`;
      }).join('');
      entriesBody.innerHTML = tableHtml;

      // Build mobile cards
      if (entriesCards){
        const cardsHtml = filtered.map(r=>{
          const stock = r.headCount ? `${r.headCount} ${r.species||''} ${r.livestockClass||''}`.trim() : '';

          let inputs = '';
          if (r.purchaseType){
            inputs = r.purchaseType;
            const bits = [];
            if (r.chemicalId && r.chemicalQty) bits.push(`${r.chemicalQty} ${r.chemicalUnit||''} chem`);
            if (r.seedId && r.seedQty)       bits.push(`${r.seedQty} ${r.seedUnit||''} seed`);
            if (r.fodderId && r.fodderQty)   bits.push(`${r.fodderQty} ${r.fodderUnit||''} fodder`);
            if (bits.length) inputs += ' (' + bits.join('; ') + ')';
          }else{
            if (r.chemicalId && r.chemicalQty) inputs = `${r.chemicalQty} ${r.chemicalUnit||''} chem`;
            else if (r.seedId && r.seedQty)    inputs = `${r.seedQty} ${r.seedUnit||''} seed`;
            else if (r.fodderId && r.fodderQty)inputs = `${r.fodderQty} ${r.fodderUnit||''} fodder`;
          }

          const rain = r.rainfallMm != null ? Number(r.rainfallMm).toFixed(1) : '';
          const notes = [r.notes||'', r.weather||''].filter(Boolean).join(' Â· ');

          const userLabel = userLabelFor(r);

          const delHtml = canDeleteEntry(r)
            ? `<button type="button" class="btn small danger" data-del="${r.id}">Delete</button>`
            : '';

          return `<div class="entry-card" data-id="${r.id}">
            <div class="ec-header">
              <div>${escapeHtml(r.date || '')}</div>
              <div>${escapeHtml(r.time || '')}</div>
            </div>
            <div class="ec-line">
              <span class="ec-label">Property</span>${escapeHtml(r.propertyName || '')}
            </div>
            ${userLabel ? `<div class="ec-line"><span class="ec-label">User</span>${escapeHtml(userLabel)}</div>` : ''}
            ${r.paddock ? `<div class="ec-line"><span class="ec-label">Paddock</span>${escapeHtml(r.paddock)}</div>` : ''}
            <div class="ec-line ec-activity">${escapeHtml(r.activity || '')}</div>
            ${stock ? `<div class="ec-line"><span class="ec-label">Stock</span>${escapeHtml(stock)}</div>` : ''}
            ${inputs ? `<div class="ec-line"><span class="ec-label">Inputs</span>${escapeHtml(inputs)}</div>` : ''}
            ${rain ? `<div class="ec-line"><span class="ec-label">Rain</span>${escapeHtml(rain)} mm</div>` : ''}
            ${notes ? `<div class="ec-line ec-notes">${escapeHtml(notes)}</div>` : ''}
            <div class="ec-actions no-print">
              ${delHtml}
            </div>
          </div>`;
        }).join('');
        entriesCards.innerHTML = cardsHtml;
      }

      // Wire delete buttons
      const delButtons = document.querySelectorAll('#entriesBody button[data-del], #entriesCards button[data-del]');
      delButtons.forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.del;
          if (!id) return;
          const ok = confirm('Delete this diary entry? This does NOT undo stock/chemical/seed/fodder/rainfall changes.');
          if (!ok) return;
          try{
            await db.collection('diaryEntries').doc(id).delete();
            await refreshEntries();
          }catch(e){
            console.error(e);
            alert('Delete failed, see console.');
          }
        };
      });
    }catch(e){
      console.error(e);
      entriesBody.innerHTML = '<tr><td colspan="11" class="muted small">Error loading entries.</td></tr>';
      if (entriesCards){
        entriesCards.innerHTML = '<div class="muted small">Error loading entries.</div>';
      }
    }
  }

  // Init after auth
  async function initAfterAuth(){
    dateInp.value = todayISO();
    const now = new Date();
    timeInp.value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    filterYear.value = now.getFullYear();

    // Load users for name lookup (doc id is email with special chars replaced)
    try{
      const usersSnap = await db.collection('users').get();
      USERS = {};
      usersSnap.forEach(doc=>{
        const d = doc.data() || {};
        const docId = doc.id || '';
        const emailGuess = docId.replace(/_/g,'.').toLowerCase();
        const fullName = (d.name || '').trim();
        const firstName = fullName ? fullName.split(' ')[0] : (emailGuess.split('@')[0] || '');
        USERS[emailGuess] = {
          fullName: fullName || null,
          firstName
        };
      });
    }catch(e){
      console.error('Loading users for names failed', e);
      USERS = {};
    }

    await loadProperties();
    if (propSel.options.length && propSel.value){
      await loadPaddocksForProperty(propSel.value);
      await loadGaugesForProperty(propSel.value);
      await loadChemicalsForProperty(propSel.value);
      await loadSeedsForProperty(propSel.value);
      await loadFodderForProperty(propSel.value);
      refreshTransferPropertyOptions(propSel.value);
    }

    onActivityChange();

    propSel.onchange = async ()=>{
      await loadPaddocksForProperty(propSel.value);
      await loadGaugesForProperty(propSel.value);
      await loadChemicalsForProperty(propSel.value);
      await loadSeedsForProperty(propSel.value);
      await loadFodderForProperty(propSel.value);
      refreshTransferPropertyOptions(propSel.value);
      await refreshStockContext();
    };

    $('#saveBtn').onclick = saveEntry;
    $('#resetBtn').onclick = ()=>{
      notesInp.value = '';
      weatherInp.value = '';
      headInp.value = '';
      classInp.value = '';
      rainMmInp.value = '';
      gaugeSel.selectedIndex = 0;
      chemSel.selectedIndex = 0;
      chemQty.value = '';
      chemUnit.value = '';
      seedSel.selectedIndex = 0;
      seedQty.value = '';
      seedUnit.value = '';
      fodderSel.selectedIndex = 0;
      fodderQty.value = '';
      fodderUnit.value = '';
      purchaseSupplier.value = '';
      purchaseRef.value = '';
    };
    $('#refreshBtn').onclick = refreshEntries;
    $('#printBtn').onclick = ()=>window.print();
    sortSel.onchange = refreshEntries;
    filterUserSel.onchange = refreshEntries;
    filterPropSel.onchange = refreshEntries;
    filterYear.onchange = refreshEntries;

    await refreshEntries();
  }

  // Kick off
  window.addEventListener('load', ()=>{
    setStatus('Ready');
  });
</script>
</body>
</html>
