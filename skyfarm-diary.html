<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SkyFarm â€” Diary</title>

  <!-- Firebase compat SDKs (same major as your Chemicals page) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    :root { --brand:#0B7A6E; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#f6fbf8; }
    * { box-sizing:border-box; }
    html,body { height:100%; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
           margin:0; background:var(--bg); color:var(--ink); }

    /* Header (match Chemicals look) */
    #sf-header { position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--line); }
    #sf-header .bar { display:flex; align-items:center; gap:14px; padding:10px 16px; }
    #sf-header .brand { display:flex; align-items:center; gap:8px; color:var(--brand); text-decoration:none; font-weight:700; }
    #sf-header nav a { color:var(--brand); text-decoration:none; font-weight:600; margin-right:10px; }
    #sf-header nav a[aria-current="page"] { text-decoration:underline; }
    .spacer { flex:1; }
    .muted { color:var(--muted); font-size:.9rem; }

    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { margin: 10px 0 14px; font-size: 1.6rem; }

    .card { background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0; }
    .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; align-items:center; }
    label { display:block; font-size:.9rem; color:#475569; margin-bottom:4px; }
    input, select, button { padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; font:inherit; }
    button { cursor:pointer; }
    .btn { border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
    .primary { background:var(--brand); color:#fff; border-color:var(--brand); }
    .danger { background:#ef4444; color:#fff; border-color:#ef4444; }
    .disabled { opacity:.55; pointer-events:none; }
    .small { font-size:.9rem; }
    .w110 { width:110px; } .w140 { width:140px; } .w200 { width:200px; } .w240 { width:240px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#e2e8f0; font-size:.8rem; border:1px solid #cbd5e1; }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid var(--line); padding:8px; text-align:left; vertical-align:top; }
    th { background:#f1f5f9; }

    /* Action queue */
    #actionQueue { margin-top:8px; }
    #actionQueue .item { display:flex; flex-wrap:wrap; gap:8px; align-items:center; padding:8px; border:1px dashed #d1d5db; border-radius:10px; background:#fafafa; }
    #actionQueue .item .meta { font-size:.9rem; color:#334155; }
    #actionQueue .item .remove { margin-left:auto; }

    /* Sign-in overlay */
    #authOverlay{position:fixed; inset:0; background:rgba(15,23,42,.08); display:none; align-items:center; justify-content:center; z-index:50}
    #authCard{width:min(520px,92vw); background:#fff; border:1px solid var(--line); border-radius:16px; padding:20px}
    #authCard h2{margin:0 0 8px}
  </style>
</head>
<body>
  <!-- Simple header (matches Chemicals page) -->
  <header id="sf-header">
    <div class="bar">
      <a class="brand" href="skyfarm-diary.html">ðŸŒ± SkyFarm</a>
      <nav>
        <a href="skyfarm-diary.html" aria-current="page">Diary</a>
        <a href="skyfarm-map.html">Map</a>
        <a href="skyfarm-chemical.html">Chemicals</a>
      </nav>
      <span class="spacer"></span>
      <span id="authWho" class="muted">Checking sign-inâ€¦</span>
      <button id="signOutBtn" class="btn danger" style="display:none;">Sign out</button>
    </div>
  </header>

  <div class="wrap">
    <h1>Diary</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>Property</label>
          <select id="propSel" class="w240"></select>
        </div>
        <div>
          <label>Date</label>
          <input id="dateInp" type="date" class="w140"/>
        </div>
        <div>
          <label>Time</label>
          <input id="timeInp" type="time" class="w110"/>
        </div>
        <div>
          <label>Activity</label>
          <select id="activitySel" class="w240">
            <option>Mustering / Moving stock</option>
            <option>Trucking (sale)</option>
            <option>Transfer stock (Out)</option>
            <option>Transfer stock (In)</option>
            <option>Spraying paddocks</option>
            <option>Chemical (stock)</option>
            <option>Ploughing</option>
            <option>Planting</option>
            <option>Other</option>
          </select>
        </div>
        <span class="spacer"></span>
        <div class="muted small" id="status">â€”</div>
      </div>

      <div class="row">
        <div style="min-width:260px">
          <label>Paddock</label>
          <select id="paddockSel" class="w240"><option value="">(choose)</option></select>
          <div class="small muted">Yards paddocks appear first.</div>
        </div>
        <div style="flex:1; min-width:260px">
          <label>Notes</label>
          <input id="notesInp" placeholder="optional"/>
        </div>
      </div>

      <div class="row">
        <button id="addActionBtn" class="btn">Add action</button>
        <button id="saveAllBtn" class="primary">Save all actions</button>
        <span id="msg" class="muted"></span>
        <span class="spacer"></span>
        <button id="resetBtn" class="btn">Reset form</button>
      </div>

      <!-- Action queue preview -->
      <div id="actionQueue" class="row" style="display:none; flex-direction:column; gap:8px;"></div>
    </div>

    <div class="card">
      <div class="row">
        <strong>Recent entries</strong>
        <span class="spacer"></span>
        <div>
          <label>Year</label>
          <input id="yearInp" type="number" min="2000" max="2100" class="w110"/>
        </div>
        <button id="refreshBtn" class="btn">Refresh</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Property</th><th>Activity</th><th>Paddock</th><th>Notes</th>
          </tr>
        </thead>
        <tbody id="entriesTbody"><tr><td colspan="5">Loadingâ€¦</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Sign-in overlay -->
  <div id="authOverlay">
    <div id="authCard">
      <h2>Sign in to SkyFarm</h2>
      <p class="small muted">Email &amp; password only. Anonymous sign-in is disabled.</p>
      <div class="row">
        <div style="flex:1; min-width:260px">
          <label>Email</label>
          <input id="siEmail" type="email" autocomplete="username" placeholder="you@example.com"/>
        </div>
        <div style="flex:1; min-width:220px">
          <label>Password</label>
          <input id="siPass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
        </div>
      </div>
      <div class="row">
        <button id="signInBtn" class="primary">Sign in</button>
        <span id="authMsg" class="muted small"></span>
        <span class="spacer"></span>
        <button id="closeOverlayBtn" class="btn">Close</button>
      </div>
    </div>
  </div>

  <!-- EVERYTHING below lives in a real <script> tag so the browser executes it -->
  <script>
    /* -------------------------------------------------------
       Firebase init (compat) â€” WEB KEYS (public by design)
    ------------------------------------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
      authDomain: "consentes-pastoral.firebaseapp.com",
      projectId: "consentes-pastoral",
      appId: "1:494858780013:web:d87497b370c82eeab06e64"
    };
    firebase.initializeApp(firebaseConfig);
    const db   = firebase.firestore();
    const auth = firebase.auth();

    /* -------------------------------------------------------
       Helpers & constants
    ------------------------------------------------------- */
    const $ = s => document.querySelector(s);
    const setMsg = (t, ms=3000)=>{ $('#msg').textContent=t||''; if(t && ms) setTimeout(()=>$('#msg').textContent='', ms); };
    const setStatus = t => $('#status').textContent = t || '';
    const todayISO = () => new Date().toISOString().slice(0,10);
    const escapeHtml = s => String(s ?? '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    const yBounds = (y)=>({ start:`${y}-01-01`, end:`${y}-12-31` });

    // Your three properties (from your screenshots)
    const PROPERTY_IDS = {
      "Consentes": "s7PIDM9wrEpxuJ6DGlab",
      "Mt Myrtle": "TRuxtRBx2zJIwZnRGYKJ",
      "Gerawin":   "P0dQ0H2FWHeqqxejfJzS"
    };
    const PROPERTY_NAME_BY_ID = Object.fromEntries(Object.entries(PROPERTY_IDS).map(([n,i])=>[i,n]));

    /* -------------------------------------------------------
       Sign-in overlay (Email/Password only)
    ------------------------------------------------------- */
    const overlay = $('#authOverlay');
    const authWho = $('#authWho');
    const signOutBtn = $('#signOutBtn');

    function showOverlay(show){ overlay.style.display = show ? 'flex' : 'none'; }

    $('#signInBtn').onclick = async ()=>{
      const email = $('#siEmail').value.trim();
      const pass  = $('#siPass').value;
      $('#authMsg').textContent = 'Signing inâ€¦';
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        await auth.signInWithEmailAndPassword(email, pass);
        $('#authMsg').textContent = 'Signed in.';
        showOverlay(false);
        await afterSignIn();
      }catch(e){
        $('#authMsg').textContent = 'Sign-in failed: ' + (e?.message || e?.code || 'Unknown error');
      }
    };
    $('#closeOverlayBtn').onclick = ()=> showOverlay(false);
    signOutBtn.onclick = async ()=>{ try{ await auth.signOut(); location.reload(); }catch(e){} };

    function requireAuth(){
      return new Promise(resolve=>{
        auth.onAuthStateChanged(u=>{
          if(u){
            authWho.textContent = u.email ? `Signed in as ${u.email}` : 'Signed in';
            signOutBtn.style.display = 'inline-flex';
            showOverlay(false);
            resolve(true);
          }else{
            authWho.textContent = 'Not signed in';
            signOutBtn.style.display = 'none';
            showOverlay(true);
            resolve(false);
          }
        });
      });
    }

    async function afterSignIn(){
      await initProperties();
      await onPropertyChange(); // loads paddocks for the selected property
      await refreshEntries();
    }

    /* -------------------------------------------------------
       Properties & Paddocks
    ------------------------------------------------------- */
    const propSel     = $('#propSel');
    const paddockSel  = $('#paddockSel');

    async function initProperties(){
      // Build property list
      propSel.innerHTML = Object.keys(PROPERTY_IDS)
        .sort()
        .map(n=>`<option value="${PROPERTY_IDS[n]}">${n}</option>`)
        .join('');
      // Default to Mt Myrtle (requested)
      const DEFAULT_ID = PROPERTY_IDS["Mt Myrtle"];
      if (DEFAULT_ID) propSel.value = DEFAULT_ID;

      propSel.onchange = onPropertyChange;
    }

    async function onPropertyChange(){
      const pid = propSel.value;
      if(!pid){ paddockSel.innerHTML='<option value="">(choose property)</option>'; return; }
      paddockSel.innerHTML = '<option value="">(loadingâ€¦)</option>';
      setStatus('Loading paddocksâ€¦');

      try{
        const snap = await db.collection('paddocks').where('propertyId','==',pid).get();
        const paddocks = [];
        snap.forEach(d => paddocks.push({ id:d.id, ...(d.data()||{}) }));

        // Yards first (isYards true), then by name
        paddocks.sort((a,b)=>{
          const ay = a.isYards ? 1 : 0, by = b.isYards ? 1 : 0;
          if (by - ay !== 0) return by - ay;
          const an = String(a.name||'').toLowerCase(), bn = String(b.name||'').toLowerCase();
          return an.localeCompare(bn);
        });

        if (!paddocks.length){
          paddockSel.innerHTML = '<option value="">(no paddocks found)</option>';
        } else {
          paddockSel.innerHTML =
            '<option value="">(choose)</option>' +
            paddocks.map(p => `<option value="${p.id}" data-name="${escapeHtml(p.name||'')}">${escapeHtml(p.name||'(unnamed)')}</option>`).join('');
        }
        setStatus('');
      }catch(e){
        console.error(e);
        paddockSel.innerHTML = '<option value="">(load error)</option>';
        setStatus('Paddocks load error');
      }
    }

    /* -------------------------------------------------------
       Multi-action queue & Save
    ------------------------------------------------------- */
    const dateInp     = $('#dateInp');
    const timeInp     = $('#timeInp');
    const activitySel = $('#activitySel');
    const notesInp    = $('#notesInp');

    const addActionBtn = $('#addActionBtn');
    const saveAllBtn   = $('#saveAllBtn');
    const resetBtn     = $('#resetBtn');
    const actionQueue  = $('#actionQueue');

    let queued = []; // { propertyId, propertyName, date, time, activity, paddockId, paddockName, notes }

    dateInp.value = todayISO();
    $('#yearInp').value = new Date().getFullYear();

    addActionBtn.onclick = ()=>{
      const propId = propSel.value;
      if (!propId) return alert('Choose a property');
      const propName = PROPERTY_NAME_BY_ID[propId] || '(Unknown)';

      const paddockId = paddockSel.value || null;
      const paddockName = paddockSel.selectedOptions[0]?.dataset?.name || '';

      const item = {
        propertyId: propId,
        propertyName: propName,
        date: dateInp.value || todayISO(),
        time: timeInp.value || '',
        activity: activitySel.value,
        paddockId,
        paddockName: paddockName || null,
        notes: notesInp.value || ''
      };
      queued.push(item);
      renderQueue();
      setMsg('Action added to queue.', 1500);
    };

    function renderQueue(){
      if (!queued.length){ actionQueue.style.display='none'; actionQueue.innerHTML=''; return; }
      actionQueue.style.display = 'flex';
      actionQueue.innerHTML = queued.map((q,i)=>`
        <div class="item">
          <div class="meta">
            <strong>${escapeHtml(q.propertyName)}</strong> Â· ${escapeHtml(q.activity)}
            ${q.paddockName ? ` Â· ${escapeHtml(q.paddockName)}` : ''} Â· ${escapeHtml(q.date)} ${escapeHtml(q.time||'')}
            ${q.notes ? ` â€” ${escapeHtml(q.notes)}` : ''}
          </div>
          <button class="btn danger remove" data-i="${i}">Remove</button>
        </div>
      `).join('');
      actionQueue.querySelectorAll('.remove').forEach(btn=>{
        btn.onclick = ()=>{ const i = Number(btn.dataset.i); queued.splice(i,1); renderQueue(); };
      });
    }

    saveAllBtn.onclick = async ()=>{
      if (!queued.length) return alert('Add at least one action first.');
      try{
        setMsg('Savingâ€¦', 4000);
        const batch = db.batch();
        queued.forEach(q=>{
          const ref = db.collection('diaryEntries').doc();
          batch.set(ref, {
            propertyId: q.propertyId, propertyName: q.propertyName,
            date: q.date, time: q.time,
            activity: q.activity,
            paddockId: q.paddockId || null, paddock: q.paddockName || null,
            notes: q.notes || '',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge:true });
        });
        await batch.commit();
        queued = []; renderQueue();
        setMsg('Saved all actions.');
        await refreshEntries();
      }catch(e){
        console.error(e);
        alert('Save failed: ' + (e?.message||e));
      }
    };

    resetBtn.onclick = ()=>{
      dateInp.value = todayISO();
      timeInp.value = '';
      activitySel.value = 'Mustering / Moving stock';
      paddockSel.value = '';
      notesInp.value = '';
      queued = []; renderQueue();
      setMsg('Form reset.', 1200);
    };

    /* -------------------------------------------------------
       Recent entries (simple list by year)
    ------------------------------------------------------- */
    const entriesTbody = $('#entriesTbody');
    $('#refreshBtn').onclick = refreshEntries;

    async function refreshEntries(){
      entriesTbody.innerHTML = '<tr><td colspan="5">Loadingâ€¦</td></tr>';
      try{
        const y = Number($('#yearInp').value || new Date().getFullYear());
        const {start, end} = yBounds(y);
        let q = db.collection('diaryEntries')
                  .where('date','>=',start)
                  .where('date','<=',end)
                  .orderBy('date','desc')
                  .limit(100);
        const snap = await q.get();
        const rows = [];
        snap.forEach(doc=>{
          const d = { id:doc.id, ...(doc.data()||{}) };
          rows.push(`<tr>
            <td>${escapeHtml(d.date||'')}</td>
            <td>${escapeHtml(d.propertyName||'')}</td>
            <td>${escapeHtml(d.activity||'')}</td>
            <td>${escapeHtml(d.paddock||'')}</td>
            <td>${escapeHtml(d.notes||'')}</td>
          </tr>`);
        });
        entriesTbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="5">No entries.</td></tr>';
      }catch(e){
        console.error(e);
        entriesTbody.innerHTML = '<tr><td colspan="5">Load failed (console).</td></tr>';
      }
    }

    /* -------------------------------------------------------
       Bootstrap
    ------------------------------------------------------- */
    (async function init(){
      setStatus('Connectingâ€¦');
      await requireAuth();            // shows overlay if not signed in
      if (auth.currentUser){
        setStatus('Connected');
        await afterSignIn();
      }
    })();
  </script>
</body>
</html>
