<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SkyFarm — Diary</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>

  <style>
    :root { --brand:#0B7A6E; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#f6fbf8; margin:16px; color:#0f172a; }
    h1 { margin:0 0 12px; font-size:1.6rem; }
    .wrap { max-width:1100px; margin:0 auto; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:12px 0; }
    .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; }
    label { display:block; font-size:.9rem; color:#475569; margin-bottom:4px; }
    input, select, button { padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
    button { cursor:pointer; }
    .primary { background:var(--brand); border-color:var(--brand); color:#fff; }
    .danger { background:#ef4444; border-color:#ef4444; color:#fff; }
    .muted { color:#64748b; font-size:.9rem; }
    .spacer { flex:1; }
    .hidden { display:none; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #e5e7eb; padding:8px; text-align:left; }
    th { background:#f1f5f9; }
    .nowrap { white-space:nowrap; }
    .pill { padding:2px 8px; border-radius:999px; background:#e2e8f0; font-size:.8rem; }
    .w80 { width:80px; } .w110 { width:110px; } .w140 { width:140px; } .w200 { width:200px; }
    .status-ok { color:#0B7A6E; } .status-warn { color:#9a3412; }
    .small { font-size:.9rem; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>SkyFarm — Diary</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Property</label>
        <select id="propSel" style="min-width:240px"></select>
      </div>
      <div>
        <label>Date</label>
        <input id="dateInp" type="date" />
      </div>
      <div>
        <label>Time</label>
        <input id="timeInp" type="time" />
      </div>
      <div>
        <label>Activity</label>
        <select id="activitySel" style="min-width:220px">
          <option value="Ploughing">Ploughing</option>
          <option value="Planting">Planting</option>
          <option value="Spraying paddocks">Spraying paddocks</option>
          <option value="Chemical (stock)">Chemical (stock)</option>
          <option value="Trucking (sale)">Trucking (sale)</option>
          <option value="Move stock">Move stock</option>
          <option value="Mustering">Mustering</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <span class="spacer"></span>
      <div>
        <label>&nbsp;</label>
        <span id="status" class="muted">Connecting…</span>
      </div>
    </div>

    <div class="row">
      <div style="min-width:260px">
        <label>Paddock</label>
        <select id="paddockSel" style="min-width:260px"><option value="">(choose)</option></select>
      </div>
      <div style="min-width:260px; flex:1">
        <label>Notes</label>
        <input id="notesInp" placeholder="optional" />
      </div>
    </div>

    <!-- Rainfall -->
    <div class="row">
      <div>
        <label>Rain gauge</label>
        <select id="gaugeSel" style="min-width:260px"><option value="">(choose)</option></select>
      </div>
      <div>
        <label>Rainfall (mm)</label>
        <input id="rainMm" type="number" min="0" step="0.1" class="w110" />
      </div>
      <div class="muted">Adds to gauge total and per-day totals; auto-reverts on edit/delete.</div>
    </div>

    <!-- Chemical (spraying/stock/trucking backline) -->
    <div id="chemRow" class="row hidden">
      <div>
        <label>Chemical</label>
        <select id="chemSel" style="min-width:260px"><option value="">(choose)</option></select>
      </div>
      <div>
        <label>Qty used</label>
        <input id="chemQty" type="number" min="0" step="0.01" class="w110" />
      </div>
      <div>
        <label>Unit</label>
        <input id="chemUnit" placeholder="KG/L" class="w80" disabled />
      </div>
      <div><label>&nbsp;</label><span id="chemHint" class="pill">context</span></div>
    </div>

    <!-- Livestock (trucking/moves/stock chem/mustering) -->
    <div id="stockRow" class="row hidden">
      <div>
        <label>Species</label>
        <select id="speciesSel">
          <option value="Cattle">Cattle</option>
          <option value="Sheep">Sheep</option>
          <option value="Goats">Goats</option>
        </select>
      </div>
      <div>
        <label>Class</label>
        <input id="classInp" placeholder="e.g. Weaners" class="w200" list="classOptions"/>
        <datalist id="classOptions"></datalist>
      </div>
      <div>
        <label>Head</label>
        <input id="headInp" type="number" min="0" step="1" class="w110" />
      </div>
      <div>
        <label>Buyer / Dest (Trucking)</label>
        <input id="truckBuyer" placeholder="e.g. Roma" class="w200" />
      </div>
      <div>
        <label>Docket / Ref</label>
        <input id="truckRef" placeholder="NVD / docket" class="w200" />
      </div>
    </div>

    <!-- MUSTERING -->
    <div id="musterBox" class="card hidden" style="margin-top:8px">
      <div class="row"><strong>Mustering details</strong></div>

      <div class="row small" id="musterContext" style="gap:6px; color:#334155;"></div>

      <div class="row">
        <div>
          <label>Expected (auto)</label>
          <input id="mExp" type="number" class="w110" disabled />
        </div>
        <div>
          <label>Actual</label>
          <input id="mAct" type="number" class="w110" />
        </div>
        <div>
          <label>Delta (auto)</label>
          <input id="mDelta" type="number" class="w110" disabled />
        </div>
        <div style="flex:1; min-width:260px">
          <label>Reason / notes</label>
          <input id="mReason" placeholder="e.g. counted late, moved to North 2…" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Add calves</label>
          <input id="mAddCalves" type="number" class="w110" />
        </div>
        <div>
          <label>Add weaners</label>
          <input id="mAddWeaners" type="number" class="w110" />
        </div>
        <div class="spacer"></div>
        <button id="addClassRowBtn">Add class row</button>
      </div>

      <div class="row">
        <strong>Reclass / counts by class</strong>
      </div>
      <div class="row">
        <table id="mClassTable">
          <thead>
            <tr>
              <th>Class</th>
              <th>Expected</th>
              <th>New count</th>
              <th>Reclass to</th>
              <th>Qty</th>
              <th>Missing</th>
            </tr>
          </thead>
        <tbody id="mClassBody"><tr><td colspan="6">Pick property + paddock + species to load current classes…</td></tr></tbody>
        </table>
      </div>
      <div class="muted">Set a <em>New count</em> to overwrite a class total, or use <em>Reclass to + Qty</em> to move headcounts between classes. Use <em>Missing</em> to hold animals that didn’t turn up — they’re tracked against the current financial year.</div>
    </div>

    <div class="row">
      <button id="saveBtn" class="primary">Save entry</button>
      <button id="cancelEditBtn" class="hidden">Cancel edit</button>
      <button id="resetBtn">Reset</button>
      <span id="msg" class="muted" aria-live="polite"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <strong>Recent entries</strong>
      <span class="spacer"></span>
      <label>Year</label>
      <input id="yearInp" type="number" min="2000" max="2100" class="w110" />
      <button id="exportCsvBtn">Export CSV</button>
      <button id="printBtn">Print year</button>
      <button id="refreshBtn">Refresh</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Property</th><th>Activity</th><th>Paddock</th><th>Rain (mm)</th><th>Chemical</th><th>Head</th><th></th>
        </tr>
      </thead>
      <tbody id="entriesTbody"><tr><td colspan="8">Loading…</td></tr></tbody>
    </table>
  </div>
</div>

<script>
/*** Firebase ***/
const firebaseConfig = {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/*** Helpers ***/
const $ = s => document.querySelector(s);
const setStatus = t => { const el=$('#status'); el.textContent = t||''; el.className = t?.toLowerCase().includes('connected') ? 'status-ok' : 'status-warn'; };
const setMsg = (t, ms=3000) => { $('#msg').textContent = t||''; if(t&&ms) setTimeout(()=>$('#msg').textContent='', ms); };
const todayISO = () => new Date().toISOString().slice(0,10);
const escapeHtml = s => String(s ?? '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
const yBounds = (y)=>({ start:`${y}-01-01`, end:`${y}-12-31` });
const fmtDateKey = d => d;
function fyLabel(dateStr){ const [y,m]=dateStr.split('-').map(Number); return (m>=7)?`${y}-${String(y+1).slice(2)}`:`${y-1}-${String(y).slice(2)}`; }
function missingDocId({propertyId, paddock, species, cls, fy}){ const safe=s=>String(s||'').replace(/[^\w.-]/g,'_'); return `${safe(propertyId)}__${safe(paddock)}__${safe(species)}__${safe(cls)}__${safe(fy)}`; }

/*** URL params (from Map) ***/
const url = new URL(location.href);
const urlPropId   = url.searchParams.get('propertyId') || '';
const urlPropName = url.searchParams.get('propertyName') || '';
const urlPaddock  = url.searchParams.get('paddock') || '';
const urlChemOnly = url.searchParams.get('chemOnly') === 'true';

/*** Suggested classes ***/
const SUGGESTED_CLASSES = ["Cows","Heifers","Bulls","Steers","PTIC cows","Joined cows","Calves","Weaners"];

/*** Properties ***/
const propertyIds = {
  "Consentes":"s7PlDM9wrEpxuJ6DGIab",
  "Mt Myrtle":"TRuxtRBx2zJlwZnRGYKJ",
  "Gerawin":"P0dQ0H2FWHeqqxejflZs"
};
const propertyNameById = Object.fromEntries(Object.entries(propertyIds).map(([n,i])=>[i,n]));

/*** Elements ***/
const propSel = $('#propSel'), dateInp = $('#dateInp'), timeInp = $('#timeInp'), activitySel = $('#activitySel');
const paddockSel = $('#paddockSel'), notesInp = $('#notesInp');
const gaugeSel = $('#gaugeSel'), rainMm = $('#rainMm');
const chemRow = $('#chemRow'), chemSel = $('#chemSel'), chemQty = $('#chemQty'), chemUnit = $('#chemUnit'), chemHint = $('#chemHint');
const stockRow = $('#stockRow'), speciesSel = $('#speciesSel'), classInp = $('#classInp'), headInp = $('#headInp'), truckBuyer=$('#truckBuyer'), truckRef=$('#truckRef');
const musterBox = $('#musterBox'), mExp=$('#mExp'), mAct=$('#mAct'), mDelta=$('#mDelta'), mReason=$('#mReason'), mAddCalves=$('#mAddCalves'), mAddWeaners=$('#mAddWeaners'), mClassBody=$('#mClassBody'), addClassRowBtn=$('#addClassRowBtn'), musterContext=$('#musterContext');
const saveBtn = $('#saveBtn'), cancelEditBtn = $('#cancelEditBtn'), entriesTbody = $('#entriesTbody');
const yearInp = $('#yearInp'), exportCsvBtn = $('#exportCsvBtn'), printBtn = $('#printBtn');
const classOptions = $('#classOptions');

/*** Caches / state ***/
let paddocks=[], gauges=[], chems=[], entries=[];
let editingId = null, originalEntry = null;

/*** Bootstrap ***/
(async function init(){
  try {
    try { await firebase.firestore().enablePersistence({synchronizeTabs:true}); } catch(e) { console.warn('Persistence not available:', e && e.code); }
    setStatus('Connecting…');
    await auth.signInAnonymously().catch(err=>{ console.warn('Anon auth failed:', err?.code, err?.message); });
    setStatus('Connected');
  } catch(e){ console.error(e); setStatus('Auth issue (check Anonymous Sign-in & Authorized domains)'); }

  // properties (+ All)
  propSel.innerHTML = '<option value="ALL">(All properties)</option>' +
    Object.keys(propertyIds).map(n=>`<option value="${propertyIds[n]}">${n}</option>`).join('');
  dateInp.value = todayISO(); yearInp.value = new Date().getFullYear();

  // events
  activitySel.onchange = onActivityChange;
  propSel.onchange = onPropertyChange;
  $('#refreshBtn').onclick = refreshEntries;
  $('#resetBtn').onclick = ()=>resetForm(false);
  cancelEditBtn.onclick = ()=>{ resetForm(false); setMsg('Edit cancelled'); };
  saveBtn.onclick = ()=> saveEntry().catch(e=>{console.error(e); setMsg('Save failed');});
  exportCsvBtn.onclick = exportYearCsv;
  printBtn.onclick = printYear;
  addClassRowBtn.onclick = addMusterClassRow;
  paddockSel.onchange = onPaddockOrSpeciesChange;
  speciesSel.onchange = onPaddockOrSpeciesChange;
  mAct.oninput = ()=>{ mDelta.value = (Number(mAct.value||0) - Number(mExp.value||0)) || 0; };

  onActivityChange();

  // Preselect from URL (map deep-link)
  if (urlPropId || urlPropName){
    const pid = urlPropId || propertyIds[urlPropName] || '';
    if (pid && propSel.querySelector(`option[value="${pid}"]`)) propSel.value = pid;
  }
  await onPropertyChange();

  // If paddock provided via URL, attempt fuzzy-select
  if (urlPaddock) { trySelectPaddockByName(urlPaddock); }

  // If chemOnly flag from map, pre-pick “Spraying paddocks”
  if (urlChemOnly) { activitySel.value = 'Spraying paddocks'; onActivityChange(); }

  await refreshEntries();
})();

/*** UI Toggles ***/
function onActivityChange(){
  const act = activitySel.value;
  const needsChem = (act==='Spraying paddocks' || act==='Chemical (stock)' || act==='Trucking (sale)');
  chemRow.classList.toggle('hidden', !needsChem);
  chemHint.textContent = (act==='Spraying paddocks') ? 'paddock spray' : (act==='Trucking (sale)' ? 'backline before transport' : 'stock treatment');

  const needsStock = (act==='Trucking (sale)' || act==='Move stock' || act==='Chemical (stock)' || act==='Mustering');
  stockRow.classList.toggle('hidden', !needsStock);

  musterBox.classList.toggle('hidden', act!=='Mustering');
  saveBtn.disabled = (propSel.value==='ALL');

  buildChemDropdown();
}

/*** Property change: load paddocks, gauges, chems ***/
async function onPropertyChange(){
  const pid = propSel.value;
  if (pid==='ALL'){
    paddockSel.innerHTML = '<option value="">(choose a property to select paddock)</option>';
    gaugeSel.innerHTML = '<option value="">(choose a property to select gauge)</option>';
    chemSel.innerHTML = '<option value="">(choose a property to select chemical)</option>';
    classOptions.innerHTML = '';
    saveBtn.disabled = true;
    mClassBody.innerHTML = '<tr><td colspan="6">Pick property + paddock + species to load current classes…</td></tr>';
    musterContext.innerHTML = '';
  } else {
    saveBtn.disabled = false;

    // paddocks
    paddocks=[]; paddockSel.innerHTML='<option>(loading…)</option>';
    (await db.collection('paddocks').where('propertyId','==',pid).get())
      .forEach(d=>paddocks.push({id:d.id, ...d.data()}));
    paddockSel.innerHTML='<option value="">(choose)</option>'+paddocks.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))
      .map(p=>`<option value="${p.id}" data-name="${escapeHtml(p.name||'')}">${escapeHtml(p.name||'(unnamed)')}</option>`).join('');

    // gauges
    gauges=[]; gaugeSel.innerHTML='<option>(loading…)</option>';
    (await db.collection('gauges').where('propertyId','==',pid).get())
      .forEach(d=>gauges.push({id:d.id, ...d.data()}));
    gaugeSel.innerHTML='<option value="">(choose)</option>'+gauges.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))
      .map(g=>`<option value="${g.id}" data-name="${escapeHtml(g.name||'')}">${escapeHtml(g.name||'(unnamed)')}</option>`).join('');

    // chems
    chems=[]; chemSel.innerHTML='<option>(loading…)</option>';
    (await db.collection('chemicals').where('propertyId','==',pid).get())
      .forEach(d=>chems.push({id:d.id, ...d.data()}));
    buildChemDropdown();

    await onPaddockOrSpeciesChange();
  }
}

/*** Fuzzy paddock select for deep-links from Map ***/
const norm = s => String(s||'').toLowerCase().trim();
const strip = s => norm(s).replace(/[^a-z0-9]+/g,'');
function trySelectPaddockByName(name){
  const target = strip(name);
  if (!target) return;
  for (const opt of paddockSel.options){
    if (norm(opt.dataset?.name||'') === norm(name)) { paddockSel.value = opt.value; return; }
  }
  let bestOpt=null, bestScore=0;
  for (const opt of paddockSel.options){
    const s = strip(opt.dataset?.name||'');
    if (!s) continue;
    if (s.includes(target) || target.includes(s)) { paddockSel.value = opt.value; return; }
    const score = commonPrefix(s,target).length;
    if (score>bestScore){ bestScore=score; bestOpt=opt; }
  }
  if (bestOpt) paddockSel.value = bestOpt.value;
}
function commonPrefix(a,b){ let i=0; for(; i<Math.min(a.length,b.length); i++){ if(a[i]!==b[i]) break; } return a.slice(0,i); }

/*** Chemical dropdown (filtered by use) ***/
function buildChemDropdown(){
  const pid = propSel.value;
  if(pid==='ALL'){ chemSel.innerHTML='<option value="">(choose property)</option>'; chemUnit.value=''; return; }
  const act = activitySel.value;
  const target = act==='Spraying paddocks' ? 'paddock' : (act==='Chemical (stock)' || act==='Trucking (sale)' ? 'stock' : null);
  if(!target){ chemSel.innerHTML='<option value="">(not required)</option>'; chemUnit.value=''; return; }
  const list = chems.filter(c => String(c.useOn||'').toLowerCase()===target && Number(c.quantity||0)>0);
  if(!list.length){ chemSel.innerHTML='<option value="">(no chemicals available)</option>'; chemUnit.value=''; return; }
  chemSel.innerHTML = '<option value="">(choose chemical)</option>' +
    list.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))
        .map(c=>`<option value="${c.id}" data-unit="${c.unit||''}">${escapeHtml(c.name||'Unnamed')} (${c.unit||''}) — ${Number(c.quantity||0)} left</option>`).join('');
  chemSel.onchange = ()=> chemUnit.value = chemSel.selectedOptions[0]?.dataset?.unit || '';
  chemUnit.value = chemSel.selectedOptions[0]?.dataset?.unit || '';
}

/*** Case/field tolerant fetch of livestock rows for a paddock ***/
async function fetchLivestockRows(pid, paddockName, speciesUI){
  const speciesLC = String(speciesUI||'').toLowerCase();

  let snap = await db.collection('livestock')
    .where('propertyId','==',pid)
    .where('location','==',paddockName)
    .where('species','==',speciesUI)
    .get();

  if (snap.empty){
    const title = speciesLC.charAt(0).toUpperCase() + speciesLC.slice(1);
    const variants = [title, speciesLC.toUpperCase()];
    for (const v of variants){
      const s2 = await db.collection('livestock')
        .where('propertyId','==',pid)
        .where('location','==',paddockName)
        .where('species','==',v)
        .get();
      if (!s2.empty){ snap = s2; break; }
    }
  }

  let rows = [];
  if (snap.empty){
    const s3 = await db.collection('livestock')
      .where('propertyId','==',pid)
      .where('location','==',paddockName)
      .get();
    s3.forEach(d => rows.push({ id:d.id, ...(d.data()||{}) }));
    rows = rows.filter(r => String(r.species||'').toLowerCase() === speciesLC);
  } else {
    snap.forEach(d => rows.push({ id:d.id, ...(d.data()||{}) }));
  }
  return rows;
}

/*** Expected totals & mustering table build ***/
async function onPaddockOrSpeciesChange(){
  const pid = propSel.value;
  if (pid==='ALL'){ classOptions.innerHTML=''; return; }

  const paddockName = (paddockSel.selectedOptions[0]?.dataset?.name || '').trim();
  const speciesUI = speciesSel.value || 'Cattle';
  if (!paddockName){
    classOptions.innerHTML=''; musterContext.innerHTML='';
    mClassBody.innerHTML='<tr><td colspan="6">Pick property + paddock + species…</td></tr>';
    mExp.value=''; return;
  }

  let rows = await fetchLivestockRows(pid, paddockName, speciesUI);
  rows.sort((a,b)=>String(a.class||'').localeCompare(String(b.class||'')));

  classOptions.innerHTML = rows.map(r=>`<option value="${escapeHtml(r.class||'')}"></option>`).join('');

  const act = activitySel.value;
  if (rows.length===1 && (act==='Trucking (sale)' || act==='Move stock' || act==='Chemical (stock)')){
    classInp.value = rows[0].class || '';
    headInp.value = Number(rows[0].count||0);
  }

  if (activitySel.value==='Mustering'){
    const total = rows.reduce((s,r)=>s+Number(r.count||0),0);
    mExp.value = total;
    mDelta.value = (Number(mAct.value||0) - Number(mExp.value||0)) || 0;

    const parts = rows.map(r=>`${escapeHtml(r.class||'')}: ${Number(r.count||0)}`);
    musterContext.innerHTML = `<span class="pill">Expected total: ${total}</span> ${parts.length? ' | ' + parts.join(', ') : ''}`;

    const existingClasses = new Set(rows.map(r=>String(r.class||'')));
    for (const cls of SUGGESTED_CLASSES){
      if (!existingClasses.has(cls)) rows.push({ id:null, class:cls, count:0, _new:true });
    }

    mClassBody.innerHTML = rows.map(r=>`
      <tr data-id="${r.id||''}" data-class="${escapeHtml(r.class||'')}">
        <td><input class="mc-class w200" value="${escapeHtml(r.class||'')}" ${r.id ? 'disabled' : ''} /></td>
        <td><input class="mc-current w110" value="${Number(r.count||0)}" disabled /></td>
        <td><input class="mc-new w110" type="number" min="0" /></td>
        <td><input class="mc-to w200" placeholder="e.g. Cows, Heifers, Joined cows" /></td>
        <td><input class="mc-qty w110" type="number" min="0" /></td>
        <td><input class="mc-miss w110" type="number" min="0" /></td>
      </tr>`).join('');
  }
}

function addMusterClassRow(){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="mc-class w200" placeholder="New class name" /></td>
    <td><input class="mc-current w110" value="0" disabled /></td>
    <td><input class="mc-new w110" type="number" min="0" /></td>
    <td><input class="mc-to w200" placeholder="e.g. Cows, Heifers, Joined cows" /></td>
    <td><input class="mc-qty w110" type="number" min="0" /></td>
    <td><input class="mc-miss w110" type="number" min="0" /></td>`;
  mClassBody.appendChild(tr);
}

/*** Save / Update (revert old -> apply new) ***/
async function saveEntry(){
  if (propSel.value==='ALL') return alert('Select a specific property to save.');
  const propId = propSel.value, propName = propertyNameById[propId] || '(unknown)';
  const date = dateInp.value || todayISO(), time = timeInp.value || '';
  const activity = activitySel.value;
  const paddockId = paddockSel.value || '', paddockName = paddockSel.selectedOptions[0]?.dataset?.name || '';
  const notes = notesInp.value || '';
  const gaugeId = gaugeSel.value || null, gaugeName = gaugeSel.selectedOptions[0]?.dataset?.name || null, rainfallVal = gaugeId ? Number(rainMm.value || 0) : null;
  const species = speciesSel.value || '', klass = classInp.value || '', head = parseInt(headInp.value||0,10);
  const chemId = chemSel.value || null, chemQ = parseFloat(chemQty.value||0), chemU = chemUnit.value || '', chemName = chemId ? (chems.find(c=>c.id===chemId)?.name || null) : null;

  if ((activity==='Spraying paddocks' || activity==='Chemical (stock)' || activity==='Trucking (sale)') && chemId && !(chemQ>0))
    return alert('Enter a chemical quantity > 0');

  const musterOps = [];
  if (activity==='Mustering'){
    document.querySelectorAll('#mClassBody tr').forEach(tr=>{
      const cls = tr.querySelector('.mc-class')?.value?.trim();
      if (!cls) return;
      const cur = Number(tr.querySelector('.mc-current')?.value||0);
      const newCount = tr.querySelector('.mc-new')?.value ? Number(tr.querySelector('.mc-new').value) : null;
      const to = tr.querySelector('.mc-to')?.value?.trim();
      const qty = tr.querySelector('.mc-qty')?.value ? Number(tr.querySelector('.mc-qty').value) : 0;
      const miss = tr.querySelector('.mc-miss')?.value ? Number(tr.querySelector('.mc-miss').value) : 0;
      const id = tr.getAttribute('data-id') || null;
      musterOps.push({id, cls, cur, newCount, to, qty, miss});
    });
  }

  const fy = fyLabel(date);

  const payload = {
    propertyId: propId, propertyName: propName,
    date, time, activity,
    paddockId: paddockId || null, paddock: paddockName || null,
    notes,
    rainfallGaugeId: gaugeId, rainfallGaugeName: gaugeName, rainfallMm: rainfallVal,
    species: (['Trucking (sale)','Move stock','Chemical (stock)','Mustering'].includes(activity)) ? species : null,
    livestockClass: (['Trucking (sale)','Move stock','Chemical (stock)'].includes(activity)) ? klass : null,
    headCount: (['Trucking (sale)','Move stock'].includes(activity)) ? head : null,
    chemicalId: chemId || null, chemicalName: chemName, chemQty: chemId ? chemQ : null, chemUnit: chemId ? chemU : null,
    truckBuyer: activity==='Trucking (sale)' ? (truckBuyer.value || '') : null,
    truckRef:   activity==='Trucking (sale)' ? (truckRef.value || '') : null,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    musterExpected: activity==='Mustering' ? Number(mExp.value||0) : null,
    musterActual:   activity==='Mustering' ? Number(mAct.value||0) : null,
    musterDelta:    activity==='Mustering' ? (Number(mAct.value||0) - Number(mExp.value||0)) : null,
    musterReason:   activity==='Mustering' ? (mReason.value || '') : null,
    musterAdds:     activity==='Mustering' ? { calves:Number(mAddCalves.value||0), weaners:Number(mAddWeaners.value||0) } : null,
    musterMissing:  activity==='Mustering' ? musterOps.filter(r=>r.miss>0).map(r=>({cls:r.cls, qty: Number(r.miss||0), fy})) : null
  };

  try{
    await db.runTransaction(async (tx)=>{
      let entryId = editingId || db.collection('diaryEntries').doc().id;
      const entryRef = db.collection('diaryEntries').doc(entryId);

      // revert OLD effects if editing
      if (editingId){
        const oldSnap = await tx.get(entryRef);
        if (oldSnap.exists){
          const old = oldSnap.data() || {};
          if (old.chemicalId && Number(old.chemQty||0)>0){
            const cref = db.collection('chemicals').doc(old.chemicalId);
            const cs = await tx.get(cref); if (cs.exists) tx.update(cref, {quantity:Number(cs.data().quantity||0)+Number(old.chemQty||0)});
          }
          if (old.activity==='Trucking (sale)' && Number(old.headCount||0)>0 && old.species && old.livestockClass && old.paddock){
            const q = db.collection('livestock').where('propertyId','==',old.propertyId).where('location','==',old.paddock).where('species','==',old.species).where('class','==',old.livestockClass);
            const s = await tx.get(q); s.forEach(doc=>{ const cur=Number((doc.data()||{}).count||0); tx.update(db.collection('livestock').doc(doc.id), {count:cur+Number(old.headCount||0)}); });
          }
          if (old.rainfallGaugeId && Number(old.rainfallMm||0)>0){
            const gref = db.collection('gauges').doc(old.rainfallGaugeId); const gs = await tx.get(gref);
            if (gs.exists){
              tx.update(gref,{ rainTotal: firebase.firestore.FieldValue.increment(-Number(old.rainfallMm||0)), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
              const dayRef = gref.collection('daily').doc(fmtDateKey(old.date || todayISO()));
              tx.set(dayRef, { mm: firebase.firestore.FieldValue.increment(-Number(old.rainfallMm||0)) , date: fmtDateKey(old.date || todayISO()) }, { merge:true });
              tx.set(gref.collection('readings').doc(entryId), { date: old.date || todayISO(), mm: 0, diaryEntryId: entryId }, { merge:true });
            }
          }
          if (Array.isArray(old.musterMissing)){
            for (const m of old.musterMissing){
              const mid = missingDocId({propertyId: old.propertyId, paddock: old.paddock, species: old.species, cls: m.cls, fy: m.fy});
              const mref = db.collection('missingStock').doc(mid);
              tx.set(mref, {
                propertyId: old.propertyId, location: old.paddock, species: old.species,
                class: m.cls, fy: m.fy, count: firebase.firestore.FieldValue.increment(-Number(m.qty||0)),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              }, { merge:true });
            }
          }
        }
      }

      // apply NEW effects
      if (payload.chemicalId && Number(payload.chemQty||0)>0){
        const cref = db.collection('chemicals').doc(payload.chemicalId);
        const csnap = await tx.get(cref); if(!csnap.exists) throw new Error('Chemical not found');
        const next = Number(csnap.data().quantity||0) - Number(payload.chemQty||0);
        if (next < -0.0001) throw new Error('Not enough chemical in inventory'); tx.update(cref, {quantity: next});
      }
      if (payload.activity==='Trucking (sale)' && Number(payload.headCount||0)>0 && payload.species && payload.livestockClass && payload.paddock){
        const q = db.collection('livestock').where('propertyId','==',payload.propertyId).where('location','==',payload.paddock).where('species','==',payload.species).where('class','==',payload.livestockClass);
        const s = await tx.get(q); s.forEach(doc=>{ const cur=Number((doc.data()||{}).count||0); const next=cur-Number(payload.headCount||0); if(next<0) throw new Error('Trucking would make class count negative'); tx.update(db.collection('livestock').doc(doc.id), {count: next}); });
      }
      if (payload.rainfallGaugeId && Number(payload.rainfallMm||0)>0){
        const gref = db.collection('gauges').doc(payload.rainfallGaugeId);
        const gs = await tx.get(gref); if(!gs.exists) throw new Error('Gauge not found');
        tx.update(gref, { rainTotal: firebase.firestore.FieldValue.increment(Number(payload.rainfallMm||0)), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        const dayRef = gref.collection('daily').doc(fmtDateKey(payload.date));
        tx.set(dayRef, { date: fmtDateKey(payload.date), mm: firebase.firestore.FieldValue.increment(Number(payload.rainfallMm||0)) }, { merge:true });
        tx.set(gref.collection('readings').doc(entryId), { date: payload.date, mm: Number(payload.rainfallMm||0), diaryEntryId: entryId }, { merge:true });
      }
      if (activity==='Mustering'){
        const baseQ = db.collection('livestock').where('propertyId','==',propId).where('location','==',paddockName).where('species','==',species);
        const baseSnap = await tx.get(baseQ);
        const byClass = {}; baseSnap.forEach(doc=> byClass[doc.data().class] = { id: doc.id, count: Number(doc.data().count||0) });

        for (const r of musterOps){
          if (r.newCount!=null && r.cls){
            if (byClass[r.cls]){ tx.update(db.collection('livestock').doc(byClass[r.cls].id), { count: Number(r.newCount) }); byClass[r.cls].count = Number(r.newCount); }
            else { const newRef=db.collection('livestock').doc(); tx.set(newRef,{propertyId:propId, location:paddockName, species, class:r.cls, count:Number(r.newCount)}); byClass[r.cls]={id:newRef.id, count:Number(r.newCount)}; }
          }
        }
        for (const r of musterOps){
          if (r.to && r.qty>0 && r.cls){
            const from = byClass[r.cls] || null; if (!from) continue;
            if (from.count - r.qty < 0) throw new Error(`Reclass from ${r.cls} would go negative`);
            tx.update(db.collection('livestock').doc(from.id), { count: from.count - r.qty }); from.count -= r.qty;
            if (byClass[r.to]){ tx.update(db.collection('livestock').doc(byClass[r.to].id), { count: byClass[r.to].count + r.qty }); byClass[r.to].count += r.qty; }
            else { const n=db.collection('livestock').doc(); tx.set(n,{propertyId:propId, location:paddockName, species, class:r.to, count:r.qty}); byClass[r.to]={id:n.id,count:r.qty}; }
          }
        }
        const addOps = [
          {to:'Calves', qty:Number(mAddCalves.value||0)},
          {to:'Weaners', qty:Number(mAddWeaners.value||0)}
        ];
        for (const a of addOps){
          if (a.qty>0){
            if (byClass[a.to]){ tx.update(db.collection('livestock').doc(byClass[a.to].id), {count: byClass[a.to].count + a.qty}); byClass[a.to].count += a.qty; }
            else { const n=db.collection('livestock').doc(); tx.set(n,{propertyId:propId, location:paddockName, species, class:a.to, count:a.qty}); byClass[a.to]={id:n.id,count:a.qty}; }
          }
        }
        const newMissing = [];
        for (const r of musterOps){
          if (r.miss>0){
            const mid = missingDocId({propertyId: propId, paddock: paddockName, species, cls: r.cls, fy});
            const mref = db.collection('missingStock').doc(mid);
            tx.set(mref, {
              propertyId: propId, location: paddockName, species, class: r.cls, fy,
              count: firebase.firestore.FieldValue.increment(Number(r.miss||0)),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge:true });
            newMissing.push({cls:r.cls, qty:Number(r.miss||0), fy});
          }
        }
        payload.musterMissing = newMissing.length ? newMissing : null;
      }

      if (editingId){
        tx.update(entryRef, payload);
      } else {
        tx.set(entryRef, { ...payload, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
    });

    setMsg(editingId ? 'Updated' : 'Saved');
    resetForm(false);
    await refreshEntries();
    if (activitySel.value==='Mustering') onPaddockOrSpeciesChange();
  } catch(e){ console.error(e); alert('Save failed: ' + e.message); }
}

/*** Entries & actions ***/
async function refreshEntries(){
  entriesTbody.innerHTML = '<tr><td colspan="8">Loading…</td></tr>';
  let q = db.collection('diaryEntries').orderBy('date','desc').limit(200);
  const pid = propSel.value; if (pid!=='ALL') q = q.where('propertyId','==',pid);
  const snap = await q.get(); entries=[]; snap.forEach(doc=> entries.push({id:doc.id, ...doc.data()}));
  renderEntries();
}

function renderEntries(){
  const tb = entriesTbody; tb.innerHTML='';
  if(!entries.length){ tb.innerHTML='<tr><td colspan="8">No entries</td></tr>'; return; }
  for (const r of entries){
    const chem = r.chemicalName ? `${escapeHtml(r.chemicalName)} ${r.chemQty||''} ${r.chemUnit||''}` : '';
    const rain = (r.rainfallMm!=null) ? String(r.rainfallMm) : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(r.date||'')}</td>
      <td>${escapeHtml(r.propertyName||'')}</td>
      <td>${escapeHtml(r.activity||'')}</td>
      <td>${escapeHtml(r.paddock||'')}</td>
      <td>${rain}</td>
      <td>${chem}</td>
      <td>${r.headCount||''}</td>
      <td class="nowrap">
        <button data-e>Edit</button>
        <button data-d class="danger">Delete</button>
      </td>`;
    tr.querySelector('[data-e]').onclick = () => startEdit(r.id);
    tr.querySelector('[data-d]').onclick = () => deleteEntry(r.id);
    tb.appendChild(tr);
  }
}

async function startEdit(id){
  const doc = await db.collection('diaryEntries').doc(id).get();
  if(!doc.exists) return alert('Entry not found');
  const r = doc.data(); editingId = id; originalEntry = r;

  if (propSel.value !== r.propertyId){ propSel.value = r.propertyId; await onPropertyChange(); }

  dateInp.value = r.date || todayISO(); timeInp.value = r.time || '';
  activitySel.value = r.activity || 'Other'; onActivityChange();

  if (r.paddockId && paddockSel.querySelector(`option[value="${r.paddockId}"]`)) paddockSel.value = r.paddockId; else paddockSel.value = '';
  if (r.rainfallGaugeId && gaugeSel.querySelector(`option[value="${r.rainfallGaugeId}"]`)) gaugeSel.value = r.rainfallGaugeId; else gaugeSel.value = '';
  rainMm.value = (r.rainfallMm!=null) ? r.rainfallMm : '';

  speciesSel.value = r.species || 'Cattle';
  classInp.value = r.livestockClass || '';
  headInp.value = r.headCount || '';

  if (r.chemicalId && chemSel.querySelector(`option[value="${r.chemicalId}"]`)) chemSel.value = r.chemicalId; else chemSel.value='';
  chemQty.value = r.chemQty || ''; chemUnit.value = r.chemUnit || '';

  mExp.value = r.musterExpected || '';
  mAct.value = r.musterActual || '';
  mDelta.value = (r.musterDelta!=null)? r.musterDelta : '';
  mReason.value = r.musterReason || '';
  mAddCalves.value = r?.musterAdds?.calves || '';
  mAddWeaners.value = r?.musterAdds?.weaners || '';

  if (activitySel.value==='Mustering') await onPaddockOrSpeciesChange();

  saveBtn.textContent = 'Save changes';
  cancelEditBtn.classList.remove('hidden');
}

async function deleteEntry(id){
  if(!confirm('Delete this diary entry?')) return;
  try{
    await db.runTransaction(async (tx)=>{
      const ref = db.collection('diaryEntries').doc(id);
      const snap = await tx.get(ref);
      if (snap.exists){
        const r = snap.data();

        if (r.chemicalId && Number(r.chemQty||0)>0){
          const cref = db.collection('chemicals').doc(r.chemicalId);
          const cs = await tx.get(cref);
          if (cs.exists) tx.update(cref, { quantity: Number(cs.data().quantity||0) + Number(r.chemQty||0) });
        }
        if (r.activity==='Trucking (sale)' && Number(r.headCount||0)>0 && r.species && r.livestockClass && r.paddock){
          const q = db.collection('livestock')
            .where('propertyId','==', r.propertyId)
            .where('location','==', r.paddock)
            .where('species','==', r.species)
            .where('class','==', r.livestockClass);
          const s = await tx.get(q);
          s.forEach(doc=>{ const cur = Number((doc.data()||{}).count||0); tx.update(db.collection('livestock').doc(doc.id), { count: cur + Number(r.headCount||0) }); });
        }
        if (r.rainfallGaugeId && Number(r.rainfallMm||0)>0){
          const gref = db.collection('gauges').doc(r.rainfallGaugeId);
          const gs = await tx.get(gref);
          if (gs.exists){
            tx.update(gref, { rainTotal: firebase.firestore.FieldValue.increment(-Number(r.rainfallMm||0)), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
            const dayRef = gref.collection('daily').doc(fmtDateKey(r.date || todayISO()));
            tx.set(dayRef, { date: fmtDateKey(r.date || todayISO()), mm: firebase.firestore.FieldValue.increment(-Number(r.rainfallMm||0)) }, { merge:true });
            tx.set(gref.collection('readings').doc(id), { date: r.date || todayISO(), mm: 0, diaryEntryId: id }, { merge:true });
          }
        }
        if (Array.isArray(r.musterMissing)){
          for (const m of r.musterMissing){
            const mid = missingDocId({propertyId: r.propertyId, paddock: r.paddock, species: r.species, cls: m.cls, fy: m.fy});
            const mref = db.collection('missingStock').doc(mid);
            tx.set(mref, {
              propertyId: r.propertyId, location: r.paddock, species: r.species,
              class: m.cls, fy: m.fy, count: firebase.firestore.FieldValue.increment(-Number(m.qty||0)),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge:true });
          }
        }
        tx.delete(ref);
      }
    });
    setMsg('Deleted');
    await refreshEntries();
  }catch(e){ console.error(e); setMsg('Delete failed'); }
}

function resetForm(clearProp){
  if (clearProp) propSel.value='ALL';
  dateInp.value = todayISO(); timeInp.value='';
  activitySel.value='Ploughing'; onActivityChange();
  paddockSel.value=''; notesInp.value='';
  gaugeSel.value=''; rainMm.value='';
  speciesSel.value='Cattle'; classInp.value=''; headInp.value='';
  chemSel.value=''; chemQty.value=''; chemUnit.value='';
  mExp.value=''; mAct.value=''; mDelta.value=''; mReason.value=''; mAddCalves.value=''; mAddWeaners.value='';
  mClassBody.innerHTML = '<tr><td colspan="6">Pick property + paddock + species to load current classes…</td></tr>';
  musterContext.innerHTML = '';
  editingId=null; originalEntry=null; saveBtn.textContent='Save entry'; cancelEditBtn.classList.add('hidden');
}

/*** Export & Print ***/
async function exportYearCsv(){
  const y = Number(yearInp.value || new Date().getFullYear());
  const {start,end} = yBounds(y);
  let q = db.collection('diaryEntries').where('date','>=',start).where('date','<=',end).orderBy('date','asc');
  if (propSel.value!=='ALL') q = q.where('propertyId','==',propSel.value);
  const snap = await q.get();
  const rows = [];
  snap.forEach(d=>{
    const r=d.data();
    rows.push([r.date,r.propertyName,r.activity,r.paddock??'',r.rainfallMm??'',r.chemicalName??'',r.chemQty??'',r.chemUnit??'',r.headCount??'',r.notes??'']);
  });
  const head = 'Date,Property,Activity,Paddock,Rain(mm),Chemical,Qty,Unit,Head,Notes';
  const csv = head + '\n' + rows.map(cols=>cols.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = `diary_${y}.csv`; a.click();
}

async function printYear(){
  const y = Number(yearInp.value || new Date().getFullYear());
  const {start,end} = yBounds(y);
  let q = db.collection('diaryEntries').where('date','>=',start).where('date','<=',end).orderBy('date','asc');
  if (propSel.value!=='ALL') q = q.where('propertyId','==',propSel.value);
  const snap = await q.get();
  const items = []; snap.forEach(d=>items.push(d.data()));
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>Diary ${y}</title><style>body{font-family:system-ui;margin:24px} h2{margin:0 0 12px} table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #ddd;padding:6px;text-align:left} th{background:#f1f5f9}</style></head><body><h2>Diary — ${y}</h2><table><thead><tr><th>Date</th><th>Property</th><th>Activity</th><th>Paddock</th><th>Rain</th><th>Chemical</th><th>Head</th><th>Notes</th></tr></thead><tbody>${
    items.map(r=>`<tr><td>${r.date||''}</td><td>${r.propertyName||''}</td><td>${r.activity||''}</td><td>${r.paddock||''}</td><td>${r.rainfallMm??''}</td><td>${r.chemicalName||''} ${r.chemQty||''} ${r.chemUnit||''}</td><td>${r.headCount??''}</td><td>${(r.notes||'').replace(/</g,'&lt;')}</td></tr>`).join('')
  }</tbody></table></body></html>`);
  w.document.close(); w.focus(); w.print();
}
</script>
</body>
</html>