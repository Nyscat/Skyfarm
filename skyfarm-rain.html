<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SkyFarm — Rainfall</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
  <!-- XLSX for Excel parsing in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f6fbf8;
      --card:#ffffff;
      --line:#dbe3eb;
      --ink:#111827;
      --muted:#6b7280;
      --accent:#047857;
      --accent-soft:#ecfdf3;
      --danger:#b91c1c;
      --danger-soft:#fef2f2;
      --focus:#2563eb;
      --shadow:0 18px 40px rgba(15,23,42,.1);
      --shadow-soft:0 10px 30px rgba(15,23,42,.08);
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,-system-ui,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top, #e0f2fe 0, #f6fbf8 42%, #f6fbf8 100%);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
    }

    a{color:#0f766e;text-decoration:none;}
    a:hover{text-decoration:underline;}

    header{
      background:rgba(255,255,255,.93);
      border-bottom:1px solid rgba(148,163,184,.4);
      backdrop-filter:blur(18px);
      position:sticky;
      top:0;
      z-index:40;
    }
    .header-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      max-width:1200px;
      margin:0 auto;
      padding:8px 16px;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .brand-icon{
      width:32px;
      height:32px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 10%, #e0f2fe, #0f766e);
      box-shadow:0 10px 20px rgba(15,23,42,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#ecfdf3;
      font-weight:600;
      font-size:16px;
    }
    .brand-text{
      display:flex;
      flex-direction:column;
    }
    .brand-text span:first-child{
      font-weight:600;
      font-size:1rem;
      letter-spacing:.02em;
    }
    .brand-text span:last-child{
      font-size:.78rem;
      color:var(--muted);
    }

    .header-right{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      padding:4px 10px;
      font-size:.75rem;
      color:var(--muted);
      gap:6px;
      background:rgba(255,255,255,.7);
    }
    .pill-label{
      padding:2px 6px;
      border-radius:999px;
      background:#ecfdf3;
      color:#065f46;
      font-weight:500;
      font-size:.72rem;
    }

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      padding:6px 12px;
      background:#fff;
      font-size:.8rem;
      font-weight:500;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:var(--ink);
      box-shadow:0 2px 4px rgba(15,23,42,.04);
    }
    .btn:hover{background:#f9fafb;box-shadow:0 4px 10px rgba(15,23,42,.08);}
    .btn.primary{
      background:#047857;
      color:#ecfdf3;
      border-color:#047857;
      box-shadow:0 8px 18px rgba(4,120,87,.35);
    }
    .btn.primary:hover{
      background:#065f46;
      border-color:#065f46;
    }
    .btn.sm{
      padding:4px 9px;
      font-size:.75rem;
      border-radius:999px;
    }
    .btn.icon-only{
      width:30px;
      height:30px;
      padding:0;
      justify-content:center;
    }

    .spacer{flex:1;}
    .muted{color:var(--muted);}
    .small{font-size:.8rem;}
    .hidden{display:none;}

    .db-menu-wrap{position:relative;}
    .db-menu{
      position:absolute;
      top:100%;
      left:0;
      background:#fff;
      border:1px solid var(--line);
      border-radius:10px;
      min-width:160px;
      padding:4px 0;
      box-shadow:0 10px 25px rgba(15,23,42,.12);
      z-index:20;
    }
    .db-menu a{
      display:block;
      padding:6px 12px;
      font-size:.85rem;
      color:var(--ink);
      text-decoration:none;
    }
    .db-menu a:hover{background:#f1f5f9;}

    .wrap{max-width:1200px;margin:0 auto;padding:16px;}
    h1{margin:12px 0;font-size:1.5rem;}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      margin:12px 0;
      box-shadow:0 10px 30px rgba(15,23,42,.04);
    }
    .card.controls{display:flex;flex-direction:column;gap:10px;}
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
    }

    label{
      display:block;
      font-size:.8rem;
      font-weight:500;
      color:var(--muted);
      margin-bottom:3px;
    }

    select,input[type="text"],input[type="number"],input[type="email"],input[type="password"],input[type="date"],input[type="file"]{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.9);
      padding:6px 10px;
      font-size:.9rem;
      min-width:80px;
      outline:none;
      background:#fff;
    }
    select:focus,input:focus{
      border-color:var(--focus);
      box-shadow:0 0 0 1px rgba(37,99,235,.2);
    }

    #status{
      font-size:.8rem;
    }
    .status-warn{color:var(--danger);}

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:4px;
      font-size:.78rem;
    }
    th,td{
      border:1px solid #e5e7eb;
      padding:4px 5px;
      text-align:right;
    }
    th{
      background:#f9fafb;
      font-weight:600;
      color:#4b5563;
    }
    th:first-child,td:first-child{
      text-align:left;
      white-space:nowrap;
    }
    tbody tr:nth-child(odd) td{background:#f9fafb;}
    tbody tr:nth-child(even) td{background:#ffffff;}

    .total-row td{
      font-weight:600;
      background:#ecfdf3;
      border-top:2px solid #34d399;
    }
    .cum-row td{
      font-weight:500;
      background:#e0f2fe;
      border-top:2px solid #3b82f6;
    }

    .rain-header{
      font-weight:600;
      margin-bottom:6px;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
      font-size:.95rem;
    }

    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      font-size:.75rem;
      color:var(--muted);
      margin-top:6px;
    }
    .legend span{display:inline-flex;align-items:center;gap:4px;}
    .legend-swatch{
      width:12px;
      height:12px;
      border-radius:999px;
    }
    .swatch-total{background:#22c55e;}
    .swatch-cum{background:#3b82f6;}

    /* Summary section */
    #summaryCard{
      border-style:dashed;
      border-color:#cbd5f5;
      background:linear-gradient(135deg,#f5f3ff,#eff6ff);
    }

    #summaryContent{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:10px;
      margin-top:8px;
    }
    .summary-item{
      border-radius:10px;
      padding:8px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(255,255,255,.85);
    }
    .summary-item.wet{border-color:#22c55e;background:#ecfdf3;}
    .summary-item.dry{border-color:#f97316;background:#fff7ed;}

    /* Auth overlay */
    #authOverlay{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top,#0f172a 0,rgba(15,23,42,.92) 45%,rgba(15,23,42,.94) 100%);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }

    @media (max-width:700px){
      .header-inner{flex-wrap:wrap;gap:6px;}
      .row{flex-direction:column;align-items:flex-start;}
      .card.controls{gap:8px;}
      table{font-size:.72rem;}
      .rain-header{flex-direction:column;align-items:flex-start;}
    }
  </style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="brand">
      <div class="brand-icon">SF</div>
      <div class="brand-text">
        <span>SkyFarm</span>
        <span>Property rainfall</span>
      </div>
    </div>
    <div class="header-right">
      <div class="pill">
        <span class="pill-label">Beta</span>
        <span>Rainfall to 9am daily</span>
      </div>

      <div class="db-menu-wrap">
        <button id="dbMenuBtn" class="btn sm icon-only" title="Database tools">
          ☰
        </button>
        <div id="dbMenu" class="db-menu hidden">
          <a href="skyfarm-properties.html">Properties</a>
          <a href="skyfarm-gauges.html">Rain gauges</a>
          <a href="skyfarm-rain.html">Rainfall</a>
        </div>
      </div>

      <button id="signOutBtn" class="btn sm hidden">Sign out</button>
    </div>
  </div>
</header>

<div class="wrap">
  <h1>Rainfall</h1>

  <div class="card controls">
    <div class="row">
      <div>
        <label>Gauge</label>
        <select id="gaugeSel" style="min-width:260px">
          <option value="">Loading gauges…</option>
        </select>
      </div>
      <div>
        <label>Year</label>
        <select id="yearSel"></select>
      </div>
      <button id="reloadBtn" class="btn">Reload</button>
      <button id="printBtn" class="btn primary">Print / PDF</button>
      <span class="muted" id="status" style="margin-left:auto">Loading…</span>
    </div>
    <div class="muted small" id="gaugeInfo"></div>
  </div>

  <div id="importCard" class="card" style="margin-top:12px;display:none;">
    <div class="row">
      <div>
        <h2 style="margin-top:0;">Historic rainfall import</h2>
        <p class="small muted">
          Admin only. Select the <strong>Consentes House - Rainfall.xlsx</strong> workbook and click import.
        </p>
      </div>
    </div>
    <div class="row">
      <div>
        <label for="importFile">Workbook</label>
        <input id="importFile" type="file" accept=".xlsx,.xls" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="runImportBtn" class="btn" type="button">Import to Firestore</button>
      </div>
    </div>
    <p id="importStatus" class="small muted" style="margin-top:8px;"></p>
  </div>

  <div class="card">
    <div class="rain-header" id="chartTitle">Yearly Rainfall Record</div>
    <table id="rainTable">
      <thead id="rainHead"></thead>
      <tbody id="rainBody"></tbody>
    </table>

    <div class="legend">
      <span><span class="legend-swatch swatch-total"></span> Total rain (mm)</span>
      <span><span class="legend-swatch swatch-cum"></span> Cumulative total (mm)</span>
      <span>Rainfall is recorded up to 9.00am on the day it was measured.</span>
      <span>Total days is the number of days with ≥ 0.1&nbsp;mm of rain.</span>
    </div>
  </div>

  <div class="card" id="summaryCard">
    <h3 style="margin-top:0;">Summary & averages</h3>
    <div id="summaryContent" class="muted small">
      Loading long-term averages from <code>consentes-house-rain.json</code>…
    </div>
  </div>
</div>

<!-- Auth overlay -->
<div id="authOverlay" style="position:fixed;inset:0;background:radial-gradient(circle at top,#0f172a 0,rgba(15,23,42,.92) 45%,rgba(15,23,42,.94) 100%);display:none;align-items:center;justify-content:center;z-index:50;">
  <div style="width:min(520px,92vw);background:#fff;border:1px solid var(--line);border-radius:16px;padding:20px;">
    <h2 style="margin:0 0 10px 0;">Sign in to SkyFarm</h2>
    <p class="muted small">Email &amp; password only. Anonymous sign-in is disabled for this app.</p>
    <div class="row" style="margin-top:8px;">
      <div style="flex:1;min-width:220px;">
        <label>Email</label>
        <input id="siEmail" type="email" placeholder="you@example.com" autocomplete="username">
      </div>
      <div style="flex:1;min-width:220px;">
        <label>Password</label>
        <input id="siPass" type="password" placeholder="••••••••" autocomplete="current-password">
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <button id="signInBtn" class="btn primary">Sign in</button>
      <span id="authMsg" class="muted small"></span>
      <span class="spacer"></span>
      <button id="closeOverlayBtn" class="btn" type="button">Close</button>
    </div>
  </div>
</div>

<script>
  /* Firebase init */
  const firebaseConfig = {
    apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
    authDomain: "consentes-pastoral.firebaseapp.com",
    projectId: "consentes-pastoral",
    appId: "1:494858780013:web:d87497b370c82eeab06e64"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const $ = s => document.querySelector(s);
  const gaugeSel = $('#gaugeSel');
  const yearSel  = $('#yearSel');
  const statusEl = $('#status');
  const gaugeInfo = $('#gaugeInfo');
  const rainHead = $('#rainHead');
  const rainBody = $('#rainBody');
  const chartTitle = $('#chartTitle');

  const authOverlay = $('#authOverlay');
  const authWho = $('#authWho');
  const signOutBtn = $('#signOutBtn');

  const summaryContent = $('#summaryContent');

  // Historic import UI
  const importCard   = $('#importCard');
  const importFile   = $('#importFile');
  const importBtn    = $('#runImportBtn');
  const importStatus = $('#importStatus');

  const ACTIVE_GAUGE_KEY = 'sf.activeGaugeId';
  const ACTIVE_YEAR_KEY  = 'sf.activeRainYear';

  let propertiesById = new Map();
  let gauges = [];
  let currentGauge = null;
  let climatology = null; // from consentes-house-rain.json

  function setStatus(msg, warn){
    statusEl.textContent = msg || '';
    statusEl.classList.toggle('status-warn', !!warn);
  }
  function showOverlay(show){ authOverlay.style.display = show ? 'flex' : 'none'; }

  function setImportStatus(msg){
    if (!importStatus) return;
    importStatus.textContent = msg || '';
  }

  // ===== Historic rainfall import (Consentes House) =====

  const HISTORIC_GAUGE_ID = 's7PlDM9wrEpxuJ6DGIab';

  const monthMap = {
    jan: 1, feb: 2, mar: 3, apr: 4,
    may: 5, jun: 6, jul: 7, aug: 8,
    sep: 9, oct: 10, nov: 11, dec: 12,
  };

  function parseWorkbookToEntries(workbook){
    const entries = [];

    workbook.SheetNames.forEach(sheetName=>{
      const year = parseInt(sheetName, 10);
      if (!year || year < 1900 || year > 3000) return;

      const ws = workbook.Sheets[sheetName];
      if (!ws) return;

      const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:null});
      if (!rows || rows.length < 2) return;

      const headers = rows[0].map(v => (v == null ? '' : String(v).trim().toLowerCase()));
      const monthIdxByCol = {};

      headers.forEach((h, idx)=>{
        if (idx === 0) return;
        if (!h) return;
        const key = h.slice(0,3);
        if (monthMap[key]) monthIdxByCol[idx] = monthMap[key];
      });

      for (let r = 1; r < rows.length; r++){
        const row = rows[r];
        if (!row || row.length === 0) continue;

        const dayVal = row[0];
        const dayNum = Number(dayVal);
        if (!Number.isFinite(dayNum) || dayNum < 1 || dayNum > 31) continue;

        for (let c = 1; c < row.length; c++){
          const month = monthIdxByCol[c];
          if (!month) continue;

          const cell = row[c];
          const val = Number(cell);
          if (!Number.isFinite(val)) continue;
          if (Math.abs(val) < 0.0001) continue;

          const mmRounded = Math.round(val * 10) / 10;
          const dateStr =
            String(year).padStart(4,'0') + '-' +
            String(month).padStart(2,'0') + '-' +
            String(dayNum).padStart(2,'0');

          entries.push({date: dateStr, mm: mmRounded});
        }
      }
    });

    return entries;
  }

  async function runHistoricImport(){
    if (!importFile || !importFile.files || !importFile.files[0]){
      alert('Choose the "Consentes House - Rainfall.xlsx" file first.');
      return;
    }

    const file = importFile.files[0];
    try{
      setImportStatus('Reading workbook…');
      const buf = await file.arrayBuffer();
      const workbook = XLSX.read(buf, {type:'array'});

      const entries = parseWorkbookToEntries(workbook);
      if (!entries.length){
        setImportStatus('No rainy days found in workbook. Check the file.');
        return;
      }

      setImportStatus(`Found ${entries.length} rainy days. Writing to Firestore…`);

      const batchLimit = 400;
      let batch = db.batch();
      let countInBatch = 0;
      let written = 0;

      for (let i = 0; i < entries.length; i++){
        const e = entries[i];
        const docRef = db
          .collection('gauges')
          .doc(HISTORIC_GAUGE_ID)
          .collection('daily')
          .doc(e.date);

        batch.set(docRef, {mm: e.mm, source: 'historicImport'});
        countInBatch++;

        if (countInBatch >= batchLimit){
          await batch.commit();
          written += countInBatch;
          setImportStatus(`Wrote ${written}/${entries.length} days…`);
          batch = db.batch();
          countInBatch = 0;
        }
      }

      if (countInBatch > 0){
        await batch.commit();
        written += countInBatch;
      }

      setImportStatus(`Import complete. Wrote ${written} rainy days.`);
      alert('Historic rainfall import complete. Reload the page and select an older year to check.');
    }catch(err){
      console.error('Historic import failed', err);
      setImportStatus('Import failed: ' + (err.message || err));
      alert('Import failed. Check the console log for more detail.');
    }
  }

  if (importBtn){
    importBtn.addEventListener('click', ()=>{
      runHistoricImport();
    });
  }

  /* Header DB menu */
  (function(){
    const btn = $('#dbMenuBtn');
    const menu = $('#dbMenu');
    if (!btn || !menu) return;
    btn.onclick = e => { e.stopPropagation(); menu.classList.toggle('hidden'); };
    document.addEventListener('click', ()=> menu.classList.add('hidden'));
  })();

  /* Auth */
  const siEmail = $('#siEmail');
  const siPass = $('#siPass');
  const signInBtn = $('#signInBtn');
  const authMsg = $('#authMsg');
  const closeOverlayBtn = $('#closeOverlayBtn');

  function setAuthMsg(msg, isError){
    authMsg.textContent = msg || '';
    authMsg.style.color = isError ? '#b91c1c' : '#6b7280';
  }

  signInBtn.onclick = async ()=>{
    const email = (siEmail.value || '').trim();
    const pass = siPass.value || '';
    if (!email || !pass){
      setAuthMsg('Enter email and password.', true);
      return;
    }
    setAuthMsg('Signing in…');
    signInBtn.disabled = true;
    try{
      await auth.signInWithEmailAndPassword(email, pass);
      setAuthMsg('Signed in.');
      showOverlay(false);
    }catch(e){
      console.error(e);
      setAuthMsg(e.message || 'Sign-in failed.', true);
    }finally{
      signInBtn.disabled = false;
    }
  };

  closeOverlayBtn.onclick = ()=> showOverlay(false);

  auth.onAuthStateChanged(async user=>{
    if (user){
      // note: authWho element is not shown in this version, but we keep the text update
      const whoEl = document.getElementById('authWho');
      if (whoEl){
        whoEl.textContent = user.email ? `Signed in as ${user.email}` : 'Signed in';
      }
      signOutBtn.classList.remove('hidden');
      showOverlay(false);
      if (importCard) importCard.style.display = 'block';
      try{ await db.enablePersistence({synchronizeTabs:true}); }catch(e){}
      await initPage();
    }else{
      const whoEl = document.getElementById('authWho');
      if (whoEl){
        whoEl.textContent = 'Not signed in';
      }
      signOutBtn.classList.add('hidden');
      showOverlay(true);
      if (importCard) importCard.style.display = 'none';
      setStatus('Please sign in', true);
    }
  });

  signOutBtn.onclick = ()=> auth.signOut();

  /* Data loading */
  async function loadProperties(){
    const snap = await db.collection('properties').get();
    propertiesById = new Map();
    snap.forEach(doc=>{
      propertiesById.set(doc.id, doc.data().name || '(Property)');
    });
  }

  async function loadGauges(){
    const snap = await db.collection('gauges').get();
    gauges = [];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      if (d.active === false) return;
      const g = { id:doc.id, name:d.name || '(Gauge)', propertyId:d.propertyId || null };
      gauges.push(g);
    });
    gauges.sort((a,b)=>{
      const pa = propertiesById.get(a.propertyId) || '';
      const pb = propertiesById.get(b.propertyId) || '';
      if (pa !== pb) return pa.localeCompare(pb);
      return a.name.localeCompare(b.name);
    });

    gaugeSel.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = 'Select gauge…';
    gaugeSel.appendChild(placeholder);

    gauges.forEach(g=>{
      const opt = document.createElement('option');
      opt.value = g.id;
      const pname = propertiesById.get(g.propertyId) || '';
      opt.textContent = pname ? `${pname} — ${g.name}` : g.name;
      gaugeSel.appendChild(opt);
    });

    const savedId = localStorage.getItem(ACTIVE_GAUGE_KEY) || '';
    if (savedId){
      const found = gauges.find(g=>g.id === savedId);
      if (found){
        gaugeSel.value = savedId;
        currentGauge = found;
      }
    }

    if (!currentGauge && gauges.length){
      currentGauge = gauges[0];
      gaugeSel.value = currentGauge.id;
    }
  }

  async function loadClimatology(){
    try{
      const res = await fetch('consentes-house-rain.json');
      if (!res.ok) return;
      climatology = await res.json();
    }catch(e){
      console.warn('Failed to load climatology', e);
    }
  }

  function updateGaugeInfo(){
    if (!currentGauge){
      gaugeInfo.textContent = '';
      return;
    }
    const pname = propertiesById.get(currentGauge.propertyId) || '';
    gaugeInfo.innerHTML = pname
      ? `<strong>${currentGauge.name}</strong> on <strong>${pname}</strong>`
      : `<strong>${currentGauge.name}</strong>`;
  }

  function initYears(){
    const now = new Date();
    const thisYear = now.getFullYear();
    const saved = parseInt(localStorage.getItem(ACTIVE_YEAR_KEY) || '', 10);

    const earliestYear = 2000; // earliest year in historic data
    const startYear = earliestYear;
    const endYear   = thisYear + 1;

    yearSel.innerHTML = '';
    for (let y=endYear; y>=startYear; y--){
      const opt = document.createElement('option');
      opt.value = String(y);
      opt.textContent = String(y);
      yearSel.appendChild(opt);
    }
    if (saved && saved >= startYear && saved <= endYear){
      yearSel.value = String(saved);
    }else{
      yearSel.value = String(thisYear);
    }
  }

  function bindEvents(){
    $('#reloadBtn').onclick = ()=> loadRain();
    $('#printBtn').onclick  = ()=> window.print();
    gaugeSel.onchange = ()=>{
      currentGauge = gauges.find(g=>g.id === gaugeSel.value) || null;
      if (currentGauge){
        localStorage.setItem(ACTIVE_GAUGE_KEY, currentGauge.id);
      }
      updateGaugeInfo();
      loadRain();
    };
    yearSel.onchange = ()=>{
      localStorage.setItem(ACTIVE_YEAR_KEY, yearSel.value);
      loadRain();
    };
  }

  async function initPage(){
    try{
      setStatus('Loading properties…');
      await loadProperties();
      setStatus('Loading gauges…');
      await loadGauges();
      setStatus('Loading climatology…');
      await loadClimatology();
      setStatus('');
      initYears();
      updateGaugeInfo();
      bindEvents();
      await loadRain();
    }catch(e){
      console.error(e);
      setStatus('Failed to load data.', true);
    }
  }

  async function loadRain(){
    if (!currentGauge){
      setStatus('Select a gauge.', true);
      return;
    }
    const year = parseInt(yearSel.value, 10);
    if (!year){
      setStatus('Select a year.', true);
      return;
    }

    setStatus('Loading rainfall…');
    rainHead.innerHTML = '';
    rainBody.innerHTML = '';
    chartTitle.textContent = `Yearly Rainfall Record — ${year}`;

    const start = new Date(year, 0, 1);
    const end   = new Date(year+1, 0, 1);

    const dailySnap = await db.collection('gauges').doc(currentGauge.id)
      .collection('daily')
      .where(firebase.firestore.FieldPath.documentId(), '>=', formatDateId(start))
      .where(firebase.firestore.FieldPath.documentId(), '<', formatDateId(end))
      .get();

    const grid = new Array(31).fill(0).map(()=> new Array(12).fill(null));

    dailySnap.forEach(doc=>{
      const id = doc.id; // YYYY-MM-DD
      const mm = (doc.data() || {}).mm;
      if (!Number.isFinite(mm)) return;
      const y = parseInt(id.slice(0,4), 10);
      const m = parseInt(id.slice(5,7), 10) - 1;
      const d = parseInt(id.slice(8,10), 10) - 1;
      if (y === year && m>=0 && m<12 && d>=0 && d<31){
        grid[d][m] = mm;
      }
    });

    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    let headHtml = '<tr><th>Day</th>';
    for (let m=0; m<12; m++) headHtml += `<th>${months[m]}</th>`;
    headHtml += '</tr>';
    rainHead.innerHTML = headHtml;

    const monthTotals = new Array(12).fill(0);
    const monthRainDays = new Array(12).fill(0);

    function fmt(v){
      if (v == null) return '';
      if (!Number.isFinite(v)) return '';
      return (Math.abs(v % 1) < 0.001) ? v.toFixed(0) : v.toFixed(1);
    }

    let bodyHtml = '';
    for (let d=0; d<31; d++){
      bodyHtml += `<tr><td>${d+1}</td>`;
      for (let m=0; m<12; m++){
        const v = grid[d][m];
        if (v != null && Number.isFinite(v)){
          monthTotals[m] += v;
          if (v >= 0.1) monthRainDays[m] += 1;
        }
        bodyHtml += `<td>${fmt(v)}</td>`;
      }
      bodyHtml += '</tr>';
    }

    // total rain
    bodyHtml += '<tr class="total-row"><td>Total rain (mm)</td>';
    for (let m=0; m<12; m++) bodyHtml += `<td>${fmt(monthTotals[m])}</td>`;
    bodyHtml += '</tr>';

    // cumulative total row
    const cum = new Array(12).fill(0);
    for (let m=0; m<12; m++){
      cum[m] = (m === 0 ? monthTotals[m] : cum[m-1] + monthTotals[m]);
    }
    bodyHtml += '<tr class="cum-row"><td>Cumulative total (mm)</td>';
    for (let m=0; m<12; m++) bodyHtml += `<td>${fmt(cum[m])}</td>`;
    bodyHtml += '</tr>';

    // rain days row
    bodyHtml += '<tr><td>Rain days (≥0.1mm)</td>';
    for (let m=0; m<12; m++) bodyHtml += `<td>${monthRainDays[m]}</td>`;
    bodyHtml += '</tr>';

    rainBody.innerHTML = bodyHtml;

    setStatus('');
    renderSummary(year, monthTotals);
  }

  function renderSummary(year, monthTotals){
    if (!climatology || !climatology.monthlyAverages){
      summaryContent.textContent = 'No climatology data available.';
      return;
    }
    const avg = climatology.monthlyAverages;
    const monthsLabels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    let html = '';
    let yearTotal = 0;
    let avgYearTotal = 0;
    for (let i=0; i<12; i++){
      yearTotal += monthTotals[i] || 0;
      avgYearTotal += avg[i] || 0;
    }
    const pctYear = avgYearTotal ? (yearTotal / avgYearTotal * 100) : null;

    function fmt1(v){ return v == null ? '—' : v.toFixed(1); }
    function fmtPct(v){ return v == null ? '—' : v.toFixed(0) + '%'; }

    html += `<div class="summary-item ${pctYear != null && pctYear >= 110 ? 'wet' : pctYear != null && pctYear <= 90 ? 'dry' : ''}">
      <strong>${year}</strong>
      <div>This year: ${fmt1(yearTotal)} mm</div>
      <div>Average: ${fmt1(avgYearTotal)} mm</div>
      <div>Percent of avg: ${fmtPct(pctYear)}</div>
    </div>`;

    for (let i=0; i<12; i++){
      const thisM = monthTotals[i] || 0;
      const avgM = avg[i] || 0;
      const pct = avgM ? (thisM / avgM * 100) : null;
      const cls = pct != null && pct >= 130 ? 'wet' : pct != null && pct <= 70 ? 'dry' : '';
      html += `<div class="summary-item ${cls}">
        <strong>${monthsLabels[i]}</strong>
        <div>This year: ${fmt1(thisM)} mm</div>
        <div>Average: ${fmt1(avgM)} mm</div>
        <div>Pct of avg: ${fmtPct(pct)}</div>
      </div>`;
    }

    html += '</div>';
    summaryContent.innerHTML = html;
  }

  function formatDateId(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
</script>
</body>
</html>
