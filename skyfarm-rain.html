<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SkyFarm â€” Rainfall</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
  <!-- XLSX for Excel parsing in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f6fbf8;
      --card:#ffffff;
      --line:#e2e8f0;
      --ink:#111827;
      --muted:#6b7280;
      --accent:#047857;
      --accent-soft:#ecfdf3;
      --danger:#b91c1c;
      --danger-soft:#fef2f2;
      --focus:#2563eb;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,-system-ui,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top, #e0f2fe 0, #f6fbf8 42%, #f6fbf8 100%);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
    }

    a{color:#0f766e;text-decoration:none;}
    a:hover{text-decoration:underline;}

    /* Header */
    #sf-header{
      background:rgba(255,255,255,.94);
      border-bottom:1px solid rgba(148,163,184,.4);
      backdrop-filter:blur(18px);
      position:sticky;
      top:0;
      z-index:40;
    }
    #sf-header .bar{
      max-width:1200px;
      margin:0 auto;
      padding:8px 16px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    #sf-header .brand{
      font-weight:600;
      font-size:1rem;
      padding:4px 10px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 10%, #e0f2fe, #0f766e);
      color:#ecfdf3;
      box-shadow:0 10px 20px rgba(15,23,42,.25);
      text-decoration:none;
    }
    #sf-header nav{
      display:flex;
      gap:8px;
      margin-left:8px;
    }
    #sf-header nav a{
      padding:4px 10px;
      border-radius:999px;
      font-size:.82rem;
      color:#0f172a;
      text-decoration:none;
    }
    #sf-header nav a[aria-current="page"]{
      background:#e0f2fe;
      font-weight:500;
    }
    .nav-db{
      position:relative;
      margin-left:8px;
    }
    .spacer{flex:1;}
    .muted{color:var(--muted);}
    .small{font-size:.8rem;}
    .hidden{display:none;}

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      padding:6px 12px;
      background:#fff;
      font-size:.8rem;
      font-weight:500;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:var(--ink);
    }
    .btn.primary{
      background:#047857;
      color:#ecfdf3;
      border-color:#047857;
    }
    .btn.primary:hover{
      background:#065f46;
      border-color:#065f46;
    }
    .btn.small{
      padding:4px 10px;
      font-size:.78rem;
    }

    .db-menu{
      position:absolute;
      top:100%;
      right:0;
      background:#fff;
      border:1px solid var(--line);
      border-radius:10px;
      min-width:180px;
      padding:4px 0;
      box-shadow:0 10px 25px rgba(15,23,42,.12);
      z-index:20;
    }
    .db-menu a{
      display:block;
      padding:6px 12px;
      font-size:.9rem;
      color:var(--ink);
      text-decoration:none;
    }
    .db-menu a:hover{background:#f1f5f9;}

    .wrap{max-width:1200px;margin:0 auto;padding:16px;}
    h1{margin:12px 0;font-size:1.5rem;}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      margin:12px 0;
    }
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    label{font-size:.85rem;color:#475569;display:block;margin-bottom:4px;}
    select,input,button{
      padding:6px 10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      background:#fff;
      font-size:.9rem;
    }
    select:focus,input:focus,button:focus{
      outline:none;
      border-color:var(--focus);
      box-shadow:0 0 0 1px rgba(37,99,235,.2);
    }

    #status{font-size:.8rem;}
    .status-warn{color:var(--danger);}

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:4px;
      font-size:.78rem;
    }
    th,td{
      border:1px solid #e5e7eb;
      padding:4px 5px;
      text-align:right;
    }
    th{
      background:#f9fafb;
      font-weight:600;
      color:#4b5563;
    }
    th:first-child,td:first-child{
      text-align:left;
      white-space:nowrap;
    }
    tbody tr:nth-child(odd) td{background:#f9fafb;}
    tbody tr:nth-child(even) td{background:#ffffff;}

    .total-row td{
      font-weight:600;
      background:#ecfdf3;
      border-top:2px solid #34d399;
    }
    .cum-row td{
      font-weight:500;
      background:#e0f2fe;
      border-top:2px solid #3b82f6;
    }

    .rain-header{
      font-weight:600;
      margin-bottom:6px;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
      font-size:.95rem;
    }

    .note{font-size:.8rem;color:#4b5563;margin-top:4px;}

    .summary-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:8px;
      margin-top:8px;
    }
    .summary-item{
      border-radius:10px;
      padding:8px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(255,255,255,.9);
      font-size:.8rem;
    }
    .summary-item strong{display:block;font-size:.8rem;margin-bottom:2px;}
    .summary-bad{border-color:#f97316;background:#fff7ed;}
    .summary-good{border-color:#22c55e;background:#ecfdf3;}

    @media (max-width:900px){
      .summary-grid{grid-template-columns:repeat(2, minmax(0,1fr));}
    }
    @media (max-width:600px){
      .summary-grid{grid-template-columns:1fr;}
      #sf-header .bar{flex-wrap:wrap;}
      .row{flex-direction:column;align-items:flex-start;}
    }

    @media print{
      body{background:#fff;}
      #sf-header,.controls{display:none !important;}
      .wrap{margin:0;padding:8px;}
      .card{border:none;padding:0;margin:0;}
      table{font-size:.8rem;}
      .rain-header{font-size:1rem;margin-bottom:4px;}
      .note{font-size:.7rem;}
    }
  </style>
</head>
<body>

<!-- Header -->
<div id="sf-header">
  <div class="bar">
    <a class="brand" href="skyfarm-diary.html">ðŸŒ± SkyFarm</a>
    <nav>
      <a href="skyfarm-diary.html">Diary</a>
      <a href="skyfarm-map.html">Map</a>
      <a href="skyfarm-rain.html" aria-current="page">Rain</a>
    </nav>
    <div class="nav-db">
      <button id="dbMenuBtn" class="btn small" type="button">Database â–¾</button>
      <div id="dbMenu" class="db-menu hidden">
        <a href="skyfarm-livestock.html">Livestock</a>
        <a href="skyfarm-chemical.html">Chemicals</a>
        <a href="skyfarm-seeds.html">Seeds</a>
        <a href="skyfarm-barcode.html">Barcode Scanner</a>
        <a href="skyfarm-users.html">Users &amp; Roles</a>
      </div>
    </div>
    <span class="spacer"></span>
    <span id="authWho" class="muted">Connectingâ€¦</span>
    <button id="signOutBtn" class="btn small hidden" style="border-color:#ef4444;color:#ef4444;">Sign out</button>
  </div>
</div>

<div class="wrap">
  <h1>Rainfall</h1>

  <div class="card controls">
    <div class="row">
      <div>
        <label>Gauge</label>
        <select id="gaugeSel" style="min-width:260px">
          <option value="">Loading gaugesâ€¦</option>
        </select>
      </div>
      <div>
        <label>Year</label>
        <select id="yearSel"></select>
      </div>
      <button id="reloadBtn" class="btn">Reload</button>
      <button id="printBtn" class="btn primary">Print / PDF</button>
      <span class="muted" id="status" style="margin-left:auto">Loadingâ€¦</span>
    </div>
    <div class="muted small" id="gaugeInfo"></div>
  </div>

  <!-- Hidden import card (only shows with ?import=1 and when signed in) -->
  <div id="importCard" class="card" style="margin-top:12px;display:none;">
    <div class="row">
      <div>
        <h2 style="margin-top:0;">Historic rainfall import</h2>
        <p class="small muted">
          Admin only. Select the <strong>Consentes House - Rainfall.xlsx</strong> workbook and click import.
        </p>
      </div>
    </div>
    <div class="row">
      <div>
        <label for="importFile">Workbook</label>
        <input id="importFile" type="file" accept=".xlsx,.xls" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="runImportBtn" class="btn" type="button">Import to Firestore</button>
      </div>
    </div>
    <p id="importStatus" class="small muted" style="margin-top:8px;"></p>
  </div>

  <div class="card">
    <div class="rain-header" id="chartTitle">Yearly Rainfall Record</div>
    <table id="rainTable">
      <thead id="rainHead"></thead>
      <tbody id="rainBody"></tbody>
    </table>

    <p class="note">
      Rainfall is recorded up to 9.00am on the day it was measured. Total days is the number of days with â‰¥ 0.1 mm of rain.
    </p>
  </div>

  <div class="card" id="summaryCard">
    <h3 style="margin-top:0;">Summary & averages</h3>
    <div id="summaryContent" class="muted small">
      Loading long-term averages from <code>consentes-house-rain.json</code>â€¦
    </div>
  </div>
</div>

<!-- Auth overlay -->
<div id="authOverlay" style="position:fixed;inset:0;background:radial-gradient(circle at top,#0f172a 0,rgba(15,23,42,.92) 45%,rgba(15,23,42,.94) 100%);display:none;align-items:center;justify-content:center;z-index:50;">
  <div style="width:min(520px,92vw);background:#fff;border:1px solid var(--line);border-radius:16px;padding:20px;">
    <h2 style="margin:0 0 10px 0;">Sign in to SkyFarm</h2>
    <p class="muted small">Email &amp; password only. Anonymous sign-in is disabled.</p>
    <div class="row">
      <div style="flex:1;min-width:260px;">
        <label>Email</label>
        <input id="siEmail" type="email" placeholder="you@example.com" autocomplete="username">
      </div>
      <div style="flex:1;min-width:220px;">
        <label>Password</label>
        <input id="siPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <button id="signInBtn" class="btn primary">Sign in</button>
      <span id="authMsg" class="muted small"></span>
      <span class="spacer"></span>
      <button id="closeOverlayBtn" class="btn" type="button">Close</button>
    </div>
  </div>
</div>

<script>
  /* Firebase init */
  const firebaseConfig = {
    apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
    authDomain: "consentes-pastoral.firebaseapp.com",
    projectId: "consentes-pastoral",
    appId: "1:494858780013:web:d87497b370c82eeab06e64"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const $ = s => document.querySelector(s);
  const gaugeSel = $('#gaugeSel');
  const yearSel  = $('#yearSel');
  const statusEl = $('#status');
  const gaugeInfo = $('#gaugeInfo');
  const rainHead = $('#rainHead');
  const rainBody = $('#rainBody');
  const chartTitle = $('#chartTitle');

  const authOverlay = $('#authOverlay');
  const authWho = $('#authWho');
  const signOutBtn = $('#signOutBtn');

  const summaryContent = $('#summaryContent');

  // Historic import UI
  const importCard   = $('#importCard');
  const importFile   = $('#importFile');
  const importBtn    = $('#runImportBtn');
  const importStatus = $('#importStatus');
  const showImport   = new URLSearchParams(location.search).get('import') === '1';

  const ACTIVE_GAUGE_KEY = 'sf.activeGaugeId';
  const ACTIVE_YEAR_KEY  = 'sf.activeRainYear';

  let propertiesById = new Map();
  let gauges = [];
  let currentGauge = null;
  let climatology = null; // from consentes-house-rain.json

  function setStatus(msg, warn){
    statusEl.textContent = msg || '';
    statusEl.classList.toggle('status-warn', !!warn);
  }
  function showOverlay(show){ authOverlay.style.display = show ? 'flex' : 'none'; }

  function setImportStatus(msg){
    if (!importStatus) return;
    importStatus.textContent = msg || '';
  }

  /* Header DB menu */
  (function(){
    const btn = $('#dbMenuBtn');
    const menu = $('#dbMenu');
    if (!btn || !menu) return;
    btn.onclick = e => { e.stopPropagation(); menu.classList.toggle('hidden'); };
    document.addEventListener('click', ()=> menu.classList.add('hidden'));
  })();

  /* Auth */
  const siEmail = $('#siEmail');
  const siPass = $('#siPass');
  const signInBtn = $('#signInBtn');
  const authMsg = $('#authMsg');
  const closeOverlayBtn = $('#closeOverlayBtn');

  function setAuthMsg(msg, isError){
    authMsg.textContent = msg || '';
    authMsg.style.color = isError ? '#b91c1c' : '#6b7280';
  }

  signInBtn.onclick = async ()=>{
    const email = (siEmail.value || '').trim();
    const pass = siPass.value || '';
    if (!email || !pass){
      setAuthMsg('Enter email and password.', true);
      return;
    }
    setAuthMsg('Signing inâ€¦');
    signInBtn.disabled = true;
    try{
      await auth.signInWithEmailAndPassword(email, pass);
      setAuthMsg('Signed in.');
      showOverlay(false);
    }catch(e){
      console.error(e);
      setAuthMsg(e.message || 'Sign-in failed.', true);
    }finally{
      signInBtn.disabled = false;
    }
  };

  closeOverlayBtn.onclick = ()=> showOverlay(false);
  signOutBtn.onclick = async ()=>{ try{ await auth.signOut(); location.reload(); }catch(e){} };

  auth.onAuthStateChanged(async user=>{
    if (user){
      authWho.textContent = user.email ? `Signed in as ${user.email}` : 'Signed in';
      signOutBtn.classList.remove('hidden');
      showOverlay(false);
      if (showImport && importCard) importCard.style.display = 'block';
      try{ await db.enablePersistence({synchronizeTabs:true}); }catch(e){}
      await initPage();
    }else{
      authWho.textContent = 'Not signed in';
      signOutBtn.classList.add('hidden');
      showOverlay(true);
      if (importCard) importCard.style.display = 'none';
      setStatus('Please sign in', true);
    }
  });

  async function initPage(){
    setStatus('Loading gaugesâ€¦');
    await loadProperties();
    await loadGauges();
    initYears();
    bindEvents();
    // Load long-term averages JSON (best effort)
    loadClimatology();
    setStatus('Ready');
    if (gaugeSel.value) await loadRain();
  }

  async function loadProperties(){
    propertiesById.clear();
    const snap = await db.collection('properties').get();
    snap.forEach(doc=>{
      propertiesById.set(doc.id, (doc.data() || {}).name || '(Property)');
    });
  }

  async function loadGauges(){
    gauges = [];
    const snap = await db.collection('gauges').get();
    snap.forEach(doc=>{
      const d = doc.data() || {};
      if (d.active === false) return;
      gauges.push({
        id: doc.id,
        name: d.name || '(Gauge)',
        propertyId: d.propertyId || null
      });
    });
    gauges.sort((a,b)=>{
      const pa = propertiesById.get(a.propertyId) || '';
      const pb = propertiesById.get(b.propertyId) || '';
      if (pa !== pb) return pa.localeCompare(pb);
      return a.name.localeCompare(b.name);
    });

    gaugeSel.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = 'Select gaugeâ€¦';
    gaugeSel.appendChild(opt0);

    gauges.forEach(g=>{
      const opt = document.createElement('option');
      opt.value = g.id;
      const propName = propertiesById.get(g.propertyId) || '';
      opt.textContent = propName ? `${propName} â€” ${g.name}` : g.name;
      gaugeSel.appendChild(opt);
    });

    const savedGaugeId = localStorage.getItem(ACTIVE_GAUGE_KEY) || '';
    if (savedGaugeId){
      const found = gauges.find(g=>g.id === savedGaugeId);
      if (found){
        gaugeSel.value = savedGaugeId;
        currentGauge = found;
      }
    }

    if (!currentGauge && gauges.length){
      currentGauge = gauges[0];
      gaugeSel.value = currentGauge.id;
    }

    updateGaugeInfo();
  }

  function initYears(){
    const now = new Date();
    const thisYear = now.getFullYear();
    const saved = parseInt(localStorage.getItem(ACTIVE_YEAR_KEY) || '', 10);

    const earliestYear = 2000;
    const startYear = earliestYear;
    const endYear   = thisYear + 1;

    yearSel.innerHTML = '';
    for (let y=endYear; y>=startYear; y--){
      const opt = document.createElement('option');
      opt.value = String(y);
      opt.textContent = String(y);
      yearSel.appendChild(opt);
    }
    if (saved && saved >= startYear && saved <= endYear){
      yearSel.value = String(saved);
    }else{
      yearSel.value = String(thisYear);
    }
  }

  function bindEvents(){
    $('#reloadBtn').onclick = ()=> loadRain();
    $('#printBtn').onclick  = ()=> window.print();
    gaugeSel.onchange = ()=>{
      currentGauge = gauges.find(g=>g.id === gaugeSel.value) || null;
      localStorage.setItem(ACTIVE_GAUGE_KEY, gaugeSel.value || '');
      updateGaugeInfo();
      loadRain();
    };
    yearSel.onchange = ()=>{
      localStorage.setItem(ACTIVE_YEAR_KEY, yearSel.value || '');
      loadRain();
    };
  }

  function updateGaugeInfo(){
    if (!currentGauge){
      gaugeInfo.textContent = '';
      chartTitle.textContent = 'Yearly Rainfall Record';
      return;
    }
    const propName = propertiesById.get(currentGauge.propertyId) || '(Property)';
    gaugeInfo.textContent = `Gauge: ${currentGauge.name}  â€¢  Property: ${propName}`;
    chartTitle.textContent = `Yearly Rainfall Record â€” ${propName} â€” ${currentGauge.name}`;
  }

  function makeEmptyYear(){
    const days = [];
    for (let d=0; d<31; d++){
      days.push(new Array(12).fill(null));
    }
    return days;
  }

  function parseDateInfo(docId, data){
    const raw = data.dateISO || data.date || docId || '';
    if (typeof raw !== 'string') return null;
    const m = raw.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (!m) return null;
    return {
      year: parseInt(m[1],10),
      month: parseInt(m[2],10),
      day: parseInt(m[3],10),
    };
  }

  function extractMm(data){
    const v = data.mm ?? data.rainMm ?? data.amount ?? data.total ?? data.rainTotal ?? 0;
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  async function loadRain(){
    if (!currentGauge){
      setStatus('No gauge selected', true);
      return;
    }
    const year = parseInt(yearSel.value,10);
    if (!year){
      setStatus('Invalid year', true);
      return;
    }

    setStatus('Loading rainfallâ€¦');
    rainHead.innerHTML = '';
    rainBody.innerHTML = '<tr><td colspan="13">Loadingâ€¦</td></tr>';

    try{
      const baseRef = db.collection('gauges').doc(currentGauge.id).collection('daily');
      const snap = await baseRef.get();
      const grid = makeEmptyYear();

      snap.forEach(doc=>{
        const data = doc.data() || {};
        const info = parseDateInfo(doc.id, data);
        if (!info || info.year !== year) return;
        const mm = extractMm(data);
        if (!Number.isFinite(mm)) return;
        const dIdx = info.day - 1;
        const mIdx = info.month - 1;
        if (dIdx < 0 || dIdx >= 31 || mIdx < 0 || mIdx >= 12) return;
        grid[dIdx][mIdx] = (grid[dIdx][mIdx] || 0) + mm;
      });

      const stats = renderTable(grid);
      setStatus('Loaded');
      updateSummary(year, stats.monthTotals);
    }catch(e){
      console.error(e);
      rainBody.innerHTML = '<tr><td colspan="13">Error loading rainfall.</td></tr>';
      setStatus('Error loading rainfall.', true);
    }
  }

  function renderTable(grid){
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    let headHtml = '<tr><th>Day</th>';
    for (let m=0; m<12; m++) headHtml += `<th>${months[m]}</th>`;
    headHtml += '</tr>';
    rainHead.innerHTML = headHtml;

    const monthTotals = new Array(12).fill(0);
    const monthRainDays = new Array(12).fill(0);

    function fmt(v){
      if (v == null) return '';
      if (!Number.isFinite(v)) return '';
      const n = Number(v);
      return (Math.abs(n % 1) < 0.001) ? n.toFixed(0) : n.toFixed(1);
    }

    let bodyHtml = '';
    for (let d=0; d<31; d++){
      bodyHtml += `<tr><td>${d+1}</td>`;
      for (let m=0; m<12; m++){
        const v = grid[d][m];
        if (v != null && Number.isFinite(v)){
          monthTotals[m] += v;
          if (v >= 0.1) monthRainDays[m] += 1;
        }
        bodyHtml += `<td>${fmt(v)}</td>`;
      }
      bodyHtml += '</tr>';
    }

    bodyHtml += '<tr class="total-row"><td>Total rain (mm)</td>';
    for (let m=0; m<12; m++) bodyHtml += `<td>${fmt(monthTotals[m])}</td>`;
    bodyHtml += '</tr>';

    const cum = new Array(12).fill(0);
    for (let m=0; m<12; m++){
      cum[m] = (m === 0 ? monthTotals[m] : cum[m-1] + monthTotals[m]);
    }
    bodyHtml += '<tr class="cum-row"><td>Cumulative total (mm)</td>';
    for (let m=0; m<12; m++) bodyHtml += `<td>${fmt(cum[m])}</td>`;
    bodyHtml += '</tr>';

    bodyHtml += '<tr><td>Total rain days</td>';
    for (let m=0; m<12; m++) bodyHtml += `<td>${monthRainDays[m] || ''}</td>`;
    bodyHtml += '</tr>';

    rainBody.innerHTML = bodyHtml;
    return { monthTotals, monthRainDays };
  }

  async function loadClimatology(){
    try{
      const resp = await fetch('consentes-house-rain.json', {cache:'no-store'});
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      climatology = await resp.json();
      if (!climatology || !climatology.longTerm){
        summaryContent.textContent = 'Averages file is present but empty. You can fill monthlyAverage and annualAverage later.';
      }
    }catch(e){
      console.error('Failed to load consentes-house-rain.json', e);
      summaryContent.textContent = 'Long-term averages file not found or unreadable.';
    }
  }

  function updateSummary(year, monthTotals){
    if (!summaryContent) return;
    if (!currentGauge){
      summaryContent.textContent = 'Select a gauge and year to see summary.';
      return;
    }

    const gaugeName = (currentGauge.name || '').toLowerCase();
    if (!climatology){
      summaryContent.textContent = 'Loading long-term averagesâ€¦';
      return;
    }

    // Only wired for Consentes House for now
    if (!gaugeName.includes('consentes')) {
      summaryContent.textContent = 'Long-term averages are currently only set up for Consentes House.';
      return;
    }

    if (!year || !monthTotals){
      summaryContent.textContent = 'Select a year to compare against long-term averages.';
      return;
    }

    const lt = climatology.longTerm || {};
    const ltaMonthly = Array.isArray(lt.monthlyAverage) ? lt.monthlyAverage : [];
    const ltaAnnual = typeof lt.annualAverage === 'number' ? lt.annualAverage : null;

    const thisYearTotal = monthTotals.reduce((sum,v)=> sum + (Number.isFinite(v)?v:0), 0);
    let yearPct = null;
    if (ltaAnnual && ltaAnnual > 0){
      yearPct = (thisYearTotal / ltaAnnual) * 100;
    }

    const monthsLabels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    function fmt1(v){ return v == null ? 'â€”' : v.toFixed(1); }
    function fmtPct(v){ return v == null ? 'â€”' : v.toFixed(0) + '%'; }

    let html = '';
    html += `<div class="muted small">Gauge averages source: <code>consentes-house-rain.json</code> (long-term).</div>`;
    html += '<div class="summary-grid">';

    // Annual tile
    let annualClass = '';
    if (yearPct != null){
      if (yearPct < 80) annualClass = 'summary-bad';
      else if (yearPct > 120) annualClass = 'summary-good';
    }
    html += `<div class="summary-item ${annualClass}">
      <strong>${year} vs long-term</strong>
      <div>This year: ${fmt1(thisYearTotal)} mm</div>
      <div>Average: ${fmt1(ltaAnnual)} mm</div>
      <div>Pct of avg: ${fmtPct(yearPct)}</div>
    </div>`;

    // First 3 months tiles
    for (let i=0; i<3; i++){
      const thisM = monthTotals[i] || 0;
      const avgM = (Array.isArray(ltaMonthly) && i < ltaMonthly.length) ? (ltaMonthly[i] || 0) : 0;
      let pct = null;
      if (avgM && avgM > 0) pct = (thisM / avgM) * 100;
      let cls = '';
      if (pct != null){
        if (pct < 80) cls = 'summary-bad';
        else if (pct > 120) cls = 'summary-good';
      }
      html += `<div class="summary-item ${cls}">
        <strong>${monthsLabels[i]}</strong>
        <div>This year: ${fmt1(thisM)} mm</div>
        <div>Average: ${fmt1(avgM)} mm</div>
        <div>Pct of avg: ${fmtPct(pct)}</div>
      </div>`;
    }

    html += '</div>';
    summaryContent.innerHTML = html;
  }

  // ===== Historic rainfall import (Consentes House) =====

  const HISTORIC_GAUGE_ID = 'TIrJaj2xgf6V5ieW2Wr0';

  const monthMap = {
    jan: 1, feb: 2, mar: 3, apr: 4,
    may: 5, jun: 6, jul: 7, aug: 8,
    sep: 9, oct: 10, nov: 11, dec: 12,
  };

  function parseWorkbookToEntries(workbook){
    const entries = [];

    workbook.SheetNames.forEach(sheetName=>{
      const year = parseInt(sheetName, 10);
      if (!year || year < 1900 || year > 3000) return;

      const ws = workbook.Sheets[sheetName];
      if (!ws) return;

      const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:null});
      if (!rows || rows.length < 2) return;

      const headers = rows[0].map(v => (v == null ? '' : String(v).trim().toLowerCase()));
      const monthIdxByCol = {};

      headers.forEach((h, idx)=>{
        if (idx === 0) return;
        if (!h) return;
        const key = h.slice(0,3);
        if (monthMap[key]) monthIdxByCol[idx] = monthMap[key];
      });

      for (let r = 1; r < rows.length; r++){
        const row = rows[r];
        if (!row || row.length === 0) continue;

        const dayVal = row[0];
        const dayNum = Number(dayVal);
        if (!Number.isFinite(dayNum) || dayNum < 1 || dayNum > 31) continue;

        for (let c = 1; c < row.length; c++){
          const month = monthIdxByCol[c];
          if (!month) continue;

          const cell = row[c];
          const val = Number(cell);
          if (!Number.isFinite(val)) continue;
          if (Math.abs(val) < 0.0001) continue;

          const mmRounded = Math.round(val * 10) / 10;
          const dateStr =
            String(year).padStart(4,'0') + '-' +
            String(month).padStart(2,'0') + '-' +
            String(dayNum).padStart(2,'0');

          entries.push({date: dateStr, mm: mmRounded});
        }
      }
    });

    return entries;
  }

  async function runHistoricImport(){
    if (!importFile || !importFile.files || !importFile.files[0]){
      alert('Choose the "Consentes House - Rainfall.xlsx" file first.');
      return;
    }

    const file = importFile.files[0];
    try{
      setImportStatus('Reading workbookâ€¦');
      const buf = await file.arrayBuffer();
      const workbook = XLSX.read(buf, {type:'array'});

      const entries = parseWorkbookToEntries(workbook);
      if (!entries.length){
        setImportStatus('No rainy days found in workbook. Check the file.');
        return;
      }

      setImportStatus(`Found ${entries.length} rainy days. Writing to Firestoreâ€¦`);

      const batchLimit = 400;
      let batch = db.batch();
      let countInBatch = 0;
      let written = 0;

      for (let i = 0; i < entries.length; i++){
        const e = entries[i];
        const docRef = db
          .collection('gauges')
          .doc(HISTORIC_GAUGE_ID)
          .collection('daily')
          .doc(e.date);

        batch.set(docRef, {mm: e.mm, source: 'historicImport'});
        countInBatch++;

        if (countInBatch >= batchLimit){
          await batch.commit();
          written += countInBatch;
          setImportStatus(`Wrote ${written}/${entries.length} daysâ€¦`);
          batch = db.batch();
          countInBatch = 0;
        }
      }

      if (countInBatch > 0){
        await batch.commit();
        written += countInBatch;
      }

      setImportStatus(`Import complete. Wrote ${written} rainy days.`);
      alert('Historic rainfall import complete. Reload the page and select an older year to check.');
    }catch(err){
      console.error('Historic import failed', err);
      setImportStatus('Import failed: ' + (err.message || err));
      alert('Import failed. Check the console log for more detail.');
    }
  }

  if (importBtn){
    importBtn.addEventListener('click', ()=>{
      runHistoricImport();
    });
  }
</script>
</body>
</html>
