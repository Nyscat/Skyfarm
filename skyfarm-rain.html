<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SkyFarm ‚Äî Property Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#f6fbf8;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --brand:#0B7A6E;
      --line:#e5e7eb;
    }
    *{box-sizing:border-box;}

    html,body{
      height:100%;
      margin:0;
      padding:0;
    }

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);
      color:var(--ink);
    }

    /* Header */
    #sf-header{position:sticky;top:0;z-index:10;}
    #sf-header .bar{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 14px;
      background:#fff;
      border-bottom:1px solid var(--line);
      flex-wrap:wrap;
    }
    #sf-header .brand{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--brand);
      font-weight:700;
      text-decoration:none;
    }
    #sf-header nav a{
      color:var(--brand);
      text-decoration:none;
      font-weight:600;
      margin-right:10px;
    }
    #sf-header nav a[aria-current="page"]{text-decoration:underline;}
    .spacer{flex:1;}
    .muted{color:var(--muted);font-size:.9rem;}
    .hidden{display:none;}

    .nav-db{position:relative;}
    .nav-db button{font-size:.9rem;}
    .db-menu{
      position:absolute;
      top:100%;
      left:0;
      background:#fff;
      border:1px solid var(--line);
      border-radius:10px;
      min-width:160px;
      padding:4px 0;
      box-shadow:0 10px 25px rgba(15,23,42,.12);
      z-index:20;
    }
    .db-menu a{
      display:block;
      padding:6px 12px;
      color:var(--ink);
      text-decoration:none;
      font-size:.9rem;
    }
    .db-menu a:hover{background:#f1f5f9;}

    .wrap{max-width:1200px;margin:0 auto;padding:16px;}
    h1{margin:12px 0;font-size:1.6rem;}
    .panel{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;}
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#ecfeff;
      font-size:.8rem;
      margin-right:4px;
    }

    label{font-size:.85rem;color:#475569;display:block;margin-bottom:4px;}
    select,input,button{
      padding:6px 10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      font:inherit;
      background:#fff;
    }
    button{cursor:pointer;}
    .btn{border-radius:10px;}
    .primary{background:var(--brand);color:#fff;border-color:var(--brand);}
    .danger{background:#ef4444;color:#fff;border-color:#ef4444;}

    /* Map layout */
    .map-layout{
      display:grid;
      grid-template-columns:1fr 360px;
      gap:16px;
      align-items:start;
    }

    #map{
      width:100%;
      height:560px;       /* desktop default */
      min-height:320px;
      background:#e5e7eb;
      border-radius:12px;
    }

    .map-panel{padding:0;}

    /* Auth overlay */
    #authOverlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.06);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    #authCard{
      width:min(520px,92vw);
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:20px;
    }
    #authCard h2{margin:0 0 10px;}

    /* Mobile layout */
    @media (max-width:800px){
      .map-layout{
        display:flex;
        flex-direction:column;
      }
      /* height on mobile will be overridden in JS, but keep a sane default */
      #map{
        height:60vh;
        min-height:340px;
      }
    }
  </style>
</head>
<body>

<!-- Header -->
<div id="sf-header">
  <div class="bar">
    <a class="brand" href="skyfarm-diary.html">üå± SkyFarm</a>
    <nav>
      <a href="skyfarm-diary.html">Diary</a>
      <a href="skyfarm-map.html" aria-current="page">Map</a>
      <a href="skyfarm-rain.html">Rain</a>
    </nav>
    <div class="nav-db">
      <button id="dbMenuBtn" class="btn small" type="button">Database ‚ñæ</button>
      <div id="dbMenu" class="db-menu hidden">
        <a href="skyfarm-livestock.html">Livestock</a>
        <a href="skyfarm-chemical.html">Chemicals</a>
        <a href="skyfarm-seeds.html">Seeds</a>
        <a href="skyfarm-fodder.html">Fodder</a>
        <a href="skyfarm-barcode.html">Barcode scanner</a>
        <a href="skyfarm-users.html">Users &amp; roles</a>
      </div>
    </div>
    <span class="spacer"></span>
    <span id="authWho" class="muted">Connecting‚Ä¶</span>
    <button id="signOutBtn" class="danger hidden">Sign out</button>
  </div>
</div>

<div class="wrap">
  <h1>Property Map</h1>
  <p id="status" class="muted">Loading paddock data‚Ä¶</p>

  <div class="panel" style="margin-bottom:12px;">
    <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
      <div>
        <label>Property</label>
        <select id="propertySel" style="min-width:200px;">
          <option value="ALL">(All properties)</option>
        </select>
      </div>
      <span class="muted" id="propertyHint">Zooms map to the selected property‚Äôs paddocks.</span>
    </div>
  </div>

  <div class="map-layout">
    <div class="panel map-panel">
      <div id="map"></div>
    </div>

    <aside class="panel">
      <h3 style="margin-top:0;">Paddock details</h3>
      <div id="paddockInfo" class="muted">
        Click a paddock to see livestock totals and recent diary entries (last 30 days).
      </div>
    </aside>
  </div>
</div>

<!-- Auth overlay -->
<div id="authOverlay">
  <div id="authCard">
    <h2>Sign in to SkyFarm</h2>
    <p class="muted" style="font-size:.85rem;">Email &amp; password only. Anonymous sign-in is disabled.</p>
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:8px;">
      <div style="flex:1;min-width:260px;">
        <label>Email</label>
        <input id="siEmail" type="email" placeholder="you@example.com" autocomplete="username">
      </div>
      <div style="flex:1;min-width:220px;">
        <label>Password</label>
        <input id="siPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
      <button id="signInBtn" class="primary btn">Sign in</button>
      <span id="authMsg" class="muted" style="font-size:.85rem;"></span>
      <span class="spacer"></span>
      <button id="closeOverlayBtn" class="btn" type="button">Close</button>
    </div>
  </div>
</div>

<script>
/* ---------- Firebase init ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const db   = firebase.firestore();
const auth = firebase.auth();

/* Force map height based on viewport (helps iOS Safari) */
function setMapHeight(){
  var el = document.getElementById('map');
  if (!el) return;
  var vh   = window.innerHeight || document.documentElement.clientHeight || 600;
  var h    = Math.max(Math.round(vh * 0.6), 340);  // at least ~340px
  el.style.height    = h + 'px';
  el.style.minHeight = h + 'px';
}
setMapHeight();
window.addEventListener('resize', setMapHeight);
window.addEventListener('orientationchange', setMapHeight);

/* ---------- Header DB menu ---------- */
const dbMenuBtn = document.getElementById('dbMenuBtn');
const dbMenu    = document.getElementById('dbMenu');
if (dbMenuBtn && dbMenu){
  dbMenuBtn.onclick = function(e){ e.stopPropagation(); dbMenu.classList.toggle('hidden'); };
  document.addEventListener('click', function(e){
    if (!dbMenu.contains(e.target) && e.target !== dbMenuBtn) dbMenu.classList.add('hidden');
  });
}

/* ---------- Auth overlay ---------- */
const authOverlay  = document.getElementById('authOverlay');
const authWho      = document.getElementById('authWho');
const signOutBtn   = document.getElementById('signOutBtn');
const signInBtn    = document.getElementById('signInBtn');
const closeOverlay = document.getElementById('closeOverlayBtn');

function showOverlay(on){ authOverlay.style.display = on ? 'flex' : 'none'; }

signInBtn.onclick = async function(){
  var email = document.getElementById('siEmail').value.trim();
  var pass  = document.getElementById('siPass').value;
  var msgEl = document.getElementById('authMsg');
  msgEl.textContent = 'Signing in‚Ä¶';
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithEmailAndPassword(email, pass);
    msgEl.textContent = 'Signed in.';
    showOverlay(false);
  }catch(e){
    msgEl.textContent = 'Sign-in failed: ' + (e && e.message ? e.message : 'Unknown');
  }
};
closeOverlay.onclick = function(){ showOverlay(false); };
signOutBtn.onclick   = async function(){ try{ await auth.signOut(); location.reload(); }catch(e){} };

/* ---------- UI helpers ---------- */
var statusEl      = document.getElementById('status');
var paddockInfoEl = document.getElementById('paddockInfo');
var propertySel   = document.getElementById('propertySel');
function setStatus(t){ if (statusEl) statusEl.textContent = t; }
function esc(s){
  return String(s == null ? '' : s).replace(/[&<>"]/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]); });
}

/* ---------- Map ---------- */
var map = L.map('map').setView([-20.0, 142.5], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom:19,
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

function ensureMapSize(){
  try{ map.invalidateSize(); }catch(e){}
}
window.addEventListener('resize', function(){ setMapHeight(); setTimeout(ensureMapSize, 200); });
window.addEventListener('orientationchange', function(){ setMapHeight(); setTimeout(ensureMapSize, 400); });
window.addEventListener('load', function(){ setTimeout(ensureMapSize, 400); });
document.addEventListener('visibilitychange', function(){
  if (!document.hidden) setTimeout(ensureMapSize, 300);
});

/* ---------- Constants & sources ---------- */
var KNOWN_PROPERTIES = {
  "Consentes": "s7PlDM9wrEpxuJ6DGIab",
  "Mt Myrtle": "TRuxtRBx2zJlwZnRGYKJ",
  "Gerawin":   "P0dQ0H2FWHeqqxejflZs"
};
var CLOUD_URLS = [
  "https://storage.googleapis.com/consentes-maps/consentes_station.json",
  "https://storage.googleapis.com/consentes-maps/mt_myrtle.json"
];
var LOCAL_FALLBACKS = [
  "maps/consentes_station.json",
  "maps/mt_myrtle.json"
];
var ACTIVE_PROPERTY_KEY = 'sf.map.activePropertyId';

var propertyMeta   = new Map();
var paddockIndex   = new Map();
var livestockIndex = new Map();
var diaryCache     = new Map();

var allBounds      = null;
var firestoreReady = false;

/* ---------- Firestore-backed indexes ---------- */
async function loadProperties(){
  propertyMeta.clear();
  var snap = await db.collection('properties').get();
  snap.forEach(function(doc){
    var d = doc.data() || {};
    var name = d.name || '(Property)';
    propertyMeta.set(doc.id, { name:name, bounds:null });
  });
  Object.keys(KNOWN_PROPERTIES).forEach(function(name){
    var id = KNOWN_PROPERTIES[name];
    if (!propertyMeta.has(id)) propertyMeta.set(id, { name:name, bounds:null });
  });
}

async function loadPaddocksIndex(){
  paddockIndex.clear();
  var snap = await db.collection('paddocks').get();
  snap.forEach(function(doc){
    var d = doc.data() || {};
    var name = (d.name || '').trim();
    var pid  = d.propertyId || null;
    if (!name || !pid) return;
    var pm = propertyMeta.get(pid);
    paddockIndex.set(name, {
      propertyId: pid,
      propertyName: pm ? pm.name : '(Property)'
    });
  });
}

async function loadLivestockIndex(){
  livestockIndex.clear();
  var snap = await db.collection('livestock').get();
  snap.forEach(function(doc){
    var d = doc.data() || {};
    var propId  = d.propertyId;
    var paddock = (d.location || '').trim();
    var count   = Number(d.count || 0);
    if (!propId || !paddock || !count) return;
    var key = propId + '|' + paddock;
    var rec = livestockIndex.get(key);
    if (!rec){
      rec = { total:0, byClass:{} };
      livestockIndex.set(key, rec);
    }
    rec.total += count;
    var cls = (d.class || d.species || 'Stock').trim() || 'Stock';
    rec.byClass[cls] = (rec.byClass[cls] || 0) + count;
  });
}

/* ---------- Diary helpers ---------- */
async function getRecentDiary(propertyId, paddockName){
  var cacheKey = propertyId + '|' + paddockName;
  if (diaryCache.has(cacheKey)) return diaryCache.get(cacheKey);

  var today = new Date();
  var from  = new Date(today.getTime() - 30*24*60*60*1000);
  var fromISO = from.toISOString().slice(0,10);

  var out = [];
  var snap = await db.collection('diaryEntries')
    .where('propertyId','==',propertyId)
    .orderBy('date','desc')
    .limit(100)
    .get();

  snap.forEach(function(doc){
    var d = doc.data() || {};
    var pad = (d.paddock || '').trim();
    if (pad !== paddockName) return;
    var dateStr = d.date || '';
    if (dateStr && dateStr < fromISO) return;
    out.push({
      date: dateStr,
      activity: d.activity || '',
      notes: d.notes || ''
    });
  });

  diaryCache.set(cacheKey, out);
  return out;
}

/* ---------- Render paddock info ---------- */
function renderPaddockInfo(propertyName, paddockName, stockRec, diaryList){
  var html = '';
  html += '<div><strong>Paddock:</strong> '+esc(paddockName)+'</div>';
  html += '<div><strong>Property:</strong> '+esc(propertyName)+'</div>';

  if (stockRec){
    html += '<div style="margin-top:6px;"><strong>Livestock in paddock:</strong> '+stockRec.total+'</div>';
    var classes = Object.keys(stockRec.byClass);
    if (classes.length){
      html += '<div style="margin-top:4px;font-size:.9rem;">';
      classes.sort().forEach(function(c){
        html += '<span class="pill">'+esc(c)+': '+stockRec.byClass[c]+'</span>';
      });
      html += '</div>';
    }
  }else{
    html += '<div style="margin-top:6px;">No livestock records for this paddock.</div>';
  }

  if (diaryList && diaryList.length){
    html += '<div style="margin-top:10px;"><strong>Recent diary entries (last 30 days)</strong></div>';
    html += '<ul style="margin:4px 0 0 18px;padding:0;font-size:.9rem;">';
    diaryList.forEach(function(e){
      var label = [e.date, e.activity].filter(Boolean).join(' ‚Äî ');
      var notes = e.notes ? ': '+esc(e.notes) : '';
      html += '<li>'+esc(label)+notes+'</li>';
    });
    html += '</ul>';
  }else{
    html += '<div style="margin-top:10px;">No diary entries for this paddock in the last 30 days.</div>';
  }

  paddockInfoEl.innerHTML = html;
}

/* ---------- Paddock click ---------- */
async function handlePaddockClick(mapIndex, feature){
  var props  = feature && feature.properties ? feature.properties : {};
  var paddockName = props.title ? String(props.title).trim() : 'Paddock';

  var pid = null;
  var propertyName = '';

  var idx = paddockIndex.get(paddockName);
  if (idx){
    pid = idx.propertyId;
    propertyName = idx.propertyName;
  }else{
    if (mapIndex === 0){
      pid = KNOWN_PROPERTIES["Consentes"];
      propertyName = "Consentes / Gerawin";
    }else if (mapIndex === 1){
      pid = KNOWN_PROPERTIES["Mt Myrtle"];
      propertyName = "Mt Myrtle";
    }
  }

  if (!pid){
    paddockInfoEl.innerHTML = '<span class="muted">No property match for paddock ‚Äú'+esc(paddockName)+'‚Äù.</span>';
    return;
  }

  if (!propertyName){
    var meta = propertyMeta.get(pid);
    propertyName = meta ? meta.name : '(Property)';
  }

  if (!firestoreReady){
    paddockInfoEl.innerHTML = '<span class="muted">Still connecting to Firebase‚Ä¶ try again in a moment.</span>';
    return;
  }

  var key      = pid + '|' + paddockName;
  var stockRec = livestockIndex.get(key);

  paddockInfoEl.innerHTML = '<span class="muted">Loading diary entries‚Ä¶</span>';

  var diaryList = [];
  try{
    diaryList = await getRecentDiary(pid, paddockName);
  }catch(e){ diaryList = []; }

  renderPaddockInfo(propertyName, paddockName, stockRec, diaryList);
}

/* ---------- GeoJSON fetch with fallback ---------- */
async function fetchWithFallback(primaryUrl, fallbackUrl){
  try{
    var r = await fetch(primaryUrl, {cache:'no-store'});
    if (!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }catch(e){
    var r2 = await fetch(fallbackUrl, {cache:'no-store'});
    if (!r2.ok) throw new Error('Fallback HTTP '+r2.status);
    return await r2.json();
  }
}

/* ---------- Property dropdown & zoom ---------- */
function rebuildPropertyDropdown(){
  var entries = [];
  propertyMeta.forEach(function(meta,id){
    if (meta.bounds) entries.push({id:id,name:meta.name});
  });
  entries.sort(function(a,b){ return a.name.localeCompare(b.name); });

  var saved = localStorage.getItem(ACTIVE_PROPERTY_KEY) || 'ALL';
  propertySel.innerHTML = '<option value="ALL">(All properties)</option>';
  entries.forEach(function(p){
    var opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name;
    propertySel.appendChild(opt);
  });

  if (saved !== 'ALL' && propertyMeta.has(saved) && propertyMeta.get(saved).bounds){
    propertySel.value = saved;
    zoomToProperty(saved);
  }else{
    propertySel.value = 'ALL';
    if (allBounds) map.fitBounds(allBounds, {padding:[20,20]});
  }

  propertySel.onchange = function(){
    var val = propertySel.value;
    localStorage.setItem(ACTIVE_PROPERTY_KEY, val);
    zoomToProperty(val);
  };
}

function zoomToProperty(propertyId){
  if (propertyId === 'ALL'){
    if (allBounds) map.fitBounds(allBounds, {padding:[20,20]});
    return;
  }
  var meta = propertyMeta.get(propertyId);
  if (meta && meta.bounds){
    map.fitBounds(meta.bounds, {padding:[20,20]});
  }
}

/* ---------- Auth + Firestore bootstrap ---------- */
auth.onAuthStateChanged(async function(user){
  if (user){
    authWho.textContent = user.email ? 'Signed in as '+user.email : 'Signed in';
    signOutBtn.classList.remove('hidden');
    showOverlay(false);
    try{ await db.enablePersistence({synchronizeTabs:true}); }catch(e){}
    try{
      setStatus('Loading properties & paddocks‚Ä¶');
      await loadProperties();
      await loadPaddocksIndex();
      setStatus('Loading livestock‚Ä¶');
      await loadLivestockIndex();
      firestoreReady = true;
      setStatus('Loading map‚Ä¶');
      await loadMapLayers();
      setStatus('Map ready. Click a paddock to see livestock and diary.');
      ensureMapSize();
    }catch(e){
      firestoreReady = false;
      setStatus('Error loading data for map.');
      console.error(e);
    }
  } else {
    authWho.textContent = 'Not signed in';
    signOutBtn.classList.add('hidden');
    firestoreReady = false;
    showOverlay(true);
    setStatus('Please sign in to see livestock & diary on paddocks.');
  }
});

/* ---------- Map layers ---------- */
function featureStyle(feature){
  var g = feature && feature.geometry ? feature.geometry : {};
  var t = g.type;
  if (t === 'Polygon' || t === 'MultiPolygon'){
    return { color:'#00897B', weight:2, fillOpacity:0.25 };
  }
  return { color:'#64748b', weight:1, fillOpacity:0 };
}

async function loadMapLayers(){
  allBounds = null;

  for (var i=0;i<CLOUD_URLS.length;i++){
    try{
      var data = await fetchWithFallback(CLOUD_URLS[i], LOCAL_FALLBACKS[i]);
      if (!data || (data.type !== 'FeatureCollection' && data.type !== 'Feature')) continue;

      var layer = L.geoJSON(data, {
        style: featureStyle,
        onEachFeature: function(feature, lyr){
          var g = feature && feature.geometry ? feature.geometry : {};
          var t = g.type;
          var isPaddock = (t === 'Polygon' || t === 'MultiPolygon');

          if (isPaddock){
            var props  = feature.properties || {};
            var title  = props.title ? String(props.title).trim() : '';
            var pid    = null;

            var idx = paddockIndex.get(title);
            if (idx){
              pid = idx.propertyId;
            }else{
              if (i === 1) pid = KNOWN_PROPERTIES["Mt Myrtle"];
            }

            var b = (typeof lyr.getBounds === 'function') ? lyr.getBounds() : null;
            if (b && b.isValid && b.isValid()){
              if (!allBounds) allBounds = b; else allBounds.extend(b);
              if (pid && propertyMeta.has(pid)){
                var meta = propertyMeta.get(pid);
                if (!meta.bounds) meta.bounds = b; else meta.bounds.extend(b);
              }
            }

            lyr.on('click', function(){ handlePaddockClick(i, feature); });
          }else if (feature.properties && feature.properties.title){
            lyr.bindTooltip(String(feature.properties.title), {direction:'top'});
          }
        }
      }).addTo(map);

      try{
        var lb = layer.getBounds();
        if (lb && lb.isValid && lb.isValid()){
          if (!allBounds) allBounds = lb; else allBounds.extend(lb);
        }
      }catch(_){}
    }catch(e){
      console.error('Failed to load map source', i, e);
    }
  }

  rebuildPropertyDropdown();
  if (!allBounds){
    setStatus('No features drawn');
  }else{
    map.fitBounds(allBounds, {padding:[20,20]});
  }
  ensureMapSize();
}
</script>
</body>
</html>
