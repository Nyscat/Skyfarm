<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SkyFarm — Users & Roles (Admin)</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>

<style>
  :root { --brand:#0B7A6E; }
  * { box-sizing:border-box; }
  body {
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:#f6fbf8;
    margin:16px;
    color:#0f172a;
  }
  h1 { margin:0 0 12px; font-size:1.6rem; }
  .wrap { max-width:1200px; margin:0 auto; }
  .card {
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:12px;
    margin:12px 0;
  }
  .row {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin:8px 0;
    align-items:flex-end;
  }
  label {
    display:block;
    font-size:.9rem;
    color:#475569;
    margin-bottom:4px;
  }
  input, select, button, textarea {
    padding:8px 10px;
    border:1px solid #cbd5e1;
    border-radius:10px;
    background:#fff;
    font-family:inherit;
    font-size:.9rem;
  }
  button { cursor:pointer; }
  .primary {
    background:var(--brand);
    color:#fff;
    border-color:var(--brand);
  }
  .danger {
    background:#ef4444;
    color:#fff;
    border-color:#ef4444;
  }
  .muted { color:#64748b; font-size:.9rem; }
  .spacer { flex:1; }
  table { width:100%; border-collapse:collapse; font-size:.9rem; }
  th, td { border-bottom:1px solid #e5e7eb; padding:8px; text-align:left; vertical-align:top; }
  th { background:#f1f5f9; }
  .badge {
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    background:#e2e8f0;
    font-size:.8rem;
    margin-right:6px;
  }
  .pill {
    padding:2px 8px;
    border-radius:999px;
    background:#dcfce7;
    color:#065f46;
    font-size:.8rem;
  }
  .warn { color:#9a3412; }
  .grid {
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap:8px;
  }
  .nowrap{ white-space:nowrap; }

  @media (max-width: 900px){
    body { margin:8px; }
    .row { flex-direction:column; align-items:flex-start; }
  }
</style>

<link rel="stylesheet" href="skyfarm-shared.css">
</head>
<body>
<div id="sf-header-root"></div>
<script src="skyfarm-header.js"></script>
<script>SkyFarmHeader.mount();</script>

<!-- Shared auth gate + login stamping -->
<script src="skyfarm-auth.js"></script>
<script>SkyFarmAuth.requireAuth();</script>

<div class="wrap">
  <h1>SkyFarm — Users & Roles</h1>

  <!-- Invite block -->
  <div class="card">
    <div class="row">
      <strong>Invite a user (email link)</strong>
      <span class="spacer"></span>
      <span id="status" class="muted">Checking access…</span>
    </div>
    <div id="inviteBody">
      <div class="grid">
        <div>
          <label>Email</label>
          <input id="invEmail" type="email" placeholder="user@example.com" style="width:100%" />
        </div>
        <div>
          <label>Name (optional)</label>
          <input id="invName" placeholder="e.g. Jane Brown" style="width:100%" />
        </div>
        <div>
          <label>Role</label>
          <select id="invRole" style="width:100%">
            <option value="worker">Worker</option>
            <option value="manager">Manager</option>
            <option value="admin">Admin</option>
          </select>
          <div class="muted" style="margin-top:4px">
            <div><span class="badge">Admin</span>Full access incl. Users</div>
            <div><span class="badge">Manager</span>All pages except Users</div>
            <div><span class="badge">Worker</span>Own diary entries only</div>
          </div>
        </div>
        <div>
          <label>Allowed properties</label>
          <div id="invProps" class="grid" style="grid-template-columns: repeat(1, minmax(200px,1fr));"></div>
        </div>
        <div>
          <label>Redirect after sign-in</label>
          <input id="redirectUrl" style="width:100%" />
          <div class="muted">
            Default: live domain — users land on Diary after confirming the link.
          </div>
        </div>
      </div>
      <div class="row">
        <button id="inviteBtn" class="primary">Send invite link</button>
        <span id="inviteMsg" class="muted" aria-live="polite"></span>
      </div>
    </div>
  </div>

  <!-- Manage users -->
  <div class="card">
    <div class="row">
      <strong>Manage users</strong>
      <span class="spacer"></span>
      <input id="search" placeholder="Search email / name" />
      <button id="refreshBtn">Refresh</button>
    </div>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Name</th>
            <th>Role</th>
            <th>Properties</th>
            <th class="nowrap">Last login</th>
            <th class="nowrap">Last seen</th>
            <th class="nowrap">Last updated</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="usersTbody">
          <tr><td colspan="8">Checking access…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
/*** Firebase ***/
const firebaseConfig = {
  apiKey: "AIzaSyBO9_0v1HdvVDuK3EFvaBGvQJIGvBwmW70",
  authDomain: "consentes-pastoral.firebaseapp.com",
  projectId: "consentes-pastoral",
  appId: "1:494858780013:web:d87497b370c82eeab06e64"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/*** Constants ***/
const PROPERTY_IDS = {
  "Consentes":"s7PlDM9wrEpxuJ6DGIab",
  "Mt Myrtle":"TRuxtRBx2zJlwZnRGYKJ",
  "Gerawin":"P0dQ0H2FWHeqqxejflZs"
};

/*** DOM helpers ***/
const $  = s=>document.querySelector(s);
const statusEl = $('#status');
const setStatus = (t, good)=>{
  statusEl.textContent = t || '';
  statusEl.className = good ? 'pill' : 'warn';
};
const setMsg = (el,t,ms=4000)=>{
  el.textContent = t || '';
  if(t && ms){
    setTimeout(()=>{ if(el.textContent===t) el.textContent=''; }, ms);
  }
};
const fmtTs = (ts)=>{
  try{
    if (!ts) return '';
    const d = ts.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
    return d ? d.toLocaleString() : '';
  }catch(e){
    return '';
  }
};

/*** Elements ***/
const invEmail   = $('#invEmail');
const invName    = $('#invName');
const invRole    = $('#invRole');
const invPropsBox= $('#invProps');
const redirectUrl= $('#redirectUrl');
const inviteBtn  = $('#inviteBtn');
const inviteMsg  = $('#inviteMsg');
const usersTbody = $('#usersTbody');
const searchInp  = $('#search');
const refreshBtn = $('#refreshBtn');
const inviteBody = $('#inviteBody');

let users = [];
let CURRENT_ROLE = 'worker';

/*** Role gate ***/
auth.onAuthStateChanged(async user=>{
  if (!user){
    setStatus('Sign in required', false);
    inviteBody.style.opacity = 0.4;
    inviteBtn.disabled = true;
    refreshBtn.disabled = true;
    usersTbody.innerHTML = '<tr><td colspan="8">Sign in to use this page.</td></tr>';
    return;
  }

  const email = (user.email || '').toLowerCase();
  if (!email){
    setStatus('Signed-in user has no email', false);
    return;
  }

  const docId = email.replace(/[^\w.-]/g,'_');
  let role = 'worker';
  try{
    const snap = await db.collection('users').doc(docId).get();
    if (snap.exists){
      const data = snap.data() || {};
      role = data.role || 'worker';
    }
  }catch(e){
    console.error(e);
  }
  CURRENT_ROLE = role;

  if (CURRENT_ROLE !== 'admin'){
    setStatus('Access denied — admin only', false);
    inviteBody.style.opacity = 0.4;
    inviteBtn.disabled = true;
    refreshBtn.disabled = true;
    searchInp.disabled = true;
    usersTbody.innerHTML =
      '<tr><td colspan="8">This page is only available to admin users.</td></tr>';
    return;
  }

  setStatus('Admin access', true);
  inviteBody.style.opacity = 1;
  inviteBtn.disabled = false;
  refreshBtn.disabled = false;
  searchInp.disabled = false;
  await initAdminUI();
});

/*** Admin initialisation ***/
async function initAdminUI(){
  invPropsBox.innerHTML = Object.entries(PROPERTY_IDS).map(([name,id])=>`
    <label style="display:flex;align-items:center;gap:8px;">
      <input type="checkbox" value="${id}"> ${name}
    </label>`).join('');

  const defaultRedirect = location.hostname.endsWith('consentes.com.au')
    ? `${location.origin}/skyfarm-diary.html`
    : 'https://www.consentes.com.au/skyfarm-diary.html';
  redirectUrl.value = defaultRedirect;

  inviteBtn.onclick  = sendInvite;
  refreshBtn.onclick = loadUsers;
  searchInp.oninput  = renderUsers;

  await loadUsers();
}

/*** Invite ***/
async function sendInvite(){
  const email = (invEmail.value || '').trim().toLowerCase();
  if (!email || !email.includes('@')){
    return setMsg(inviteMsg,'Enter a valid email address');
  }
  const name = (invName.value || '').trim();
  const role = invRole.value || 'worker';
  const allowed = Array.from(invPropsBox.querySelectorAll('input:checked')).map(c=>c.value);

  const docId = email.replace(/[^\w.-]/g,'_');

  try{
    await db.collection('users').doc(docId).set({
      email,
      name,
      role,
      allowedProperties: allowed,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  }catch(e){
    console.error(e);
    setMsg(inviteMsg,'Saved user record but failed before email was sent.');
  }

  try{
    await auth.sendSignInLinkToEmail(email,{
      url: redirectUrl.value,
      handleCodeInApp:true
    });
    localStorage.setItem('emailForSignIn',email);
    setMsg(inviteMsg,`Invite sent to ${email}.`);
    invEmail.value = '';
    invName.value  = '';
  }catch(e){
    console.error(e);
    setMsg(inviteMsg,`Failed to send email: ${e.code || ''} ${e.message || ''}`);
  }
}

/*** Load users ***/
async function loadUsers(){
  usersTbody.innerHTML = '<tr><td colspan="8">Loading…</td></tr>';
  users = [];
  try{
    const snap = await db.collection('users').orderBy('updatedAt','desc').get();
    snap.forEach(d=>{
      const r = d.data() || {};
      users.push({
        ...r,
        id: d.id,
        lastLoginAtText: fmtTs(r.lastLoginAt),
        lastSeenAtText:  fmtTs(r.lastSeenAt),
        updatedAtText:   fmtTs(r.updatedAt)
      });
    });
  }catch(e){
    console.error(e);
    usersTbody.innerHTML = '<tr><td colspan="8">Error loading users.</td></tr>';
    return;
  }
  renderUsers();
}

function renderUsers(){
  const q = (searchInp.value || '').toLowerCase();
  const list = users.filter(u =>
    !q ||
    (u.email && u.email.toLowerCase().includes(q)) ||
    (u.name && u.name.toLowerCase().includes(q))
  );

  usersTbody.innerHTML = '';
  if (!list.length){
    usersTbody.innerHTML = '<tr><td colspan="8">No users.</td></tr>';
    return;
  }

  for (const u of list){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${u.email || ''}</td>
      <td><input data-name value="${u.name || ''}"></td>
      <td>
        <select data-role>
          <option value="worker"${u.role==='worker'?' selected':''}>Worker</option>
          <option value="manager"${u.role==='manager'?' selected':''}>Manager</option>
          <option value="admin"${u.role==='admin'?' selected':''}>Admin</option>
        </select>
      </td>
      <td>${Object.entries(PROPERTY_IDS).map(([n,id])=>
        `<label><input type="checkbox" value="${id}"${(u.allowedProperties || []).includes(id)?' checked':''}> ${n}</label>`
      ).join('<br>')}</td>
      <td class="nowrap">${u.lastLoginAtText || ''}</td>
      <td class="nowrap">${u.lastSeenAtText || ''}</td>
      <td class="nowrap">${u.updatedAtText || ''}</td>
      <td class="nowrap">
        <button data-save class="primary">Save</button>
        <button data-del class="danger">Del</button>
      </td>`;
    tr.querySelector('[data-save]').onclick = ()=>saveRow(u.id,tr);
    tr.querySelector('[data-del]').onclick  = ()=>delRow(u.id,u.email);
    usersTbody.appendChild(tr);
  }
}

/*** Save / delete rows ***/
async function saveRow(id,tr){
  const name   = tr.querySelector('[data-name]').value;
  const role   = tr.querySelector('[data-role]').value;
  const allowed= Array.from(tr.querySelectorAll('input[type=checkbox]:checked')).map(c=>c.value);
  try{
    await db.collection('users').doc(id).set({
      name,
      role,
      allowedProperties: allowed,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
    await loadUsers();
  }catch(e){
    console.error(e);
    alert('Save failed, see console.');
  }
}

async function delRow(id,email){
  if (!confirm(`Remove ${email}?`)) return;
  try{
    await db.collection('users').doc(id).delete();
    await loadUsers();
  }catch(e){
    console.error(e);
    alert('Delete failed, see console.');
  }
}

/*** Sign-in via email link helper (optional) ***/
window.addEventListener('load',async()=>{
  try{
    if (auth.isSignInWithEmailLink(location.href)){
      let email = localStorage.getItem('emailForSignIn') || prompt('Enter your email');
      if (email){
        await auth.signInWithEmailLink(email, location.href);
        localStorage.removeItem('emailForSignIn');
        setMsg(inviteMsg,`Signed in as ${email}`);
      }
    }
  }catch(e){
    console.error(e);
  }
});
</script>
</body>
</html>
